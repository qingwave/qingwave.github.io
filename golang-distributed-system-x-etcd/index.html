<!DOCTYPE html><html class="2xl:text-[20px]" dir="ltr" lang="zh"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>Golang分布式应用之etcd</title><meta content="index,follow" name="robots"/><meta content="Golang分布式应用之etcd" property="og:title"/><meta content="https://qingwave.github.io/golang-distributed-system-x-etcd" property="og:url"/><meta content="article" property="og:type"/><link href="https://qingwave.github.io/golang-distributed-system-x-etcd" rel="canonical"/><style is:global>:root{--aw-font-sans:'InterVariable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" name="google-site-verification"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" type="text/partytown"></script><script type="text/partytown">(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href="/favicon.ico" rel="shortcut icon"><link href="/favicon.svg" rel="icon" type="image/svg+xml"><link href="/favicon.svg" rel="mask-icon" color="#8D46E7"><link href="/sitemap-index.xml" rel="sitemap"><link href="/_astro/_...page_.185b9619.css" rel="stylesheet"/><script>!function(t,e,n,i){(i=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(i[n]||[]).concat(["dataLayer.push"])}(window,"partytown","forward"),function(t,e,n,i,a,o,r,d,s,c,p,l){function u(){l||(l=1,"/"==(r=(o.lib||"/~partytown/")+(o.debug?"debug/":""))[0]&&(s=e.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(f,1e4),e.addEventListener("pt0",h),a?w(1):n.serviceWorker?n.serviceWorker.register(r+(o.swPath||"partytown-sw.js"),{scope:r}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):f())))}function w(t){c=e.createElement(t?"script":"iframe"),t||(c.setAttribute("style","display:block;width:0;height:0;border:0;visibility:hidden"),c.setAttribute("aria-hidden",!0)),c.src=r+"partytown-"+(t?"atomics.js?v=0.7.6":"sandbox-sw.html?"+Date.now()),e.body.appendChild(c)}function f(n,a){for(h(),i==t&&(o.forward||[]).map((function(e){delete t[e.split(".")[0]]})),n=0;n<s.length;n++)(a=e.createElement("script")).innerHTML=s[n].innerHTML,e.head.appendChild(a);c&&c.parentNode.removeChild(c)}function h(){clearTimeout(d)}o=t.partytown||{},i==t&&(o.forward||[]).map((function(e){p=t,e.split(".").map((function(e,n,i){p=p[i[n]]=n+1<i.length?"push"==i[n+1]?[]:p[i[n]]||{}:function(){(t._ptf=t._ptf||[]).push(i,arguments)}}))})),"complete"==e.readyState?u():(t.addEventListener("DOMContentLoaded",u),t.addEventListener("load",u))}(window,document,navigator,top,window.crossOriginIsolated)</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id="header"><div class="max-w-3xl mx-auto sm:px-6 px-6 md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href="/" class="items-center flex"><img class="h-6 w-6 dark:invert invert-0" src="/favicon.svg"></a><div class="items-center flex md:hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type="button" data-aw-toggle-color-scheme><svg astro-icon="ph:moon-fill" class="h-8 w-8" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill="currentColor"/></svg></button> <button aria-label="Toggle Menu" class="items-center transition dark:focus:ring-gray-700 dark:hover:bg-gray-800 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex ml-1.5 p-2.5 rounded-lg text-gray-500 text-sm" type="button" data-aw-toggle-menu><svg astro-icon="tabler:menu" class="h-6 w-6" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g class="icon-tabler" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 8h16"/><path d="M4 16h16"/></g></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 text-xl w-full"><li class=""><a href="/blog" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">写作</a></li><li class=""><a href="/project" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">项目</a></li><li class=""><a href="/tags" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">标签</a></li><li class=""><a href="/about" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type="button" data-aw-toggle-color-scheme><svg astro-icon="ph:moon-fill" class="h-6 w-6" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill="currentColor"/></svg></button></div></div></div></header><main><section class="max-w-3xl mx-auto lg:py-20 py-8 sm:py-16"><article><header class=""><div class="flex px-4 flex-col justify-between max-w-3xl mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Sun Aug 07 2022 17:48:18 GMT+0000 (Coordinated Universal Time)">Aug 7, 2022</time> · <a href="/categories/code" class="capitalize hover:underline">code</a></p></div><h1 class="max-w-3xl mx-auto sm:px-6 px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">Golang分布式应用之etcd</h1><p class="max-w-3xl mx-auto sm:px-6 px-4 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="max-w-3xl mx-auto sm:px-6 px-4"><div class="border-t dark:border-slate-700"></div></div></header><div class="max-w-3xl mx-auto sm:px-6 px-6 mt-8 break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert lg:prose-xl overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-lg prose-md"><div class="table-wrap"><p>etcd 是一个可靠的分布式 KV 存储数据库，由 CoreOS 开源。Kuberentes 使用 etcd 作为其存储引擎，随着云原生的火热，etcd 也逐渐广泛应用起来。</p><p>etcd 除了作为普通的 KV 存储、配置存储，还可以用在以下分布式场景中：</p><ul><li>服务发现</li><li>分布式锁</li><li>选主</li><li>分布式队列</li><li>分布式系统协调</li><li>负载均衡</li></ul><p>本文结合 Golang 来编写对应的中间件，所有代码见<a href="https://github.com/qingwave/gocorex">https://github.com/qingwave/gocorex</a></p><h2 id="服务发现">服务发现</h2><p>在分布式系统中，如何能找到所需要访问的服务即服务发现。服务较少时可以直接访问其 IP，但随着业务规模的扩大，维护其地址越来越复杂，如果服务频繁的扩缩容，必须能够实时感应服务的断点变化。 通常有多种方式可以解决</p><ol><li>系统级别，如 LVS、DNS、Kubernetes 中的 Service、Istio 等</li><li>微服务注册中心，如 Spring Cloud 中的 Enruka，Dubbo 等</li><li>借助分布式协调系统 etcd、ZK、Consul 等</li></ol><p>服务发现提供的功能包括：</p><ul><li>服务注册、注销</li><li>服务宕机或异常时，自动注销</li><li>感知服务端点变化</li></ul><p>借助 etcd 实现服务发现</p><ul><li>可以通过将端点写同一个目录(相同前缀，如/services/job/endpoint1, /services/job/endpoint2)，并通过 Lease 设置一个过期时间，不断刷新 Lease，如果服务宕机，Lease 过期对应端点会自动删除</li><li>通过 Watch API 可以监听端点变化</li></ul><p>主要代码如下</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">New</span><span style="color:#f8f8f2">(config EtcdDiscoveryConfig) (</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EtcdDiscovery, </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 创建session，session会自动续约</span></span>
<span class="line"><span style="color:#f8f8f2">	session, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> concurrency.</span><span style="color:#8be9fd">NewSession</span><span style="color:#f8f8f2">(config.Client, concurrency.</span><span style="color:#8be9fd">WithTTL</span><span style="color:#f8f8f2">(config.TTLSeconds))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	config.Prefix </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> strings.</span><span style="color:#8be9fd">TrimSuffix</span><span style="color:#f8f8f2">(config.Prefix, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">/</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">) </span><span style="color:#ff79c6">+</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">/</span><span style="color:#e9f284">"</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">EtcdDiscovery{</span></span>
<span class="line"><span style="color:#f8f8f2">		EtcdDiscoveryConfig: config,</span></span>
<span class="line"><span style="color:#f8f8f2">		session:             session,</span></span>
<span class="line"><span style="color:#f8f8f2">		myKey:               config.Prefix </span><span style="color:#ff79c6">+</span><span style="color:#f8f8f2"> config.Key,</span></span>
<span class="line"><span style="color:#f8f8f2">		services:            </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">map</span><span style="color:#f8f8f2">[</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">]</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">),</span></span>
<span class="line"><span style="color:#f8f8f2">	}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (d </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EtcdDiscovery) </span><span style="color:#50fa7b">Register</span><span style="color:#f8f8f2">(ctx context.Context) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	lease </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> d.session.</span><span style="color:#8be9fd">Lease</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 注册服务</span></span>
<span class="line"><span style="color:#f8f8f2">	_, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> d.Client.</span><span style="color:#8be9fd">Put</span><span style="color:#f8f8f2">(ctx, d.myKey, d.Val, clientv3.</span><span style="color:#8be9fd">WithLease</span><span style="color:#f8f8f2">(lease))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (d </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EtcdDiscovery) </span><span style="color:#50fa7b">UnRegister</span><span style="color:#f8f8f2">(ctx context.Context) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 注销服务</span></span>
<span class="line"><span style="color:#f8f8f2">	_, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> d.Client.</span><span style="color:#8be9fd">Delete</span><span style="color:#f8f8f2">(ctx, d.myKey)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// 监听端点变化</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (d </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EtcdDiscovery) </span><span style="color:#50fa7b">Watch</span><span style="color:#f8f8f2">(ctx context.Context) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// context用来停止监听</span></span>
<span class="line"><span style="color:#f8f8f2">	d.watchContext, d.watchCancel </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> context.</span><span style="color:#8be9fd">WithCancel</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 首先获取所有端点</span></span>
<span class="line"><span style="color:#f8f8f2">	resp, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> d.Client.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(d.watchContext, d.Prefix, clientv3.</span><span style="color:#8be9fd">WithPrefix</span><span style="color:#f8f8f2">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	services </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">map</span><span style="color:#f8f8f2">[</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">]</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, kv </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> resp.Kvs {</span></span>
<span class="line"><span style="color:#f8f8f2">		services[</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(kv.Key)] </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(kv.Value)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	d.</span><span style="color:#8be9fd">setServices</span><span style="color:#f8f8f2">(services)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 回调点，用户可自定义</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> d.Callbacks.OnStartedDiscovering </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		d.Callbacks.</span><span style="color:#8be9fd">OnStartedDiscovering</span><span style="color:#f8f8f2">(d.</span><span style="color:#8be9fd">ListServices</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> d.Callbacks.OnStoppedDiscovering </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			d.Callbacks.</span><span style="color:#8be9fd">OnStoppedDiscovering</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> d.</span><span style="color:#8be9fd">watchCancel</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 监听目录，通过WithPrefix可以添加子目录变化</span></span>
<span class="line"><span style="color:#f8f8f2">	ch </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> d.Client.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(d.watchContext, d.Prefix, clientv3.</span><span style="color:#8be9fd">WithPrefix</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">select</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">d.watchContext.</span><span style="color:#8be9fd">Done</span><span style="color:#f8f8f2">():</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> wr, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">ch:</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">ok {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">watch closed</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> wr.</span><span style="color:#8be9fd">Err</span><span style="color:#f8f8f2">() </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> wr.</span><span style="color:#8be9fd">Err</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">            </span><span style="color:#6272a4">// 将添加事件同步到本地端点列表</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, ev </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> wr.Events {</span></span>
<span class="line"><span style="color:#f8f8f2">				key, val </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(ev.Kv.Key), </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(ev.Kv.Value)</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">switch</span><span style="color:#f8f8f2"> ev.Type {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> mvccpb.PUT:</span></span>
<span class="line"><span style="color:#f8f8f2">					d.</span><span style="color:#8be9fd">addService</span><span style="color:#f8f8f2">(key, val)</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> mvccpb.DELETE:</span></span>
<span class="line"><span style="color:#f8f8f2">					d.</span><span style="color:#8be9fd">delService</span><span style="color:#f8f8f2">(key)</span></span>
<span class="line"><span style="color:#f8f8f2">				}</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> d.Callbacks.OnServiceChanged </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">					event </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> DiscoveryEvent{Type: mvccpb.Event_EventType_name[</span><span style="color:#8be9fd">int32</span><span style="color:#f8f8f2">(ev.Type)], Service: d.</span><span style="color:#8be9fd">serviceFromKv</span><span style="color:#f8f8f2">(key, val)}</span></span>
<span class="line"><span style="color:#f8f8f2">					d.Callbacks.</span><span style="color:#8be9fd">OnServiceChanged</span><span style="color:#f8f8f2">(d.</span><span style="color:#8be9fd">ListServices</span><span style="color:#f8f8f2">(), event)</span></span>
<span class="line"><span style="color:#f8f8f2">				}</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>主要实现逻辑如下：</p><ol><li>创建 Session， Session 中 Lease 会自动续约</li><li>服务注册时，在目录下创建对应的子目录，并附带 Lease</li><li>通过 Watch 接口监听目录变化，同步到本地</li></ol><p>简单测试下，通过 worker 模拟不同的端点</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">main</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	client, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> clientv3.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(clientv3.Config{</span></span>
<span class="line"><span style="color:#f8f8f2">		Endpoints:   []</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">{</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">localhost:2379</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">},</span></span>
<span class="line"><span style="color:#f8f8f2">		DialTimeout: </span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2"> time.Second,</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		log.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to create etcd lock: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">Close</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	worker </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(i </span><span style="color:#8be9fd">int</span><span style="color:#f8f8f2">, run </span><span style="color:#8be9fd">bool</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">		id </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Sprintf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">worker-</span><span style="color:#bd93f9">%d</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, i)</span></span>
<span class="line"><span style="color:#f8f8f2">		val </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Sprintf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">10.0.0.</span><span style="color:#bd93f9">%d</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, i)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		sd, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> etcdiscovery.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(etcdiscovery.EtcdDiscoveryConfig{</span></span>
<span class="line"><span style="color:#f8f8f2">			Client:     client,</span></span>
<span class="line"><span style="color:#f8f8f2">			Prefix:     </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">/services</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">			Key:        id,</span></span>
<span class="line"><span style="color:#f8f8f2">			Val:        val,</span></span>
<span class="line"><span style="color:#f8f8f2">			TTLSeconds: </span><span style="color:#bd93f9">2</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">			Callbacks: etcdiscovery.DiscoveryCallbacks{</span></span>
<span class="line"><span style="color:#f8f8f2">				OnStartedDiscovering: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(services []etcdiscovery.Service) {</span></span>
<span class="line"><span style="color:#f8f8f2">					log.</span><span style="color:#8be9fd">Printf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">[</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">], onstarted, services: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id, services)</span></span>
<span class="line"><span style="color:#f8f8f2">				},</span></span>
<span class="line"><span style="color:#f8f8f2">				OnStoppedDiscovering: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">					log.</span><span style="color:#8be9fd">Printf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">[</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">], onstoped</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id)</span></span>
<span class="line"><span style="color:#f8f8f2">				},</span></span>
<span class="line"><span style="color:#f8f8f2">				OnServiceChanged: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(services []etcdiscovery.Service, event etcdiscovery.DiscoveryEvent) {</span></span>
<span class="line"><span style="color:#f8f8f2">					log.</span><span style="color:#8be9fd">Printf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">[</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">], onchanged, services: </span><span style="color:#bd93f9">%v</span><span style="color:#f1fa8c">, event: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id, services, event)</span></span>
<span class="line"><span style="color:#f8f8f2">				},</span></span>
<span class="line"><span style="color:#f8f8f2">			},</span></span>
<span class="line"><span style="color:#f8f8f2">		})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			log.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to create service etcdiscovery: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> sd.</span><span style="color:#8be9fd">Close</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">run {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> sd.</span><span style="color:#8be9fd">UnRegister</span><span style="color:#f8f8f2">(context.</span><span style="color:#8be9fd">Background</span><span style="color:#f8f8f2">()); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				log.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to unregister service [</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">]: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id, err)</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> sd.</span><span style="color:#8be9fd">Register</span><span style="color:#f8f8f2">(context.</span><span style="color:#8be9fd">Background</span><span style="color:#f8f8f2">()); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			log.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to register service [</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">]: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id, err)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> sd.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(context.</span><span style="color:#8be9fd">Background</span><span style="color:#f8f8f2">()); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			log.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to watch service: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	wg </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> group.</span><span style="color:#8be9fd">NewGroup</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> i </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">; i </span><span style="color:#ff79c6">&#x3C;</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2">; i</span><span style="color:#ff79c6">++</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		id </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> i</span></span>
<span class="line"><span style="color:#f8f8f2">		wg.</span><span style="color:#8be9fd">Go</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() { </span><span style="color:#8be9fd">worker</span><span style="color:#f8f8f2">(id, </span><span style="color:#bd93f9">true</span><span style="color:#f8f8f2">) })</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">		time.</span><span style="color:#8be9fd">Sleep</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">2</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2"> time.Second)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">worker</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2">, </span><span style="color:#bd93f9">true</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// unregister</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">		time.</span><span style="color:#8be9fd">Sleep</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">4</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2"> time.Second)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">worker</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">2</span><span style="color:#f8f8f2">, </span><span style="color:#bd93f9">false</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	wg.</span><span style="color:#8be9fd">Wait</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>通过结果可以看到，服务可以正常的注册注销，并能实时监听端点变化</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:02 [worker-1], onstarted, services: [{/services/worker-1 worker-1 10.0.0.1} {/services/worker-2 worker-2 10.0.0.2} {/services/worker-0 worker-0 10.0.0.0}]</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:02 [worker-2], onstarted, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-2 worker-2 10.0.0.2}]</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:02 [worker-0], onstarted, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-2 worker-2 10.0.0.2}]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:04 [worker-2], onchanged, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-2 worker-2 10.0.0.2} {/services/worker-3 worker-3 10.0.0.3}], event: {PUT {/services/worker-3 worker-3 10.0.0.3}}</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:04 [worker-1], onchanged, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-2 worker-2 10.0.0.2} {/services/worker-3 worker-3 10.0.0.3}], event: {PUT {/services/worker-3 worker-3 10.0.0.3}}</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:04 [worker-0], onchanged, services: [{/services/worker-3 worker-3 10.0.0.3} {/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-2 worker-2 10.0.0.2}], event: {PUT {/services/worker-3 worker-3 10.0.0.3}}</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:04 [worker-3], onstarted, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-2 worker-2 10.0.0.2} {/services/worker-3 worker-3 10.0.0.3}]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:06 [worker-1], onchanged, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-3 worker-3 10.0.0.3}], event: {DELETE {/services/worker-2 worker-2 }}</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:06 [worker-3], onchanged, services: [{/services/worker-3 worker-3 10.0.0.3} {/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1}], event: {DELETE {/services/worker-2 worker-2 }}</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:06 [worker-0], onchanged, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-3 worker-3 10.0.0.3}], event: {DELETE {/services/worker-2 worker-2 }}</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 08:44:06 [worker-2], onchanged, services: [{/services/worker-0 worker-0 10.0.0.0} {/services/worker-1 worker-1 10.0.0.1} {/services/worker-3 worker-3 10.0.0.3}], event: {DELETE {/services/worker-2 worker-2 }}</span></span></code></pre><h2 id="分布式锁">分布式锁</h2><p>在 ECTD 官方库<a href="https://pkg.go.dev/go.etcd.io/etcd/client/v3/concurrency">go.etcd.io/etcd/client/v3/concurrency</a>中，已经支持分布式锁。</p><p>主要原理与之前通过<a href="/golang-distributed-system-x-redis">Redis</a>实现的分布式锁类似，如果目录创建成功则加锁成功，解锁直接删除即可。</p><p>etcd 锁的使用</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#6272a4">// 创建session并不断刷新</span></span>
<span class="line"><span style="color:#f8f8f2">session, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> concurrency.</span><span style="color:#8be9fd">NewSession</span><span style="color:#f8f8f2">(client, concurrency.</span><span style="color:#8be9fd">WithTTL</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">time.Second))</span></span>
<span class="line"><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">mutex </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> concurrency.</span><span style="color:#8be9fd">NewMutex</span><span style="color:#f8f8f2">(session, config.Prefix)</span></span>
<span class="line"><span style="color:#f8f8f2">mutex.</span><span style="color:#8be9fd">Lock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> mutext.</span><span style="color:#8be9fd">UnLock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8be9fd">do</span><span style="color:#f8f8f2">()</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">.</span></span></code></pre><p>加锁的核心逻辑如下</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (m </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Mutex) </span><span style="color:#50fa7b">tryAcquire</span><span style="color:#f8f8f2">(ctx context.Context) (</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">v3.TxnResponse, </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	s </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> m.s</span></span>
<span class="line"><span style="color:#f8f8f2">	client </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> m.s.</span><span style="color:#8be9fd">Client</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	m.myKey </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Sprintf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#bd93f9">%s%x</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, m.pfx, s.</span><span style="color:#8be9fd">Lease</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	cmp </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> v3.</span><span style="color:#8be9fd">Compare</span><span style="color:#f8f8f2">(v3.</span><span style="color:#8be9fd">CreateRevision</span><span style="color:#f8f8f2">(m.myKey), </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">=</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// put self in lock waiters via myKey; oldest waiter holds lock</span></span>
<span class="line"><span style="color:#f8f8f2">	put </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> v3.</span><span style="color:#8be9fd">OpPut</span><span style="color:#f8f8f2">(m.myKey, </span><span style="color:#e9f284">""</span><span style="color:#f8f8f2">, v3.</span><span style="color:#8be9fd">WithLease</span><span style="color:#f8f8f2">(s.</span><span style="color:#8be9fd">Lease</span><span style="color:#f8f8f2">()))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// reuse key in case this session already holds the lock</span></span>
<span class="line"><span style="color:#f8f8f2">	get </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> v3.</span><span style="color:#8be9fd">OpGet</span><span style="color:#f8f8f2">(m.myKey)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// fetch current holder to complete uncontended path with only one RPC</span></span>
<span class="line"><span style="color:#f8f8f2">	getOwner </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> v3.</span><span style="color:#8be9fd">OpGet</span><span style="color:#f8f8f2">(m.pfx, v3.</span><span style="color:#8be9fd">WithFirstCreate</span><span style="color:#f8f8f2">()</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	resp, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">Txn</span><span style="color:#f8f8f2">(ctx).</span><span style="color:#8be9fd">If</span><span style="color:#f8f8f2">(cmp).</span><span style="color:#8be9fd">Then</span><span style="color:#f8f8f2">(put, getOwner).</span><span style="color:#8be9fd">Else</span><span style="color:#f8f8f2">(get, getOwner).</span><span style="color:#8be9fd">Commit</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	m.myRev </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> resp.Header.Revision</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">resp.Succeeded {</span></span>
<span class="line"><span style="color:#f8f8f2">		m.myRev </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> resp.Responses[</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">].</span><span style="color:#8be9fd">GetResponseRange</span><span style="color:#f8f8f2">().Kvs[</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">].CreateRevision</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> resp, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>tryAcquire 通过事务来执行加锁逻辑:</p><ol><li>判断当前 Key 是否为空，即代码中 Revision 为 0</li><li>如果为空，使用 Put 设置并附加 Lease</li><li>如果不为空，获取当前锁的所有者，即最先加锁的对象，避免惊群效应</li></ol><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (m </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Mutex) </span><span style="color:#50fa7b">Lock</span><span style="color:#f8f8f2">(ctx context.Context) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	resp, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> m.</span><span style="color:#8be9fd">tryAcquire</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// if no key on prefix / the minimum rev is key, already hold the lock</span></span>
<span class="line"><span style="color:#f8f8f2">	ownerKey </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> resp.Responses[</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">].</span><span style="color:#8be9fd">GetResponseRange</span><span style="color:#f8f8f2">().Kvs</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">len</span><span style="color:#f8f8f2">(ownerKey) </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">||</span><span style="color:#f8f8f2"> ownerKey[</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">].CreateRevision </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> m.myRev {</span></span>
<span class="line"><span style="color:#f8f8f2">		m.hdr </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> resp.Header</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	client </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> m.s.</span><span style="color:#8be9fd">Client</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	_, werr </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">waitDeletes</span><span style="color:#f8f8f2">(ctx, client, m.pfx, m.myRev</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// release lock key if wait failed</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> werr </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		m.</span><span style="color:#8be9fd">Unlock</span><span style="color:#f8f8f2">(client.</span><span style="color:#8be9fd">Ctx</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> werr</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// make sure the session is not expired, and the owner key still exists.</span></span>
<span class="line"><span style="color:#f8f8f2">	gresp, werr </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, m.myKey)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>Lock 方法会一直阻塞，直到获取锁返回执行出错:</p><ol><li>调用 tryAcquire</li><li>如果已经加锁成功，或者已经加过锁（可重入），则直接返回</li><li>调用 waitDeletes 方法，等待所有小于当前 Revsion 的 Key 删除</li></ol><h2 id="分布式选主">分布式选主</h2><p>对于有状态的服务，为了提供其服务水平 SLA 减少宕机时间，通过会有多个副本，当主节点宕机时，副本节点可以快速切换。</p><p>通过 etcd 可以实现选主服务，与分布式比较类似</p><ul><li>选主成功，不断上报心跳</li><li>通过 Watch 接口，当节点失效时，去竞争主(类似加锁过程)</li></ul><p>在 ECTD 官方库<a href="https://pkg.go.dev/go.etcd.io/etcd/client/v3/concurrency">go.etcd.io/etcd/client/v3/concurrency</a>中，已经支持了分布式选主。</p><p>选主核心逻辑如下</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (e </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Election) </span><span style="color:#50fa7b">Campaign</span><span style="color:#f8f8f2">(ctx context.Context, val </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	s </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> e.session</span></span>
<span class="line"><span style="color:#f8f8f2">	client </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> e.session.</span><span style="color:#8be9fd">Client</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	k </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Sprintf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#bd93f9">%s%x</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, e.keyPrefix, s.</span><span style="color:#8be9fd">Lease</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	txn </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">Txn</span><span style="color:#f8f8f2">(ctx).</span><span style="color:#8be9fd">If</span><span style="color:#f8f8f2">(v3.</span><span style="color:#8be9fd">Compare</span><span style="color:#f8f8f2">(v3.</span><span style="color:#8be9fd">CreateRevision</span><span style="color:#f8f8f2">(k), </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">=</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">))</span></span>
<span class="line"><span style="color:#f8f8f2">	txn </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> txn.</span><span style="color:#8be9fd">Then</span><span style="color:#f8f8f2">(v3.</span><span style="color:#8be9fd">OpPut</span><span style="color:#f8f8f2">(k, val, v3.</span><span style="color:#8be9fd">WithLease</span><span style="color:#f8f8f2">(s.</span><span style="color:#8be9fd">Lease</span><span style="color:#f8f8f2">())))</span></span>
<span class="line"><span style="color:#f8f8f2">	txn </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> txn.</span><span style="color:#8be9fd">Else</span><span style="color:#f8f8f2">(v3.</span><span style="color:#8be9fd">OpGet</span><span style="color:#f8f8f2">(k))</span></span>
<span class="line"><span style="color:#f8f8f2">	resp, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> txn.</span><span style="color:#8be9fd">Commit</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	e.leaderKey, e.leaderRev, e.leaderSession </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> k, resp.Header.Revision, s</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">resp.Succeeded {</span></span>
<span class="line"><span style="color:#f8f8f2">		kv </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> resp.Responses[</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">].</span><span style="color:#8be9fd">GetResponseRange</span><span style="color:#f8f8f2">().Kvs[</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">]</span></span>
<span class="line"><span style="color:#f8f8f2">		e.leaderRev </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> kv.CreateRevision</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(kv.Value) </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> val {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> e.</span><span style="color:#8be9fd">Proclaim</span><span style="color:#f8f8f2">(ctx, val); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				e.</span><span style="color:#8be9fd">Resign</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	_, err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">waitDeletes</span><span style="color:#f8f8f2">(ctx, client, e.keyPrefix, e.leaderRev</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#6272a4">// clean up in case of context cancel</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">select</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">ctx.</span><span style="color:#8be9fd">Done</span><span style="color:#f8f8f2">():</span></span>
<span class="line"><span style="color:#f8f8f2">			e.</span><span style="color:#8be9fd">Resign</span><span style="color:#f8f8f2">(client.</span><span style="color:#8be9fd">Ctx</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">default</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f8f8f2">			e.leaderSession </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	e.hdr </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> resp.Header</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>以上逻辑与 ECTD 锁中的实现非常相似</p><ol><li>开启事务，首先判断当前服务 Key 是否存在</li><li>不存在，通过 Put 设置对应值</li><li>存在获得当前目录最小 Revision 的值，即当前主节点</li><li>通过 waitDeletes，直到当前进程的 Revision</li></ol><p>简单封装下，支持回调，参考了 Kubernetes 的选主实现</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">New</span><span style="color:#f8f8f2">(config LeaderElectionConfig) (</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EctdLeaderElection, </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	session, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> concurrency.</span><span style="color:#8be9fd">NewSession</span><span style="color:#f8f8f2">(config.Client, concurrency.</span><span style="color:#8be9fd">WithTTL</span><span style="color:#f8f8f2">(config.LeaseSeconds))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	election </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> concurrency.</span><span style="color:#8be9fd">NewElection</span><span style="color:#f8f8f2">(session, config.Prefix)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">EctdLeaderElection{</span></span>
<span class="line"><span style="color:#f8f8f2">		LeaderElectionConfig: config,</span></span>
<span class="line"><span style="color:#f8f8f2">		session:              session,</span></span>
<span class="line"><span style="color:#f8f8f2">		election:             election,</span></span>
<span class="line"><span style="color:#f8f8f2">	}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"><span style="color:#6272a4">// 运行选主</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (le </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EctdLeaderElection) </span><span style="color:#50fa7b">Run</span><span style="color:#f8f8f2">(ctx context.Context) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">		le.Callbacks.</span><span style="color:#8be9fd">OnStoppedLeading</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	ctx, cancel </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> context.</span><span style="color:#8be9fd">WithCancel</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">cancel</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 添加选主变化</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> le.</span><span style="color:#8be9fd">observe</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 开始选主</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> le.election.</span><span style="color:#8be9fd">Campaign</span><span style="color:#f8f8f2">(ctx, le.Identity); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 选主完成，运行OnStarted，运行结束则退出选主</span></span>
<span class="line"><span style="color:#f8f8f2">	le.Callbacks.</span><span style="color:#8be9fd">OnStartedLeading</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"><span style="color:#6272a4">// 监听Key变化，执行回调</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (le </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EctdLeaderElection) </span><span style="color:#50fa7b">observe</span><span style="color:#f8f8f2">(ctx context.Context) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> le.Callbacks.OnNewLeader </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	ch </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> le.election.</span><span style="color:#8be9fd">Observe</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">select</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">ctx.</span><span style="color:#8be9fd">Done</span><span style="color:#f8f8f2">():</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> resp, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">ch:</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">ok {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">len</span><span style="color:#f8f8f2">(resp.Kvs) </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">continue</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">			leader </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(resp.Kvs[</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">].Value)</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> leader </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> le.Identity {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> le.Callbacks.</span><span style="color:#8be9fd">OnNewLeader</span><span style="color:#f8f8f2">(leader)</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (le </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EctdLeaderElection) </span><span style="color:#50fa7b">Close</span><span style="color:#f8f8f2">() </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> le.session.</span><span style="color:#8be9fd">Close</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>测试选主服务</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">main</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	client, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> clientv3.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(clientv3.Config{</span></span>
<span class="line"><span style="color:#f8f8f2">		Endpoints:   []</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">{</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">localhost:2379</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">},</span></span>
<span class="line"><span style="color:#f8f8f2">		DialTimeout: </span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2"> time.Second,</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		log.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to create etcd lock: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">Close</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	prefix </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">/worker/election</span><span style="color:#e9f284">"</span></span>
<span class="line"><span style="color:#f8f8f2">	worker </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(i </span><span style="color:#8be9fd">int</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">		id </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Sprintf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">worker-</span><span style="color:#bd93f9">%d</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, i)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		le, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> leaderelection.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(leaderelection.LeaderElectionConfig{</span></span>
<span class="line"><span style="color:#f8f8f2">			Client:       client,</span></span>
<span class="line"><span style="color:#f8f8f2">			LeaseSeconds: </span><span style="color:#bd93f9">15</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">			Prefix:       prefix,</span></span>
<span class="line"><span style="color:#f8f8f2">			Identity:     id,</span></span>
<span class="line"><span style="color:#f8f8f2">			Callbacks: leaderelection.LeaderCallbacks{</span></span>
<span class="line"><span style="color:#f8f8f2">				OnStartedLeading: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(ctx context.Context) {</span></span>
<span class="line"><span style="color:#f8f8f2">					log.</span><span style="color:#8be9fd">Printf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">OnStarted[</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">]: acquire new leader</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id)</span></span>
<span class="line"><span style="color:#f8f8f2">					time.</span><span style="color:#8be9fd">Sleep</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2"> time.Second)</span></span>
<span class="line"><span style="color:#f8f8f2">					log.</span><span style="color:#8be9fd">Printf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">OnStarted[</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">]: worker done</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id)</span></span>
<span class="line"><span style="color:#f8f8f2">				},</span></span>
<span class="line"><span style="color:#f8f8f2">				OnStoppedLeading: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">					log.</span><span style="color:#8be9fd">Printf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">OnStopped[</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">]: exit</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id)</span></span>
<span class="line"><span style="color:#f8f8f2">				},</span></span>
<span class="line"><span style="color:#f8f8f2">				OnNewLeader: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(identity </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">					log.</span><span style="color:#8be9fd">Printf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">OnNewLeader[</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">]: new leader </span><span style="color:#bd93f9">%s</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, id, identity)</span></span>
<span class="line"><span style="color:#f8f8f2">				},</span></span>
<span class="line"><span style="color:#f8f8f2">			},</span></span>
<span class="line"><span style="color:#f8f8f2">		})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			log.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to create leader election: </span><span style="color:#bd93f9">%v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> le.</span><span style="color:#8be9fd">Close</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		le.</span><span style="color:#8be9fd">Run</span><span style="color:#f8f8f2">(context.</span><span style="color:#8be9fd">Background</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	wg </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> sync.WaitGroup{}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> i </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">; i </span><span style="color:#ff79c6">&#x3C;=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2">; i</span><span style="color:#ff79c6">++</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		wg.</span><span style="color:#8be9fd">Add</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		id </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> i</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> wg.</span><span style="color:#8be9fd">Done</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#8be9fd">worker</span><span style="color:#f8f8f2">(id)</span></span>
<span class="line"><span style="color:#f8f8f2">		}()</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	wg.</span><span style="color:#8be9fd">Wait</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>运行结果</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#f8f8f2">2022/08/08 09:33:32 OnNewLeader[worker-2]: new leader worker-3</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:33:32 OnNewLeader[worker-1]: new leader worker-3</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:33:32 OnStarted[worker-3]: acquire new leader</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:34:02 OnStarted[worker-3]: worker </span><span style="color:#ff79c6">done</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:34:02 OnStopped[worker-3]: </span><span style="color:#8be9fd">exit</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:34:02 OnStarted[worker-2]: acquire new leader</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:34:02 OnNewLeader[worker-1]: new leader worker-2</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:34:32 OnStarted[worker-2]: worker </span><span style="color:#ff79c6">done</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:34:32 OnStopped[worker-2]: </span><span style="color:#8be9fd">exit</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:34:32 OnStarted[worker-1]: acquire new leader</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:35:02 OnStarted[worker-1]: worker </span><span style="color:#ff79c6">done</span></span>
<span class="line"><span style="color:#f8f8f2">2022/08/08 09:35:02 OnStopped[worker-1]: </span><span style="color:#8be9fd">exit</span></span></code></pre><h2 id="发布订阅">发布订阅</h2><p>借助 etcd 的前缀查找、Watch 的功能，可以实现发布订阅功能，主要逻辑如下</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto"><code><span class="line"><span style="color:#6272a4">// 发布时，直接通过Put将对象设置在对应Topic路径下，并可以设置Lease，自动删除过时消息</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (ps </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EtcdPubSub) </span><span style="color:#50fa7b">Publish</span><span style="color:#f8f8f2">(ctx context.Context, topic </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">, msg Msg) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	le, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ps.Client.Lease.</span><span style="color:#8be9fd">Grant</span><span style="color:#f8f8f2">(ctx, </span><span style="color:#8be9fd">int64</span><span style="color:#f8f8f2">(ps.TTLSeconds))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	_, err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> ps.Client.</span><span style="color:#8be9fd">Put</span><span style="color:#f8f8f2">(ctx, ps.Prefix</span><span style="color:#ff79c6">+</span><span style="color:#f8f8f2">topic</span><span style="color:#ff79c6">+</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">/</span><span style="color:#e9f284">"</span><span style="color:#ff79c6">+</span><span style="color:#f8f8f2">msg.Name, msg.Val, clientv3.</span><span style="color:#8be9fd">WithLease</span><span style="color:#f8f8f2">(le.ID))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// 订阅时，通过Watch来监听Topic是否有Put事件，这里忽略Delete事件</span></span>
<span class="line"><span style="color:#6272a4">// Revision为0时，从当前时间点开始监听</span></span>
<span class="line"><span style="color:#6272a4">// Revision为1时，监听Topic创建后的所有事件</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (ps </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EtcdPubSub) </span><span style="color:#50fa7b">SubscribeFromRev</span><span style="color:#f8f8f2">(ctx context.Context, topic </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">, rev </span><span style="color:#8be9fd">int64</span><span style="color:#f8f8f2">) (</span><span style="color:#ff79c6">&#x3C;-chan</span><span style="color:#f8f8f2"> Msg, </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	wch </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ps.Client.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(ctx, ps.Prefix</span><span style="color:#ff79c6">+</span><span style="color:#f8f8f2">topic, clientv3.</span><span style="color:#8be9fd">WithPrefix</span><span style="color:#f8f8f2">(), clientv3.</span><span style="color:#8be9fd">WithFilterDelete</span><span style="color:#f8f8f2">(), clientv3.</span><span style="color:#8be9fd">WithRev</span><span style="color:#f8f8f2">(rev))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	msg </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">chan</span><span style="color:#f8f8f2"> Msg)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">close</span><span style="color:#f8f8f2">(msg)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			wc, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">wch</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">ok {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, ev </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> wc.Events {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> ev.Type </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> mvccpb.PUT {</span></span>
<span class="line"><span style="color:#f8f8f2">					</span><span style="color:#ff79c6">break</span></span>
<span class="line"><span style="color:#f8f8f2">				}</span></span>
<span class="line"><span style="color:#f8f8f2">				name </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> strings.</span><span style="color:#8be9fd">TrimPrefix</span><span style="color:#f8f8f2">(</span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(ev.Kv.Key), ps.Prefix</span><span style="color:#ff79c6">+</span><span style="color:#f8f8f2">topic</span><span style="color:#ff79c6">+</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">/</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">				msg </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2"> Msg{Name: name, Val: </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2">(ev.Kv.Value)}</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> msg, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>发布时，直接通过 PUT 操作在 Topic 路径下设置消息； 订阅时，通过 Watch 来捕获消息，通过 Revision 来配置不同的监听行为</p><ul><li>Revision 为 0 时，从当前时间点开始监听</li><li>Revision 为 1 时，监听 Topic 创建后的所有事件</li></ul><h2 id="总结">总结</h2><p>本文主要结合 Golang 总结了 etcd 中服务发现、分布式锁、选主等实现方式，另外 etcd 还可以应用在发布订阅、负载均衡等方面。</p><p>本文所有代码见<a href="https://github.com/qingwave/gocorex">https://github.com/qingwave/gocorex</a>，欢迎批评指正。</p><blockquote><p>Explore more in <a href="https://qingwave.github.io">https://qingwave.github.io</a></p></blockquote></div></div><div class="flex flex-col justify-between max-w-3xl mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class="mr-5"><li class="rounded-lg bg-gray-100 dark:bg-slate-700 font-medium inline-block mx-1 my-1 px-2 py-1"><a href="/tags/etcd" class="dark:text-slate-300 dark:hover:text-gray-200 hover:text-primary text-muted">#etcd</a></li><li class="rounded-lg bg-gray-100 dark:bg-slate-700 font-medium inline-block mx-1 my-1 px-2 py-1"><a href="/tags/golang" class="dark:text-slate-300 dark:hover:text-gray-200 hover:text-primary text-muted">#golang</a></li><li class="rounded-lg bg-gray-100 dark:bg-slate-700 font-medium inline-block mx-1 my-1 px-2 py-1"><a href="/tags/分布式" class="dark:text-slate-300 dark:hover:text-gray-200 hover:text-primary text-muted">#分布式</a></li></ul></div></article><div class="max-w-3xl mx-auto sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script async src="https://giscus.app/client.js" crossorigin="anonymous" data-category="Announcements" data-category-id="DIC_kwDOCg97r84CBQfL" data-emit-metadata="0" data-input-position="top" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="qingwave/qingwave.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict="0" data-theme="light"></script></div></section></main><footer class="relative"><div class="max-w-3xl mx-auto sm:px-6 px-4"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden="true"></div><div class="max-w-3xl mx-auto sm:px-6 px-4 dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href="/rss.xml" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label="RSS"><svg astro-icon="tabler:rss" class="h-5 w-5" viewBox="0 0 24 24"><g class="icon-tabler" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href="https://qingwave.github.io" class="hover:brightness-50">Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function a(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:"dark"===localStorage.theme?"dark":"light"}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),a=encodeURIComponent(t.getAttribute("data-aw-text"));let c;switch(o){case"facebook":c=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":c=`https://twitter.com/intent/tweet?url=${n}&text=${a}`;break;case"linkedin":c=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${a}`;break;case"whatsapp":c=`https://wa.me/?text=${a}%20${n}`;break;case"mail":c=`mailto:?subject=%22${a}%22&body=${a}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=c,s.click()})),a(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{a()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>