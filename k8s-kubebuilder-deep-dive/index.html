<!DOCTYPE html><html class="2xl:text-[20px]" dir="ltr" lang="zh"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>深入了解kubebuilder</title><meta content="index,follow" name="robots"/><meta content="深入了解kubebuilder" property="og:title"/><meta content="https://qingwave.github.io/k8s-kubebuilder-deep-dive" property="og:url"/><meta content="article" property="og:type"/><link href="https://qingwave.github.io/k8s-kubebuilder-deep-dive" rel="canonical"/><style is:global>:root{--aw-font-sans:'InterVariable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" name="google-site-verification"><script src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async type="text/partytown"></script><script type="text/partytown">(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href="/favicon.ico" rel="shortcut icon"><link href="/favicon.svg" rel="icon" type="image/svg+xml"><link href="/favicon.svg" rel="mask-icon" color="#8D46E7"><link href="/sitemap-index.xml" rel="sitemap"><link href="/_astro/404.78bd7817.css" rel="stylesheet"/><link href="/_astro/_...page_.18cbe2bf.css" rel="stylesheet"/><script src="/_astro/hoisted.69f8e884.js" type="module"></script><script>!function(t,e,n,i){(i=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(i[n]||[]).concat(["dataLayer.push"])}(window,"partytown","forward"),function(t,e,n,i,a,o,r,d,s,c,p,l){function u(){l||(l=1,"/"==(r=(o.lib||"/~partytown/")+(o.debug?"debug/":""))[0]&&(s=e.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(f,1e4),e.addEventListener("pt0",h),a?w(1):n.serviceWorker?n.serviceWorker.register(r+(o.swPath||"partytown-sw.js"),{scope:r}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):f())))}function w(t){c=e.createElement(t?"script":"iframe"),t||(c.setAttribute("style","display:block;width:0;height:0;border:0;visibility:hidden"),c.setAttribute("aria-hidden",!0)),c.src=r+"partytown-"+(t?"atomics.js?v=0.7.6":"sandbox-sw.html?"+Date.now()),e.body.appendChild(c)}function f(n,a){for(h(),i==t&&(o.forward||[]).map((function(e){delete t[e.split(".")[0]]})),n=0;n<s.length;n++)(a=e.createElement("script")).innerHTML=s[n].innerHTML,e.head.appendChild(a);c&&c.parentNode.removeChild(c)}function h(){clearTimeout(d)}o=t.partytown||{},i==t&&(o.forward||[]).map((function(e){p=t,e.split(".").map((function(e,n,i){p=p[i[n]]=n+1<i.length?"push"==i[n+1]?[]:p[i[n]]||{}:function(){(t._ptf=t._ptf||[]).push(i,arguments)}}))})),"complete"==e.readyState?u():(t.addEventListener("DOMContentLoaded",u),t.addEventListener("load",u))}(window,document,navigator,top,window.crossOriginIsolated)</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id="header"><div class="max-w-3xl mx-auto sm:px-6 px-6 md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href="/" class="items-center flex"><img src="/favicon.svg" class="h-6 w-6 dark:invert invert-0"></a><div class="items-center flex md:hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type="button" data-aw-toggle-color-scheme><svg astro-icon="ph:moon-fill" class="h-8 w-8" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill="currentColor"/></svg></button> <button aria-label="Toggle Menu" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:focus:ring-gray-700 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 ml-1.5 rounded-lg text-gray-500 transition" type="button" data-aw-toggle-menu><svg astro-icon="tabler:menu" class="h-6 w-6" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g class="icon-tabler" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 8h16"/><path d="M4 16h16"/></g></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 text-xl w-full"><li class=""><a href="/blog" class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>写作</a></li><li class=""><a href="/project" class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>项目</a></li><li class=""><a href="/tags" class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>标签</a></li><li class=""><a href="/about" class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type="button" data-aw-toggle-color-scheme><svg astro-icon="ph:moon-fill" class="h-6 w-6" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill="currentColor"/></svg></button></div></div></div></header><main><section class="max-w-3xl mx-auto lg:py-20 py-8 sm:py-16"><article><header class=""><div class="flex px-4 flex-col justify-between max-w-3xl mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Mon Aug 23 2021 00:25:53 GMT+0000 (Coordinated Universal Time)">Aug 23, 2021</time> · <a href="/categories/cloud" class="capitalize hover:underline">cloud</a></p></div><h1 class="max-w-3xl mx-auto sm:px-6 px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">深入了解kubebuilder</h1><p class="max-w-3xl mx-auto sm:px-6 px-4 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="max-w-3xl mx-auto sm:px-6 px-4"><div class="border-t dark:border-slate-700"></div></div></header><div class="max-w-3xl mx-auto sm:px-6 px-6 mt-8 break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert lg:prose-xl overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-lg prose-md"><div class="table-wrap"><p>前文<a href="./how-to-write-a-k8s-operator">快速实现一个 Kubernetes Operator</a>介绍了<code>kubebuilder</code>工具，快速实现了一个<code>Operator</code>。今天我们深入水下，探寻<code>kubebuilder</code>究竟是如何工作的。</p><h2 id="普通开发流程">普通开发流程</h2><p>如果不借助任何<code>Operator</code>脚手架，我们是如何实现<code>Operator</code>的？大体分为一下几步：</p><ul><li>CRD 定义</li><li>Controller 开发，编写逻辑</li><li>测试部署</li></ul><h3 id="api-定义">API 定义</h3><p>首先通过<a href="https://github.com/kubernetes/code-generator">k8s.io/code-generator</a>项目生成 API 相关代码，定义相关字段。</p><h3 id="controller-实现">Controller 实现</h3><p>实现 Controller 以官方提供的<a href="https://github.com/kubernetes/sample-controller">sample-controller</a>为例，如图所示 <img src="https://github.com/kubernetes/sample-controller/raw/master/docs/images/client-go-controller-interaction.jpeg" alt="custom-controller"></p><p>主要分为以下几步：</p><p>初始化<code>client</code>配置</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">//通过master/kubeconfig建立client config</span></span>
<span class="line"><span style="color:#f8f8f2">  cfg, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> clientcmd.</span><span style="color:#8be9fd">BuildConfigFromFlags</span><span style="color:#f8f8f2">(masterURL, kubeconfig)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		klog.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Error building kubeconfig: </span><span style="color:#bd93f9">%s</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// kubernetes client</span></span>
<span class="line"><span style="color:#f8f8f2">	kubeClient, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> kubernetes.</span><span style="color:#8be9fd">NewForConfig</span><span style="color:#f8f8f2">(cfg)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		klog.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Error building kubernetes clientset: </span><span style="color:#bd93f9">%s</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// crd client</span></span>
<span class="line"><span style="color:#f8f8f2">	exampleClient, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> clientset.</span><span style="color:#8be9fd">NewForConfig</span><span style="color:#f8f8f2">(cfg)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		klog.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Error building example clientset: </span><span style="color:#bd93f9">%s</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span></code></pre><p>初始化 Informer 并启动</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">//k8s sharedInformer</span></span>
<span class="line"><span style="color:#f8f8f2">  kubeInformerFactory </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> kubeinformers.</span><span style="color:#8be9fd">NewSharedInformerFactory</span><span style="color:#f8f8f2">(kubeClient, time.Second</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">30</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// crd sharedInformer</span></span>
<span class="line"><span style="color:#f8f8f2">	exampleInformerFactory </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> informers.</span><span style="color:#8be9fd">NewSharedInformerFactory</span><span style="color:#f8f8f2">(exampleClient, time.Second</span><span style="color:#ff79c6">*</span><span style="color:#bd93f9">30</span><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// 初始化controller，传入informer, 注册了Deployment与Foo Informers</span></span>
<span class="line"><span style="color:#f8f8f2">	controller </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">NewController</span><span style="color:#f8f8f2">(kubeClient, exampleClient,</span></span>
<span class="line"><span style="color:#f8f8f2">		kubeInformerFactory.</span><span style="color:#8be9fd">Apps</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">V1</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">Deployments</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">		exampleInformerFactory.</span><span style="color:#8be9fd">Samplecontroller</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">V1alpha1</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">Foos</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">//启动Informer</span></span>
<span class="line"><span style="color:#f8f8f2">	kubeInformerFactory.</span><span style="color:#8be9fd">Start</span><span style="color:#f8f8f2">(stopCh)</span></span>
<span class="line"><span style="color:#f8f8f2">	exampleInformerFactory.</span><span style="color:#8be9fd">Start</span><span style="color:#f8f8f2">(stopCh)</span></span></code></pre><p>最后启动<code>Controller</code></p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f8f8f2">  </span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> controller.</span><span style="color:#8be9fd">Run</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">2</span><span style="color:#f8f8f2">, stopCh); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		klog.</span><span style="color:#8be9fd">Fatalf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Error running controller: </span><span style="color:#bd93f9">%s</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span></code></pre><p>在<code>Controller</code>的实现中，通过<code>NewController</code>来初始化：</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">NewController</span><span style="color:#f8f8f2">(</span></span>
<span class="line"><span style="color:#f8f8f2">	kubeclientset kubernetes.Interface,</span></span>
<span class="line"><span style="color:#f8f8f2">	sampleclientset clientset.Interface,</span></span>
<span class="line"><span style="color:#f8f8f2">	deploymentInformer appsinformers.DeploymentInformer,</span></span>
<span class="line"><span style="color:#f8f8f2">	fooInformer informers.FooInformer) </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Create event broadcaster</span></span>
<span class="line"><span style="color:#f8f8f2">	utilruntime.</span><span style="color:#8be9fd">Must</span><span style="color:#f8f8f2">(samplescheme.</span><span style="color:#8be9fd">AddToScheme</span><span style="color:#f8f8f2">(scheme.Scheme))</span></span>
<span class="line"><span style="color:#f8f8f2">	klog.</span><span style="color:#8be9fd">V</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">4</span><span style="color:#f8f8f2">).</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Creating event broadcaster</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	eventBroadcaster </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> record.</span><span style="color:#8be9fd">NewBroadcaster</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	eventBroadcaster.</span><span style="color:#8be9fd">StartStructuredLogging</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	eventBroadcaster.</span><span style="color:#8be9fd">StartRecordingToSink</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">typedcorev1.EventSinkImpl{Interface: kubeclientset.</span><span style="color:#8be9fd">CoreV1</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">Events</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">""</span><span style="color:#f8f8f2">)})</span></span>
<span class="line"><span style="color:#f8f8f2">	recorder </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> eventBroadcaster.</span><span style="color:#8be9fd">NewRecorder</span><span style="color:#f8f8f2">(scheme.Scheme, corev1.EventSource{Component: controllerAgentName})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	controller </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">Controller{</span></span>
<span class="line"><span style="color:#f8f8f2">		kubeclientset:     kubeclientset,</span></span>
<span class="line"><span style="color:#f8f8f2">		sampleclientset:   sampleclientset,</span></span>
<span class="line"><span style="color:#f8f8f2">		deploymentsLister: deploymentInformer.</span><span style="color:#8be9fd">Lister</span><span style="color:#f8f8f2">(), </span><span style="color:#6272a4">//只读cache</span></span>
<span class="line"><span style="color:#f8f8f2">		deploymentsSynced: deploymentInformer.</span><span style="color:#8be9fd">Informer</span><span style="color:#f8f8f2">().HasSynced, </span><span style="color:#6272a4">//调用Informer()会注册informer到共享informer中</span></span>
<span class="line"><span style="color:#f8f8f2">		foosLister:        fooInformer.</span><span style="color:#8be9fd">Lister</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">		foosSynced:        fooInformer.</span><span style="color:#8be9fd">Informer</span><span style="color:#f8f8f2">().HasSynced,</span></span>
<span class="line"><span style="color:#f8f8f2">		workqueue:         workqueue.</span><span style="color:#8be9fd">NewNamedRateLimitingQueue</span><span style="color:#f8f8f2">(workqueue.</span><span style="color:#8be9fd">DefaultControllerRateLimiter</span><span style="color:#f8f8f2">(), </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Foos</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">), </span><span style="color:#6272a4">// 初始化工作队列</span></span>
<span class="line"><span style="color:#f8f8f2">		recorder:          recorder,</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	klog.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Setting up event handlers</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 添加回调事件</span></span>
<span class="line"><span style="color:#f8f8f2">	fooInformer.</span><span style="color:#8be9fd">Informer</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">AddEventHandler</span><span style="color:#f8f8f2">(cache.ResourceEventHandlerFuncs{</span></span>
<span class="line"><span style="color:#f8f8f2">		AddFunc: controller.enqueueFoo,</span></span>
<span class="line"><span style="color:#f8f8f2">		UpdateFunc: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(old, new </span><span style="color:#ff79c6">interface</span><span style="color:#f8f8f2">{}) {</span></span>
<span class="line"><span style="color:#f8f8f2">			controller.</span><span style="color:#8be9fd">enqueueFoo</span><span style="color:#f8f8f2">(new)</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	deploymentInformer.</span><span style="color:#8be9fd">Informer</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">AddEventHandler</span><span style="color:#f8f8f2">(cache.ResourceEventHandlerFuncs{</span></span>
<span class="line"><span style="color:#f8f8f2">		AddFunc: controller.handleObject,</span></span>
<span class="line"><span style="color:#f8f8f2">		UpdateFunc: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(old, new </span><span style="color:#ff79c6">interface</span><span style="color:#f8f8f2">{}) {</span></span>
<span class="line"><span style="color:#f8f8f2">			newDepl </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> new.(</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">appsv1.Deployment)</span></span>
<span class="line"><span style="color:#f8f8f2">			oldDepl </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> old.(</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">appsv1.Deployment)</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> newDepl.ResourceVersion </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> oldDepl.ResourceVersion {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#6272a4">// Periodic resync will send update events for all known Deployments.</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#6272a4">// Two different versions of the same Deployment will always have different RVs.</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">			controller.</span><span style="color:#8be9fd">handleObject</span><span style="color:#f8f8f2">(new)</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">		DeleteFunc: controller.handleObject,</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> controller</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>Controller</code>启动则是典型的 k8s 工作流，通过控制循环不断从工作队列获取对象进行处理，使其达到期望状态</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (c </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller) </span><span style="color:#50fa7b">Run</span><span style="color:#f8f8f2">(workers </span><span style="color:#8be9fd;font-style:italic">int</span><span style="color:#f8f8f2">, stopCh </span><span style="color:#ff79c6">&#x3C;-chan</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> utilruntime.</span><span style="color:#8be9fd">HandleCrash</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> c.workqueue.</span><span style="color:#8be9fd">ShutDown</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 等待cache同步</span></span>
<span class="line"><span style="color:#f8f8f2">	klog.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Waiting for informer caches to sync</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> cache.</span><span style="color:#8be9fd">WaitForCacheSync</span><span style="color:#f8f8f2">(stopCh, c.deploymentsSynced, c.foosSynced); </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">ok {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to wait for caches to sync</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 启动worker,每个worker一个goroutine</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> i </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">; i </span><span style="color:#ff79c6">&#x3C;</span><span style="color:#f8f8f2"> workers; i</span><span style="color:#ff79c6">++</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> wait.</span><span style="color:#8be9fd">Until</span><span style="color:#f8f8f2">(c.runWorker, time.Second, stopCh)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// 等待退出信号</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">stopCh</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// worker就是一个循环不断调用processNextWorkItem</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (c </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller) </span><span style="color:#50fa7b">runWorker</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">processNextWorkItem</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (c </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller) </span><span style="color:#50fa7b">processNextWorkItem</span><span style="color:#f8f8f2">() </span><span style="color:#8be9fd;font-style:italic">bool</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 从工作队列获取对象</span></span>
<span class="line"><span style="color:#f8f8f2">	obj, shutdown </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.workqueue.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> shutdown {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">false</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// We wrap this block in a func so we can defer c.workqueue.Done.</span></span>
<span class="line"><span style="color:#f8f8f2">	err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(obj </span><span style="color:#ff79c6">interface</span><span style="color:#f8f8f2">{}) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> c.workqueue.</span><span style="color:#8be9fd">Done</span><span style="color:#f8f8f2">(obj)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">var</span><span style="color:#f8f8f2"> key </span><span style="color:#8be9fd;font-style:italic">string</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">var</span><span style="color:#f8f8f2"> ok </span><span style="color:#8be9fd;font-style:italic">bool</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> key, ok </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> obj.(</span><span style="color:#8be9fd;font-style:italic">string</span><span style="color:#f8f8f2">); </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">ok {</span></span>
<span class="line"><span style="color:#f8f8f2">			c.workqueue.</span><span style="color:#8be9fd">Forget</span><span style="color:#f8f8f2">(obj)</span></span>
<span class="line"><span style="color:#f8f8f2">			utilruntime.</span><span style="color:#8be9fd">HandleError</span><span style="color:#f8f8f2">(fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">expected string in workqueue but got </span><span style="color:#bd93f9">%#v</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, obj))</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#6272a4">// 进行处理，核心逻辑</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">syncHandler</span><span style="color:#f8f8f2">(key); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#6272a4">// 处理失败再次加入队列</span></span>
<span class="line"><span style="color:#f8f8f2">			c.workqueue.</span><span style="color:#8be9fd">AddRateLimited</span><span style="color:#f8f8f2">(key)</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">error syncing '</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">': </span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">, requeuing</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, key, err.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#6272a4">// 处理成功不入队</span></span>
<span class="line"><span style="color:#f8f8f2">		c.workqueue.</span><span style="color:#8be9fd">Forget</span><span style="color:#f8f8f2">(obj)</span></span>
<span class="line"><span style="color:#f8f8f2">		klog.</span><span style="color:#8be9fd">Infof</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Successfully synced '</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">'</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, key)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">	}(obj)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		utilruntime.</span><span style="color:#8be9fd">HandleError</span><span style="color:#f8f8f2">(err)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">true</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">true</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><h2 id="operator-模式">Operator 模式</h2><p>在<code>Operator</code>模式下，用户只需要实现<code>Reconcile</code>(调谐)即<code>sample-controller</code>中的<code>syncHandler</code>，其他步骤<code>kubebuilder</code>已经帮我们实现了。那我们来一探究竟，<code>kubebuilder</code>是怎么一步步触发<code>Reconcile</code>逻辑。</p><p>以<a href="https://github.com/qingwave/mygame">mygame</a>为例，通常使用<code>kubebuilder</code>生成的主文件如下：</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">var</span><span style="color:#f8f8f2"> (</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 用来解析kubernetes对象</span></span>
<span class="line"><span style="color:#f8f8f2">	scheme   </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> runtime.</span><span style="color:#8be9fd">NewScheme</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	setupLog </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> ctrl.Log.</span><span style="color:#8be9fd">WithName</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">setup</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">init</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	utilruntime.</span><span style="color:#8be9fd">Must</span><span style="color:#f8f8f2">(clientgoscheme.</span><span style="color:#8be9fd">AddToScheme</span><span style="color:#f8f8f2">(scheme))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 添加自定义对象到scheme</span></span>
<span class="line"><span style="color:#f8f8f2">	utilruntime.</span><span style="color:#8be9fd">Must</span><span style="color:#f8f8f2">(myappv1.</span><span style="color:#8be9fd">AddToScheme</span><span style="color:#f8f8f2">(scheme))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//+kubebuilder:scaffold:scheme</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">main</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// ...</span></span>
<span class="line"><span style="color:#f8f8f2">	ctrl.</span><span style="color:#8be9fd">SetLogger</span><span style="color:#f8f8f2">(zap.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(zap.</span><span style="color:#8be9fd">UseFlagOptions</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">opts)))</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 初始化controller manager</span></span>
<span class="line"><span style="color:#f8f8f2">	mgr, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ctrl.</span><span style="color:#8be9fd">NewManager</span><span style="color:#f8f8f2">(ctrl.</span><span style="color:#8be9fd">GetConfigOrDie</span><span style="color:#f8f8f2">(), ctrl.Options{</span></span>
<span class="line"><span style="color:#f8f8f2">		Scheme:                 scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">		MetricsBindAddress:     metricsAddr,</span></span>
<span class="line"><span style="color:#f8f8f2">		Port:                   </span><span style="color:#bd93f9">9443</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">		HealthProbeBindAddress: probeAddr,</span></span>
<span class="line"><span style="color:#f8f8f2">		LeaderElection:         enableLeaderElection,</span></span>
<span class="line"><span style="color:#f8f8f2">		LeaderElectionID:       </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">7bc453ad.qingwave.github.io</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		setupLog.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">unable to start manager</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		os.</span><span style="color:#8be9fd">Exit</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 初始化Reconciler</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> (</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">controllers.GameReconciler{</span></span>
<span class="line"><span style="color:#f8f8f2">		Client: mgr.</span><span style="color:#8be9fd">GetClient</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">		Scheme: mgr.</span><span style="color:#8be9fd">GetScheme</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">	}).</span><span style="color:#8be9fd">SetupWithManager</span><span style="color:#f8f8f2">(mgr); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		setupLog.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">unable to create controller</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">controller</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Game</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		os.</span><span style="color:#8be9fd">Exit</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 初始化Webhook</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> enableWebhook {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> (</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">myappv1.Game{}).</span><span style="color:#8be9fd">SetupWebhookWithManager</span><span style="color:#f8f8f2">(mgr); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			setupLog.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">unable to create webhook</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">webhook</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Game</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">			os.</span><span style="color:#8be9fd">Exit</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//+kubebuilder:scaffold:builder</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 启动manager</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> mgr.</span><span style="color:#8be9fd">Start</span><span style="color:#f8f8f2">(ctrl.</span><span style="color:#8be9fd">SetupSignalHandler</span><span style="color:#f8f8f2">()); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		setupLog.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">problem running manager</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		os.</span><span style="color:#8be9fd">Exit</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>kubebuilder</code>封装了<code>controller-runtime</code>，在主文件中主要初始了<code>controller-manager</code>,以及我们填充的<code>Reconciler</code>与<code>Webhook</code>，最后启动<code>manager</code>。</p><p>分别来看下每个流程。</p><h3 id="manager-初始化">Manager 初始化</h3><p>代码如下：</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">New</span><span style="color:#f8f8f2">(config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config, options Options) (Manager, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 设置默认配置</span></span>
<span class="line"><span style="color:#f8f8f2">	options </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">setOptionsDefaults</span><span style="color:#f8f8f2">(options)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// cluster初始化</span></span>
<span class="line"><span style="color:#f8f8f2">	cluster, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> cluster.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(config, </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(clusterOptions </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">cluster.Options) {</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.Scheme </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.Scheme</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.MapperProvider </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.MapperProvider</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.Logger </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.Logger</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.SyncPeriod </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.SyncPeriod</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.Namespace </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.Namespace</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.NewCache </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.NewCache</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.ClientBuilder </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.ClientBuilder</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.ClientDisableCacheFor </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.ClientDisableCacheFor</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.DryRunClient </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.DryRunClient</span></span>
<span class="line"><span style="color:#f8f8f2">		clusterOptions.EventBroadcaster </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> options.EventBroadcaster</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// event recorder初始化</span></span>
<span class="line"><span style="color:#f8f8f2">	recorderProvider, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.</span><span style="color:#8be9fd">newRecorderProvider</span><span style="color:#f8f8f2">(config, cluster.</span><span style="color:#8be9fd">GetScheme</span><span style="color:#f8f8f2">(), options.Logger.</span><span style="color:#8be9fd">WithName</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">events</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">), options.makeBroadcaster)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 选主的资源锁配置</span></span>
<span class="line"><span style="color:#f8f8f2">	leaderConfig </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.LeaderElectionConfig</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> leaderConfig </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		leaderConfig </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> rest.</span><span style="color:#8be9fd">CopyConfig</span><span style="color:#f8f8f2">(config)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	resourceLock, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.</span><span style="color:#8be9fd">newResourceLock</span><span style="color:#f8f8f2">(leaderConfig, recorderProvider, leaderelection.Options{</span></span>
<span class="line"><span style="color:#f8f8f2">		LeaderElection:             options.LeaderElection,</span></span>
<span class="line"><span style="color:#f8f8f2">		LeaderElectionResourceLock: options.LeaderElectionResourceLock,</span></span>
<span class="line"><span style="color:#f8f8f2">		LeaderElectionID:           options.LeaderElectionID,</span></span>
<span class="line"><span style="color:#f8f8f2">		LeaderElectionNamespace:    options.LeaderElectionNamespace,</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">controllerManager{</span></span>
<span class="line"><span style="color:#f8f8f2">		cluster:                 cluster,</span></span>
<span class="line"><span style="color:#f8f8f2">		recorderProvider:        recorderProvider,</span></span>
<span class="line"><span style="color:#f8f8f2">		resourceLock:            resourceLock,</span></span>
<span class="line"><span style="color:#f8f8f2">		metricsListener:         metricsListener,</span></span>
<span class="line"><span style="color:#f8f8f2">		metricsExtraHandlers:    metricsExtraHandlers,</span></span>
<span class="line"><span style="color:#f8f8f2">		logger:                  options.Logger,</span></span>
<span class="line"><span style="color:#f8f8f2">		elected:                 </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">chan</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}),</span></span>
<span class="line"><span style="color:#f8f8f2">		port:                    options.Port,</span></span>
<span class="line"><span style="color:#f8f8f2">		host:                    options.Host,</span></span>
<span class="line"><span style="color:#f8f8f2">		certDir:                 options.CertDir,</span></span>
<span class="line"><span style="color:#f8f8f2">		leaseDuration:           </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">options.LeaseDuration,</span></span>
<span class="line"><span style="color:#f8f8f2">		renewDeadline:           </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">options.RenewDeadline,</span></span>
<span class="line"><span style="color:#f8f8f2">		retryPeriod:             </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">options.RetryPeriod,</span></span>
<span class="line"><span style="color:#f8f8f2">		healthProbeListener:     healthProbeListener,</span></span>
<span class="line"><span style="color:#f8f8f2">		readinessEndpointName:   options.ReadinessEndpointName,</span></span>
<span class="line"><span style="color:#f8f8f2">		livenessEndpointName:    options.LivenessEndpointName,</span></span>
<span class="line"><span style="color:#f8f8f2">		gracefulShutdownTimeout: </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">options.GracefulShutdownTimeout,</span></span>
<span class="line"><span style="color:#f8f8f2">		internalProceduresStop:  </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">chan</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}),</span></span>
<span class="line"><span style="color:#f8f8f2">		leaderElectionStopped:   </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">chan</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}),</span></span>
<span class="line"><span style="color:#f8f8f2">	}, </span><span style="color:#bd93f9">nil</span></span></code></pre><p>在<code>New</code>中主要初始化了各种配置端口、选主信息、<code>eventRecorder</code>，最重要的是初始了<code>Cluster</code>。<code>Cluster</code>用来访问 k8s，初始化代码如下：</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#6272a4">// New constructs a brand new cluster</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">New</span><span style="color:#f8f8f2">(config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config, opts </span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">Option) (Cluster, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> config </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, errors.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">must specify Config</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	options </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> Options{}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, opt </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> opts {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">opt</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">options)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	options </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">setOptionsDefaults</span><span style="color:#f8f8f2">(options)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Create the mapper provider</span></span>
<span class="line"><span style="color:#f8f8f2">	mapper, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.</span><span style="color:#8be9fd">MapperProvider</span><span style="color:#f8f8f2">(config)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		options.Logger.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Failed to get API Group-Resources</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Create the cache for the cached read client and registering informers</span></span>
<span class="line"><span style="color:#f8f8f2">	cache, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.</span><span style="color:#8be9fd">NewCache</span><span style="color:#f8f8f2">(config, cache.Options{Scheme: options.Scheme, Mapper: mapper, Resync: options.SyncPeriod, Namespace: options.Namespace})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	clientOptions </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.Options{Scheme: options.Scheme, Mapper: mapper}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	apiReader, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(config, clientOptions)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	writeObj, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.ClientBuilder.</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">WithUncached</span><span style="color:#f8f8f2">(options.ClientDisableCacheFor</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">).</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">Build</span><span style="color:#f8f8f2">(cache, config, clientOptions)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.DryRunClient {</span></span>
<span class="line"><span style="color:#f8f8f2">		writeObj </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">NewDryRunClient</span><span style="color:#f8f8f2">(writeObj)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	recorderProvider, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.</span><span style="color:#8be9fd">newRecorderProvider</span><span style="color:#f8f8f2">(config, options.Scheme, options.Logger.</span><span style="color:#8be9fd">WithName</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">events</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">), options.makeBroadcaster)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">cluster{</span></span>
<span class="line"><span style="color:#f8f8f2">		config:           config,</span></span>
<span class="line"><span style="color:#f8f8f2">		scheme:           options.Scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">		cache:            cache,</span></span>
<span class="line"><span style="color:#f8f8f2">		fieldIndexes:     cache,</span></span>
<span class="line"><span style="color:#f8f8f2">		client:           writeObj,</span></span>
<span class="line"><span style="color:#f8f8f2">		apiReader:        apiReader,</span></span>
<span class="line"><span style="color:#f8f8f2">		recorderProvider: recorderProvider,</span></span>
<span class="line"><span style="color:#f8f8f2">		mapper:           mapper,</span></span>
<span class="line"><span style="color:#f8f8f2">		logger:           options.Logger,</span></span>
<span class="line"><span style="color:#f8f8f2">	}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>这里主要创建了<code>cache</code>与读写<code>client</code></p><h3 id="cache-初始化">Cache 初始化</h3><p>创建<code>cache</code>代码：</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#6272a4">// New initializes and returns a new Cache.</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">New</span><span style="color:#f8f8f2">(config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config, opts Options) (Cache, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	opts, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">defaultOpts</span><span style="color:#f8f8f2">(config, opts)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	im </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> internal.</span><span style="color:#8be9fd">NewInformersMap</span><span style="color:#f8f8f2">(config, opts.Scheme, opts.Mapper, </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">opts.Resync, opts.Namespace)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">informerCache{InformersMap: im}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>New</code>中调用了<code>NewInformersMap</code>来创建<code>infermer map</code>，分为<code>structured</code>、<code>unstructured</code>与<code>metadata</code></p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">NewInformersMap</span><span style="color:#f8f8f2">(config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config,</span></span>
<span class="line"><span style="color:#f8f8f2">	scheme </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">runtime.Scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">	mapper meta.RESTMapper,</span></span>
<span class="line"><span style="color:#f8f8f2">	resync time.Duration,</span></span>
<span class="line"><span style="color:#f8f8f2">	namespace </span><span style="color:#8be9fd;font-style:italic">string</span><span style="color:#f8f8f2">) </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">InformersMap {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">InformersMap{</span></span>
<span class="line"><span style="color:#f8f8f2">		structured:   </span><span style="color:#8be9fd">newStructuredInformersMap</span><span style="color:#f8f8f2">(config, scheme, mapper, resync, namespace),</span></span>
<span class="line"><span style="color:#f8f8f2">		unstructured: </span><span style="color:#8be9fd">newUnstructuredInformersMap</span><span style="color:#f8f8f2">(config, scheme, mapper, resync, namespace),</span></span>
<span class="line"><span style="color:#f8f8f2">		metadata:     </span><span style="color:#8be9fd">newMetadataInformersMap</span><span style="color:#f8f8f2">(config, scheme, mapper, resync, namespace),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		Scheme: scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>最终都是调用<code>newSpecificInformersMap</code></p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#6272a4">// newStructuredInformersMap creates a new InformersMap for structured objects.</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">newStructuredInformersMap</span><span style="color:#f8f8f2">(config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config, scheme </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">runtime.Scheme, mapper meta.RESTMapper, resync time.Duration, namespace </span><span style="color:#8be9fd;font-style:italic">string</span><span style="color:#f8f8f2">) </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">specificInformersMap {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">newSpecificInformersMap</span><span style="color:#f8f8f2">(config, scheme, mapper, resync, namespace, createStructuredListWatch)</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">newSpecificInformersMap</span><span style="color:#f8f8f2">(config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config,</span></span>
<span class="line"><span style="color:#f8f8f2">	scheme </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">runtime.Scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">	mapper meta.RESTMapper,</span></span>
<span class="line"><span style="color:#f8f8f2">	resync time.Duration,</span></span>
<span class="line"><span style="color:#f8f8f2">	namespace </span><span style="color:#8be9fd;font-style:italic">string</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">	createListWatcher createListWatcherFunc) </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">specificInformersMap {</span></span>
<span class="line"><span style="color:#f8f8f2">	ip </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">specificInformersMap{</span></span>
<span class="line"><span style="color:#f8f8f2">		config:            config,</span></span>
<span class="line"><span style="color:#f8f8f2">		Scheme:            scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">		mapper:            mapper,</span></span>
<span class="line"><span style="color:#f8f8f2">		informersByGVK:    </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">map</span><span style="color:#f8f8f2">[schema.GroupVersionKind]</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">MapEntry),</span></span>
<span class="line"><span style="color:#f8f8f2">		codecs:            serializer.</span><span style="color:#8be9fd">NewCodecFactory</span><span style="color:#f8f8f2">(scheme),</span></span>
<span class="line"><span style="color:#f8f8f2">		paramCodec:        runtime.</span><span style="color:#8be9fd">NewParameterCodec</span><span style="color:#f8f8f2">(scheme),</span></span>
<span class="line"><span style="color:#f8f8f2">		resync:            resync,</span></span>
<span class="line"><span style="color:#f8f8f2">		startWait:         </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">chan</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}),</span></span>
<span class="line"><span style="color:#f8f8f2">		createListWatcher: createListWatcher,</span></span>
<span class="line"><span style="color:#f8f8f2">		namespace:         namespace,</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> ip</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">createStructuredListWatch</span><span style="color:#f8f8f2">(gvk schema.GroupVersionKind, ip </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">specificInformersMap) (</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">cache.ListWatch, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Kubernetes APIs work against Resources, not GroupVersionKinds.  Map the</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// groupVersionKind to the Resource API we will use.</span></span>
<span class="line"><span style="color:#f8f8f2">	mapping, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ip.mapper.</span><span style="color:#8be9fd">RESTMapping</span><span style="color:#f8f8f2">(gvk.</span><span style="color:#8be9fd">GroupKind</span><span style="color:#f8f8f2">(), gvk.Version)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	client, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> apiutil.</span><span style="color:#8be9fd">RESTClientForGVK</span><span style="color:#f8f8f2">(gvk, </span><span style="color:#bd93f9">false</span><span style="color:#f8f8f2">, ip.config, ip.codecs)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	listGVK </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> gvk.</span><span style="color:#8be9fd">GroupVersion</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">WithKind</span><span style="color:#f8f8f2">(gvk.Kind </span><span style="color:#ff79c6">+</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">List</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	listObj, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ip.Scheme.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(listGVK)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// TODO: the functions that make use of this ListWatch should be adapted to</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//  pass in their own contexts instead of relying on this fixed one here.</span></span>
<span class="line"><span style="color:#f8f8f2">	ctx </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> context.</span><span style="color:#8be9fd">TODO</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Create a new ListWatch for the obj</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">cache.ListWatch{</span></span>
<span class="line"><span style="color:#f8f8f2">		ListFunc: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(opts metav1.ListOptions) (runtime.Object, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">			res </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> listObj.</span><span style="color:#8be9fd">DeepCopyObject</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">			isNamespaceScoped </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ip.namespace </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">""</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;&#x26;</span><span style="color:#f8f8f2"> mapping.Scope.</span><span style="color:#8be9fd">Name</span><span style="color:#f8f8f2">() </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> meta.RESTScopeNameRoot</span></span>
<span class="line"><span style="color:#f8f8f2">			err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">NamespaceIfScoped</span><span style="color:#f8f8f2">(ip.namespace, isNamespaceScoped).</span><span style="color:#8be9fd">Resource</span><span style="color:#f8f8f2">(mapping.Resource.Resource).</span><span style="color:#8be9fd">VersionedParams</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">opts, ip.paramCodec).</span><span style="color:#8be9fd">Do</span><span style="color:#f8f8f2">(ctx).</span><span style="color:#8be9fd">Into</span><span style="color:#f8f8f2">(res)</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> res, err</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#6272a4">// Setup the watch function</span></span>
<span class="line"><span style="color:#f8f8f2">		WatchFunc: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(opts metav1.ListOptions) (watch.Interface, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#6272a4">// Watch needs to be set to true separately</span></span>
<span class="line"><span style="color:#f8f8f2">			opts.Watch </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">true</span></span>
<span class="line"><span style="color:#f8f8f2">			isNamespaceScoped </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ip.namespace </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">""</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;&#x26;</span><span style="color:#f8f8f2"> mapping.Scope.</span><span style="color:#8be9fd">Name</span><span style="color:#f8f8f2">() </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> meta.RESTScopeNameRoot</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">NamespaceIfScoped</span><span style="color:#f8f8f2">(ip.namespace, isNamespaceScoped).</span><span style="color:#8be9fd">Resource</span><span style="color:#f8f8f2">(mapping.Resource.Resource).</span><span style="color:#8be9fd">VersionedParams</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">opts, ip.paramCodec).</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">	}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>在<code>newSpecificInformersMap</code>中通过<code>informersByGVK</code>来记录<code>schema</code>中每个<code>GVK</code>对象与<code>informer</code>的对应关系，使用时可根据<code>GVK</code>得到<code>informer</code>再去<code>List</code>/<code>Get</code>。</p><p><code>newSpecificInformersMap</code>中的<code>createListWatcher</code>来初始化<code>ListWatch</code>对象。</p><h3 id="client-初始化">Client 初始化</h3><p>client 这里有多种类型，<code>apiReader</code>直接从<code>apiserver</code>读取对象，<code>writeObj</code>可以从<code>apiserver</code>或者<code>cache</code>中读取数据。</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f8f8f2">	apiReader, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(config, clientOptions)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">New</span><span style="color:#f8f8f2">(config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config, options Options) (Client, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> config </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">must provide non-nil rest.Config to client.New</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Init a scheme if none provided</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.Scheme </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		options.Scheme </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> scheme.Scheme</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Init a Mapper if none provided</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.Mapper </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">var</span><span style="color:#f8f8f2"> err </span><span style="color:#8be9fd;font-style:italic">error</span></span>
<span class="line"><span style="color:#f8f8f2">		options.Mapper, err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> apiutil.</span><span style="color:#8be9fd">NewDynamicRESTMapper</span><span style="color:#f8f8f2">(config)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 从cache中读取</span></span>
<span class="line"><span style="color:#f8f8f2">	clientcache </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">clientCache{</span></span>
<span class="line"><span style="color:#f8f8f2">		config: config,</span></span>
<span class="line"><span style="color:#f8f8f2">		scheme: options.Scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">		mapper: options.Mapper,</span></span>
<span class="line"><span style="color:#f8f8f2">		codecs: serializer.</span><span style="color:#8be9fd">NewCodecFactory</span><span style="color:#f8f8f2">(options.Scheme),</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		structuredResourceByType:   </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">map</span><span style="color:#f8f8f2">[schema.GroupVersionKind]</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">resourceMeta),</span></span>
<span class="line"><span style="color:#f8f8f2">		unstructuredResourceByType: </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">map</span><span style="color:#f8f8f2">[schema.GroupVersionKind]</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">resourceMeta),</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	rawMetaClient, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> metadata.</span><span style="color:#8be9fd">NewForConfig</span><span style="color:#f8f8f2">(config)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">unable to construct metadata-only client for use as part of client: </span><span style="color:#bd93f9">%w</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	c </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">client{</span></span>
<span class="line"><span style="color:#f8f8f2">		typedClient: typedClient{</span></span>
<span class="line"><span style="color:#f8f8f2">			cache:      clientcache,</span></span>
<span class="line"><span style="color:#f8f8f2">			paramCodec: runtime.</span><span style="color:#8be9fd">NewParameterCodec</span><span style="color:#f8f8f2">(options.Scheme),</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">		unstructuredClient: unstructuredClient{</span></span>
<span class="line"><span style="color:#f8f8f2">			cache:      clientcache,</span></span>
<span class="line"><span style="color:#f8f8f2">			paramCodec: noConversionParamCodec{},</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">		metadataClient: metadataClient{</span></span>
<span class="line"><span style="color:#f8f8f2">			client:     rawMetaClient,</span></span>
<span class="line"><span style="color:#f8f8f2">			restMapper: options.Mapper,</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">		scheme: options.Scheme,</span></span>
<span class="line"><span style="color:#f8f8f2">		mapper: options.Mapper,</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> c, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>writeObj</code>实现了读写分离的<code>Client</code>，写直连<code>apiserver</code>，读获取在<code>cache</code>中则直接读取<code>cache</code>，否则通过<code>clientset</code>。</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#f8f8f2">writeObj, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> options.ClientBuilder.</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">WithUncached</span><span style="color:#f8f8f2">(options.ClientDisableCacheFor</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">).</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">Build</span><span style="color:#f8f8f2">(cache, config, clientOptions)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (n </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">newClientBuilder) </span><span style="color:#50fa7b">Build</span><span style="color:#f8f8f2">(cache cache.Cache, config </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">rest.Config, options client.Options) (client.Client, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Create the Client for Write operations.</span></span>
<span class="line"><span style="color:#f8f8f2">	c, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(config, options)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> client.</span><span style="color:#8be9fd">NewDelegatingClient</span><span style="color:#f8f8f2">(client.NewDelegatingClientInput{</span></span>
<span class="line"><span style="color:#f8f8f2">		CacheReader:     cache,</span></span>
<span class="line"><span style="color:#f8f8f2">		Client:          c,</span></span>
<span class="line"><span style="color:#f8f8f2">		UncachedObjects: n.uncached,</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// 读写分离client</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">NewDelegatingClient</span><span style="color:#f8f8f2">(in NewDelegatingClientInput) (Client, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	uncachedGVKs </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">map</span><span style="color:#f8f8f2">[schema.GroupVersionKind]</span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}{}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, obj </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> in.UncachedObjects {</span></span>
<span class="line"><span style="color:#f8f8f2">		gvk, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> apiutil.</span><span style="color:#8be9fd">GVKForObject</span><span style="color:#f8f8f2">(obj, in.Client.</span><span style="color:#8be9fd">Scheme</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		uncachedGVKs[gvk] </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}{}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">delegatingClient{</span></span>
<span class="line"><span style="color:#f8f8f2">		scheme: in.Client.</span><span style="color:#8be9fd">Scheme</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">		mapper: in.Client.</span><span style="color:#8be9fd">RESTMapper</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">		Reader: </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">delegatingReader{</span></span>
<span class="line"><span style="color:#f8f8f2">			CacheReader:       in.CacheReader,</span></span>
<span class="line"><span style="color:#f8f8f2">			ClientReader:      in.Client,</span></span>
<span class="line"><span style="color:#f8f8f2">			scheme:            in.Client.</span><span style="color:#8be9fd">Scheme</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">			uncachedGVKs:      uncachedGVKs,</span></span>
<span class="line"><span style="color:#f8f8f2">			cacheUnstructured: in.CacheUnstructured,</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">		Writer:       in.Client,</span></span>
<span class="line"><span style="color:#f8f8f2">		StatusClient: in.Client,</span></span>
<span class="line"><span style="color:#f8f8f2">	}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// Get retrieves an obj for a given object key from the Kubernetes Cluster.</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (d </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">delegatingReader) </span><span style="color:#50fa7b">Get</span><span style="color:#f8f8f2">(ctx context.Context, key ObjectKey, obj Object) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//根据是否cached选择client</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> isUncached, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> d.</span><span style="color:#8be9fd">shouldBypassCache</span><span style="color:#f8f8f2">(obj); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	} </span><span style="color:#ff79c6">else</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> isUncached {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> d.ClientReader.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, key, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> d.CacheReader.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, key, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><h3 id="controller-初始化">Controller 初始化</h3><p>Controller 初始化代码如下：</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (r </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">GameReconciler) </span><span style="color:#50fa7b">SetupWithManager</span><span style="color:#f8f8f2">(mgr ctrl.Manager) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	ctrl.</span><span style="color:#8be9fd">NewControllerManagedBy</span><span style="color:#f8f8f2">(mgr).</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">WithOptions</span><span style="color:#f8f8f2">(controller.Options{</span></span>
<span class="line"><span style="color:#f8f8f2">			MaxConcurrentReconciles: </span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">		}).</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">For</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">myappv1.Game{}). </span><span style="color:#6272a4">// Reconcile资源</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">Owns</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">appsv1.Deployment{}). </span><span style="color:#6272a4">// 监听Owner是当前资源的Deployment</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#8be9fd">Complete</span><span style="color:#f8f8f2">(r)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// Complete builds the Application ControllerManagedBy.</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (blder </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Builder) </span><span style="color:#50fa7b">Complete</span><span style="color:#f8f8f2">(r reconcile.Reconciler) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	_, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.</span><span style="color:#8be9fd">Build</span><span style="color:#f8f8f2">(r)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// Build builds the Application ControllerManagedBy and returns the Controller it created.</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (blder </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Builder) </span><span style="color:#50fa7b">Build</span><span style="color:#f8f8f2">(r reconcile.Reconciler) (controller.Controller, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> r </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">must provide a non-nil Reconciler</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> blder.mgr </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">must provide a non-nil Manager</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> blder.forInput.err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, blder.forInput.err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Checking the reconcile type exist or not</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> blder.forInput.object </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">must provide an object for reconciliation</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Set the Config</span></span>
<span class="line"><span style="color:#f8f8f2">	blder.</span><span style="color:#8be9fd">loadRestConfig</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Set the ControllerManagedBy</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.</span><span style="color:#8be9fd">doController</span><span style="color:#f8f8f2">(r); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Set the Watch</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.</span><span style="color:#8be9fd">doWatch</span><span style="color:#f8f8f2">(); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> blder.ctrl, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>初始化<code>Controller</code>调用<code>ctrl.NewControllerManagedBy</code>来创建<code>Builder</code>，填充配置，最后通过<code>Build</code>方法完成初始化，主要做了三件事</p><ol><li>设置配置</li><li><code>doController</code>来创建<code>controller</code></li><li><code>doWatch</code>来设置需要监听的资源</li></ol><p>先看<code>controller</code>初始化</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (blder </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Builder) </span><span style="color:#50fa7b">doController</span><span style="color:#f8f8f2">(r reconcile.Reconciler) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	ctrlOptions </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.ctrlOptions</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> ctrlOptions.Reconciler </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		ctrlOptions.Reconciler </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> r</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	gvk, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">getGvk</span><span style="color:#f8f8f2">(blder.forInput.object, blder.mgr.</span><span style="color:#8be9fd">GetScheme</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Setup the logger.</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> ctrlOptions.Log </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		ctrlOptions.Log </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> blder.mgr.</span><span style="color:#8be9fd">GetLogger</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	ctrlOptions.Log </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> ctrlOptions.Log.</span><span style="color:#8be9fd">WithValues</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">reconciler group</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, gvk.Group, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">reconciler kind</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, gvk.Kind)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Build the controller and return.</span></span>
<span class="line"><span style="color:#f8f8f2">	blder.ctrl, err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">newController</span><span style="color:#f8f8f2">(blder.</span><span style="color:#8be9fd">getControllerName</span><span style="color:#f8f8f2">(gvk), blder.mgr, ctrlOptions)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">New</span><span style="color:#f8f8f2">(name </span><span style="color:#8be9fd;font-style:italic">string</span><span style="color:#f8f8f2">, mgr manager.Manager, options Options) (Controller, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	c, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">NewUnmanaged</span><span style="color:#f8f8f2">(name, mgr, options)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Add the controller as a Manager components</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> c, mgr.</span><span style="color:#8be9fd">Add</span><span style="color:#f8f8f2">(c)</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> </span><span style="color:#50fa7b">NewUnmanaged</span><span style="color:#f8f8f2">(name </span><span style="color:#8be9fd;font-style:italic">string</span><span style="color:#f8f8f2">, mgr manager.Manager, options Options) (Controller, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.Reconciler </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">must specify Reconciler</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">len</span><span style="color:#f8f8f2">(name) </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">must specify Name for Controller</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.Log </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		options.Log </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> mgr.</span><span style="color:#8be9fd">GetLogger</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.MaxConcurrentReconciles </span><span style="color:#ff79c6">&#x3C;=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		options.MaxConcurrentReconciles </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">1</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.CacheSyncTimeout </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		options.CacheSyncTimeout </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">2</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2"> time.Minute</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> options.RateLimiter </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		options.RateLimiter </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> workqueue.</span><span style="color:#8be9fd">DefaultControllerRateLimiter</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Inject dependencies into Reconciler</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> mgr.</span><span style="color:#8be9fd">SetFields</span><span style="color:#f8f8f2">(options.Reconciler); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Create controller with dependencies set</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">controller.Controller{</span></span>
<span class="line"><span style="color:#f8f8f2">		Do: options.Reconciler,</span></span>
<span class="line"><span style="color:#f8f8f2">		MakeQueue: </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() workqueue.RateLimitingInterface {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> workqueue.</span><span style="color:#8be9fd">NewNamedRateLimitingQueue</span><span style="color:#f8f8f2">(options.RateLimiter, name)</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">		MaxConcurrentReconciles: options.MaxConcurrentReconciles,</span></span>
<span class="line"><span style="color:#f8f8f2">		CacheSyncTimeout:        options.CacheSyncTimeout,</span></span>
<span class="line"><span style="color:#f8f8f2">		SetFields:               mgr.SetFields,</span></span>
<span class="line"><span style="color:#f8f8f2">		Name:                    name,</span></span>
<span class="line"><span style="color:#f8f8f2">		Log:                     options.Log.</span><span style="color:#8be9fd">WithName</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">controller</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">).</span><span style="color:#8be9fd">WithName</span><span style="color:#f8f8f2">(name),</span></span>
<span class="line"><span style="color:#f8f8f2">	}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>doController</code>调用<code>controller.New</code>来创建<code>controller</code>并添加到<code>manager</code>，在<code>NewUnmanaged</code>可以看到我们熟悉的配置，与上文<code>sample-controller</code>类似这里也设置了工作队列、最大 Worker 数等。</p><p><code>doWatch</code>代码如下</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (blder </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Builder) </span><span style="color:#50fa7b">doWatch</span><span style="color:#f8f8f2">() </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Reconcile type</span></span>
<span class="line"><span style="color:#f8f8f2">	typeForSrc, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.</span><span style="color:#8be9fd">project</span><span style="color:#f8f8f2">(blder.forInput.object, blder.forInput.objectProjection)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	src </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">source.Kind{Type: typeForSrc}</span></span>
<span class="line"><span style="color:#f8f8f2">	hdler </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">handler.EnqueueRequestForObject{}</span></span>
<span class="line"><span style="color:#f8f8f2">	allPredicates </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">append</span><span style="color:#f8f8f2">(blder.globalPredicates, blder.forInput.predicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.ctrl.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(src, hdler, allPredicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Watches the managed types</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, own </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> blder.ownsInput {</span></span>
<span class="line"><span style="color:#f8f8f2">		typeForSrc, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.</span><span style="color:#8be9fd">project</span><span style="color:#f8f8f2">(own.object, own.objectProjection)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		src </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">source.Kind{Type: typeForSrc}</span></span>
<span class="line"><span style="color:#f8f8f2">		hdler </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">handler.EnqueueRequestForOwner{</span></span>
<span class="line"><span style="color:#f8f8f2">			OwnerType:    blder.forInput.object,</span></span>
<span class="line"><span style="color:#f8f8f2">			IsController: </span><span style="color:#bd93f9">true</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		allPredicates </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">append</span><span style="color:#f8f8f2">([]predicate.</span><span style="color:#8be9fd">Predicate</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">), blder.globalPredicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		allPredicates </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">append</span><span style="color:#f8f8f2">(allPredicates, own.predicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.ctrl.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(src, hdler, allPredicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Do the watch requests</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, w </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> blder.watchesInput {</span></span>
<span class="line"><span style="color:#f8f8f2">		allPredicates </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">append</span><span style="color:#f8f8f2">([]predicate.</span><span style="color:#8be9fd">Predicate</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">), blder.globalPredicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">		allPredicates </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">append</span><span style="color:#f8f8f2">(allPredicates, w.predicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#6272a4">// If the source of this watch is of type *source.Kind, project it.</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> srckind, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> w.src.(</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">source.Kind); ok {</span></span>
<span class="line"><span style="color:#f8f8f2">			typeForSrc, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.</span><span style="color:#8be9fd">project</span><span style="color:#f8f8f2">(srckind.Type, w.objectProjection)</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">			srckind.Type </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> typeForSrc</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> blder.ctrl.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(w.src, w.eventhandler, allPredicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>doWatch</code>以此<code>watch</code>当前资源，<code>ownsInput</code>资源（即 owner 为当前资源），以及通过<code>builder</code>传入的<code>watchsInput</code>，最后调用<code>ctrl.Watch</code>来注册。其中参数<code>eventhandler</code>为入队函数，如当前资源入队实现为<code>handler.EnqueueRequestForObject</code>，类似地<code>handler.EnqueueRequestForOwner</code>是将<code>owner</code>加入工作队列。</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">type</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd;font-style:italic">EnqueueRequestForObject</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// Create implements EventHandler</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (e </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">EnqueueRequestForObject) </span><span style="color:#50fa7b">Create</span><span style="color:#f8f8f2">(evt event.CreateEvent, q workqueue.RateLimitingInterface) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> evt.Object </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		enqueueLog.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">CreateEvent received with no metadata</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">event</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, evt)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 加入队列</span></span>
<span class="line"><span style="color:#f8f8f2">	q.</span><span style="color:#8be9fd">Add</span><span style="color:#f8f8f2">(reconcile.Request{NamespacedName: types.NamespacedName{</span></span>
<span class="line"><span style="color:#f8f8f2">		Name:      evt.Object.</span><span style="color:#8be9fd">GetName</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">		Namespace: evt.Object.</span><span style="color:#8be9fd">GetNamespace</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">	}})</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>Watch</code>实现如下：</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (c </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller) </span><span style="color:#50fa7b">Watch</span><span style="color:#f8f8f2">(src source.Source, evthdler handler.EventHandler, prct </span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">predicate.Predicate) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	c.mu.</span><span style="color:#8be9fd">Lock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> c.mu.</span><span style="color:#8be9fd">Unlock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Inject Cache into arguments</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">SetFields</span><span style="color:#f8f8f2">(src); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">SetFields</span><span style="color:#f8f8f2">(evthdler); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, pr </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> prct {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">SetFields</span><span style="color:#f8f8f2">(pr); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">c.Started {</span></span>
<span class="line"><span style="color:#f8f8f2">		c.startWatches </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">append</span><span style="color:#f8f8f2">(c.startWatches, watchDescription{src: src, handler: evthdler, predicates: prct})</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	c.Log.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Starting EventSource</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">source</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, src)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> src.</span><span style="color:#8be9fd">Start</span><span style="color:#f8f8f2">(c.ctx, evthdler, c.Queue, prct</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (ks </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Kind) </span><span style="color:#50fa7b">InjectCache</span><span style="color:#f8f8f2">(c cache.Cache) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> ks.cache </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		ks.cache </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> c</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (ks </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Kind) </span><span style="color:#50fa7b">Start</span><span style="color:#f8f8f2">(ctx context.Context, handler handler.EventHandler, queue workqueue.RateLimitingInterface,</span></span>
<span class="line"><span style="color:#f8f8f2">	prct </span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">predicate.Predicate) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">	i, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ks.cache.</span><span style="color:#8be9fd">GetInformer</span><span style="color:#f8f8f2">(ctx, ks.Type)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> kindMatchErr, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> err.(</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">meta.NoKindMatchError); ok {</span></span>
<span class="line"><span style="color:#f8f8f2">			log.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">if kind is a CRD, it should be installed before calling Start</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">kind</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, kindMatchErr.GroupKind)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	i.</span><span style="color:#8be9fd">AddEventHandler</span><span style="color:#f8f8f2">(internal.EventHandler{Queue: queue, EventHandler: handler, Predicates: prct})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// informer get 实现</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (m </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">InformersMap) </span><span style="color:#50fa7b">Get</span><span style="color:#f8f8f2">(ctx context.Context, gvk schema.GroupVersionKind, obj runtime.Object) (</span><span style="color:#8be9fd;font-style:italic">bool</span><span style="color:#f8f8f2">, </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">MapEntry, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">switch</span><span style="color:#f8f8f2"> obj.(type) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">unstructured.Unstructured:</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> m.unstructured.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, gvk, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">unstructured.UnstructuredList:</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> m.unstructured.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, gvk, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">metav1.PartialObjectMetadata:</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> m.metadata.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, gvk, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">metav1.PartialObjectMetadataList:</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> m.metadata.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, gvk, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">default</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> m.structured.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, gvk, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// 如果informer不存在则新创建一个，加入到informerMap</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (ip </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">specificInformersMap) </span><span style="color:#50fa7b">Get</span><span style="color:#f8f8f2">(ctx context.Context, gvk schema.GroupVersionKind, obj runtime.Object) (</span><span style="color:#8be9fd;font-style:italic">bool</span><span style="color:#f8f8f2">, </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">MapEntry, </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Return the informer if it is found</span></span>
<span class="line"><span style="color:#f8f8f2">	i, started, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() (</span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">MapEntry, </span><span style="color:#8be9fd;font-style:italic">bool</span><span style="color:#f8f8f2">, </span><span style="color:#8be9fd;font-style:italic">bool</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">		ip.mu.</span><span style="color:#8be9fd">RLock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> ip.mu.</span><span style="color:#8be9fd">RUnlock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">		i, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> ip.informersByGVK[gvk]</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> i, ip.started, ok</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">ok {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">var</span><span style="color:#f8f8f2"> err </span><span style="color:#8be9fd;font-style:italic">error</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> i, started, err </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> ip.</span><span style="color:#8be9fd">addInformerToMap</span><span style="color:#f8f8f2">(gvk, obj); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> started, </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2">, err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> started, i, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><p><code>Watch</code>通过<code>SetFeilds</code>方法注入<code>cache</code>, 最后添加到<code>controller</code>的<code>startWatches</code>队列，若已启动，调用<code>Start</code>方法配置回调函数<code>EventHandler</code>。</p><h3 id="manager-启动">Manager 启动</h3><p>最后来看<code>Manager</code>启动流程</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (cm </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">controllerManager) </span><span style="color:#50fa7b">Start</span><span style="color:#f8f8f2">(ctx context.Context) (err </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> cm.</span><span style="color:#8be9fd">Add</span><span style="color:#f8f8f2">(cm.cluster); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to add cluster to runnables: </span><span style="color:#bd93f9">%w</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, err)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	cm.internalCtx, cm.internalCancel </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> context.</span><span style="color:#8be9fd">WithCancel</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	stopComplete </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">chan</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2">{})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">close</span><span style="color:#f8f8f2">(stopComplete)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">		stopErr </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> cm.</span><span style="color:#8be9fd">engageStopProcedure</span><span style="color:#f8f8f2">(stopComplete)</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	cm.errChan </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">make</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">chan</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> cm.metricsListener </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> cm.</span><span style="color:#8be9fd">serveMetrics</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Serve health probes</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> cm.healthProbeListener </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> cm.</span><span style="color:#8be9fd">serveHealthProbes</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> cm.</span><span style="color:#8be9fd">startNonLeaderElectionRunnables</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> cm.resourceLock </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> cm.</span><span style="color:#8be9fd">startLeaderElection</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				cm.errChan </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">		} </span><span style="color:#ff79c6">else</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#6272a4">// Treat not having leader election enabled the same as being elected.</span></span>
<span class="line"><span style="color:#f8f8f2">			cm.</span><span style="color:#8be9fd">startLeaderElectionRunnables</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#8be9fd">close</span><span style="color:#f8f8f2">(cm.elected)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">select</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">ctx.</span><span style="color:#8be9fd">Done</span><span style="color:#f8f8f2">():</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#6272a4">// We are done</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">case</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">cm.errChan:</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#6272a4">// Error starting or running a runnable</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>主要流程包括：</p><ol><li>启动监控服务</li><li>启动健康检查服务</li><li>启动非选主服务</li><li>启动选主服务</li></ol><p>对于非选主服务，代码如下</p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (cm </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">controllerManager) </span><span style="color:#50fa7b">startNonLeaderElectionRunnables</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	cm.mu.</span><span style="color:#8be9fd">Lock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> cm.mu.</span><span style="color:#8be9fd">Unlock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	cm.</span><span style="color:#8be9fd">waitForCache</span><span style="color:#f8f8f2">(cm.internalCtx)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Start the non-leaderelection Runnables after the cache has synced</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, c </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> cm.nonLeaderElectionRunnables {</span></span>
<span class="line"><span style="color:#f8f8f2">		cm.</span><span style="color:#8be9fd">startRunnable</span><span style="color:#f8f8f2">(c)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (cm </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">controllerManager) </span><span style="color:#50fa7b">waitForCache</span><span style="color:#f8f8f2">(ctx context.Context) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> cm.started {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, cache </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> cm.caches {</span></span>
<span class="line"><span style="color:#f8f8f2">		cm.</span><span style="color:#8be9fd">startRunnable</span><span style="color:#f8f8f2">(cache)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, cache </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> cm.caches {</span></span>
<span class="line"><span style="color:#f8f8f2">		cache.</span><span style="color:#8be9fd">GetCache</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">WaitForCacheSync</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	cm.started </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">true</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>启动<code>cache</code>，启动其他服务，对于选主服务也类似，初始化<code>controller</code>时会加入到选主服务队列，即最后启动<code>Controller</code></p><pre class="astro-code dracula" is:raw="" style="background-color:#282a36;overflow-x:auto" tabindex="0"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (c </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller) </span><span style="color:#50fa7b">Start</span><span style="color:#f8f8f2">(ctx context.Context) </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">	c.Queue </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">MakeQueue</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> c.Queue.</span><span style="color:#8be9fd">ShutDown</span><span style="color:#f8f8f2">() </span><span style="color:#6272a4">// needs to be outside the iife so that we shutdown after the stop channel is closed</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> c.mu.</span><span style="color:#8be9fd">Unlock</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> utilruntime.</span><span style="color:#8be9fd">HandleCrash</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, watch </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> c.startWatches {</span></span>
<span class="line"><span style="color:#f8f8f2">			c.Log.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Starting EventSource</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">source</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, watch.src)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> watch.src.</span><span style="color:#8be9fd">Start</span><span style="color:#f8f8f2">(ctx, watch.handler, c.Queue, watch.predicates</span><span style="color:#ff79c6">...</span><span style="color:#f8f8f2">); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> _, watch </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">range</span><span style="color:#f8f8f2"> c.startWatches {</span></span>
<span class="line"><span style="color:#f8f8f2">			syncingSource, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> watch.src.(source.SyncingSource)</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">ok {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">continue</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">() </span><span style="color:#8be9fd;font-style:italic">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#6272a4">// use a context with timeout for launching sources and syncing caches.</span></span>
<span class="line"><span style="color:#f8f8f2">				sourceStartCtx, cancel </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> context.</span><span style="color:#8be9fd">WithTimeout</span><span style="color:#f8f8f2">(ctx, c.CacheSyncTimeout)</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">defer</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">cancel</span><span style="color:#f8f8f2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> syncingSource.</span><span style="color:#8be9fd">WaitForSync</span><span style="color:#f8f8f2">(sourceStartCtx); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">					err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Errorf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to wait for </span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c"> caches to sync: </span><span style="color:#bd93f9">%w</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, c.Name, err)</span></span>
<span class="line"><span style="color:#f8f8f2">					c.Log.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Could not wait for Cache to sync</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">					</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">				}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">			}(); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> i </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">0</span><span style="color:#f8f8f2">; i </span><span style="color:#ff79c6">&#x3C;</span><span style="color:#f8f8f2"> c.MaxConcurrentReconciles; i</span><span style="color:#ff79c6">++</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">go</span><span style="color:#f8f8f2"> wait.</span><span style="color:#8be9fd">UntilWithContext</span><span style="color:#f8f8f2">(ctx, </span><span style="color:#ff79c6">func</span><span style="color:#f8f8f2">(ctx context.Context) {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">for</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">processNextWorkItem</span><span style="color:#f8f8f2">(ctx) {</span></span>
<span class="line"><span style="color:#f8f8f2">				}</span></span>
<span class="line"><span style="color:#f8f8f2">			}, c.JitterPeriod)</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">		c.Started </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">true</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">	}()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">&#x3C;-</span><span style="color:#f8f8f2">ctx.</span><span style="color:#8be9fd">Done</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	c.Log.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Stopping workers</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (c </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller) </span><span style="color:#50fa7b">processNextWorkItem</span><span style="color:#f8f8f2">(ctx context.Context) </span><span style="color:#8be9fd;font-style:italic">bool</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	obj, shutdown </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.Queue.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">	c.</span><span style="color:#8be9fd">reconcileHandler</span><span style="color:#f8f8f2">(ctx, obj)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">true</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (c </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Controller) </span><span style="color:#50fa7b">reconcileHandler</span><span style="color:#f8f8f2">(ctx context.Context, obj </span><span style="color:#ff79c6">interface</span><span style="color:#f8f8f2">{}) {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Make sure that the the object is a valid request.</span></span>
<span class="line"><span style="color:#f8f8f2">	req, ok </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> obj.(reconcile.Request)</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> result, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.Do.</span><span style="color:#8be9fd">Reconcile</span><span style="color:#f8f8f2">(ctx, req); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><code>Controller</code>启动主要包括</p><ol><li>等待 cache 同步</li><li>启动多个<code>processNextWorkItem</code></li><li>每个 Worker 调用<code>c.Do.Reconcile</code>来进行数据处理 与<code>sample-controller</code>工作流程一致，不断获取工作队列中的数据调用<code>Reconcile</code>进行调谐。</li></ol><h3 id="流程归纳">流程归纳</h3><p>至此，通过<code>kubebuilder</code>生成代码的主要逻辑已经明朗，对比<code>sample-controller</code>其实整体流程类似，只是<code>kubebuilder</code>通过<code>controller-runtime</code>已经帮我们做了很多工作，如<code>client</code>、<code>cache</code>的初始化，<code>controller</code>的运行框架，我们只需要关心<code>Reconcile</code>逻辑即可。</p><ol><li>初始化<code>manager</code>，创建<code>client</code>与<code>cache</code></li><li>创建<code>controller</code>，对于监听资源会创建对应<code>informer</code>并添加回调函数</li><li>启动<code>manager</code>，启动<code>cache</code>与<code>controller</code></li></ol><h2 id="总结">总结</h2><p><code>kubebuilder</code>大大简化了开发<code>Operator</code>的流程，了解其背后的原理有利于我们对<code>Operator</code>进行调优，能更好地应用于生产。</p><h2 id="引用">引用</h2><ul><li><a href="https://github.com/kubernetes/sample-controller">https://github.com/kubernetes/sample-controller</a></li><li><a href="https://book.kubebuilder.io/architecture.html">https://book.kubebuilder.io/architecture.html</a></li><li><a href="https://developer.aliyun.com/article/719215">https://developer.aliyun.com/article/719215</a></li></ul></div></div><div class="flex flex-col justify-between max-w-3xl mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class="mr-5"><li class="border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-full"><a href="/tags/k8s" class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#k8s</a></li></ul></div></article><div class="max-w-3xl mx-auto sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script src="https://giscus.app/client.js" async crossorigin="anonymous" data-category="Announcements" data-category-id="DIC_kwDOCg97r84CBQfL" data-emit-metadata="0" data-input-position="top" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="qingwave/qingwave.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict="0" data-theme="light"></script></div></section></main><footer class="relative"><div class="max-w-3xl mx-auto sm:px-6 px-4"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden="true"></div><div class="max-w-3xl mx-auto sm:px-6 px-4 dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href="/rss.xml" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label="RSS"><svg astro-icon="tabler:rss" class="h-5 w-5" viewBox="0 0 24 24"><g class="icon-tabler" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href="https://qingwave.github.io" class="hover:brightness-50">Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function c(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:localStorage.theme}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),c=encodeURIComponent(t.getAttribute("data-aw-text"));let a;switch(o){case"facebook":a=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":a=`https://twitter.com/intent/tweet?url=${n}&text=${c}`;break;case"linkedin":a=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${c}`;break;case"whatsapp":a=`https://wa.me/?text=${c}%20${n}`;break;case"mail":a=`mailto:?subject=%22${c}%22&body=${c}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=a,s.click()})),c(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{c()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>