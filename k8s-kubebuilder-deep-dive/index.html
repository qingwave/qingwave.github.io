<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">
        深入了解kubebuilder
        
    </title><meta name="Description" content="Coding, Reading and Daydreaming"><meta property="og:title" content="深入了解kubebuilder" />
<meta property="og:description" content="前文快速实现一个Kubernetes Operator介绍了kubebuilder工具，快速实现了一个Operator。今天我们深入水下，探寻kubebuilder究竟是如何工作的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qingwave.github.io/k8s-kubebuilder-deep-dive/" /><meta property="og:image" content="https://qingwave.github.io/img/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-23T00:25:53+00:00" />
<meta property="article:modified_time" content="2021-12-12T04:54:36+00:00" /><meta property="og:site_name" content="Qingwave" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://qingwave.github.io/img/favicon.png"/>

<meta name="twitter:title" content="深入了解kubebuilder"/>
<meta name="twitter:description" content="前文快速实现一个Kubernetes Operator介绍了kubebuilder工具，快速实现了一个Operator。今天我们深入水下，探寻kubebuilder究竟是如何工作的。"/>
<meta name="application-name" content="Qingwave">
<meta name="apple-mobile-web-app-title" content="Qingwave">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://qingwave.github.io/k8s-kubebuilder-deep-dive/" /><link rel="prev" href="https://qingwave.github.io/how-to-write-a-k8s-operator/" /><link rel="next" href="https://qingwave.github.io/k8s-clusterautoscaler-from-zero-issue/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><meta name="google-site-verification" content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" /><meta name="baidu-site-verification" content="muFp3xopwC" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "深入了解kubebuilder",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qingwave.github.io\/k8s-kubebuilder-deep-dive\/"
        },"genre": "posts","keywords": "k8s","wordcount":  5751 ,
        "url": "https:\/\/qingwave.github.io\/k8s-kubebuilder-deep-dive\/","datePublished": "2021-08-23T00:25:53+00:00","dateModified": "2021-12-12T04:54:36+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "qinng"
            },"description": ""
    }
    </script></head>

<body header-desktop="normal" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span><span class="header-title-post"> Time</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#普通开发流程">普通开发流程</a>
      <ul>
        <li><a href="#api定义">API定义</a></li>
        <li><a href="#controller实现">Controller实现</a></li>
      </ul>
    </li>
    <li><a href="#operator模式">Operator模式</a>
      <ul>
        <li><a href="#manager初始化">Manager初始化</a></li>
        <li><a href="#cache初始化">Cache初始化</a></li>
        <li><a href="#client初始化">Client初始化</a></li>
        <li><a href="#controller初始化">Controller初始化</a></li>
        <li><a href="#manager启动">Manager启动</a></li>
        <li><a href="#流程归纳">流程归纳</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title">深入了解kubebuilder</h1><div class="post-meta">
            <div class="post-meta-line"><time datetime="Aug 23, 2021">Aug 23, 2021</time>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#普通开发流程">普通开发流程</a>
      <ul>
        <li><a href="#api定义">API定义</a></li>
        <li><a href="#controller实现">Controller实现</a></li>
      </ul>
    </li>
    <li><a href="#operator模式">Operator模式</a>
      <ul>
        <li><a href="#manager初始化">Manager初始化</a></li>
        <li><a href="#cache初始化">Cache初始化</a></li>
        <li><a href="#client初始化">Client初始化</a></li>
        <li><a href="#controller初始化">Controller初始化</a></li>
        <li><a href="#manager启动">Manager启动</a></li>
        <li><a href="#流程归纳">流程归纳</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>前文<a href="./how-to-write-a-k8s-operator" rel="">快速实现一个Kubernetes Operator</a>介绍了<code>kubebuilder</code>工具，快速实现了一个<code>Operator</code>。今天我们深入水下，探寻<code>kubebuilder</code>究竟是如何工作的。</p>
<h2 id="普通开发流程" class="headerLink">
    <a href="#%e6%99%ae%e9%80%9a%e5%bc%80%e5%8f%91%e6%b5%81%e7%a8%8b" class="header-mark"></a>普通开发流程</h2><p>如果不借助任何<code>Operator</code>脚手架，我们是如何实现<code>Operator</code>的？大体分为一下几步：</p>
<ul>
<li>CRD定义</li>
<li>Controller开发，编写逻辑</li>
<li>测试部署</li>
</ul>
<h3 id="api定义" class="headerLink">
    <a href="#api%e5%ae%9a%e4%b9%89" class="header-mark"></a>API定义</h3><p>首先通过<a href="https://github.com/kubernetes/code-generator" target="_blank" rel="noopener noreffer">k8s.io/code-generator</a>项目生成API相关代码，定义相关字段。</p>
<h3 id="controller实现" class="headerLink">
    <a href="#controller%e5%ae%9e%e7%8e%b0" class="header-mark"></a>Controller实现</h3><p>实现Controller以官方提供的<a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener noreffer">sample-controller</a>为例，如图所示
<img
        class="lazyload"
        data-src="https://github.com/kubernetes/sample-controller/raw/master/docs/images/client-go-controller-interaction.jpeg"
        data-srcset="https://github.com/kubernetes/sample-controller/raw/master/docs/images/client-go-controller-interaction.jpeg, https://github.com/kubernetes/sample-controller/raw/master/docs/images/client-go-controller-interaction.jpeg 1.5x, https://github.com/kubernetes/sample-controller/raw/master/docs/images/client-go-controller-interaction.jpeg 2x"
        data-sizes="auto"
        alt="https://github.com/kubernetes/sample-controller/raw/master/docs/images/client-go-controller-interaction.jpeg"
        title="custom-controller">

</p>
<p>主要分为以下几步：</p>
<p>初始化<code>client</code>配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl">  <span class="c1">//通过master/kubeconfig建立client config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">cfg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="nx">masterURL</span><span class="p">,</span> <span class="nx">kubeconfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error building kubeconfig: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// kubernetes client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error building kubernetes clientset: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// crd client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">exampleClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error building example clientset: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><p>初始化Informer并启动</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl">  <span class="c1">//k8s sharedInformer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">kubeInformerFactory</span> <span class="o">:=</span> <span class="nx">kubeinformers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// crd sharedInformer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">exampleInformerFactory</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">exampleClient</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 初始化controller，传入informer, 注册了Deployment与Foo Informers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">controller</span> <span class="o">:=</span> <span class="nf">NewController</span><span class="p">(</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">exampleClient</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kubeInformerFactory</span><span class="p">.</span><span class="nf">Apps</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Deployments</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">exampleInformerFactory</span><span class="p">.</span><span class="nf">Samplecontroller</span><span class="p">().</span><span class="nf">V1alpha1</span><span class="p">().</span><span class="nf">Foos</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//启动Informer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kubeInformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">exampleInformerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span></code></pre></div><p>最后启动<code>Controller</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error running controller: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></div><p>在<code>Controller</code>的实现中，通过<code>NewController</code>来初始化：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kubeclientset</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sampleclientset</span> <span class="nx">clientset</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">deploymentInformer</span> <span class="nx">appsinformers</span><span class="p">.</span><span class="nx">DeploymentInformer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fooInformer</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">FooInformer</span><span class="p">)</span> <span class="o">*</span><span class="nx">Controller</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create event broadcaster
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">samplescheme</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Creating event broadcaster&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eventBroadcaster</span> <span class="o">:=</span> <span class="nx">record</span><span class="p">.</span><span class="nf">NewBroadcaster</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eventBroadcaster</span><span class="p">.</span><span class="nf">StartStructuredLogging</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eventBroadcaster</span><span class="p">.</span><span class="nf">StartRecordingToSink</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">typedcorev1</span><span class="p">.</span><span class="nx">EventSinkImpl</span><span class="p">{</span><span class="nx">Interface</span><span class="p">:</span> <span class="nx">kubeclientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">Events</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">recorder</span> <span class="o">:=</span> <span class="nx">eventBroadcaster</span><span class="p">.</span><span class="nf">NewRecorder</span><span class="p">(</span><span class="nx">scheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">EventSource</span><span class="p">{</span><span class="nx">Component</span><span class="p">:</span> <span class="nx">controllerAgentName</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">controller</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Controller</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kubeclientset</span><span class="p">:</span>     <span class="nx">kubeclientset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sampleclientset</span><span class="p">:</span>   <span class="nx">sampleclientset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">deploymentsLister</span><span class="p">:</span> <span class="nx">deploymentInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">(),</span> <span class="c1">//只读cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">deploymentsSynced</span><span class="p">:</span> <span class="nx">deploymentInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span><span class="p">,</span> <span class="c1">//调用Informer()会注册informer到共享informer中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">foosLister</span><span class="p">:</span>        <span class="nx">fooInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">foosSynced</span><span class="p">:</span>        <span class="nx">fooInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">workqueue</span><span class="p">:</span>         <span class="nx">workqueue</span><span class="p">.</span><span class="nf">NewNamedRateLimitingQueue</span><span class="p">(</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">DefaultControllerRateLimiter</span><span class="p">(),</span> <span class="s">&#34;Foos&#34;</span><span class="p">),</span> <span class="c1">// 初始化工作队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">recorder</span><span class="p">:</span>          <span class="nx">recorder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Setting up event handlers&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 添加回调事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fooInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">AddFunc</span><span class="p">:</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">enqueueFoo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueFoo</span><span class="p">(</span><span class="nx">new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">deploymentInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">AddFunc</span><span class="p">:</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">handleObject</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">newDepl</span> <span class="o">:=</span> <span class="nx">new</span><span class="p">.(</span><span class="o">*</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">oldDepl</span> <span class="o">:=</span> <span class="nx">old</span><span class="p">.(</span><span class="o">*</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">newDepl</span><span class="p">.</span><span class="nx">ResourceVersion</span> <span class="o">==</span> <span class="nx">oldDepl</span><span class="p">.</span><span class="nx">ResourceVersion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Periodic resync will send update events for all known Deployments.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// Two different versions of the same Deployment will always have different RVs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">controller</span><span class="p">.</span><span class="nf">handleObject</span><span class="p">(</span><span class="nx">new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DeleteFunc</span><span class="p">:</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">handleObject</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">controller</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>Controller</code>启动则是典型的k8s工作流，通过控制循环不断从工作队列获取对象进行处理，使其达到期望状态</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">workers</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleCrash</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">ShutDown</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 等待cache同步
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Waiting for informer caches to sync&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">WaitForCacheSync</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deploymentsSynced</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">foosSynced</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to wait for caches to sync&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 启动worker,每个worker一个goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workers</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">runWorker</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 等待退出信号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// worker就是一个循环不断调用processNextWorkItem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">runWorker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">c</span><span class="p">.</span><span class="nf">processNextWorkItem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">processNextWorkItem</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 从工作队列获取对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj</span><span class="p">,</span> <span class="nx">shutdown</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// We wrap this block in a func so we can defer c.workqueue.Done.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">key</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">obj</span><span class="p">.(</span><span class="kt">string</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Forget</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;expected string in workqueue but got %#v&#34;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 进行处理，核心逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">syncHandler</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 处理失败再次加入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">AddRateLimited</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error syncing &#39;%s&#39;: %s, requeuing&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 处理成功不入队
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Forget</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Successfully synced &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="operator模式" class="headerLink">
    <a href="#operator%e6%a8%a1%e5%bc%8f" class="header-mark"></a>Operator模式</h2><p>在<code>Operator</code>模式下，用户只需要实现<code>Reconcile</code>(调谐)即<code>sample-controller</code>中的<code>syncHandler</code>，其他步骤<code>kubebuilder</code>已经帮我们实现了。那我们来一探究竟，<code>kubebuilder</code>是怎么一步步触发<code>Reconcile</code>逻辑。</p>
<p>以<a href="https://github.com/qingwave/mygame" target="_blank" rel="noopener noreffer">mygame</a>为例，通常使用<code>kubebuilder</code>生成的主文件如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 用来解析kubernetes对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">scheme</span>   <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewScheme</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">setupLog</span> <span class="p">=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">WithName</span><span class="p">(</span><span class="s">&#34;setup&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">clientgoscheme</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 添加自定义对象到scheme
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">myappv1</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//+kubebuilder:scaffold:scheme
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetLogger</span><span class="p">(</span><span class="nx">zap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">zap</span><span class="p">.</span><span class="nf">UseFlagOptions</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化controller manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">mgr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewManager</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">GetConfigOrDie</span><span class="p">(),</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Scheme</span><span class="p">:</span>                 <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MetricsBindAddress</span><span class="p">:</span>     <span class="nx">metricsAddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Port</span><span class="p">:</span>                   <span class="mi">9443</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">HealthProbeBindAddress</span><span class="p">:</span> <span class="nx">probeAddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LeaderElection</span><span class="p">:</span>         <span class="nx">enableLeaderElection</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LeaderElectionID</span><span class="p">:</span>       <span class="s">&#34;7bc453ad.qingwave.github.io&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">setupLog</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;unable to start manager&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化Reconciler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="nx">controllers</span><span class="p">.</span><span class="nx">GameReconciler</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Client</span><span class="p">:</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetClient</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Scheme</span><span class="p">:</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetScheme</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}).</span><span class="nf">SetupWithManager</span><span class="p">(</span><span class="nx">mgr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">setupLog</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;unable to create controller&#34;</span><span class="p">,</span> <span class="s">&#34;controller&#34;</span><span class="p">,</span> <span class="s">&#34;Game&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化Webhook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">enableWebhook</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="nx">myappv1</span><span class="p">.</span><span class="nx">Game</span><span class="p">{}).</span><span class="nf">SetupWebhookWithManager</span><span class="p">(</span><span class="nx">mgr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">setupLog</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;unable to create webhook&#34;</span><span class="p">,</span> <span class="s">&#34;webhook&#34;</span><span class="p">,</span> <span class="s">&#34;Game&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//+kubebuilder:scaffold:builder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 启动manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">SetupSignalHandler</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">setupLog</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;problem running manager&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>kubebuilder</code>封装了<code>controller-runtime</code>，在主文件中主要初始了<code>controller-manager</code>,以及我们填充的<code>Reconciler</code>与<code>Webhook</code>，最后启动<code>manager</code>。</p>
<p>分别来看下每个流程。</p>
<h3 id="manager初始化" class="headerLink">
    <a href="#manager%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>Manager初始化</h3><p>代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="nx">Manager</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置默认配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">options</span> <span class="p">=</span> <span class="nf">setOptionsDefaults</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// cluster初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cluster</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">clusterOptions</span> <span class="o">*</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">Scheme</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">MapperProvider</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">MapperProvider</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">Logger</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">SyncPeriod</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">SyncPeriod</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">Namespace</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Namespace</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">NewCache</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">NewCache</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">ClientBuilder</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ClientBuilder</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">ClientDisableCacheFor</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ClientDisableCacheFor</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">DryRunClient</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">DryRunClient</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">EventBroadcaster</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">EventBroadcaster</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// event recorder初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">recorderProvider</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">newRecorderProvider</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">cluster</span><span class="p">.</span><span class="nf">GetScheme</span><span class="p">(),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">WithName</span><span class="p">(</span><span class="s">&#34;events&#34;</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">makeBroadcaster</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 选主的资源锁配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">leaderConfig</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">LeaderElectionConfig</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">leaderConfig</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">leaderConfig</span> <span class="p">=</span> <span class="nx">rest</span><span class="p">.</span><span class="nf">CopyConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resourceLock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">newResourceLock</span><span class="p">(</span><span class="nx">leaderConfig</span><span class="p">,</span> <span class="nx">recorderProvider</span><span class="p">,</span> <span class="nx">leaderelection</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LeaderElection</span><span class="p">:</span>             <span class="nx">options</span><span class="p">.</span><span class="nx">LeaderElection</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LeaderElectionResourceLock</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">LeaderElectionResourceLock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LeaderElectionID</span><span class="p">:</span>           <span class="nx">options</span><span class="p">.</span><span class="nx">LeaderElectionID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LeaderElectionNamespace</span><span class="p">:</span>    <span class="nx">options</span><span class="p">.</span><span class="nx">LeaderElectionNamespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">controllerManager</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cluster</span><span class="p">:</span>                 <span class="nx">cluster</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">recorderProvider</span><span class="p">:</span>        <span class="nx">recorderProvider</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resourceLock</span><span class="p">:</span>            <span class="nx">resourceLock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metricsListener</span><span class="p">:</span>         <span class="nx">metricsListener</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metricsExtraHandlers</span><span class="p">:</span>    <span class="nx">metricsExtraHandlers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">:</span>                  <span class="nx">options</span><span class="p">.</span><span class="nx">Logger</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">elected</span><span class="p">:</span>                 <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">port</span><span class="p">:</span>                    <span class="nx">options</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">host</span><span class="p">:</span>                    <span class="nx">options</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">certDir</span><span class="p">:</span>                 <span class="nx">options</span><span class="p">.</span><span class="nx">CertDir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">leaseDuration</span><span class="p">:</span>           <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">LeaseDuration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">renewDeadline</span><span class="p">:</span>           <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">RenewDeadline</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">retryPeriod</span><span class="p">:</span>             <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">RetryPeriod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">healthProbeListener</span><span class="p">:</span>     <span class="nx">healthProbeListener</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">readinessEndpointName</span><span class="p">:</span>   <span class="nx">options</span><span class="p">.</span><span class="nx">ReadinessEndpointName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">livenessEndpointName</span><span class="p">:</span>    <span class="nx">options</span><span class="p">.</span><span class="nx">LivenessEndpointName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gracefulShutdownTimeout</span><span class="p">:</span> <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">GracefulShutdownTimeout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">internalProceduresStop</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">leaderElectionStopped</span><span class="p">:</span>   <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span></code></pre></div><p>在<code>New</code>中主要初始化了各种配置端口、选主信息、<code>eventRecorder</code>，最重要的是初始了<code>Cluster</code>。<code>Cluster</code>用来访问k8s，初始化代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// New constructs a brand new cluster
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="p">(</span><span class="nx">Cluster</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">config</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;must specify Config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">options</span> <span class="o">:=</span> <span class="nx">Options</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">opt</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">options</span> <span class="p">=</span> <span class="nf">setOptionsDefaults</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create the mapper provider
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">mapper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">MapperProvider</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">options</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Failed to get API Group-Resources&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create the cache for the cached read client and registering informers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cache</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">NewCache</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Scheme</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">Mapper</span><span class="p">:</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">Resync</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">SyncPeriod</span><span class="p">,</span> <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">clientOptions</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Scheme</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">Mapper</span><span class="p">:</span> <span class="nx">mapper</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">apiReader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">clientOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">writeObj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ClientBuilder</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithUncached</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientDisableCacheFor</span><span class="o">...</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Build</span><span class="p">(</span><span class="nx">cache</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">clientOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">DryRunClient</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">writeObj</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewDryRunClient</span><span class="p">(</span><span class="nx">writeObj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">recorderProvider</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">newRecorderProvider</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nf">WithName</span><span class="p">(</span><span class="s">&#34;events&#34;</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nx">makeBroadcaster</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">cluster</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">config</span><span class="p">:</span>           <span class="nx">config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scheme</span><span class="p">:</span>           <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cache</span><span class="p">:</span>            <span class="nx">cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fieldIndexes</span><span class="p">:</span>     <span class="nx">cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">:</span>           <span class="nx">writeObj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiReader</span><span class="p">:</span>        <span class="nx">apiReader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">recorderProvider</span><span class="p">:</span> <span class="nx">recorderProvider</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mapper</span><span class="p">:</span>           <span class="nx">mapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">:</span>           <span class="nx">options</span><span class="p">.</span><span class="nx">Logger</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>这里主要创建了<code>cache</code>与读写<code>client</code></p>
<h3 id="cache初始化" class="headerLink">
    <a href="#cache%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>Cache初始化</h3><p>创建<code>cache</code>代码：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// New initializes and returns a new Cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="nx">Cache</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">defaultOpts</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">im</span> <span class="o">:=</span> <span class="nx">internal</span><span class="p">.</span><span class="nf">NewInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Mapper</span><span class="p">,</span> <span class="o">*</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Resync</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">informerCache</span><span class="p">{</span><span class="nx">InformersMap</span><span class="p">:</span> <span class="nx">im</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>New</code>中调用了<code>NewInformersMap</code>来创建<code>infermer map</code>，分为<code>structured</code>、<code>unstructured</code>与<code>metadata</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewInformersMap</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mapper</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTMapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resync</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">InformersMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">InformersMap</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">structured</span><span class="p">:</span>   <span class="nf">newStructuredInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">resync</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">unstructured</span><span class="p">:</span> <span class="nf">newUnstructuredInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">resync</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metadata</span><span class="p">:</span>     <span class="nf">newMetadataInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">resync</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">Scheme</span><span class="p">:</span> <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>最终都是调用<code>newSpecificInformersMap</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// newStructuredInformersMap creates a new InformersMap for structured objects.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newStructuredInformersMap</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">mapper</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTMapper</span><span class="p">,</span> <span class="nx">resync</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">specificInformersMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">newSpecificInformersMap</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="nx">mapper</span><span class="p">,</span> <span class="nx">resync</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">createStructuredListWatch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newSpecificInformersMap</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mapper</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTMapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">resync</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">namespace</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">createListWatcher</span> <span class="nx">createListWatcherFunc</span><span class="p">)</span> <span class="o">*</span><span class="nx">specificInformersMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ip</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">specificInformersMap</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">config</span><span class="p">:</span>            <span class="nx">config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Scheme</span><span class="p">:</span>            <span class="nx">scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mapper</span><span class="p">:</span>            <span class="nx">mapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">informersByGVK</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">]</span><span class="o">*</span><span class="nx">MapEntry</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">codecs</span><span class="p">:</span>            <span class="nx">serializer</span><span class="p">.</span><span class="nf">NewCodecFactory</span><span class="p">(</span><span class="nx">scheme</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">paramCodec</span><span class="p">:</span>        <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewParameterCodec</span><span class="p">(</span><span class="nx">scheme</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resync</span><span class="p">:</span>            <span class="nx">resync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">startWait</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">createListWatcher</span><span class="p">:</span> <span class="nx">createListWatcher</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">namespace</span><span class="p">:</span>         <span class="nx">namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ip</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createStructuredListWatch</span><span class="p">(</span><span class="nx">gvk</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">,</span> <span class="nx">ip</span> <span class="o">*</span><span class="nx">specificInformersMap</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Kubernetes APIs work against Resources, not GroupVersionKinds.  Map the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// groupVersionKind to the Resource API we will use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">mapping</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">mapper</span><span class="p">.</span><span class="nf">RESTMapping</span><span class="p">(</span><span class="nx">gvk</span><span class="p">.</span><span class="nf">GroupKind</span><span class="p">(),</span> <span class="nx">gvk</span><span class="p">.</span><span class="nx">Version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">RESTClientForGVK</span><span class="p">(</span><span class="nx">gvk</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">config</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">codecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">listGVK</span> <span class="o">:=</span> <span class="nx">gvk</span><span class="p">.</span><span class="nf">GroupVersion</span><span class="p">().</span><span class="nf">WithKind</span><span class="p">(</span><span class="nx">gvk</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">+</span> <span class="s">&#34;List&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">listObj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">listGVK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// TODO: the functions that make use of this ListWatch should be adapted to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//  pass in their own contexts instead of relying on this fixed one here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Create a new ListWatch for the obj
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ListWatch</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ListFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">res</span> <span class="o">:=</span> <span class="nx">listObj</span><span class="p">.</span><span class="nf">DeepCopyObject</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">isNamespaceScoped</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTScopeNameRoot</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span><span class="nf">NamespaceIfScoped</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">isNamespaceScoped</span><span class="p">).</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">paramCodec</span><span class="p">).</span><span class="nf">Do</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">Into</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Setup the watch function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">WatchFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">watch</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Watch needs to be set to true separately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">opts</span><span class="p">.</span><span class="nx">Watch</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="nx">isNamespaceScoped</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">mapping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">RESTScopeNameRoot</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span><span class="nf">NamespaceIfScoped</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">isNamespaceScoped</span><span class="p">).</span><span class="nf">Resource</span><span class="p">(</span><span class="nx">mapping</span><span class="p">.</span><span class="nx">Resource</span><span class="p">.</span><span class="nx">Resource</span><span class="p">).</span><span class="nf">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">paramCodec</span><span class="p">).</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在<code>newSpecificInformersMap</code>中通过<code>informersByGVK</code>来记录<code>schema</code>中每个<code>GVK</code>对象与<code>informer</code>的对应关系，使用时可根据<code>GVK</code>得到<code>informer</code>再去<code>List</code>/<code>Get</code>。</p>
<p><code>newSpecificInformersMap</code>中的<code>createListWatcher</code>来初始化<code>ListWatch</code>对象。</p>
<h3 id="client初始化" class="headerLink">
    <a href="#client%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>Client初始化</h3><p>client这里有多种类型，<code>apiReader</code>直接从<code>apiserver</code>读取对象，<code>writeObj</code>可以从<code>apiserver</code>或者<code>cache</code>中读取数据。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl">	<span class="nx">apiReader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">clientOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">config</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must provide non-nil rest.Config to client.New&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Init a scheme if none provided
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span> <span class="p">=</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">Scheme</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Init a Mapper if none provided
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Mapper</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">		<span class="nx">options</span><span class="p">.</span><span class="nx">Mapper</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">NewDynamicRESTMapper</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 从cache中读取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">clientcache</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">clientCache</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">config</span><span class="p">:</span> <span class="nx">config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scheme</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mapper</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Mapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">codecs</span><span class="p">:</span> <span class="nx">serializer</span><span class="p">.</span><span class="nf">NewCodecFactory</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">structuredResourceByType</span><span class="p">:</span>   <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">]</span><span class="o">*</span><span class="nx">resourceMeta</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">unstructuredResourceByType</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">]</span><span class="o">*</span><span class="nx">resourceMeta</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rawMetaClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to construct metadata-only client for use as part of client: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">typedClient</span><span class="p">:</span> <span class="nx">typedClient</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cache</span><span class="p">:</span>      <span class="nx">clientcache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">paramCodec</span><span class="p">:</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewParameterCodec</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">unstructuredClient</span><span class="p">:</span> <span class="nx">unstructuredClient</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cache</span><span class="p">:</span>      <span class="nx">clientcache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">paramCodec</span><span class="p">:</span> <span class="nx">noConversionParamCodec</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metadataClient</span><span class="p">:</span> <span class="nx">metadataClient</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">client</span><span class="p">:</span>     <span class="nx">rawMetaClient</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">restMapper</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Mapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scheme</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mapper</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Mapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>writeObj</code>实现了读写分离的<code>Client</code>，写直连<code>apiserver</code>，读获取在<code>cache</code>中则直接读取<code>cache</code>，否则通过<code>clientset</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="nx">writeObj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ClientBuilder</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithUncached</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientDisableCacheFor</span><span class="o">...</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Build</span><span class="p">(</span><span class="nx">cache</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">clientOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">newClientBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">cache</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Cache</span><span class="p">,</span> <span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Create the Client for Write operations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span><span class="p">.</span><span class="nf">NewDelegatingClient</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">NewDelegatingClientInput</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">CacheReader</span><span class="p">:</span>     <span class="nx">cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Client</span><span class="p">:</span>          <span class="nx">c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UncachedObjects</span><span class="p">:</span> <span class="nx">n</span><span class="p">.</span><span class="nx">uncached</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 读写分离client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewDelegatingClient</span><span class="p">(</span><span class="nx">in</span> <span class="nx">NewDelegatingClientInput</span><span class="p">)</span> <span class="p">(</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">uncachedGVKs</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">obj</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">in</span><span class="p">.</span><span class="nx">UncachedObjects</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gvk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">GVKForObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nf">Scheme</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">uncachedGVKs</span><span class="p">[</span><span class="nx">gvk</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">delegatingClient</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scheme</span><span class="p">:</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nf">Scheme</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mapper</span><span class="p">:</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nf">RESTMapper</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Reader</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">delegatingReader</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">CacheReader</span><span class="p">:</span>       <span class="nx">in</span><span class="p">.</span><span class="nx">CacheReader</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ClientReader</span><span class="p">:</span>      <span class="nx">in</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">scheme</span><span class="p">:</span>            <span class="nx">in</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nf">Scheme</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">uncachedGVKs</span><span class="p">:</span>      <span class="nx">uncachedGVKs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cacheUnstructured</span><span class="p">:</span> <span class="nx">in</span><span class="p">.</span><span class="nx">CacheUnstructured</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Writer</span><span class="p">:</span>       <span class="nx">in</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">StatusClient</span><span class="p">:</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Get retrieves an obj for a given object key from the Kubernetes Cluster.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">delegatingReader</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">ObjectKey</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">Object</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//根据是否cached选择client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">isUncached</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">shouldBypassCache</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">isUncached</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">ClientReader</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">CacheReader</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="controller初始化" class="headerLink">
    <a href="#controller%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>Controller初始化</h3><p>Controller初始化代码如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">GameReconciler</span><span class="p">)</span> <span class="nf">SetupWithManager</span><span class="p">(</span><span class="nx">mgr</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Manager</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctrl</span><span class="p">.</span><span class="nf">NewControllerManagedBy</span><span class="p">(</span><span class="nx">mgr</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithOptions</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">MaxConcurrentReconciles</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">For</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">myappv1</span><span class="p">.</span><span class="nx">Game</span><span class="p">{}).</span> <span class="c1">// Reconcile资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">Owns</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{}).</span> <span class="c1">// 监听Owner是当前资源的Deployment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">Complete</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Complete builds the Application ControllerManagedBy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">Complete</span><span class="p">(</span><span class="nx">r</span> <span class="nx">reconcile</span><span class="p">.</span><span class="nx">Reconciler</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">Build</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Build builds the Application ControllerManagedBy and returns the Controller it created.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">r</span> <span class="nx">reconcile</span><span class="p">.</span><span class="nx">Reconciler</span><span class="p">)</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">Controller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must provide a non-nil Reconciler&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">mgr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must provide a non-nil Manager&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Checking the reconcile type exist or not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">object</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must provide an object for reconciliation&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Set the Config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">blder</span><span class="p">.</span><span class="nf">loadRestConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Set the ControllerManagedBy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">doController</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Set the Watch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">doWatch</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>初始化<code>Controller</code>调用<code>ctrl.NewControllerManagedBy</code>来创建<code>Builder</code>，填充配置，最后通过<code>Build</code>方法完成初始化，主要做了三件事</p>
<ol>
<li>设置配置</li>
<li><code>doController</code>来创建<code>controller</code></li>
<li><code>doWatch</code>来设置需要监听的资源</li>
</ol>
<p>先看<code>controller</code>初始化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">doController</span><span class="p">(</span><span class="nx">r</span> <span class="nx">reconcile</span><span class="p">.</span><span class="nx">Reconciler</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctrlOptions</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">ctrlOptions</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ctrlOptions</span><span class="p">.</span><span class="nx">Reconciler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctrlOptions</span><span class="p">.</span><span class="nx">Reconciler</span> <span class="p">=</span> <span class="nx">r</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">gvk</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">getGvk</span><span class="p">(</span><span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">mgr</span><span class="p">.</span><span class="nf">GetScheme</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Setup the logger.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">ctrlOptions</span><span class="p">.</span><span class="nx">Log</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctrlOptions</span><span class="p">.</span><span class="nx">Log</span> <span class="p">=</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">mgr</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctrlOptions</span><span class="p">.</span><span class="nx">Log</span> <span class="p">=</span> <span class="nx">ctrlOptions</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">WithValues</span><span class="p">(</span><span class="s">&#34;reconciler group&#34;</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">.</span><span class="nx">Group</span><span class="p">,</span> <span class="s">&#34;reconciler kind&#34;</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">.</span><span class="nx">Kind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Build the controller and return.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">blder</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">newController</span><span class="p">(</span><span class="nx">blder</span><span class="p">.</span><span class="nf">getControllerName</span><span class="p">(</span><span class="nx">gvk</span><span class="p">),</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">mgr</span><span class="p">,</span> <span class="nx">ctrlOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">mgr</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">Manager</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="nx">Controller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewUnmanaged</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Add the controller as a Manager components
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewUnmanaged</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">mgr</span> <span class="nx">manager</span><span class="p">.</span><span class="nx">Manager</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="nx">Controller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Reconciler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must specify Reconciler&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must specify Name for Controller&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Log</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">options</span><span class="p">.</span><span class="nx">Log</span> <span class="p">=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">MaxConcurrentReconciles</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">options</span><span class="p">.</span><span class="nx">MaxConcurrentReconciles</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">CacheSyncTimeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">options</span><span class="p">.</span><span class="nx">CacheSyncTimeout</span> <span class="p">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">RateLimiter</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">options</span><span class="p">.</span><span class="nx">RateLimiter</span> <span class="p">=</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nf">DefaultControllerRateLimiter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Inject dependencies into Reconciler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">SetFields</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">Reconciler</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create controller with dependencies set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">controller</span><span class="p">.</span><span class="nx">Controller</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Do</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Reconciler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MakeQueue</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nf">NewNamedRateLimitingQueue</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">RateLimiter</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MaxConcurrentReconciles</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">MaxConcurrentReconciles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">CacheSyncTimeout</span><span class="p">:</span>        <span class="nx">options</span><span class="p">.</span><span class="nx">CacheSyncTimeout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SetFields</span><span class="p">:</span>               <span class="nx">mgr</span><span class="p">.</span><span class="nx">SetFields</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Name</span><span class="p">:</span>                    <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Log</span><span class="p">:</span>                     <span class="nx">options</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">WithName</span><span class="p">(</span><span class="s">&#34;controller&#34;</span><span class="p">).</span><span class="nf">WithName</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>doController</code>调用<code>controller.New</code>来创建<code>controller</code>并添加到<code>manager</code>，在<code>NewUnmanaged</code>可以看到我们熟悉的配置，与上文<code>sample-controller</code>类似这里也设置了工作队列、最大Worker数等。</p>
<p><code>doWatch</code>代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">doWatch</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Reconcile type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">typeForSrc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">project</span><span class="p">(</span><span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">objectProjection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">src</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">typeForSrc</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hdler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestForObject</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">allPredicates</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">blder</span><span class="p">.</span><span class="nx">globalPredicates</span><span class="p">,</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">predicates</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">hdler</span><span class="p">,</span> <span class="nx">allPredicates</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Watches the managed types
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">own</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">ownsInput</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">typeForSrc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">project</span><span class="p">(</span><span class="nx">own</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span> <span class="nx">own</span><span class="p">.</span><span class="nx">objectProjection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">src</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="nx">typeForSrc</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">hdler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestForOwner</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">OwnerType</span><span class="p">:</span>    <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">object</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">IsController</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">allPredicates</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">([]</span><span class="nx">predicate</span><span class="p">.</span><span class="nf">Predicate</span><span class="p">(</span><span class="kc">nil</span><span class="p">),</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">globalPredicates</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">allPredicates</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">allPredicates</span><span class="p">,</span> <span class="nx">own</span><span class="p">.</span><span class="nx">predicates</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">hdler</span><span class="p">,</span> <span class="nx">allPredicates</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Do the watch requests
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">w</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">watchesInput</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">allPredicates</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">([]</span><span class="nx">predicate</span><span class="p">.</span><span class="nf">Predicate</span><span class="p">(</span><span class="kc">nil</span><span class="p">),</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">globalPredicates</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">allPredicates</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">allPredicates</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">predicates</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// If the source of this watch is of type *source.Kind, project it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">srckind</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">src</span><span class="p">.(</span><span class="o">*</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">typeForSrc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">project</span><span class="p">(</span><span class="nx">srckind</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">objectProjection</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">srckind</span><span class="p">.</span><span class="nx">Type</span> <span class="p">=</span> <span class="nx">typeForSrc</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">eventhandler</span><span class="p">,</span> <span class="nx">allPredicates</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>doWatch</code>以此<code>watch</code>当前资源，<code>ownsInput</code>资源（即owner为当前资源），以及通过<code>builder</code>传入的<code>watchsInput</code>，最后调用<code>ctrl.Watch</code>来注册。其中参数<code>eventhandler</code>为入队函数，如当前资源入队实现为<code>handler.EnqueueRequestForObject</code>，类似地<code>handler.EnqueueRequestForOwner</code>是将<code>owner</code>加入工作队列。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">EnqueueRequestForObject</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create implements EventHandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">EnqueueRequestForObject</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">evt</span> <span class="nx">event</span><span class="p">.</span><span class="nx">CreateEvent</span><span class="p">,</span> <span class="nx">q</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">Object</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">enqueueLog</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;CreateEvent received with no metadata&#34;</span><span class="p">,</span> <span class="s">&#34;event&#34;</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 加入队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">q</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">reconcile</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">NamespacedName</span><span class="p">:</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Name</span><span class="p">:</span>      <span class="nx">evt</span><span class="p">.</span><span class="nx">Object</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Namespace</span><span class="p">:</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">Object</span><span class="p">.</span><span class="nf">GetNamespace</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>Watch</code>实现如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">Watch</span><span class="p">(</span><span class="nx">src</span> <span class="nx">source</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">evthdler</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">EventHandler</span><span class="p">,</span> <span class="nx">prct</span> <span class="o">...</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">Predicate</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Inject Cache into arguments
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SetFields</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SetFields</span><span class="p">(</span><span class="nx">evthdler</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">prct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SetFields</span><span class="p">(</span><span class="nx">pr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">Started</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">startWatches</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">startWatches</span><span class="p">,</span> <span class="nx">watchDescription</span><span class="p">{</span><span class="nx">src</span><span class="p">:</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">handler</span><span class="p">:</span> <span class="nx">evthdler</span><span class="p">,</span> <span class="nx">predicates</span><span class="p">:</span> <span class="nx">prct</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting EventSource&#34;</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="nx">src</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">src</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">evthdler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Queue</span><span class="p">,</span> <span class="nx">prct</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ks</span> <span class="o">*</span><span class="nx">Kind</span><span class="p">)</span> <span class="nf">InjectCache</span><span class="p">(</span><span class="nx">c</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Cache</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ks</span><span class="p">.</span><span class="nx">cache</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ks</span><span class="p">.</span><span class="nx">cache</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ks</span> <span class="o">*</span><span class="nx">Kind</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">EventHandler</span><span class="p">,</span> <span class="nx">queue</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">prct</span> <span class="o">...</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">Predicate</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ks</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nf">GetInformer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ks</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">kindMatchErr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">meta</span><span class="p">.</span><span class="nx">NoKindMatchError</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;if kind is a CRD, it should be installed before calling Start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;kind&#34;</span><span class="p">,</span> <span class="nx">kindMatchErr</span><span class="p">.</span><span class="nx">GroupKind</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">i</span><span class="p">.</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="nx">internal</span><span class="p">.</span><span class="nx">EventHandler</span><span class="p">{</span><span class="nx">Queue</span><span class="p">:</span> <span class="nx">queue</span><span class="p">,</span> <span class="nx">EventHandler</span><span class="p">:</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">Predicates</span><span class="p">:</span> <span class="nx">prct</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// informer get 实现
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">InformersMap</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">gvk</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="o">*</span><span class="nx">MapEntry</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">obj</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">unstructured</span><span class="p">.</span><span class="nx">Unstructured</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">unstructured</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">unstructured</span><span class="p">.</span><span class="nx">UnstructuredList</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">unstructured</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">PartialObjectMetadata</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">PartialObjectMetadataList</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">structured</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">gvk</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 如果informer不存在则新创建一个，加入到informerMap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ip</span> <span class="o">*</span><span class="nx">specificInformersMap</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">gvk</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="o">*</span><span class="nx">MapEntry</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Return the informer if it is found
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">i</span><span class="p">,</span> <span class="nx">started</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">MapEntry</span><span class="p">,</span> <span class="kt">bool</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ip</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">i</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">informersByGVK</span><span class="p">[</span><span class="nx">gvk</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ip</span><span class="p">.</span><span class="nx">started</span><span class="p">,</span> <span class="nx">ok</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">started</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ip</span><span class="p">.</span><span class="nf">addInformerToMap</span><span class="p">(</span><span class="nx">gvk</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">started</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">started</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>Watch</code>通过<code>SetFeilds</code>方法注入<code>cache</code>, 最后添加到<code>controller</code>的<code>startWatches</code>队列，若已启动，调用<code>Start</code>方法配置回调函数<code>EventHandler</code>。</p>
<h3 id="manager启动" class="headerLink">
    <a href="#manager%e5%90%af%e5%8a%a8" class="header-mark"></a>Manager启动</h3><p>最后来看<code>Manager</code>启动流程</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cm</span> <span class="o">*</span><span class="nx">controllerManager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">cluster</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to add cluster to runnables: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cm</span><span class="p">.</span><span class="nx">internalCtx</span><span class="p">,</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">internalCancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">stopComplete</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">stopComplete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">stopErr</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">engageStopProcedure</span><span class="p">(</span><span class="nx">stopComplete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cm</span><span class="p">.</span><span class="nx">errChan</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">metricsListener</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">serveMetrics</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Serve health probes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">healthProbeListener</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">serveHealthProbes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">startNonLeaderElectionRunnables</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">resourceLock</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="o">:=</span> <span class="nx">cm</span><span class="p">.</span><span class="nf">startLeaderElection</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">cm</span><span class="p">.</span><span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Treat not having leader election enabled the same as being elected.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">cm</span><span class="p">.</span><span class="nf">startLeaderElectionRunnables</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nb">close</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">elected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// We are done
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">cm</span><span class="p">.</span><span class="nx">errChan</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Error starting or running a runnable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>主要流程包括：</p>
<ol>
<li>启动监控服务</li>
<li>启动健康检查服务</li>
<li>启动非选主服务</li>
<li>启动选主服务</li>
</ol>
<p>对于非选主服务，代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cm</span> <span class="o">*</span><span class="nx">controllerManager</span><span class="p">)</span> <span class="nf">startNonLeaderElectionRunnables</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cm</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cm</span><span class="p">.</span><span class="nf">waitForCache</span><span class="p">(</span><span class="nx">cm</span><span class="p">.</span><span class="nx">internalCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Start the non-leaderelection Runnables after the cache has synced
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">nonLeaderElectionRunnables</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cm</span><span class="p">.</span><span class="nf">startRunnable</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cm</span> <span class="o">*</span><span class="nx">controllerManager</span><span class="p">)</span> <span class="nf">waitForCache</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">started</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cache</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">caches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cm</span><span class="p">.</span><span class="nf">startRunnable</span><span class="p">(</span><span class="nx">cache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cache</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">caches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cache</span><span class="p">.</span><span class="nf">GetCache</span><span class="p">().</span><span class="nf">WaitForCacheSync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cm</span><span class="p">.</span><span class="nx">started</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>启动<code>cache</code>，启动其他服务，对于选主服务也类似，初始化<code>controller</code>时会加入到选主服务队列，即最后启动<code>Controller</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">Queue</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">MakeQueue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Queue</span><span class="p">.</span><span class="nf">ShutDown</span><span class="p">()</span> <span class="c1">// needs to be outside the iife so that we shutdown after the stop channel is closed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleCrash</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">watch</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">startWatches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting EventSource&#34;</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">src</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Queue</span><span class="p">,</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">predicates</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">watch</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">startWatches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">syncingSource</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">watch</span><span class="p">.</span><span class="nx">src</span><span class="p">.(</span><span class="nx">source</span><span class="p">.</span><span class="nx">SyncingSource</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// use a context with timeout for launching sources and syncing caches.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">sourceStartCtx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">CacheSyncTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syncingSource</span><span class="p">.</span><span class="nf">WaitForSync</span><span class="p">(</span><span class="nx">sourceStartCtx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">err</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to wait for %s caches to sync: %w&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nx">c</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Could not wait for Cache to sync&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="p">}();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">MaxConcurrentReconciles</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">UntilWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="nx">c</span><span class="p">.</span><span class="nf">processNextWorkItem</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">},</span> <span class="nx">c</span><span class="p">.</span><span class="nx">JitterPeriod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">Started</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Stopping workers&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">processNextWorkItem</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">obj</span><span class="p">,</span> <span class="nx">shutdown</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Queue</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nf">reconcileHandler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">reconcileHandler</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Make sure that the the object is a valid request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">req</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="nx">reconcile</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Do</span><span class="p">.</span><span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>Controller</code>启动主要包括</p>
<ol>
<li>等待cache同步</li>
<li>启动多个<code>processNextWorkItem</code></li>
<li>每个Worker调用<code>c.Do.Reconcile</code>来进行数据处理
与<code>sample-controller</code>工作流程一致，不断获取工作队列中的数据调用<code>Reconcile</code>进行调谐。</li>
</ol>
<h3 id="流程归纳" class="headerLink">
    <a href="#%e6%b5%81%e7%a8%8b%e5%bd%92%e7%ba%b3" class="header-mark"></a>流程归纳</h3><p>至此，通过<code>kubebuilder</code>生成代码的主要逻辑已经明朗，对比<code>sample-controller</code>其实整体流程类似，只是<code>kubebuilder</code>通过<code>controller-runtime</code>已经帮我们做了很多工作，如<code>client</code>、<code>cache</code>的初始化，<code>controller</code>的运行框架，我们只需要关心<code>Reconcile</code>逻辑即可。</p>
<ol>
<li>初始化<code>manager</code>，创建<code>client</code>与<code>cache</code></li>
<li>创建<code>controller</code>，对于监听资源会创建对应<code>informer</code>并添加回调函数</li>
<li>启动<code>manager</code>，启动<code>cache</code>与<code>controller</code></li>
</ol>
<h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h2><p><code>kubebuilder</code>大大简化了开发<code>Operator</code>的流程，了解其背后的原理有利于我们对<code>Operator</code>进行调优，能更好地应用于生产。</p>
<h2 id="引用" class="headerLink">
    <a href="#%e5%bc%95%e7%94%a8" class="header-mark"></a>引用</h2><ul>
<li><a href="https://github.com/kubernetes/sample-controller" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/sample-controller</a></li>
<li><a href="https://book.kubebuilder.io/architecture.html" target="_blank" rel="noopener noreffer">https://book.kubebuilder.io/architecture.html</a></li>
<li><a href="https://developer.aliyun.com/article/719215" target="_blank" rel="noopener noreffer">https://developer.aliyun.com/article/719215</a></li>
</ul></div>

        
        <div class="post-footer" id="post-footer">
    <div class="post-meta-line"><span class="single-tag">
                <a href='/tags/k8s/'>#k8s</a></span></div>

    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-link">
                <a href='/about'>About Me</a>
            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
        </div>
    </div><div class="post-nav"><a href="/how-to-write-a-k8s-operator/" class="prev" rel="prev" title="快速实现一个Kubernetes Operator"><i class="fas fa-angle-left fa-fw"></i>快速实现一个Kubernetes Operator</a>
            <a href="/k8s-clusterautoscaler-from-zero-issue/" class="next" rel="next" title="ClusterAutoScaler无法从零扩容">ClusterAutoScaler无法从零扩容<i class="fas fa-angle-right fa-fw"></i></a></div></div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qingwave.github.io" target="_blank" rel="noopener noreferrer">Qingwave</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-134548083-1', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"maxShownLines":-1},"comment":{"giscus":{"customTheme":"light","darkTheme":"dark","dataCategory":"Announcements","dataCategoryId":"DIC_kwDOCg97r84CBQfL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"qingwave/qingwave.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=","lightTheme":"light"}}};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script></div>
</body>

</html>