<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">
        容器内存分析
        
    </title><meta name="Description" content="Coding, Reading and Daydreaming"><meta property="og:title" content="容器内存分析" />
<meta property="og:description" content="背景在容器化环境中，平台需要提供准确的业务监控指标，已方便业务查看。那么如何准确计算容器或Pod的内存使用率，k8s/docker又是如何计算，本文通过实验与源码阅读相结合来分析容器的内存实际使用量。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qingwave.github.io/container-memory/" /><meta property="og:image" content="https://qingwave.github.io/img/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-29T14:37:21+00:00" />
<meta property="article:modified_time" content="2021-11-20T10:59:07+00:00" /><meta property="og:site_name" content="Qingwave" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://qingwave.github.io/img/favicon.png"/>

<meta name="twitter:title" content="容器内存分析"/>
<meta name="twitter:description" content="背景在容器化环境中，平台需要提供准确的业务监控指标，已方便业务查看。那么如何准确计算容器或Pod的内存使用率，k8s/docker又是如何计算，本文通过实验与源码阅读相结合来分析容器的内存实际使用量。"/>
<meta name="application-name" content="Qingwave">
<meta name="apple-mobile-web-app-title" content="Qingwave">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://qingwave.github.io/container-memory/" /><link rel="prev" href="https://qingwave.github.io/k8s-docker-stack/" /><link rel="next" href="https://qingwave.github.io/k8s-limit-fd-and-thread1/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><meta name="google-site-verification" content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" /><meta name="baidu-site-verification" content="muFp3xopwC" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "容器内存分析",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qingwave.github.io\/container-memory\/"
        },"genre": "posts","keywords": "k8s, docker, cgroup","wordcount":  1518 ,
        "url": "https:\/\/qingwave.github.io\/container-memory\/","datePublished": "2019-05-29T14:37:21+00:00","dateModified": "2021-11-20T10:59:07+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Qingwave"
            },"description": ""
    }
    </script></head>

<body header-desktop="normal" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span><span class="header-title-post"> Time</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#预备知识">预备知识</a></li>
    <li><a href="#查看源码">查看源码</a>
      <ul>
        <li><a href="#docker-stat">docker stat</a></li>
        <li><a href="#kubectl-top">kubectl top</a></li>
      </ul>
    </li>
    <li><a href="#实验">实验</a></li>
    <li><a href="#结论">结论</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title">容器内存分析</h1><div class="post-meta">
            <div class="post-meta-line"><time datetime="May 29, 2019">May 29, 2019</time>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#预备知识">预备知识</a></li>
    <li><a href="#查看源码">查看源码</a>
      <ul>
        <li><a href="#docker-stat">docker stat</a></li>
        <li><a href="#kubectl-top">kubectl top</a></li>
      </ul>
    </li>
    <li><a href="#实验">实验</a></li>
    <li><a href="#结论">结论</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="背景" class="headerLink">
    <a href="#%e8%83%8c%e6%99%af" class="header-mark"></a>背景</h2><p>在容器化环境中，平台需要提供准确的业务监控指标，已方便业务查看。那么如何准确计算容器或Pod的内存使用率，k8s/docker又是如何计算，本文通过实验与源码阅读相结合来分析容器的内存实际使用量。</p>
<h2 id="预备知识" class="headerLink">
    <a href="#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86" class="header-mark"></a>预备知识</h2><p>不管docker还是k8s(通过cadvisor)最终都通过cgroup的memory group来得到内存的原始文件，memory相关的主要文件如下:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cgroup.event_control       #用于eventfd的接口
</span></span><span class="line"><span class="cl">memory.usage_in_bytes      #显示当前已用的内存
</span></span><span class="line"><span class="cl">memory.limit_in_bytes      #设置/显示当前限制的内存额度
</span></span><span class="line"><span class="cl">memory.failcnt             #显示内存使用量达到限制值的次数
</span></span><span class="line"><span class="cl">memory.max_usage_in_bytes  #历史内存最大使用量
</span></span><span class="line"><span class="cl">memory.soft_limit_in_bytes #设置/显示当前限制的内存软额度
</span></span><span class="line"><span class="cl">memory.stat                #显示当前cgroup的内存使用情况
</span></span><span class="line"><span class="cl">memory.use_hierarchy       #设置/显示是否将子cgroup的内存使用情况统计到当前cgroup里面
</span></span><span class="line"><span class="cl">memory.force_empty         #触发系统立即尽可能的回收当前cgroup中可以回收的内存
</span></span><span class="line"><span class="cl">memory.pressure_level      #设置内存压力的通知事件，配合cgroup.event_control一起使用
</span></span><span class="line"><span class="cl">memory.swappiness          #设置和显示当前的swappiness
</span></span><span class="line"><span class="cl">memory.move_charge_at_immigrate #设置当进程移动到其他cgroup中时，它所占用的内存是否也随着移动过去
</span></span><span class="line"><span class="cl">memory.oom_control         #设置/显示oom controls相关的配置
</span></span><span class="line"><span class="cl">memory.numa_stat           #显示numa相关的内存
</span></span></code></pre></div><p>更多信息可参考<a href="https://qingwave.github.io/2018/11/15/Pod-memory-usage-in-k8s/#Cadvisor%E4%B8%AD%E6%9C%89%E5%85%B3pod%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87%E7%9A%84%E6%8C%87%E6%A0%87" target="_blank" rel="noopener noreffer">Pod memory usage in k8s</a></p>
<h2 id="查看源码" class="headerLink">
    <a href="#%e6%9f%a5%e7%9c%8b%e6%ba%90%e7%a0%81" class="header-mark"></a>查看源码</h2><h3 id="docker-stat" class="headerLink">
    <a href="#docker-stat" class="header-mark"></a>docker stat</h3><p>docker stat的源码在<a href="https://github.com/docker/cli/blob/37f9a88c696ae81be14c1697bd083d6421b4933c/cli/command/container/stats_helpers.go#L233" target="_blank" rel="noopener noreffer">stats_helpers.go</a>,如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">calculateMemUsageUnixNoCache</span><span class="p">(</span><span class="nx">mem</span> <span class="nx">types</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">)</span> <span class="kt">float64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">mem</span><span class="p">.</span><span class="nx">Usage</span> <span class="o">-</span> <span class="nx">mem</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;cache&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>内存使用量为<code>memory.usage=memory.usage_in_bytes-cache</code></p>
<h3 id="kubectl-top" class="headerLink">
    <a href="#kubectl-top" class="header-mark"></a>kubectl top</h3><p>在k8s中，<code>kubectl top</code>命令通过<code>metric-server/heapster</code>获取cadvisor中<code>working_set</code>的值，来表示Pod实例使用内存大小(不包括pause),metrics-server 中<a href="https://github.com/kubernetes-sigs/metrics-server/blob/d4432d67b2fc435b9c71a89c13659882008a4c54/pkg/sources/summary/summary.go#L206" target="_blank" rel="noopener noreffer">pod内存</a>获取如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">decodeMemory</span><span class="p">(</span><span class="nx">target</span> <span class="o">*</span><span class="nx">resource</span><span class="p">.</span><span class="nx">Quantity</span><span class="p">,</span> <span class="nx">memStats</span> <span class="o">*</span><span class="nx">stats</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">memStats</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">memStats</span><span class="p">.</span><span class="nx">WorkingSetBytes</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;missing memory usage metric&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="nx">target</span> <span class="p">=</span> <span class="o">*</span><span class="nf">uint64Quantity</span><span class="p">(</span><span class="o">*</span><span class="nx">memStats</span><span class="p">.</span><span class="nx">WorkingSetBytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">target</span><span class="p">.</span><span class="nx">Format</span> <span class="p">=</span> <span class="nx">resource</span><span class="p">.</span><span class="nx">BinarySI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>cadvisor中<a href="https://github.com/google/cadvisor/blob/0ff17b8d0df3712923c46ca484701b876d02dfee/container/libcontainer/handler.go#L706" target="_blank" rel="noopener noreffer">working_set</a>计算如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">setMemoryStats</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">cgroups</span><span class="p">.</span><span class="nx">Stats</span><span class="p">,</span> <span class="nx">ret</span> <span class="o">*</span><span class="nx">info</span><span class="p">.</span><span class="nx">ContainerStats</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Usage</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Usage</span><span class="p">.</span><span class="nx">Usage</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">MaxUsage</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Usage</span><span class="p">.</span><span class="nx">MaxUsage</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Failcnt</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Usage</span><span class="p">.</span><span class="nx">Failcnt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">UseHierarchy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Cache</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;total_cache&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">RSS</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;total_rss&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Swap</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;total_swap&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">MappedFile</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;total_mapped_file&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Cache</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;cache&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">RSS</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;rss&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Swap</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;swap&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">MappedFile</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;mapped_file&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;pgfault&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">ContainerData</span><span class="p">.</span><span class="nx">Pgfault</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">HierarchicalData</span><span class="p">.</span><span class="nx">Pgfault</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;pgmajfault&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">ContainerData</span><span class="p">.</span><span class="nx">Pgmajfault</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">HierarchicalData</span><span class="p">.</span><span class="nx">Pgmajfault</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">workingSet</span> <span class="o">:=</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">Usage</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">MemoryStats</span><span class="p">.</span><span class="nx">Stats</span><span class="p">[</span><span class="s">&#34;total_inactive_file&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">workingSet</span> <span class="p">&lt;</span> <span class="nx">v</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">workingSet</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">workingSet</span> <span class="o">-=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ret</span><span class="p">.</span><span class="nx">Memory</span><span class="p">.</span><span class="nx">WorkingSet</span> <span class="p">=</span> <span class="nx">workingSet</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>working_set=memory.usage_in_bytes-total_inactive_file (&gt;=0)</code>
在kubelet中节点内存不足时同样以<code>working_set</code>判断pod是否OOM的标准</p>
<h2 id="实验" class="headerLink">
    <a href="#%e5%ae%9e%e9%aa%8c" class="header-mark"></a>实验</h2><ol>
<li>创建Pod
Pod的资源申请如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>查看cgroup内存情况
找到容器某个进程，查看memory cgroup</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># cat /proc/16062/cgroup </span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">8:memory:/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod21a55da5_f9f8_11e9_b051_fa163e7e981a.slice/docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope
</span></span></code></pre></div><p>进入容器memory cgroup对应的目录</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope]# ls
</span></span><span class="line"><span class="cl">cgroup.clone_children  memory.kmem.failcnt             memory.kmem.tcp.limit_in_bytes      memory.max_usage_in_bytes        memory.move_charge_at_immigrate  memory.stat            tasks
</span></span><span class="line"><span class="cl">cgroup.event_control   memory.kmem.limit_in_bytes      memory.kmem.tcp.max_usage_in_bytes  memory.memsw.failcnt             memory.numa_stat                 memory.swappiness
</span></span><span class="line"><span class="cl">cgroup.procs           memory.kmem.max_usage_in_bytes  memory.kmem.tcp.usage_in_bytes      memory.memsw.limit_in_bytes      memory.oom_control               memory.usage_in_bytes
</span></span><span class="line"><span class="cl">memory.failcnt         memory.kmem.slabinfo            memory.kmem.usage_in_bytes          memory.memsw.max_usage_in_bytes  memory.pressure_level            memory.use_hierarchy
</span></span><span class="line"><span class="cl">memory.force_empty     memory.kmem.tcp.failcnt         memory.limit_in_bytes               memory.memsw.usage_in_bytes      memory.soft_limit_in_bytes       notify_on_release
</span></span></code></pre></div><p>查看主要memory文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># cat memory.limit_in_bytes (容器memory limit值，即1Gi)</span>
</span></span><span class="line"><span class="cl"><span class="m">1073741824</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node01 docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># cat memory.kmem.limit_in_bytes (容器内核使用memory limit值)</span>
</span></span><span class="line"><span class="cl"><span class="m">9223372036854771712</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node01 docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># </span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@node01 docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># cat memory.soft_limit_in_bytes</span>
</span></span><span class="line"><span class="cl"><span class="m">9223372036854771712</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># cat notify_on_release</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># cat memory.oom_control </span>
</span></span><span class="line"><span class="cl">oom_kill_disable <span class="m">0</span>
</span></span><span class="line"><span class="cl">under_oom <span class="m">0</span>
</span></span><span class="line"><span class="cl">oom_kill <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># cat memory.usage_in_bytes </span>
</span></span><span class="line"><span class="cl"><span class="m">2265088</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># cat memory.kmem.usage_in_bytes </span>
</span></span><span class="line"><span class="cl"><span class="m">901120</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>docker-57ba1991ab4ba50a9b2eaf5bf90e2c20073198d767653becf77d55ee25e1a6f9.scope<span class="o">]</span><span class="c1"># cat memory.stat </span>
</span></span><span class="line"><span class="cl">cache <span class="m">12288</span>
</span></span><span class="line"><span class="cl">rss <span class="m">1351680</span>
</span></span><span class="line"><span class="cl">rss_huge <span class="m">0</span>
</span></span><span class="line"><span class="cl">shmem <span class="m">4096</span>
</span></span><span class="line"><span class="cl">mapped_file <span class="m">4096</span>
</span></span><span class="line"><span class="cl">dirty <span class="m">0</span>
</span></span><span class="line"><span class="cl">writeback <span class="m">0</span>
</span></span><span class="line"><span class="cl">swap <span class="m">0</span>
</span></span><span class="line"><span class="cl">pgpgin <span class="m">4544</span>
</span></span><span class="line"><span class="cl">pgpgout <span class="m">4211</span>
</span></span><span class="line"><span class="cl">pgfault <span class="m">1948</span>
</span></span><span class="line"><span class="cl">pgmajfault <span class="m">0</span>
</span></span><span class="line"><span class="cl">inactive_anon <span class="m">4096</span>
</span></span><span class="line"><span class="cl">active_anon <span class="m">1351680</span>
</span></span><span class="line"><span class="cl">inactive_file <span class="m">8192</span>
</span></span><span class="line"><span class="cl">active_file <span class="m">0</span>
</span></span><span class="line"><span class="cl">unevictable <span class="m">0</span>
</span></span><span class="line"><span class="cl">hierarchical_memory_limit <span class="m">1073741824</span>
</span></span><span class="line"><span class="cl">hierarchical_memsw_limit <span class="m">1073741824</span>
</span></span><span class="line"><span class="cl">total_cache <span class="m">12288</span>
</span></span><span class="line"><span class="cl">total_rss <span class="m">1351680</span>
</span></span><span class="line"><span class="cl">total_rss_huge <span class="m">0</span>
</span></span><span class="line"><span class="cl">total_shmem <span class="m">4096</span>
</span></span><span class="line"><span class="cl">total_mapped_file <span class="m">4096</span>
</span></span><span class="line"><span class="cl">total_dirty <span class="m">0</span>
</span></span><span class="line"><span class="cl">total_writeback <span class="m">0</span>
</span></span><span class="line"><span class="cl">total_swap <span class="m">0</span>
</span></span><span class="line"><span class="cl">total_pgpgin <span class="m">4544</span>
</span></span><span class="line"><span class="cl">total_pgpgout <span class="m">4211</span>
</span></span><span class="line"><span class="cl">total_pgfault <span class="m">1948</span>
</span></span><span class="line"><span class="cl">total_pgmajfault <span class="m">0</span>
</span></span><span class="line"><span class="cl">total_inactive_anon <span class="m">4096</span>
</span></span><span class="line"><span class="cl">total_active_anon <span class="m">1351680</span>
</span></span><span class="line"><span class="cl">total_inactive_file <span class="m">8192</span>
</span></span><span class="line"><span class="cl">total_active_file <span class="m">0</span>
</span></span><span class="line"><span class="cl">total_unevictable <span class="m">0</span>
</span></span></code></pre></div><p>根据memory可得到如下关系：
<code>memory.usage_in_bytes = memory.kmem.usage_in_bytes + rss + cache</code>
即2265088=901120+1351680+12288</p>
<p>那么容器的真实内存即：
<code>memory.usage=memory.usage_in_bytes-cache</code>
即<code>rss+kmem_usage</code></p>
<p>通过<code>docker stat</code>查看，与公式相符合</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CONTAINER ID        NAME                                                                                     CPU %               MEM USAGE / LIMIT   MEM %               NET I/O             BLOCK I/O           PIDS
</span></span><span class="line"><span class="cl">57ba1991ab4b        k8s...default_21a55da5-f9f8-11e9-b051-fa163e7e981a_0   0.00%               2.148MiB / 1GiB     0.21%               12MB / 68.8MB       0B / 0B             2
</span></span></code></pre></div><h2 id="结论" class="headerLink">
    <a href="#%e7%bb%93%e8%ae%ba" class="header-mark"></a>结论</h2><p>实际环境中，docker与k8s两种内存表示方式不同，一般<code>docker stat</code>总体值会小于<code>kubectl top</code></p>
<ul>
<li>docker中内存表示为：
<code>memory.usage = memory.usage_in_bytes - cache</code></li>
<li>k8s中：
<code>memory.usage = working_set = memory.usage_in_bytes - total_inactive_file (&gt;=0)</code>
根据cgroup memory关系有：
<code>memory.usage_in_bytes = memory.kmem.usage_in_bytes + rss + cache</code></li>
</ul>
<p>真实环境中两种表示相差不大，但更推荐使用<code>working_set</code>作为容器内存真实使用量(kubelt判断OOM的依据)，
则容器内存使用率可表示为：
<code>container_memory_working_set_bytes / memory.limit_in_bytes</code></p>
<h2 id="参考" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>参考</h2><ol>
<li><a href="https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt" target="_blank" rel="noopener noreffer">https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt</a></li>
<li><a href="https://medium.com/@zhimin.wen/memory-limit-of-pod-and-oom-killer-891ee1f1cad8" target="_blank" rel="noopener noreffer">https://medium.com/@zhimin.wen/memory-limit-of-pod-and-oom-killer-891ee1f1cad8</a></li>
</ol>
</div>

        
        <div class="post-footer" id="post-footer">
    <div class="post-meta-line"><span class="single-tag">
                <a href='/tags/k8s/'>#k8s</a>
                    <span class="separator"> </span>
                <a href='/tags/docker/'>#docker</a>
                    <span class="separator"> </span>
                <a href='/tags/cgroup/'>#cgroup</a></span></div>

    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-link">
                <a href='/about'>About Me</a>
            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
        </div>
    </div><div class="post-nav"><a href="/k8s-docker-stack/" class="prev" rel="prev" title="k8s与docker组件堆栈及Debug"><i class="fas fa-angle-left fa-fw"></i>k8s与docker组件堆栈及Debug</a>
            <a href="/k8s-limit-fd-and-thread1/" class="next" rel="next" title="k8s中fd与thread限制(一)">k8s中fd与thread限制(一)<i class="fas fa-angle-right fa-fw"></i></a></div></div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qingwave.github.io" target="_blank" rel="noopener noreferrer">Qingwave</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-134548083-1', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"maxShownLines":-1},"comment":{"giscus":{"customTheme":"light","darkTheme":"dark","dataCategory":"Announcements","dataCategoryId":"DIC_kwDOCg97r84CBQfL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"qingwave/qingwave.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=","lightTheme":"light"}}};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script></div>
</body>

</html>