<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">
        捕获Kubernetes中Pod驱逐事件
        
    </title><meta name="Description" content="Coding, Reading and Daydreaming"><meta property="og:title" content="捕获Kubernetes中Pod驱逐事件" />
<meta property="og:description" content="最近在工作中需要捕获Kubernetes的Pod驱逐事件，再做额外的操作。第一个想法是能不能监听（watch）驱逐对象（Eviction Resource），很遗憾Eviction并没有watch接口，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qingwave.github.io/k8s-watch-eviction-event/" /><meta property="og:image" content="https://qingwave.github.io/img/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-08T08:36:52+00:00" />
<meta property="article:modified_time" content="2022-07-08T10:37:19+00:00" /><meta property="og:site_name" content="Qingwave" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://qingwave.github.io/img/favicon.png"/>

<meta name="twitter:title" content="捕获Kubernetes中Pod驱逐事件"/>
<meta name="twitter:description" content="最近在工作中需要捕获Kubernetes的Pod驱逐事件，再做额外的操作。第一个想法是能不能监听（watch）驱逐对象（Eviction Resource），很遗憾Eviction并没有watch接口，"/>
<meta name="application-name" content="Qingwave">
<meta name="apple-mobile-web-app-title" content="Qingwave">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://qingwave.github.io/k8s-watch-eviction-event/" /><link rel="prev" href="https://qingwave.github.io/openpolicyagent-vs-casbin/" /><link rel="next" href="https://qingwave.github.io/golang-distributed-system-x-redis/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><meta name="google-site-verification" content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" /><meta name="baidu-site-verification" content="muFp3xopwC" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "捕获Kubernetes中Pod驱逐事件",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qingwave.github.io\/k8s-watch-eviction-event\/"
        },"genre": "posts","keywords": "k8s","wordcount":  1208 ,
        "url": "https:\/\/qingwave.github.io\/k8s-watch-eviction-event\/","datePublished": "2022-07-08T08:36:52+00:00","dateModified": "2022-07-08T10:37:19+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Qingwave"
            },"description": ""
    }
    </script></head>

<body header-desktop="normal" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span><span class="header-title-post"> Time</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#实现">实现</a>
      <ul>
        <li><a href="#生成项目">生成项目</a></li>
        <li><a href="#编写webhook">编写Webhook</a></li>
        <li><a href="#测试">测试</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title">捕获Kubernetes中Pod驱逐事件</h1><div class="post-meta">
            <div class="post-meta-line"><time datetime="Jul 08, 2022">Jul 08, 2022</time>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#实现">实现</a>
      <ul>
        <li><a href="#生成项目">生成项目</a></li>
        <li><a href="#编写webhook">编写Webhook</a></li>
        <li><a href="#测试">测试</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>最近在工作中需要捕获Kubernetes的Pod驱逐事件，再做额外的操作。第一个想法是能不能监听（watch）驱逐对象（Eviction Resource），很遗憾Eviction并没有watch接口，只是Pod下的一个子资源，和Scale、Status类似。等等，既然是子资源那能不能通过Webhook获取。</p>
<h2 id="实现" class="headerLink">
    <a href="#%e5%ae%9e%e7%8e%b0" class="header-mark"></a>实现</h2><p>峰回路转，在<a href="https://github.com/kubernetes/kubernetes/pull/76910" target="_blank" rel="noopener noreffer">kubernetes#pr76910</a>中已经实现对pod/eviction子资源的支持。</p>
<p>简单验证一下</p>
<h3 id="生成项目" class="headerLink">
    <a href="#%e7%94%9f%e6%88%90%e9%a1%b9%e7%9b%ae" class="header-mark"></a>生成项目</h3><p>通过kubebuilder快速生成项目</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubebuilder init --component-config --domain qinng.io --repo github.com/qingwave/k8s
</span></span><span class="line"><span class="cl">-eviction-operator
</span></span></code></pre></div><h3 id="编写webhook" class="headerLink">
    <a href="#%e7%bc%96%e5%86%99webhook" class="header-mark"></a>编写Webhook</h3><p>由于pod/eviction不是自定义资源，无法通过kubebuilder直接生成，可按照如下逻辑生成ValidatingAdmissionWebhook</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">webhook</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/go-logr/logr&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">admissionv1</span> <span class="s">&#34;k8s.io/api/admission/v1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">corev1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">policyv1</span> <span class="s">&#34;k8s.io/api/policy/v1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1/unstructured&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;k8s.io/apimachinery/pkg/types&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctrl</span> <span class="s">&#34;sigs.k8s.io/controller-runtime&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/webhook&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;sigs.k8s.io/controller-runtime/pkg/webhook/admission&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">WebhookName</span>  <span class="p">=</span> <span class="s">&#34;Eviction&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">EvictionKind</span> <span class="p">=</span> <span class="s">&#34;Eviction&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// rbac注解与webhook注解
</span></span></span><span class="line"><span class="cl"><span class="c1">// +kubebuilder:rbac:groups=&#34;&#34;,resources=pods,verbs=get;list
</span></span></span><span class="line"><span class="cl"><span class="c1">// +kubebuilder:webhook:path=/validate-v1-pod-eviction,admissionReviewVersions=v1;v1beta1,sideEffects=NoneOnDryRun,matchPolicy=Equivalent,mutating=false,failurePolicy=fail,groups=&#34;&#34;,resources=pods/eviction,verbs=create,versions=v1,name=veviction.kb.io
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// EvictionValidator validates Pods Eviction event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">EvictionValidator</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">scheme</span>  <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span>  <span class="nx">client</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span>     <span class="nx">logr</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl">	<span class="nx">decoder</span> <span class="o">*</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Decoder</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// EvictionValidator 解析Eviction, 格式化返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">EvictionValidator</span><span class="p">)</span> <span class="nf">Handle</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">WithValues</span><span class="p">(</span><span class="s">&#34;eviction&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s/%s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;start handle eviction&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Operation</span> <span class="o">!=</span> <span class="nx">admissionv1</span><span class="p">.</span><span class="nx">Create</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;skip none create request, verb: %s&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Operation</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">Allowed</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">DryRun</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="nx">req</span><span class="p">.</span><span class="nx">DryRun</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;skip dry run request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">Allowed</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Kind</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">!=</span> <span class="nx">EvictionKind</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;expected request %s but got %s&#34;</span><span class="p">,</span> <span class="nx">EvictionKind</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Kind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">Errored</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected kind %v&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Kind</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">eviction</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">getEviction</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to decode eviction&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">Errored</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;reveice new obj, obj: %+#v&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">eviction</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">eviction</span><span class="p">.</span><span class="nx">DeleteOptions</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">eviction</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">.</span><span class="nx">DryRun</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;skip eviction dry run request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">Allowed</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">handleEviction</span><span class="p">(</span><span class="nx">eviction</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">Errored</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;handle eviction success&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">admission</span><span class="p">.</span><span class="nf">Allowed</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// EvictionValidator implements admission.DecoderInjector.
</span></span></span><span class="line"><span class="cl"><span class="c1">// A decoder will be automatically injected.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// InjectDecoder injects the decoder.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">EvictionValidator</span><span class="p">)</span> <span class="nf">InjectDecoder</span><span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">admission</span><span class="p">.</span><span class="nx">Decoder</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">v</span><span class="p">.</span><span class="nx">decoder</span> <span class="p">=</span> <span class="nx">d</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 解析Eviction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">EvictionValidator</span><span class="p">)</span> <span class="nf">getEviction</span><span class="p">(</span><span class="nx">req</span> <span class="nx">admission</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">policyv1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">obj</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">unstructured</span><span class="p">.</span><span class="nx">Unstructured</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">obj</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">eviction</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">policyv1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">scheme</span><span class="p">.</span><span class="nf">Convert</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">eviction</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">eviction</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 处理驱逐事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">v</span> <span class="o">*</span><span class="nx">EvictionValidator</span><span class="p">)</span> <span class="nf">handleEviction</span><span class="p">(</span><span class="nx">eviction</span> <span class="o">*</span><span class="nx">policyv1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">podNamespacedName</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span><span class="nx">Namespace</span><span class="p">:</span> <span class="nx">eviction</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="nx">eviction</span><span class="p">.</span><span class="nx">Name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pod</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">podNamespacedName</span><span class="p">,</span> <span class="nx">pod</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">v</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;get eviction pod: %#v&#34;</span><span class="p">,</span> <span class="nx">pod</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册Webhook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewEvictionWebhook</span><span class="p">(</span><span class="nx">mgr</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Manager</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">EvictionValidator</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scheme</span><span class="p">:</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetScheme</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">:</span> <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetClient</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">:</span>    <span class="nx">mgr</span><span class="p">.</span><span class="nf">GetLogger</span><span class="p">().</span><span class="nf">WithName</span><span class="p">(</span><span class="nx">WebhookName</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mgr</span><span class="p">.</span><span class="nf">GetWebhookServer</span><span class="p">().</span><span class="nf">Register</span><span class="p">(</span><span class="s">&#34;/validate-v1-pod-eviction&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">webhook</span><span class="p">.</span><span class="nx">Admission</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Handler</span><span class="p">:</span> <span class="nx">w</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>特别注意的是，Eviction包括v1、v1beat1两个版本，解析时需要可以全部转换为v1方便处理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">webhook</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">policyv1</span> <span class="s">&#34;k8s.io/api/policy/v1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">policyv1beta1</span> <span class="s">&#34;k8s.io/api/policy/v1beta1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;k8s.io/apimachinery/pkg/conversion&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">RegisterConversion</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nf">AddConversionFunc</span><span class="p">((</span><span class="o">*</span><span class="nx">policyv1beta1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="p">(</span><span class="o">*</span><span class="nx">policyv1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">scope</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">ConvertV1beta1EvictionToV1Eviction</span><span class="p">(</span><span class="nx">a</span><span class="p">.(</span><span class="o">*</span><span class="nx">policyv1beta1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">),</span> <span class="nx">b</span><span class="p">.(</span><span class="o">*</span><span class="nx">policyv1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">),</span> <span class="nx">scope</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 注册转换函数v1beta1-&gt;v1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">ConvertV1beta1EvictionToV1Eviction</span><span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">policyv1beta1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">,</span> <span class="nx">out</span> <span class="o">*</span><span class="nx">policyv1</span><span class="p">.</span><span class="nx">Eviction</span><span class="p">,</span> <span class="nx">s</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">Scope</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">ObjectMeta</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span><span class="p">.</span><span class="nx">DeleteOptions</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">.</span><span class="nf">DeepCopy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>至此，大体框架完成，需要部署建议使用cert-manager来注入证书，不需要自己手动再生成。</p>
<h3 id="测试" class="headerLink">
    <a href="#%e6%b5%8b%e8%af%95" class="header-mark"></a>测试</h3><p>通过<a href="https://github.com/ueokande/kubectl-evict" target="_blank" rel="noopener noreffer">kubectl-evict</a>驱逐pod，在operator日志中显示已捕获事件：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1.6572752110781207e+09  DEBUG   controller-runtime.webhook.webhooks     received request        {&#34;webhook&#34;: &#34;/validate-v1-pod-eviction&#34;, &#34;UID&#34;: &#34;4f98f064-97c1-4ada-a9d8-0946afb11eba&#34;, &#34;kind&#34;: &#34;policy/v1beta1, Kind=Eviction&#34;, &#34;resource&#34;: {&#34;group&#34;:&#34;&#34;,&#34;version&#34;:&#34;v1&#34;,&#34;resource&#34;:&#34;pods&#34;}}
</span></span><span class="line"><span class="cl">1.6572752110781898e+09  INFO    Eviction        start handle eviction   {&#34;eviction&#34;: &#34;default/nginx-6799fc88d8-drkc4&#34;}
</span></span><span class="line"><span class="cl">1.6572752110787241e+09  INFO    Eviction        reveice new obj, obj: v1.Eviction{TypeMeta:v1.TypeMeta{Kind:&#34;&#34;, APIVersion:&#34;&#34;}, ObjectMeta:v1.ObjectMeta{Name:&#34;nginx-6799fc88d8-drkc4&#34;, GenerateName:&#34;&#34;, Namespace:&#34;default&#34;, SelfLink:&#34;&#34;, UID:&#34;&#34;, ResourceVersion:&#34;&#34;, Generation:0, CreationTimestamp:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), DeletionTimestamp:&lt;nil&gt;, DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string(nil), OwnerReferences:[]v1.OwnerReference(nil), Finalizers:[]string(nil), ZZZ_DeprecatedClusterName:&#34;&#34;, ManagedFields:[]v1.ManagedFieldsEntry{v1.ManagedFieldsEntry{Manager:&#34;kubectl-evict&#34;, Operation:&#34;Update&#34;, APIVersion:&#34;policy/v1beta1&#34;, Time:time.Date(2022, time.July, 8, 10, 13, 31, 0, time.Local), FieldsType:&#34;FieldsV1&#34;, FieldsV1:(*v1.FieldsV1)(0xc000479a10), Subresource:&#34;&#34;}}}, DeleteOptions:(*v1.DeleteOptions)(0xc00060dc20)}    {&#34;eviction&#34;: &#34;default/nginx-6799fc88d8-drkc4&#34;}
</span></span><span class="line"><span class="cl">1.6572752111794329e+09  INFO    Eviction        get eviction pod: &amp;v1.Pod{TypeMeta:v1.TypeMeta{Kind:&#34;Pod&#34;, APIVersion:&#34;v1&#34;}, ObjectMeta:v1.ObjectMeta{Name:&#34;nginx-6799fc88d8-drkc4&#34;...
</span></span></code></pre></div><h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h2><p>通过Webhook可以实现对驱逐事件的捕捉，但也有一些地方需要注意</p>
<ul>
<li>如果处理逻辑比较复杂，尽量通过Webhook生成其他资源如CRD，Controller监听CRD再来处理其他的处理，防止Webhook处理超时，而且Controller遇到异常会再次重试</li>
<li>目前Webhook对于Eviction子资源，无法通过<code>objectSelector</code>选择特定的Pod，除非调用者在Eviction对象中包含了Pod的Labels</li>
</ul>
<blockquote>
<p>Explore more in <a href="https://qingwave.github.io" target="_blank" rel="noopener noreffer">https://qingwave.github.io</a></p>
</blockquote>
</div>

        
        <div class="post-footer" id="post-footer">
    <div class="post-meta-line"><span class="single-tag">
                <a href='/tags/k8s/'>#k8s</a></span></div>

    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-link">
                <a href='/about'>About Me</a>
            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
        </div>
    </div><div class="post-nav"><a href="/openpolicyagent-vs-casbin/" class="prev" rel="prev" title="Open Policy Agent vs Casbin"><i class="fas fa-angle-left fa-fw"></i>Open Policy Agent vs Casbin</a>
            <a href="/golang-distributed-system-x-redis/" class="next" rel="next" title="Golang分布式应用之Redis">Golang分布式应用之Redis<i class="fas fa-angle-right fa-fw"></i></a></div></div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qingwave.github.io" target="_blank" rel="noopener noreferrer">Qingwave</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-134548083-1', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"maxShownLines":-1},"comment":{"giscus":{"customTheme":"light","darkTheme":"dark","dataCategory":"Announcements","dataCategoryId":"DIC_kwDOCg97r84CBQfL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"qingwave/qingwave.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=","lightTheme":"light"}}};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script></div>
</body>

</html>