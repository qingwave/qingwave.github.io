<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=zh><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>可能是史上最全的Kubernetes证书解析</title><meta content=index,follow name=robots /><link href=https://qingwave.github.io/k8s-tls/ rel=canonical /><meta content=可能是史上最全的Kubernetes证书解析 property=og:title /><meta content=https://qingwave.github.io/k8s-tls/ property=og:url /><meta content=article property=og:type /><meta content=https://qingwave.github.io/ property=og:image /><meta content=可能是史上最全的Kubernetes证书解析 property=og:image:alt /><meta content=summary_large_image name=twitter:card /><style is:global>:root{--aw-font-sans:'Inter Variable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI name=google-site-verification><script src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async type=text/partytown></script><script type=text/partytown>(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.svg rel=mask-icon color=#8D46E7><link href=/sitemap-index.xml rel=sitemap><link href=/_astro/_page_.aC8vaGVh.css rel=stylesheet><link href=/_astro/_page_.BMI96bO2.css rel=stylesheet><script src=/_astro/hoisted.DNuUAAyM.js type=module></script><script>!function(t,e,n,r){(window.crossOriginIsolated||navigator.serviceWorker)&&((r=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(r[n]||[]).concat(["dataLayer.push"]))}(window,"partytown","forward");const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((()=>{const t=new Set;let e=[];do{Object.getOwnPropertyNames(e).forEach((n=>{"function"==typeof e[n]&&t.add(n)}))}while((e=Object.getPrototypeOf(e))!==Object.prototype);return Array.from(t)})());!function(t,r,o,i,a,s,c,d,l,p,u=t,y){function f(){y||(y=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(l=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(h,1e4),r.addEventListener("pt0",b),a?w(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):h())))}function w(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.10.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function h(n,o){for(b(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<l.length;n++)(o=r.createElement("script")).innerHTML=l[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function b(){clearTimeout(d)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?f():(t.addEventListener("DOMContentLoaded",f),t.addEventListener("load",f))}(window,document,navigator,top,window.crossOriginIsolated),document.addEventListener("astro:before-swap",(t=>{let e=document.body.querySelector("iframe[src*='/~partytown/']");t.newDocument.body.append(e)}))</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id=header><div class="px-4 mx-auto sm:px-6 max-w-3xl md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href=/ class="items-center flex"><img alt="" src=/favicon.svg class="h-6 w-6 dark:invert invert-0"></a><div class="items-center flex md:hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-7 w-7" data-icon=tabler:moon-filled height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:moon-filled><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341-.82-.476-1.644-1.298-1.31a6.5 6.5 0 0 1-6.864-10.787l.077-.08c.551-.63.113-1.653-.758-1.653h-.266l-.068-.006z" fill=currentColor /></symbol><use xlink:href=#ai:tabler:moon-filled></use></svg></button> <button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:focus:ring-gray-700 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 ml-1.5 rounded-lg text-gray-500 transition" aria-label="Toggle Menu" type=button data-aw-toggle-menu><svg class="h-6 w-6" data-icon=tabler:menu height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:menu><path d="M4 8h16M4 16h16" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use xlink:href=#ai:tabler:menu></use></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 w-full"><li class=""><a href=/blog/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>文章</a></li><li class=""><a href=/project/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>项目</a></li><li class=""><a href=/reading/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>阅读</a></li><li class=""><a href=/about/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-6 w-6" data-icon=tabler:moon-filled height=1em viewBox="0 0 24 24" width=1em><use xlink:href=#ai:tabler:moon-filled></use></svg></button></div></div></div></header><main><section class=page><article><header class=""><div class="flex px-4 flex-col justify-between mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Sat Apr 25 2020 08:53:03 GMT+0000 (Coordinated Universal Time)">Apr 25, 2020</time> · <a href=/categories/cloud/ class="capitalize hover:underline">cloud</a></p></div><h1 class="px-4 mx-auto sm:px-6 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">可能是史上最全的Kubernetes证书解析</h1><p class="px-4 mx-auto sm:px-6 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="px-4 mx-auto sm:px-6"><div class="border-t dark:border-slate-700"></div></div></header><div class="mx-auto sm:px-6 px-6 mt-8 3xl:prose-xl break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow prose-lg"><p>为了避免广告法，题目还是加个可能吧。</p><p>想要安全就必须复杂起来，证书是少不了的。在 Kubernetes 中提供了非常丰富的证书类型，满足各种不同场景的需求，今天我们就来看一看 Kubernetes 中的证书。</p><h2 id=k8s-证书分类>k8s 证书分类</h2><p>在说证书之前，先想想作为集群的入口 apiserver 需要提供那些服务，与那些组件通信，通信的两方可能需要配置证书。 与 apiserver 通信的组件大体可以分为以下几类：</p><ul><li>client(kubectl，restapi 等)：普通用户与 apiserver 之间的通信，对各类资源进行操作</li><li>kubelet，kubeproxy：master 与 node 之间的通信</li><li>etcd：k8s 的存储库</li><li>webhook：这里指 apiserver 提供的 admission-webhook，在数据持久化前调用 webhook</li><li>aggregation layer：扩展 apiserver, 需要将自定义的 api 注册到 k8s 中，相比 CRD 性能更新</li><li>pod: 在 pod 中调用 apiserver(一般调用为 10.254.0.1:433)</li></ul><p>居然有这么多种，除了在 pod 中通过 serviceacount 认证（当然 pod 需要认证 apiserver 的证书），其他几种都需要配置证书。</p><p>其他集群内组件与 apiserver 通信的，kubelet/etcd/kube-proxy 对应的也可以配置证书。</p><h2 id=apiserver-证书>apiserver 证书</h2><p>简单列举下 apiserver 证书相关的启动参数</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>--cert-dir string                           The directory where the TLS certs are located. If --tls-cert-file and --tls-private-key-file are provided, this flag will be ignored. (default "/var/run/kubernetes")</span></span>
<span class=line><span>--client-ca-file string                     If set, any request presenting a client certificate signed by one of the authorities in the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</span></span>
<span class=line><span>--etcd-certfile string                      SSL certification file used to secure etcd communication.</span></span>
<span class=line><span>--etcd-keyfile string                       SSL key file used to secure etcd communication.</span></span>
<span class=line><span>--kubelet-certificate-authority string      Path to a cert file for the certificate authority.</span></span>
<span class=line><span>--kubelet-client-certificate string         Path to a client cert file for TLS.</span></span>
<span class=line><span>--kubelet-client-key string                 Path to a client key file for TLS.</span></span>
<span class=line><span>--proxy-client-cert-file string             Client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins. It is expected that this cert includes a signature from the CA in the --requestheader-client-ca-file flag. That CA is published in the 'extension-apiserver-authentication' configmap in the kube-system namespace. Components recieving calls from kube-aggregator should use that CA to perform their half of the mutual TLS verification.</span></span>
<span class=line><span>--proxy-client-key-file string              Private key for the client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins.</span></span>
<span class=line><span>--requestheader-allowed-names stringSlice   List of client certificate common names to allow to provide usernames in headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities in --requestheader-client-ca-file is allowed.</span></span>
<span class=line><span>--requestheader-client-ca-file string       Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames in headers specified by --requestheader-username-headers</span></span>
<span class=line><span>--service-account-key-file stringArray      File containing PEM-encoded x509 RSA or ECDSA private or public keys, used to verify ServiceAccount tokens. If unspecified, --tls-private-key-file is used. The specified file can contain multiple keys, and the flag can be specified multiple times with different files.</span></span>
<span class=line><span>--ssh-keyfile string                        If non-empty, use secure SSH proxy to the nodes, using this user keyfile</span></span>
<span class=line><span>--tls-ca-file string                        If set, this certificate authority will used for secure access from Admission Controllers. This must be a valid PEM-encoded CA bundle. Alternatively, the certificate authority can be appended to the certificate provided by --tls-cert-file.</span></span>
<span class=line><span>--tls-cert-file string                      File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to /var/run/kubernetes.</span></span>
<span class=line><span>--tls-private-key-file string               File containing the default x509 private key matching --tls-cert-file.</span></span>
<span class=line><span>--tls-sni-cert-key namedCertKey             A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: "example.crt,example.key" or "foo.crt,foo.key:*.foo.com,foo.com". (default [])</span></span>
<span class=line><span>--oidc-ca-file string                       If set, the OpenID server's certificate will be verified by one of the authorities in the oidc-ca-file, otherwise the host's root CA set will be used.</span></span>
<span class=line><span>--tls-sni-cert-key namedCertKey             A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: "example.crt,example.key" or "foo.crt,foo.key:*.foo.com,foo.com". (default [])</span></span>
<span class=line><span></span></span></code></pre><p>不要害怕，咱们一个个看。</p><h3 id=tls-证书>tls 证书</h3><p>首先，apiserver 本身是一个 http 服务器，需要 tls 证书</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>--tls-cert-file string</span></span>
<span class=line><span>    File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory specified by --cert-dir.</span></span>
<span class=line><span></span></span>
<span class=line><span>--tls-private-key-file string</span></span>
<span class=line><span>    File containing the default x509 private key matching --tls-cert-file.</span></span>
<span class=line><span>其他client验证apiserver时可以通过签署这两个证书的CA，我们称为`tls-ca`</span></span>
<span class=line><span></span></span></code></pre><h3 id=client-证书>client 证书</h3><p>apiserver 提供了 tls 证书，同样也需要验证 client 的配置，但是 client 太多了(kubectl,各种 restapi 调用的), 这些 client 需要统一用一个 CA 签发，我们称为<code>client-ca</code>。</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>--client-ca-file string</span></span>
<span class=line><span>    If set, any request presenting a client certificate signed by one of the authorities in the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</span></span>
<span class=line><span></span></span></code></pre><p>需要注意的是，在 apiserver 认证中，通过<code>CN</code>和<code>O</code>来识别用户，开启 RBAC 的用户要配置<code>CN</code>和<code>O</code>做一些授权：</p><ul><li>CN：Common Name，kube-apiserver 从证书中提取作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li><li>O：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)</li></ul><p>如 kube-proxy 的证书申请, User 为<code>system:kube-proxy</code>, Group 为<code>k8s</code></p><pre class="astro-code dracula" data-language=json style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#8be9fe>  "</span><span style=color:#8be9fd>CN</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>system:kube-proxy</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#8be9fe>  "</span><span style=color:#8be9fd>hosts</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [],</span></span>
<span class=line><span style=color:#8be9fe>  "</span><span style=color:#8be9fd>key</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#8be9fe>    "</span><span style=color:#8be9fd>algo</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>rsa</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#8be9fe>    "</span><span style=color:#8be9fd>size</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9> 2048</span></span>
<span class=line><span style=color:#f8f8f2>  },</span></span>
<span class=line><span style=color:#8be9fe>  "</span><span style=color:#8be9fd>names</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#f8f8f2> [</span></span>
<span class=line><span style=color:#f8f8f2>    {</span></span>
<span class=line><span style=color:#8be9fe>      "</span><span style=color:#8be9fd>C</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>CN</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#8be9fe>      "</span><span style=color:#8be9fd>ST</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>BeiJing</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#8be9fe>      "</span><span style=color:#8be9fd>L</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>BeiJing</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#8be9fe>      "</span><span style=color:#8be9fd>O</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>k8s</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#8be9fe>      "</span><span style=color:#8be9fd>OU</span><span style=color:#8be9fe>"</span><span style=color:#ff79c6>:</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>System</span><span style=color:#e9f284>"</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line><span style=color:#f8f8f2>  ]</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=requestheader-证书>requestheader 证书</h3><p>apiserver 可以使用 HTTP 请求头中的指定字段来进行认证，相关配置如下:</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>--requestheader-allowed-names stringSlice</span></span>
<span class=line><span>    List of client certificate common names to allow to provide usernames in headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities in --requestheader-client-ca-file is allowed.</span></span>
<span class=line><span>--requestheader-client-ca-file string</span></span>
<span class=line><span>    Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames in headers specified by --requestheader-username-headers. WARNING: generally do not depend on authorization being already done for incoming requests.</span></span>
<span class=line><span>--requestheader-extra-headers-prefix strings</span></span>
<span class=line><span>    List of request header prefixes to inspect. X-Remote-Extra- is suggested.</span></span>
<span class=line><span>--requestheader-group-headers strings</span></span>
<span class=line><span>    List of request headers to inspect for groups. X-Remote-Group is suggested.</span></span>
<span class=line><span>--requestheader-username-headers strings</span></span>
<span class=line><span>    List of request headers to inspect for usernames. X-Remote-User is common.</span></span>
<span class=line><span></span></span></code></pre><p>收到请求时，apiserver 会首先认证<code>requsetheader-ca</code>，验证成功并且<code>CN</code>在<code>requestheader-allowed-names</code>（默认全部需求）中，然后通过 Http header 中的<code>X-Remote-User, X-Remote-Group</code>去得到用户；如果匹配不成功回去验证<code>client-ca</code>。</p><p>如上，<code>requestheader</code>证书与<code>client-ca</code>不能是同一个。</p><h3 id=proxy-证书>proxy 证书</h3><p>k8s 提供了丰富的扩展机制，CRD 与<a href=https://kubernetes.io/zh/docs/tasks/access-kubernetes-api/configure-aggregation-layer/ >API Aggregation</a>。 对于 API Aggregation(例如 metrics-server 提供了 metrics.k8s.io api), apiserver 接受到请求后经过一系列验证过滤，会将请求转发到扩展 API，这里 apisever 作为代理服务器，需要配置配置证书。</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>--proxy-client-cert-file string</span></span>
<span class=line><span>    Client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins. It is expected that this cert includes a signature from the CA in the --requestheader-client-ca-file flag. That CA is published in the 'extension-apiserver-authentication' configmap in the kube-system namespace. Components recieving calls from kube-aggregator should use that CA to perform their half of the mutual TLS verification.</span></span>
<span class=line><span>--proxy-client-key-file string</span></span>
<span class=line><span>    Private key for the client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins.</span></span>
<span class=line><span></span></span></code></pre><p>需要注意的是对证书需要通过<code>requestheader-ca</code>签发，扩展 api 会通过 requestheader 证书去验证，具体流程后面会写一篇，下图为官方提供的流程 <img alt=aggregation-api src=https://d33wubrfki0l68.cloudfront.net/3c5428678a95c3715894011d8dd4812d2cf229b9/e745c/images/docs/aggregation-api-auth-flow.png loading=lazy></p><h3 id=kubelet-证书>kubelet 证书</h3><p>对于 kubelet，apiserver 单独提供了证书配置选项，同时 kubelet 组件也提供了反向设置的相关选项:</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span># API Server</span></span>
<span class=line><span>--kubelet-certificate-authority string</span></span>
<span class=line><span>    Path to a cert file for the certificate authority.</span></span>
<span class=line><span>--kubelet-client-certificate string</span></span>
<span class=line><span>    Path to a client cert file for TLS.</span></span>
<span class=line><span>--kubelet-client-key string</span></span>
<span class=line><span>    Path to a client key file for TLS.</span></span>
<span class=line><span></span></span>
<span class=line><span># kubelet</span></span>
<span class=line><span>--client-ca-file string</span></span>
<span class=line><span>    If set, any request presenting a client certificate signed by one of the authorities in the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</span></span>
<span class=line><span>--tls-cert-file string</span></span>
<span class=line><span>    File containing x509 Certificate used for serving HTTPS (with intermediate certs, if any, concatenated after server cert). If --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory passed to --cert-dir.</span></span>
<span class=line><span>--tls-private-key-file string</span></span>
<span class=line><span>    File containing x509 private key matching --tls-cert-file.</span></span>
<span class=line><span></span></span></code></pre><p>kubelet 也是即作为 server 也作为 client, 需要提供 tls 证书和 client-ca, 我们称这个 CA 为<code>kubelet-ca</code>, 可以是单独的 CA。</p><h3 id=etcd-证书>etcd 证书</h3><p>这个也不用多说，用来连接 etcd，由<code>etcd-ca</code>签发</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>--etcd-certfile string                      SSL certification file used to secure etcd communication.</span></span>
<span class=line><span>--etcd-keyfile string                       SSL key file used to secure etcd communication.</span></span>
<span class=line><span></span></span></code></pre><h3 id=serviceaccount-证书>serviceaccount 证书</h3><p>在 k8s 中，通过<code>JWT</code>认证<code>serviecaccount</code>，同样有两个证书配置:</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span># apiserver</span></span>
<span class=line><span>--service-account-key-file stringArray # 用于验证sa</span></span>
<span class=line><span>    File containing PEM-encoded x509 RSA or ECDSA private or public keys, used to verify ServiceAccount tokens. The specified file can contain multiple keys, and the flag can be specified multiple times with different files. If unspecified, --tls-private-key-file is used. Must be specified when --service-account-signing-key is provided</span></span>
<span class=line><span>--service-account-signing-key-file string</span></span>
<span class=line><span>    Path to the file that contains the current private key of the service account token issuer. The issuer will sign issued ID tokens with this private key. (Requires the 'TokenRequest' feature gate.)</span></span>
<span class=line><span></span></span>
<span class=line><span># controller-manager</span></span>
<span class=line><span>–service-account-private-key-file #用于签署sa</span></span>
<span class=line><span></span></span></code></pre><p>这两个配置描述了对<code>serviceaccount</code>进行签名验证时所使用的证书；可以是单独的生成，我们称为<code>sa-key</code>。</p><h2 id=其他证书>其他证书</h2><p>其他还有<code>oidc</code>证书，用于 OpenID 认证；<code>ssh</code>证书，用来连接 node，目前以及废弃。</p><p>etcd 与 kubelet 证书上面已经提过了，需要双方都配置。</p><p>k8s 中也支持证书申请，用户可以创建<code>CertificateSigningRequest</code>来申请证书，需要在 controller-manager 配置下面的证书，用于签发证书称为<code>sing-ca</code>，多用于 webhook 的证书配置。</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>--cluster-signing-cert-file string          Filename containing a PEM-encoded X509 CA certificate used to issue cluster-scoped certificates (default "/etc/kubernetes/ca/ca.pem")</span></span>
<span class=line><span>--cluster-signing-key-file string           Filename containing a PEM-encoded RSA or ECDSA private key used to sign cluster-scoped certificates (default "/etc/kubernetes/ca/ca.key")</span></span>
<span class=line><span></span></span></code></pre><h2 id=总结>总结</h2><p>k8s 提供了强大的功能，需要考虑到各个场景的安全问题，上面我们梳理了遍目前常用的证书</p><ul><li>tls-ca</li><li>client-ca</li><li>requestheader-ca</li><li>proxy-ca</li><li>kubelet-ca</li><li>etcd-ca</li><li>sa-key</li><li>sign-ca</li></ul><p>上面除了<code>proxy-ca</code>必须使用<code>requestheader-ca</code>签发，其他所有的都可以是单独的 CA，可以根据安全性评估是使用一个 CA 还是多个 CA，我们建议下面的 CA 尽量是独立的</p><ul><li>client-ca</li><li>requestheader-ca</li><li>etcd-ca</li><li>kubelet-ca</li><li>sign-ca</li></ul><p>终于理完了，可以起床啦。</p></div><div class="flex flex-col justify-between mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class=mr-5><li class="rounded-full border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1"><a href=/tags/k8s/ class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#k8s</a></li><li class="rounded-full border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1"><a href=/tags/tls/ class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#tls</a></li></ul></div></article><div class="mx-auto sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script src=https://giscus.app/client.js async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOCg97r84CBQfL data-emit-metadata=0 data-input-position=top data-lang=en data-loading=lazy data-mapping=title data-reactions-enabled=1 data-repo=qingwave/qingwave.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict=0 data-theme=light></script></div></section><div class="bottom-8 fixed hidden right-6 z-50" id=back-to-top><button class="rounded-full dark:hover:bg-slate-800 dark:hover:text-gray-100 dark:text-gray-300 hover:bg-neutral-100 hover:text-neutral-500 p-3 text-neutral-300"><svg class="h-6 w-6" data-icon=ph:rocket-fill height=1em viewBox="0 0 256 256" width=1em><symbol id=ai:ph:rocket-fill><path d="M152 224a8 8 0 0 1-8 8h-32a8 8 0 0 1 0-16h32a8 8 0 0 1 8 8m71.62-68.17l-12.36 55.63a16 16 0 0 1-25.51 9.11L158.51 200h-61l-27.26 20.57a16 16 0 0 1-25.51-9.11l-12.36-55.63a16.09 16.09 0 0 1 3.32-13.71l28.56-34.26a123 123 0 0 1 8.57-36.67c12.9-32.34 36-52.63 45.37-59.85a16 16 0 0 1 19.6 0c9.34 7.22 32.47 27.51 45.37 59.85a123 123 0 0 1 8.57 36.67l28.56 34.26a16.09 16.09 0 0 1 3.32 13.71m-139.23 34q-16.11-29.33-19.56-57.67L48 152.36L60.36 208l.18-.13ZM140 100a12 12 0 1 0-12 12a12 12 0 0 0 12-12m68 52.36l-16.83-20.2q-3.42 28.28-19.56 57.69l23.85 18l.18.13Z" fill=currentColor /></symbol><use xlink:href=#ai:ph:rocket-fill></use></svg></button></div></main><footer class=relative><div class="px-4 mx-auto sm:px-6 max-w-3xl"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="px-4 mx-auto sm:px-6 max-w-3xl dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href=/rss.xml class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label=RSS><svg class="h-5 w-5" data-icon=tabler:rss height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:rss><path d="M4 19a1 1 0 1 0 2 0a1 1 0 1 0-2 0M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use xlink:href=#ai:tabler:rss></use></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href=https://qingwave.github.io class=hover:brightness-50>Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function c(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:localStorage.theme}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),c=encodeURIComponent(t.getAttribute("data-aw-text"));let a;switch(o){case"facebook":a=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":a=`https://twitter.com/intent/tweet?url=${n}&text=${c}`;break;case"linkedin":a=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${c}`;break;case"whatsapp":a=`https://wa.me/?text=${c}%20${n}`;break;case"mail":a=`mailto:?subject=%22${c}%22&body=${c}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=a,s.click()})),c(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{c()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>