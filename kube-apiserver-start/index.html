<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=zh><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>kube-apiserver启动流程分析</title><meta content=index,follow name=robots><link href=https://qingwave.github.io/kube-apiserver-start/ rel=canonical><meta content=kube-apiserver启动流程分析 property=og:title><meta content=https://qingwave.github.io/kube-apiserver-start/ property=og:url><meta content=article property=og:type><meta content=https://qingwave.github.io/ property=og:image><meta content=kube-apiserver启动流程分析 property=og:image:alt><meta content=summary_large_image name=twitter:card><style is:global>:root{--aw-font-sans:'Inter Variable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI name=google-site-verification><script src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async type=text/partytown></script><script type=text/partytown>(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.svg rel=mask-icon color=#8D46E7><link href=/sitemap-index.xml rel=sitemap><link href=/_astro/_page_.ByvKjQCg.css rel=stylesheet><link href=/_astro/_page_.DUBOU3dI.css rel=stylesheet><script src=/_astro/hoisted.DNuUAAyM.js type=module></script><script>!function(t,e,n,r){(window.crossOriginIsolated||navigator.serviceWorker)&&((r=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(r[n]||[]).concat(["dataLayer.push"]))}(window,"partytown","forward");const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((()=>{const t=new Set;let e=[];do{Object.getOwnPropertyNames(e).forEach((n=>{"function"==typeof e[n]&&t.add(n)}))}while((e=Object.getPrototypeOf(e))!==Object.prototype);return Array.from(t)})());!function(t,r,o,i,a,s,c,d,l,p,u=t,y){function f(){y||(y=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(l=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(h,1e4),r.addEventListener("pt0",b),a?w(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):h())))}function w(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.10.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function h(n,o){for(b(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<l.length;n++)(o=r.createElement("script")).innerHTML=l[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function b(){clearTimeout(d)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?f():(t.addEventListener("DOMContentLoaded",f),t.addEventListener("load",f))}(window,document,navigator,top,window.crossOriginIsolated),document.addEventListener("astro:before-swap",(t=>{let e=document.body.querySelector("iframe[src*='/~partytown/']");e&&t.newDocument.body.append(e)}))</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id=header><div class="px-4 mx-auto sm:px-6 max-w-3xl md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href=/ class="items-center flex"><img alt="" class="h-6 w-6 dark:invert invert-0" src=/favicon.svg></a><div class="items-center flex md:hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-7 w-7" data-icon=tabler:moon-filled height=1em width=1em><symbol id=ai:tabler:moon-filled viewBox="0 0 24 24"><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341-.82-.476-1.644-1.298-1.31a6.5 6.5 0 0 1-6.864-10.787l.077-.08c.551-.63.113-1.653-.758-1.653h-.266l-.068-.006z" fill=currentColor /></symbol><use href=#ai:tabler:moon-filled></use></svg></button> <button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:focus:ring-gray-700 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 ml-1.5 rounded-lg text-gray-500 transition" aria-label="Toggle Menu" type=button data-aw-toggle-menu><svg class="h-6 w-6" data-icon=tabler:menu height=1em width=1em><symbol id=ai:tabler:menu viewBox="0 0 24 24"><path d="M4 8h16M4 16h16" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use href=#ai:tabler:menu></use></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 w-full"><li class=""><a href=/blog/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>文章</a></li><li class=""><a href=/project/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>项目</a></li><li class=""><a href=/reading/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>阅读</a></li><li class=""><a href=/about/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-6 w-6" data-icon=tabler:moon-filled height=1em width=1em viewBox="0 0 24 24"><use href=#ai:tabler:moon-filled></use></svg></button></div></div></div></header><main><section class=page><article><header class=""><div class="flex px-4 flex-col justify-between mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Fri Apr 24 2020 15:28:16 GMT+0000 (Coordinated Universal Time)">Apr 24, 2020</time> · <a href=/categories/cloud/ class="capitalize hover:underline">cloud</a></p></div><h1 class="px-4 mx-auto sm:px-6 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">kube-apiserver启动流程分析</h1><p class="px-4 mx-auto sm:px-6 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="px-4 mx-auto sm:px-6"><div class="border-t dark:border-slate-700"></div></div></header><div class="mx-auto sm:px-6 px-6 mt-8 3xl:prose-xl break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow prose-lg"><p>kube-apiserver 共由 3 个组件构成（Aggregator. KubeAPIServer. APIExtensionServer），这些组件依次通过 Delegation 处理请求：</p><ul><li>Aggregator：暴露的功能类似于一个七层负载均衡，将来自用户的请求拦截转发给其他服务器，并且负责整个 APIServer 的 Discovery 功能；也负责处理 ApiService，注册对应的扩展 api。</li><li>KubeAPIServer ：负责对请求的一些通用处理，认证. 鉴权等，以及处理各个内建资源的 REST 服务；</li><li>APIExtensionServer：主要处理 CustomResourceDefinition（CRD）和 CustomResource（CR）的 REST 请求，也是 Delegation 的最后一环，如果对应 CR 不能被处理的话则会返回 404。</li></ul><h2 id=kube-apiserver-启动流程>kube-apiserver 启动流程</h2><p>Apiserver 通过<code>Run</code>方法启动, 主要逻辑为：</p><ol><li>调用<code>CreateServerChain</code>构建服务调用链并判断是否启动非安全的<code>httpserver</code>，<code>httpserver</code>链中包含 apiserver 要启动的三个 server，以及为每个 server 注册对应资源的路由；</li><li>调用<code>server.PrepareRun</code>进行服务运行前的准备，该方法主要完成了健康检查. 存活检查和 OpenAPI 路由的注册工作；</li><li>调用<code>prepared.Run</code>启动 server；</li></ol><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// Run runs the specified APIServer.  This should never exit.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> Run</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>completeOptions</span><span style=color:#8be9fd;font-style:italic> completedServerRunOptions</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>stopCh</span><span style=color:#ff79c6> &#x3C;-chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>	// To help debugging, immediately log version</span></span>
<span class=line><span style=color:#f8f8f2>	klog.</span><span style=color:#50fa7b>Infof</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Version: </span><span style=color:#bd93f9>%+v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, version.</span><span style=color:#50fa7b>Get</span><span style=color:#f8f8f2>())</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 创建调用链</span></span>
<span class=line><span style=color:#f8f8f2>	server, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> CreateServerChain</span><span style=color:#f8f8f2>(completeOptions, stopCh)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 进行一些准备工作， 注册一些hander，执行hook等</span></span>
<span class=line><span style=color:#f8f8f2>	prepared, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> server.</span><span style=color:#50fa7b>PrepareRun</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 开始执行</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> prepared.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(stopCh)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>执行具体的<code>Run</code>方法</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// Run spawns the secure http server. It only returns if stopCh is closed</span></span>
<span class=line><span style=color:#6272a4>// or the secure port cannot be listened on initially.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>s </span><span style=color:#8be9fd;font-style:italic>preparedGenericAPIServer</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>stopCh</span><span style=color:#ff79c6> &#x3C;-chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	delayedStopCh </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{})</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	go</span><span style=color:#ff79c6> func</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#ff79c6>		defer</span><span style=color:#50fa7b> close</span><span style=color:#f8f8f2>(delayedStopCh)</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>		&#x3C;-</span><span style=color:#f8f8f2>stopCh</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>		// As soon as shutdown is initiated, /readyz should start returning failure.</span></span>
<span class=line><span style=color:#6272a4>		// This gives the load balancer a window defined by ShutdownDelayDuration to detect that /readyz is red</span></span>
<span class=line><span style=color:#6272a4>		// and stop sending traffic to this server.</span></span>
<span class=line><span style=color:#6272a4>		// 当终止时，关闭readiness</span></span>
<span class=line><span style=color:#50fa7b>		close</span><span style=color:#f8f8f2>(s.readinessStopCh)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		time.</span><span style=color:#50fa7b>Sleep</span><span style=color:#f8f8f2>(s.ShutdownDelayDuration)</span></span>
<span class=line><span style=color:#f8f8f2>	}()</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 执行非阻塞Run</span></span>
<span class=line><span style=color:#6272a4>	// close socket after delayed stopCh</span></span>
<span class=line><span style=color:#f8f8f2>	err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> s.</span><span style=color:#50fa7b>NonBlockingRun</span><span style=color:#f8f8f2>(delayedStopCh)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	&#x3C;-</span><span style=color:#f8f8f2>stopCh</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// run shutdown hooks directly. This includes deregistering from the kubernetes endpoint in case of kube-apiserver.</span></span>
<span class=line><span style=color:#6272a4>	// 关闭前执行一些hook操作</span></span>
<span class=line><span style=color:#f8f8f2>	err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> s.</span><span style=color:#50fa7b>RunPreShutdownHooks</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// wait for the delayed stopCh before closing the handler chain (it rejects everything after Wait has been called).</span></span>
<span class=line><span style=color:#ff79c6>	&#x3C;-</span><span style=color:#f8f8f2>delayedStopCh</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 等待所有请求执行完</span></span>
<span class=line><span style=color:#6272a4>	// Wait for all requests to finish, which are bounded by the RequestTimeout variable.</span></span>
<span class=line><span style=color:#f8f8f2>	s.HandlerChainWaitGroup.</span><span style=color:#50fa7b>Wait</span><span style=color:#f8f8f2>()</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>执行<code>NonBlockingRun</code> <code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go:351</code></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>s </span><span style=color:#8be9fd;font-style:italic>preparedGenericAPIServer</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>NonBlockingRun</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>stopCh</span><span style=color:#ff79c6> &#x3C;-chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>    auditStopCh </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{})</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 1. 判断是否要启动审计日志</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> s.AuditBackend </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> s.AuditBackend.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(auditStopCh); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>            return</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>failed to run the audit backend: </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#f8f8f2>        }</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 2. 启动 https server</span></span>
<span class=line><span style=color:#f8f8f2>    internalStopCh </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{})</span></span>
<span class=line><span style=color:#ff79c6>    var</span><span style=color:#f8f8f2> stoppedCh </span><span style=color:#ff79c6>&#x3C;-chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> s.SecureServingInfo </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#ff79c6> &#x26;&#x26;</span><span style=color:#f8f8f2> s.Handler </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        var</span><span style=color:#f8f8f2> err </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#f8f8f2>        stoppedCh, err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> s.SecureServingInfo.</span><span style=color:#50fa7b>Serve</span><span style=color:#f8f8f2>(s.Handler, s.ShutdownTimeout, internalStopCh)</span></span>
<span class=line><span style=color:#ff79c6>        if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#50fa7b>            close</span><span style=color:#f8f8f2>(internalStopCh)</span></span>
<span class=line><span style=color:#50fa7b>            close</span><span style=color:#f8f8f2>(auditStopCh)</span></span>
<span class=line><span style=color:#ff79c6>            return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>        }</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>    go</span><span style=color:#ff79c6> func</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#ff79c6>        &#x3C;-</span><span style=color:#f8f8f2>stopCh</span></span>
<span class=line><span style=color:#50fa7b>        close</span><span style=color:#f8f8f2>(s.readinessStopCh)</span></span>
<span class=line><span style=color:#50fa7b>        close</span><span style=color:#f8f8f2>(internalStopCh)</span></span>
<span class=line><span style=color:#ff79c6>        if</span><span style=color:#f8f8f2> stoppedCh </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>            &#x3C;-</span><span style=color:#f8f8f2>stoppedCh</span></span>
<span class=line><span style=color:#f8f8f2>        }</span></span>
<span class=line><span style=color:#f8f8f2>        s.HandlerChainWaitGroup.</span><span style=color:#50fa7b>Wait</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#50fa7b>        close</span><span style=color:#f8f8f2>(auditStopCh)</span></span>
<span class=line><span style=color:#f8f8f2>    }()</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 3. 执行 postStartHooks</span></span>
<span class=line><span style=color:#f8f8f2>    s.</span><span style=color:#50fa7b>RunPostStartHooks</span><span style=color:#f8f8f2>(stopCh)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 4. 向 systemd 发送 ready 信号</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> _, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> systemd.</span><span style=color:#50fa7b>SdNotify</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>true</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>READY=1</span><span style=color:#ff79c6>\n</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>        klog.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Unable to send systemd daemon successful start message: </span><span style=color:#bd93f9>%v</span><span style=color:#ff79c6>\n</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h2 id=调用链分析>调用链分析</h2><p>上一节简单分析了 Apiserver 的启动流程，通过初始化各种配置，封装调用链，启动 Server。这节主要分析调用链。</p><p>初始化阶段, 通过<code>CreateServerChain</code>创建调用链， 代码在<a href=https://github.com/kubernetes/kubernetes/blob/1d057da2f73118893b5cc27c15d59ff03beb271e/cmd/kube-apiserver/app/server.go#L169>server.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// CreateServerChain creates the apiservers connected via delegation.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> CreateServerChain</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>completedOptions</span><span style=color:#8be9fd;font-style:italic> completedServerRunOptions</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>stopCh</span><span style=color:#ff79c6> &#x3C;-chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{}) (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>APIAggregator</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>  // nodetunneler与node通信，proxy实现代理功能，转发请求给其他apiservice</span></span>
<span class=line><span style=color:#6272a4>  // apiserver到cluster的通信可以通过三种方法</span></span>
<span class=line><span style=color:#6272a4>  // apiserver到kubelet的endpoint，用于logs功能，exec功能，port-forward功能</span></span>
<span class=line><span style=color:#6272a4>  // HTTP连接，即使可以用HTTPS也不做任何其他校验，并不安全</span></span>
<span class=line><span style=color:#6272a4>  // ssh tunnel，不推荐使用</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>  nodeTunneler, proxyTransport, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> CreateNodeDialer</span><span style=color:#f8f8f2>(completedOptions)</span></span>
<span class=line><span style=color:#6272a4>    // 1. 为 kubeAPIServer 创建配置</span></span>
<span class=line><span style=color:#f8f8f2>    kubeAPIServerConfig, insecureServingInfo, serviceResolver, pluginInitializer, admissionPostStartHook, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b>                                         CreateKubeAPIServerConfig</span><span style=color:#f8f8f2>(completedOptions, nodeTunneler, proxyTransport)</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 2. 判断是否配置了 APIExtensionsServer，创建 apiExtensionsConfig</span></span>
<span class=line><span style=color:#f8f8f2>    apiExtensionsConfig, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> createAPIExtensionsConfig</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>kubeAPIServerConfig.GenericConfig, kubeAPIServerConfig.ExtraConfig.VersionedInformers,        pluginInitializer, completedOptions.ServerRunOptions, completedOptions.MasterCount,vc</span></span>
<span class=line><span style=color:#f8f8f2>        serviceResolver, webhook.</span><span style=color:#50fa7b>NewDefaultAuthenticationInfoResolverWrapper</span><span style=color:#f8f8f2>(proxyTransport, kubeAPIServerConfig.GenericConfig.LoopbackClientConfig))</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 3. 初始化 APIExtensionsServer, 通过一个空的delegate初始化</span></span>
<span class=line><span style=color:#f8f8f2>    apiExtensionsServer, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> createAPIExtensionsServer</span><span style=color:#f8f8f2>(apiExtensionsConfig, genericapiserver.</span><span style=color:#50fa7b>NewEmptyDelegate</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 4. 初始化 KubeAPIServer</span></span>
<span class=line><span style=color:#f8f8f2>    kubeAPIServer, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> CreateKubeAPIServer</span><span style=color:#f8f8f2>(kubeAPIServerConfig, apiExtensionsServer.GenericAPIServer, admissionPostStartHook)</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 5. 创建 AggregatorConfig</span></span>
<span class=line><span style=color:#f8f8f2>    aggregatorConfig, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> createAggregatorConfig</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>kubeAPIServerConfig.GenericConfig, completedOptions.ServerRunOptions, kubeAPIServerConfig.          ExtraConfig.VersionedInformers, serviceResolver, proxyTransport, pluginInitializer)</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 6. 初始化 AggregatorServer</span></span>
<span class=line><span style=color:#f8f8f2>    aggregatorServer, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> createAggregatorServer</span><span style=color:#f8f8f2>(aggregatorConfig, kubeAPIServer.GenericAPIServer, apiExtensionsServer.Informers)</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>        return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>    // 7. 判断是否启动非安全端口的 http server</span></span>
<span class=line><span style=color:#ff79c6>    if</span><span style=color:#f8f8f2> insecureServingInfo </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>        insecureHandlerChain </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> kubeserver.</span><span style=color:#50fa7b>BuildInsecureHandlerChain</span><span style=color:#f8f8f2>(aggregatorServer.GenericAPIServer.</span><span style=color:#50fa7b>UnprotectedHandler</span><span style=color:#f8f8f2>(), kubeAPIServerConfig.GenericConfig)</span></span>
<span class=line><span style=color:#ff79c6>        if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> insecureServingInfo.</span><span style=color:#50fa7b>Serve</span><span style=color:#f8f8f2>(insecureHandlerChain, kubeAPIServerConfig.GenericConfig.RequestTimeout, stopCh); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>            return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>        }</span></span>
<span class=line><span style=color:#f8f8f2>    }</span></span>
<span class=line><span style=color:#ff79c6>    return</span><span style=color:#f8f8f2> aggregatorServer, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>创建过程主要有以下步骤：</p><ol><li>根据配置构造 apiserver 的配置，调用方法<code>CreateKubeAPIServerConfig</code></li><li>根据配置构造扩展的 apiserver 的配置，调用方法为<code>createAPIExtensionsConfig</code></li><li>创建 server，包括扩展的 apiserver 和原生的 apiserver，调用方法为<code>createAPIExtensionsServer</code>和<code>CreateKubeAPIServer</code>。主要就是将各个 handler 的路由方法注册到 Container 中去，完全遵循 go-restful 的设计模式，即将处理方法注册到 Route 中去，同一个根路径下的 Route 注册到 WebService 中去，WebService 注册到 Container 中，Container 负责分发。访问的过程为<code>Container-->WebService-->Route</code></li><li>聚合 server 的配置和和创建。主要就是将原生的 apiserver 和扩展的 apiserver 的访问进行整合，添加后续的一些处理接口。调用方法为<code>createAggregatorConfig</code>和<code>createAggregatorServer</code></li><li>创建完成，返回配置的 server 信息</li></ol><p>以上几个步骤，最核心的就是 apiserver 如何创建，即如何按照 go-restful 的模式，添加路由和相应的处理方法。</p><h3 id=配置初始化>配置初始化</h3><p>先看 apiserver 配置的创建<code>CreateKubeAPIServerConfig->buildGenericConfig->genericapiserver.NewConfig</code></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// BuildGenericConfig takes the master server options and produces the genericapiserver.Config associated with it</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> buildGenericConfig</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	s</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>options</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ServerRunOptions</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	proxyTransport</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>http</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Transport</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#f8f8f2>) (</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	genericConfig</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	versionedInformers</span><span style=color:#8be9fd;font-style:italic> clientgoinformers</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>SharedInformerFactory</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	insecureServingInfo</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>DeprecatedInsecureServingInfo</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	serviceResolver</span><span style=color:#8be9fd;font-style:italic> aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ServiceResolver</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	pluginInitializers</span><span style=color:#f8f8f2> []</span><span style=color:#8be9fd;font-style:italic>admission</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PluginInitializer</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	admissionPostStartHook</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PostStartHookFunc</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	storageFactory</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>serverstorage</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>DefaultStorageFactory</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	lastErr</span><span style=color:#8be9fd;font-style:italic> error</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>	// 创建genericConfig,其中包括DefaultBuildHandlerChain，一系列认证授权的中间件</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapiserver.</span><span style=color:#50fa7b>NewConfig</span><span style=color:#f8f8f2>(legacyscheme.Codecs)</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.MergedResourceConfig </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> master.</span><span style=color:#50fa7b>DefaultAPIResourceConfigSource</span><span style=color:#f8f8f2>()</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 初始化各种配置</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> s.GenericServerRunOptions.</span><span style=color:#50fa7b>ApplyTo</span><span style=color:#f8f8f2>(genericConfig); lastErr </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#6272a4>	// ...</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.OpenAPIConfig </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapiserver.</span><span style=color:#50fa7b>DefaultOpenAPIConfig</span><span style=color:#f8f8f2>(generatedopenapi.GetOpenAPIDefinitions, openapinamer.</span><span style=color:#50fa7b>NewDefinitionNamer</span><span style=color:#f8f8f2>(legacyscheme.Scheme, extensionsapiserver.Scheme, aggregatorscheme.Scheme))</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.OpenAPIConfig.Info.Title </span><span style=color:#ff79c6>=</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>Kubernetes</span><span style=color:#e9f284>"</span></span>
<span class=line><span style=color:#6272a4>	// 长连接请求</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.LongRunningFunc </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> filters.</span><span style=color:#50fa7b>BasicLongRunningRequestCheck</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#f8f8f2>		sets.</span><span style=color:#50fa7b>NewString</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>watch</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>proxy</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>		sets.</span><span style=color:#50fa7b>NewString</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>attach</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>exec</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>proxy</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>log</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>portforward</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>	)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	kubeVersion </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> version.</span><span style=color:#50fa7b>Get</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.Version </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#f8f8f2>kubeVersion</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 初始化storageFactory， 用来连接etcd</span></span>
<span class=line><span style=color:#f8f8f2>	storageFactoryConfig </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> kubeapiserver.</span><span style=color:#50fa7b>NewStorageFactoryConfig</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	storageFactoryConfig.APIResourceConfig </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericConfig.MergedResourceConfig</span></span>
<span class=line><span style=color:#f8f8f2>	completedStorageFactoryConfig, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> storageFactoryConfig.</span><span style=color:#50fa7b>Complete</span><span style=color:#f8f8f2>(s.Etcd)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	storageFactory, lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> completedStorageFactoryConfig.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> lastErr </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> genericConfig.EgressSelector </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		storageFactory.StorageConfig.Transport.EgressLookup </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericConfig.EgressSelector.Lookup</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> s.Etcd.</span><span style=color:#50fa7b>ApplyWithStorageFactoryTo</span><span style=color:#f8f8f2>(storageFactory, genericConfig); lastErr </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Use protobufs for self-communication.</span></span>
<span class=line><span style=color:#6272a4>	// Since not every generic apiserver has to support protobufs, we</span></span>
<span class=line><span style=color:#6272a4>	// cannot default to it in generic apiserver and need to explicitly</span></span>
<span class=line><span style=color:#6272a4>	// set it in kube-apiserver.</span></span>
<span class=line><span style=color:#6272a4>	// 内部使用protobufs通信</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.LoopbackClientConfig.ContentConfig.ContentType </span><span style=color:#ff79c6>=</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>application/vnd.kubernetes.protobuf</span><span style=color:#e9f284>"</span></span>
<span class=line><span style=color:#6272a4>	// Disable compression for self-communication, since we are going to be</span></span>
<span class=line><span style=color:#6272a4>	// on a fast local network</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.LoopbackClientConfig.DisableCompression </span><span style=color:#ff79c6>=</span><span style=color:#bd93f9> true</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// clientset初始化</span></span>
<span class=line><span style=color:#f8f8f2>	kubeClientConfig </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> genericConfig.LoopbackClientConfig</span></span>
<span class=line><span style=color:#f8f8f2>	clientgoExternalClient, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> clientgoclientset.</span><span style=color:#50fa7b>NewForConfig</span><span style=color:#f8f8f2>(kubeClientConfig)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>failed to create real external clientset: </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	versionedInformers </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> clientgoinformers.</span><span style=color:#50fa7b>NewSharedInformerFactory</span><span style=color:#f8f8f2>(clientgoExternalClient, </span><span style=color:#bd93f9>10</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>time.Minute)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 初始化认证实例，支持多种认证方式：requestheader,token, tls等</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.Authentication.Authenticator, genericConfig.OpenAPIConfig.SecurityDefinitions, err </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> BuildAuthenticator</span><span style=color:#f8f8f2>(s, genericConfig.EgressSelector, clientgoExternalClient, versionedInformers)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>invalid authentication config: </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 初始化鉴权配置</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.Authorization.Authorizer, genericConfig.RuleResolver, err </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> BuildAuthorizer</span><span style=color:#f8f8f2>(s, genericConfig.EgressSelector, versionedInformers)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>invalid authorization config: </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#ff79c6> !</span><span style=color:#f8f8f2>sets.</span><span style=color:#50fa7b>NewString</span><span style=color:#f8f8f2>(s.Authorization.Modes</span><span style=color:#ff79c6>...</span><span style=color:#f8f8f2>).</span><span style=color:#50fa7b>Has</span><span style=color:#f8f8f2>(modes.ModeRBAC) {</span></span>
<span class=line><span style=color:#f8f8f2>		genericConfig.DisabledPostStartHooks.</span><span style=color:#50fa7b>Insert</span><span style=color:#f8f8f2>(rbacrest.PostStartHookName)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 初始化admission webhook的配置</span></span>
<span class=line><span style=color:#f8f8f2>	admissionConfig </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>kubeapiserveradmission</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		ExternalInformers:    versionedInformers,</span></span>
<span class=line><span style=color:#f8f8f2>		LoopbackClientConfig: genericConfig.LoopbackClientConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		CloudConfigFile:      s.CloudProvider.CloudConfigFile,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	serviceResolver </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> buildServiceResolver</span><span style=color:#f8f8f2>(s.EnableAggregatorRouting, genericConfig.LoopbackClientConfig.Host, versionedInformers)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	authInfoResolverWrapper </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> webhook.</span><span style=color:#50fa7b>NewDefaultAuthenticationInfoResolverWrapper</span><span style=color:#f8f8f2>(proxyTransport, genericConfig.EgressSelector, genericConfig.LoopbackClientConfig)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> s.Audit.</span><span style=color:#50fa7b>ApplyTo</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#f8f8f2>		genericConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		genericConfig.LoopbackClientConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		versionedInformers,</span></span>
<span class=line><span style=color:#f8f8f2>		serveroptions.</span><span style=color:#50fa7b>NewProcessInfo</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>kube-apiserver</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>kube-system</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#ff79c6>		&#x26;</span><span style=color:#8be9fd;font-style:italic>serveroptions</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>WebhookOptions</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>			AuthInfoResolverWrapper: authInfoResolverWrapper,</span></span>
<span class=line><span style=color:#f8f8f2>			ServiceResolver:         serviceResolver,</span></span>
<span class=line><span style=color:#f8f8f2>		},</span></span>
<span class=line><span style=color:#f8f8f2>	)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> lastErr </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 初始化注入插件</span></span>
<span class=line><span style=color:#f8f8f2>	pluginInitializers, admissionPostStartHook, err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> admissionConfig.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(proxyTransport, genericConfig.EgressSelector, serviceResolver)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>failed to create admission plugin initializer: </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#ff79c6>		return</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> s.Admission.</span><span style=color:#50fa7b>ApplyTo</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#f8f8f2>		genericConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		versionedInformers,</span></span>
<span class=line><span style=color:#f8f8f2>		kubeClientConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		feature.DefaultFeatureGate,</span></span>
<span class=line><span style=color:#f8f8f2>		pluginInitializers</span><span style=color:#ff79c6>...</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		lastErr </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>failed to initialize admission: </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> utilfeature.DefaultFeatureGate.</span><span style=color:#50fa7b>Enabled</span><span style=color:#f8f8f2>(genericfeatures.APIPriorityAndFairness) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> s.GenericServerRunOptions.EnablePriorityAndFairness {</span></span>
<span class=line><span style=color:#f8f8f2>		genericConfig.FlowControl </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> BuildPriorityAndFairness</span><span style=color:#f8f8f2>(s, clientgoExternalClient, versionedInformers)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=apiextensionsserver-初始化>APIExtensionsServer 初始化</h3><p><code>APIExtensionsServer</code>最先初始化，在调用链的末尾, 处理 CR、CRD 相关资源.</p><p>其中包含的 controller 以及功能如下所示：</p><ol><li>openapiController：将 crd 资源的变化同步至提供的 OpenAPI 文档，可通过访问 /openapi/v2 进行查看；</li><li>crdController：负责将 crd 信息注册到 apiVersions 和 apiResources 中，两者的信息可通过 $ kubectl api-versions 和 $ kubectl api-resources 查看；</li><li>namingController：检查 crd obj 中是否有命名冲突，可在 crd .status.conditions 中查看；</li><li>establishingController：检查 crd 是否处于正常状态，可在 crd .status.conditions 中查看；</li><li>nonStructuralSchemaController：检查 crd obj 结构是否正常，可在 crd .status.conditions 中查看；</li><li>apiApprovalController：检查 crd 是否遵循 kubernetes API 声明策略，可在 crd .status.conditions 中查看；</li><li>finalizingController：类似于 finalizes 的功能，与 CRs 的删除有关；</li></ol><p><code>createAPIExtensionsServer</code>调用<code>apiextensionsConfig.Complete().New(delegateAPIServer)</code></p><p><code>k8s.io/kubernetes/staging/src/k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go:132</code></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>/</span><span style=color:#f8f8f2> New returns a new instance of CustomResourceDefinitions from the given config.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>c </span><span style=color:#8be9fd;font-style:italic>completedConfig</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>delegationTarget</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>DelegationTarget</span><span style=color:#f8f8f2>) (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>CustomResourceDefinitions</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>	// 初始化 genericServer</span></span>
<span class=line><span style=color:#f8f8f2>	genericServer, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> c.GenericConfig.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apiextensions-apiserver</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, delegationTarget)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	s </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>CustomResourceDefinitions</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		GenericAPIServer: genericServer,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 初始化apigroup, 即需要暴露的api，这里extension apiserver只注册了cr于crd相关的</span></span>
<span class=line><span style=color:#f8f8f2>	apiResourceConfig </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> c.GenericConfig.MergedResourceConfig</span></span>
<span class=line><span style=color:#f8f8f2>	apiGroupInfo </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> genericapiserver.</span><span style=color:#50fa7b>NewDefaultAPIGroupInfo</span><span style=color:#f8f8f2>(apiextensions.GroupName, Scheme, metav1.ParameterCodec, Codecs)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> apiResourceConfig.</span><span style=color:#50fa7b>VersionEnabled</span><span style=color:#f8f8f2>(v1beta1.SchemeGroupVersion) {</span></span>
<span class=line><span style=color:#f8f8f2>		storage </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>rest</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Storage</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#6272a4>		// customresourcedefinitions</span></span>
<span class=line><span style=color:#f8f8f2>		customResourceDefintionStorage </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> customresourcedefinition.</span><span style=color:#50fa7b>NewREST</span><span style=color:#f8f8f2>(Scheme, c.GenericConfig.RESTOptionsGetter)</span></span>
<span class=line><span style=color:#f8f8f2>		storage[</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>customresourcedefinitions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> customResourceDefintionStorage</span></span>
<span class=line><span style=color:#f8f8f2>		storage[</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>customresourcedefinitions/status</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> customresourcedefinition.</span><span style=color:#50fa7b>NewStatusREST</span><span style=color:#f8f8f2>(Scheme, customResourceDefintionStorage)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		apiGroupInfo.VersionedResourcesStorageMap[v1beta1.SchemeGroupVersion.Version] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> storage</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> apiResourceConfig.</span><span style=color:#50fa7b>VersionEnabled</span><span style=color:#f8f8f2>(v1.SchemeGroupVersion) {</span></span>
<span class=line><span style=color:#f8f8f2>		storage </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>rest</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Storage</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#6272a4>		// customresourcedefinitions</span></span>
<span class=line><span style=color:#f8f8f2>		customResourceDefintionStorage </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> customresourcedefinition.</span><span style=color:#50fa7b>NewREST</span><span style=color:#f8f8f2>(Scheme, c.GenericConfig.RESTOptionsGetter)</span></span>
<span class=line><span style=color:#f8f8f2>		storage[</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>customresourcedefinitions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> customResourceDefintionStorage</span></span>
<span class=line><span style=color:#f8f8f2>		storage[</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>customresourcedefinitions/status</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> customresourcedefinition.</span><span style=color:#50fa7b>NewStatusREST</span><span style=color:#f8f8f2>(Scheme, customResourceDefintionStorage)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		apiGroupInfo.VersionedResourcesStorageMap[v1.SchemeGroupVersion.Version] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> storage</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 注册apigroup</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> s.GenericAPIServer.</span><span style=color:#50fa7b>InstallAPIGroup</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>apiGroupInfo); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// clientset创建</span></span>
<span class=line><span style=color:#f8f8f2>	crdClient, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> clientset.</span><span style=color:#50fa7b>NewForConfig</span><span style=color:#f8f8f2>(s.GenericAPIServer.LoopbackClientConfig)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>		// it's really bad that this is leaking here, but until we can fix the test (which I'm pretty sure isn't even testing what it wants to test),</span></span>
<span class=line><span style=color:#6272a4>		// we need to be able to move forward</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>failed to create clientset: </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, err)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	s.Informers </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> externalinformers.</span><span style=color:#50fa7b>NewSharedInformerFactory</span><span style=color:#f8f8f2>(crdClient, </span><span style=color:#bd93f9>5</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>time.Minute)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 创建各种handler</span></span>
<span class=line><span style=color:#f8f8f2>	delegateHandler </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> delegationTarget.</span><span style=color:#50fa7b>UnprotectedHandler</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> delegateHandler </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		delegateHandler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> http.</span><span style=color:#50fa7b>NotFoundHandler</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	versionDiscoveryHandler </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>versionDiscoveryHandler</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		discovery: </span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>schema</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>GroupVersion</span><span style=color:#f8f8f2>]</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>discovery</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>APIVersionHandler</span><span style=color:#f8f8f2>{},</span></span>
<span class=line><span style=color:#f8f8f2>		delegate:  delegateHandler,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	groupDiscoveryHandler </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>groupDiscoveryHandler</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		discovery: </span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>]</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>discovery</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>APIGroupHandler</span><span style=color:#f8f8f2>{},</span></span>
<span class=line><span style=color:#f8f8f2>		delegate:  delegateHandler,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	establishingController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> establish.</span><span style=color:#50fa7b>NewEstablishingController</span><span style=color:#f8f8f2>(s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(), crdClient.</span><span style=color:#50fa7b>ApiextensionsV1</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>	crdHandler, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> NewCustomResourceDefinitionHandler</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#f8f8f2>		versionDiscoveryHandler,</span></span>
<span class=line><span style=color:#f8f8f2>		groupDiscoveryHandler,</span></span>
<span class=line><span style=color:#f8f8f2>		s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		delegateHandler,</span></span>
<span class=line><span style=color:#f8f8f2>		c.ExtraConfig.CRDRESTOptionsGetter,</span></span>
<span class=line><span style=color:#f8f8f2>		c.GenericConfig.AdmissionControl,</span></span>
<span class=line><span style=color:#f8f8f2>		establishingController,</span></span>
<span class=line><span style=color:#f8f8f2>		c.ExtraConfig.ServiceResolver,</span></span>
<span class=line><span style=color:#f8f8f2>		c.ExtraConfig.AuthResolverWrapper,</span></span>
<span class=line><span style=color:#f8f8f2>		c.ExtraConfig.MasterCount,</span></span>
<span class=line><span style=color:#f8f8f2>		s.GenericAPIServer.Authorizer,</span></span>
<span class=line><span style=color:#f8f8f2>		c.GenericConfig.RequestTimeout,</span></span>
<span class=line><span style=color:#f8f8f2>		time.</span><span style=color:#50fa7b>Duration</span><span style=color:#f8f8f2>(c.GenericConfig.MinRequestTimeout)</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>time.Second,</span></span>
<span class=line><span style=color:#f8f8f2>		apiGroupInfo.StaticOpenAPISpec,</span></span>
<span class=line><span style=color:#f8f8f2>		c.GenericConfig.MaxRequestBodyBytes,</span></span>
<span class=line><span style=color:#f8f8f2>	)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	s.GenericAPIServer.Handler.NonGoRestfulMux.</span><span style=color:#50fa7b>Handle</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>/apis</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, crdHandler)</span></span>
<span class=line><span style=color:#f8f8f2>	s.GenericAPIServer.Handler.NonGoRestfulMux.</span><span style=color:#50fa7b>HandlePrefix</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>/apis/</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, crdHandler)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	discoveryController </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> NewDiscoveryController</span><span style=color:#f8f8f2>(s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(), versionDiscoveryHandler, groupDiscoveryHandler)</span></span>
<span class=line><span style=color:#f8f8f2>	namingController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> status.</span><span style=color:#50fa7b>NewNamingConditionController</span><span style=color:#f8f8f2>(s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(), crdClient.</span><span style=color:#50fa7b>ApiextensionsV1</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>	nonStructuralSchemaController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> nonstructuralschema.</span><span style=color:#50fa7b>NewConditionController</span><span style=color:#f8f8f2>(s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(), crdClient.</span><span style=color:#50fa7b>ApiextensionsV1</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>	apiApprovalController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> apiapproval.</span><span style=color:#50fa7b>NewKubernetesAPIApprovalPolicyConformantConditionController</span><span style=color:#f8f8f2>(s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(), crdClient.</span><span style=color:#50fa7b>ApiextensionsV1</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>	finalizingController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> finalizer.</span><span style=color:#50fa7b>NewCRDFinalizer</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#f8f8f2>		s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		crdClient.</span><span style=color:#50fa7b>ApiextensionsV1</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		crdHandler,</span></span>
<span class=line><span style=color:#f8f8f2>	)</span></span>
<span class=line><span style=color:#f8f8f2>	openapiController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> openapicontroller.</span><span style=color:#50fa7b>NewController</span><span style=color:#f8f8f2>(s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>())</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 加入到启动hook中</span></span>
<span class=line><span style=color:#f8f8f2>	s.GenericAPIServer.</span><span style=color:#50fa7b>AddPostStartHookOrDie</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>start-apiextensions-informers</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>context</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PostStartHookContext</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		s.Informers.</span><span style=color:#50fa7b>Start</span><span style=color:#f8f8f2>(context.StopCh)</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#f8f8f2>	s.GenericAPIServer.</span><span style=color:#50fa7b>AddPostStartHookOrDie</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>start-apiextensions-controllers</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>context</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PostStartHookContext</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>		// OpenAPIVersionedService and StaticOpenAPISpec are populated in generic apiserver PrepareRun().</span></span>
<span class=line><span style=color:#6272a4>		// Together they serve the /openapi/v2 endpoint on a generic apiserver. A generic apiserver may</span></span>
<span class=line><span style=color:#6272a4>		// choose to not enable OpenAPI by having null openAPIConfig, and thus OpenAPIVersionedService</span></span>
<span class=line><span style=color:#6272a4>		// and StaticOpenAPISpec are both null. In that case we don't run the CRD OpenAPI controller.</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#f8f8f2> s.GenericAPIServer.OpenAPIVersionedService </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#ff79c6> &#x26;&#x26;</span><span style=color:#f8f8f2> s.GenericAPIServer.StaticOpenAPISpec </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>			go</span><span style=color:#f8f8f2> openapiController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(s.GenericAPIServer.StaticOpenAPISpec, s.GenericAPIServer.OpenAPIVersionedService, context.StopCh)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#f8f8f2> namingController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(context.StopCh)</span></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#f8f8f2> establishingController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(context.StopCh)</span></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#f8f8f2> nonStructuralSchemaController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>5</span><span style=color:#f8f8f2>, context.StopCh)</span></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#f8f8f2> apiApprovalController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>5</span><span style=color:#f8f8f2>, context.StopCh)</span></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#f8f8f2> finalizingController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>5</span><span style=color:#f8f8f2>, context.StopCh)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		discoverySyncedCh </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{})</span></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#f8f8f2> discoveryController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(context.StopCh, discoverySyncedCh)</span></span>
<span class=line><span style=color:#ff79c6>		select</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		case</span><span style=color:#ff79c6> &#x3C;-</span><span style=color:#f8f8f2>context.StopCh:</span></span>
<span class=line><span style=color:#ff79c6>		case</span><span style=color:#ff79c6> &#x3C;-</span><span style=color:#f8f8f2>discoverySyncedCh:</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#6272a4>	// we don't want to report healthy until we can handle all CRDs that have already been registered.  Waiting for the informer</span></span>
<span class=line><span style=color:#6272a4>	// to sync makes sure that the lister will be valid before we begin.  There may still be races for CRDs added after startup,</span></span>
<span class=line><span style=color:#6272a4>	// but we won't go healthy until we can handle the ones already present.</span></span>
<span class=line><span style=color:#f8f8f2>	s.GenericAPIServer.</span><span style=color:#50fa7b>AddPostStartHookOrDie</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>crd-informer-synced</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>context</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PostStartHookContext</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> wait.</span><span style=color:#50fa7b>PollImmediateUntil</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>100</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>time.Millisecond, </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() (</span><span style=color:#8be9fd;font-style:italic>bool</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>			return</span><span style=color:#f8f8f2> s.Informers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>Informer</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>HasSynced</span><span style=color:#f8f8f2>(), </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>		}, context.StopCh)</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> s, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p><code>c.GenericConfig.New</code>来初始化<code>genericapiserver</code>,包裹一些默认链，创建 handler</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>c </span><span style=color:#8be9fd;font-style:italic>completedConfig</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>name</span><span style=color:#8be9fd;font-style:italic> string</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>delegationTarget</span><span style=color:#8be9fd;font-style:italic> DelegationTarget</span><span style=color:#f8f8f2>) (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>GenericAPIServer</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> c.Serializer </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Genericapiserver.New() called with config.Serializer == nil</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> c.LoopbackClientConfig </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Genericapiserver.New() called with config.LoopbackClientConfig == nil</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> c.EquivalentResourceRegistry </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Genericapiserver.New() called with config.EquivalentResourceRegistry == nil</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 包裹了DefaultBuildHandlerChain</span></span>
<span class=line><span style=color:#f8f8f2>	handlerChainBuilder </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>handler</span><span style=color:#8be9fd;font-style:italic> http</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Handler</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>http</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Handler</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> c.</span><span style=color:#50fa7b>BuildHandlerChainFunc</span><span style=color:#f8f8f2>(handler, c.Config)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#6272a4>	// 创建apiserverhandler</span></span>
<span class=line><span style=color:#f8f8f2>	apiServerHandler </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> NewAPIServerHandler</span><span style=color:#f8f8f2>(name, c.Serializer, handlerChainBuilder, delegationTarget.</span><span style=color:#50fa7b>UnprotectedHandler</span><span style=color:#f8f8f2>())</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	...</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> s, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p><code>APIServerHandler</code>包含多种<code>http.Handler</code>类型，包括<code>go-restful</code>以及<code>non-go-restful</code>，以及在以上两者之间选择的<code>Director</code>对象，<code>go-restful</code>用于处理已经注册的 handler，<code>non-go-restful用来处理不存在的handler，API URI处理的选择过程为：</code>FullHandlerChain-> Director ->{GoRestfulContainer， NonGoRestfulMux}<code>。</code>NewAPIServerHandler`</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>func NewAPIServerHandler(name string, s runtime.NegotiatedSerializer, handlerChainBuilder HandlerChainBuilderFn, notFoundHandler http.Handler) *APIServerHandler {</span></span>
<span class=line><span>	// non-go-restful路由</span></span>
<span class=line><span>	nonGoRestfulMux := mux.NewPathRecorderMux(name)</span></span>
<span class=line><span>	if notFoundHandler != nil {</span></span>
<span class=line><span>		nonGoRestfulMux.NotFoundHandler(notFoundHandler)</span></span>
<span class=line><span>	}</span></span>
<span class=line><span></span></span>
<span class=line><span>	// go-resetful路由</span></span>
<span class=line><span>	gorestfulContainer := restful.NewContainer()</span></span>
<span class=line><span>	gorestfulContainer.ServeMux = http.NewServeMux()</span></span>
<span class=line><span>	gorestfulContainer.Router(restful.CurlyRouter{}) // e.g. for proxy/{kind}/{name}/{*}</span></span>
<span class=line><span>	gorestfulContainer.RecoverHandler(func(panicReason interface{}, httpWriter http.ResponseWriter) {</span></span>
<span class=line><span>		logStackOnRecover(s, panicReason, httpWriter)</span></span>
<span class=line><span>	})</span></span>
<span class=line><span>	gorestfulContainer.ServiceErrorHandler(func(serviceErr restful.ServiceError, request *restful.Request, response *restful.Response) {</span></span>
<span class=line><span>		serviceErrorHandler(s, serviceErr, request, response)</span></span>
<span class=line><span>	})</span></span>
<span class=line><span></span></span>
<span class=line><span>	// 选择器, 根据path选择是否执行go-restful，注册过的path执行go-restful</span></span>
<span class=line><span>	director := director{</span></span>
<span class=line><span>		name:               name,</span></span>
<span class=line><span>		goRestfulContainer: gorestfulContainer,</span></span>
<span class=line><span>		nonGoRestfulMux:    nonGoRestfulMux,</span></span>
<span class=line><span>	}</span></span>
<span class=line><span></span></span>
<span class=line><span>	return &#x26;APIServerHandler{</span></span>
<span class=line><span>		FullHandlerChain:   handlerChainBuilder(director),</span></span>
<span class=line><span>		GoRestfulContainer: gorestfulContainer,</span></span>
<span class=line><span>		NonGoRestfulMux:    nonGoRestfulMux,</span></span>
<span class=line><span>		Director:           director,</span></span>
<span class=line><span>	}</span></span>
<span class=line><span>}</span></span>
<span class=line><span></span></span></code></pre><p>以上是<code>APIExtensionsServer</code>的初始化流程，初始化 Server, 调用<code>s.GenericAPIServer.InstallAPIGroup</code>注册 api。此方法的调用链非常深，主要是为了将需要暴露的<code>API Resource</code>注册到 server 中，以便能通过 http 接口进行 resource 的 REST 操作，其他几种 server 在初始化时也都会执行对应的 <code>InstallAPI</code>方法。</p><h3 id=kubeapiserver-初始化>KubeAPIServer 初始化</h3><p>KubeAPIServer 主要是提供对 API Resource 的操作请求，为 kubernetes 中众多 API 注册路由信息，暴露 RESTful API 并且对外提供 kubernetes service，使集群中以及集群外的服务都可以通过 RESTful API 操作 kubernetes 中的资源。</p><p>与<code>APIExtensionsServer</code>，<code>KubeAPIServer</code>初始化流程如下</p><ol><li><code>CreateKubeAPIServer</code>调用<code>kubeAPIServerConfig.Complete().New</code>来初始化</li><li><code>New</code>函数创建默认的<code>apigroup</code>(pod,deployment 等内部资源), 调用<code>InstallAPIs</code>注册</li><li>启动相关 controller, 加入到<code>poststarthook</code></li></ol><h3 id=aggregatorserver-初始化>AggregatorServer 初始化</h3><p><code>Aggregator</code>通过<code>APIServices</code>对象关联到某个<code>Service</code>来进行请求的转发，其关联的<code>Service</code>类型进一步决定了请求转发形式。<code>Aggregator</code>包括一个<code>GenericAPIServer</code>和维护自身状态的<code>Controller</code>。其中 <code>GenericAPIServer</code>主要处理<code>apiregistration.k8s.io</code>组下的<code>APIService</code>资源请求。</p><p><code>Aggregator</code>除了处理资源请求外还包含几个 controller：</p><ol><li>apiserviceRegistrationController：负责<code>APIServices</code>中资源的注册与删除；</li><li>availableConditionController：维护<code>APIServices</code>的可用状态，包括其引用<code>Service</code>是否可用等；</li><li>autoRegistrationController：用于保持 API 中存在的一组特定的<code>APIServices</code>；</li><li>crdRegistrationController：负责将<code>CRD GroupVersions</code>自动注册到<code>APIServices</code>中；</li><li>openAPIAggregationController：将<code>APIServices</code>资源的变化同步至提供的<code>OpenAPI</code>文档； kubernetes 中的一些附加组件，比如 metrics-server 就是通过 Aggregator 的方式进行扩展的，实际环境中可以通过使用 apiserver-builder 工具轻松以 Aggregator 的扩展方式创建自定义资源。</li></ol><p>初始化 AggregatorServer 的主要逻辑为：</p><ol><li>调用<code>aggregatorConfig.Complete().NewWithDelegate</code>创建<code>aggregatorServer</code></li><li>初始化<code>crdRegistrationController</code>和<code>autoRegistrationController</code>，<code>crdRegistrationController</code>负责注册 CRD，<code>autoRegistrationController</code>负责将 CRD 对应的 APIServices 自动注册到 apiserver 中，CRD 创建后可通过<code>$ kubectl get apiservices</code>查看是否注册到 apiservices 中</li><li>将<code>autoRegistrationController</code>和<code>crdRegistrationController</code>加入到 PostStartHook 中</li></ol><p>首先，初始化配置<code>createAggregatorConfig</code></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> createAggregatorConfig</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	kubeAPIServerConfig</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	commandOptions</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>options</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ServerRunOptions</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	externalInformers</span><span style=color:#8be9fd;font-style:italic> kubeexternalinformers</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>SharedInformerFactory</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	serviceResolver</span><span style=color:#8be9fd;font-style:italic> aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ServiceResolver</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	proxyTransport</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>http</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Transport</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#ffb86c;font-style:italic>	pluginInitializers</span><span style=color:#f8f8f2> []</span><span style=color:#8be9fd;font-style:italic>admission</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PluginInitializer</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#f8f8f2>) (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>	// make a shallow copy to let us twiddle a few things</span></span>
<span class=line><span style=color:#6272a4>	// most of the config actually remains the same.  We only need to mess with a couple items related to the particulars of the aggregator</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> kubeAPIServerConfig</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.PostStartHooks </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PostStartHookConfigEntry</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.RESTOptionsGetter </span><span style=color:#ff79c6>=</span><span style=color:#bd93f9> nil</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// override genericConfig.AdmissionControl with kube-aggregator's scheme,</span></span>
<span class=line><span style=color:#6272a4>	// because aggregator apiserver should use its own scheme to convert its own resources.</span></span>
<span class=line><span style=color:#6272a4>	// 取消admission的配置，aggregator自行处理请求，不需要admissions</span></span>
<span class=line><span style=color:#f8f8f2>	err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> commandOptions.Admission.</span><span style=color:#50fa7b>ApplyTo</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#ff79c6>		&#x26;</span><span style=color:#f8f8f2>genericConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		externalInformers,</span></span>
<span class=line><span style=color:#f8f8f2>		genericConfig.LoopbackClientConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		feature.DefaultFeatureGate,</span></span>
<span class=line><span style=color:#f8f8f2>		pluginInitializers</span><span style=color:#ff79c6>...</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// copy the etcd options so we don't mutate originals.</span></span>
<span class=line><span style=color:#f8f8f2>	etcdOptions </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> *</span><span style=color:#f8f8f2>commandOptions.Etcd</span></span>
<span class=line><span style=color:#f8f8f2>	etcdOptions.StorageConfig.Paging </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> utilfeature.DefaultFeatureGate.</span><span style=color:#50fa7b>Enabled</span><span style=color:#f8f8f2>(features.APIListChunking)</span></span>
<span class=line><span style=color:#f8f8f2>	etcdOptions.StorageConfig.Codec </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> aggregatorscheme.Codecs.</span><span style=color:#50fa7b>LegacyCodec</span><span style=color:#f8f8f2>(v1beta1.SchemeGroupVersion, v1.SchemeGroupVersion)</span></span>
<span class=line><span style=color:#f8f8f2>	etcdOptions.StorageConfig.EncodeVersioner </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> runtime.</span><span style=color:#50fa7b>NewMultiGroupVersioner</span><span style=color:#f8f8f2>(v1beta1.SchemeGroupVersion, </span><span style=color:#8be9fd;font-style:italic>schema</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>GroupKind</span><span style=color:#f8f8f2>{Group: v1beta1.GroupName})</span></span>
<span class=line><span style=color:#f8f8f2>	genericConfig.RESTOptionsGetter </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>genericoptions</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>SimpleRestOptionsFactory</span><span style=color:#f8f8f2>{Options: etcdOptions}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// override MergedResourceConfig with aggregator defaults and registry</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> commandOptions.APIEnablement.</span><span style=color:#50fa7b>ApplyTo</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#ff79c6>		&#x26;</span><span style=color:#f8f8f2>genericConfig,</span></span>
<span class=line><span style=color:#f8f8f2>		aggregatorapiserver.</span><span style=color:#50fa7b>DefaultAPIResourceConfigSource</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		aggregatorscheme.Scheme); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 配置proxy证书，用于apiserver与扩展服务的通信，使用requestheader证书签发</span></span>
<span class=line><span style=color:#ff79c6>	var</span><span style=color:#f8f8f2> certBytes, keyBytes []</span><span style=color:#8be9fd;font-style:italic>byte</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#50fa7b> len</span><span style=color:#f8f8f2>(commandOptions.ProxyClientCertFile) </span><span style=color:#ff79c6>></span><span style=color:#bd93f9> 0</span><span style=color:#ff79c6> &#x26;&#x26;</span><span style=color:#50fa7b> len</span><span style=color:#f8f8f2>(commandOptions.ProxyClientKeyFile) </span><span style=color:#ff79c6>></span><span style=color:#bd93f9> 0</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		certBytes, err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> ioutil.</span><span style=color:#50fa7b>ReadFile</span><span style=color:#f8f8f2>(commandOptions.ProxyClientCertFile)</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>			return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>		keyBytes, err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> ioutil.</span><span style=color:#50fa7b>ReadFile</span><span style=color:#f8f8f2>(commandOptions.ProxyClientKeyFile)</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>			return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	aggregatorConfig </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		GenericConfig: </span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>RecommendedConfig</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>			Config:                genericConfig,</span></span>
<span class=line><span style=color:#f8f8f2>			SharedInformerFactory: externalInformers,</span></span>
<span class=line><span style=color:#f8f8f2>		},</span></span>
<span class=line><span style=color:#f8f8f2>		ExtraConfig: </span><span style=color:#8be9fd;font-style:italic>aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ExtraConfig</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>			ProxyClientCert: certBytes,</span></span>
<span class=line><span style=color:#f8f8f2>			ProxyClientKey:  keyBytes,</span></span>
<span class=line><span style=color:#f8f8f2>			ServiceResolver: serviceResolver,</span></span>
<span class=line><span style=color:#6272a4>			// 代理请求的具体实现</span></span>
<span class=line><span style=color:#f8f8f2>			ProxyTransport:  proxyTransport,</span></span>
<span class=line><span style=color:#f8f8f2>		},</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// we need to clear the poststarthooks so we don't add them multiple times to all the servers (that fails)</span></span>
<span class=line><span style=color:#6272a4>	// 加入PostStartHook</span></span>
<span class=line><span style=color:#f8f8f2>	aggregatorConfig.GenericConfig.PostStartHooks </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PostStartHookConfigEntry</span><span style=color:#f8f8f2>{}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> aggregatorConfig, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p><code>createAggregatorServer</code>初始化<code>Aggregator</code></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> createAggregatorServer</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>aggregatorConfig</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>delegateAPIServer</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>DelegationTarget</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>apiExtensionInformers</span><span style=color:#8be9fd;font-style:italic> apiextensionsinformers</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>SharedInformerFactory</span><span style=color:#f8f8f2>) (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>aggregatorapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>APIAggregator</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>	// 初始化配置，与前面流程相同</span></span>
<span class=line><span style=color:#f8f8f2>	aggregatorServer, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> aggregatorConfig.</span><span style=color:#50fa7b>Complete</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>NewWithDelegate</span><span style=color:#f8f8f2>(delegateAPIServer)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 创建auto-registration controller</span></span>
<span class=line><span style=color:#f8f8f2>	apiRegistrationClient, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> apiregistrationclient.</span><span style=color:#50fa7b>NewForConfig</span><span style=color:#f8f8f2>(aggregatorConfig.GenericConfig.LoopbackClientConfig)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	autoRegistrationController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> autoregister.</span><span style=color:#50fa7b>NewAutoRegisterController</span><span style=color:#f8f8f2>(aggregatorServer.APIRegistrationInformers.</span><span style=color:#50fa7b>Apiregistration</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>APIServices</span><span style=color:#f8f8f2>(), apiRegistrationClient)</span></span>
<span class=line><span style=color:#f8f8f2>	apiServices </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> apiServicesToRegister</span><span style=color:#f8f8f2>(delegateAPIServer, autoRegistrationController)</span></span>
<span class=line><span style=color:#f8f8f2>	crdRegistrationController </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> crdregistration.</span><span style=color:#50fa7b>NewCRDRegistrationController</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#f8f8f2>		apiExtensionInformers.</span><span style=color:#50fa7b>Apiextensions</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>CustomResourceDefinitions</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		autoRegistrationController)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> aggregatorServer.GenericAPIServer.</span><span style=color:#50fa7b>AddPostStartHook</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>kube-apiserver-autoregistration</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>context</span><span style=color:#8be9fd;font-style:italic> genericapiserver</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>PostStartHookContext</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>		// 启动controller</span></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#f8f8f2> crdRegistrationController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>5</span><span style=color:#f8f8f2>, context.StopCh)</span></span>
<span class=line><span style=color:#ff79c6>		go</span><span style=color:#ff79c6> func</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#6272a4>			// let the CRD controller process the initial set of CRDs before starting the autoregistration controller.</span></span>
<span class=line><span style=color:#6272a4>			// this prevents the autoregistration controller's initial sync from deleting APIServices for CRDs that still exist.</span></span>
<span class=line><span style=color:#6272a4>			// we only need to do this if CRDs are enabled on this server.  We can't use discovery because we are the source for discovery.</span></span>
<span class=line><span style=color:#ff79c6>			if</span><span style=color:#f8f8f2> aggregatorConfig.GenericConfig.MergedResourceConfig.</span><span style=color:#50fa7b>AnyVersionForGroupEnabled</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apiextensions.k8s.io</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>				crdRegistrationController.</span><span style=color:#50fa7b>WaitForInitialSync</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>			}</span></span>
<span class=line><span style=color:#f8f8f2>			autoRegistrationController.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>5</span><span style=color:#f8f8f2>, context.StopCh)</span></span>
<span class=line><span style=color:#f8f8f2>		}()</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> aggregatorServer.GenericAPIServer.</span><span style=color:#50fa7b>AddBootSequenceHealthChecks</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#50fa7b>		makeAPIServiceAvailableHealthCheck</span><span style=color:#f8f8f2>(</span></span>
<span class=line><span style=color:#e9f284>			"</span><span style=color:#f1fa8c>autoregister-completion</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#f8f8f2>			apiServices,</span></span>
<span class=line><span style=color:#f8f8f2>			aggregatorServer.APIRegistrationInformers.</span><span style=color:#50fa7b>Apiregistration</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>V1</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>APIServices</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		),</span></span>
<span class=line><span style=color:#f8f8f2>	)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> aggregatorServer, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>至此，启动步骤以前分析完了，三个组件的流量大体时一样的，通过<code>Complete().New()</code>初始化配置，创建所需的 controller, 调用<code>InstallAPIGroup</code>注册<code>apigroup</code>。</p><h2 id=请求分析>请求分析</h2><p>上面我们分析了 apiserver 的调用链，大体如下 <code>DefaultHandlerChain->{handler/crdhandler/proxy}->admission->validation->etcd</code></p><ol><li>请求进入时，会经过<code>defaultchain</code>做一些认证鉴权工作</li><li>然后通过<code>route</code>执行对应的 handler，如果为 aggration api, 将直接转发请求到对应 service</li><li>handler 处理完，经过 admission 与 validation，做一些修改和检查，用户在这部分可以自定义 webhook</li><li>最后存入 etcd</li></ol><h2 id=总结>总结</h2><p>本文大体对 apiserver 的启动流程，以及初始化过程做了分析，由于 apiserver 实现复杂，中间一些细节没涉及到，还需要对着代码研究研究。</p><h2 id=参考>参考</h2><ul><li><a href=https://juejin.im/post/5c934e5a5188252d7c216981>https://juejin.im/post/5c934e5a5188252d7c216981</a></li><li><a href=https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/ >https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/</a></li></ul></div><div class="flex flex-col justify-between mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class=mr-5><li class="rounded-full border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1"><a href=/tags/k8s/ class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#k8s</a></li></ul></div></article><div class="mx-auto sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script src=https://giscus.app/client.js async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOCg97r84CBQfL data-emit-metadata=0 data-input-position=top data-lang=en data-loading=lazy data-mapping=title data-reactions-enabled=1 data-repo=qingwave/qingwave.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict=0 data-theme=light></script></div></section><div class="bottom-8 fixed hidden right-6 z-50" id=back-to-top><button class="rounded-full dark:hover:bg-slate-800 dark:hover:text-gray-100 dark:text-gray-300 hover:bg-neutral-100 hover:text-neutral-500 p-3 text-neutral-300"><svg class="h-6 w-6" data-icon=ph:rocket-fill height=1em width=1em><symbol id=ai:ph:rocket-fill viewBox="0 0 256 256"><path d="M152 224a8 8 0 0 1-8 8h-32a8 8 0 0 1 0-16h32a8 8 0 0 1 8 8m71.62-68.17l-12.36 55.63a16 16 0 0 1-25.51 9.11L158.51 200h-61l-27.26 20.57a16 16 0 0 1-25.51-9.11l-12.36-55.63a16.09 16.09 0 0 1 3.32-13.71l28.56-34.26a123 123 0 0 1 8.57-36.67c12.9-32.34 36-52.63 45.37-59.85a16 16 0 0 1 19.6 0c9.34 7.22 32.47 27.51 45.37 59.85a123 123 0 0 1 8.57 36.67l28.56 34.26a16.09 16.09 0 0 1 3.32 13.71m-139.23 34q-16.11-29.33-19.56-57.67L48 152.36L60.36 208l.18-.13ZM140 100a12 12 0 1 0-12 12a12 12 0 0 0 12-12m68 52.36l-16.83-20.2q-3.42 28.28-19.56 57.69l23.85 18l.18.13Z" fill=currentColor /></symbol><use href=#ai:ph:rocket-fill></use></svg></button></div></main><footer class=relative><div class="px-4 mx-auto sm:px-6 max-w-3xl"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="px-4 mx-auto sm:px-6 max-w-3xl dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href=/rss.xml class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label=RSS><svg class="h-5 w-5" data-icon=tabler:rss height=1em width=1em><symbol id=ai:tabler:rss viewBox="0 0 24 24"><path d="M4 19a1 1 0 1 0 2 0a1 1 0 1 0-2 0M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use href=#ai:tabler:rss></use></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href=https://qingwave.github.io class=hover:brightness-50>Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function c(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:localStorage.theme}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),c=encodeURIComponent(t.getAttribute("data-aw-text"));let a;switch(o){case"facebook":a=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":a=`https://twitter.com/intent/tweet?url=${n}&text=${c}`;break;case"linkedin":a=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${c}`;break;case"whatsapp":a=`https://wa.me/?text=${c}%20${n}`;break;case"mail":a=`mailto:?subject=%22${c}%22&body=${c}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=a,s.click()})),c(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{c()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>