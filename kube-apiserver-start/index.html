<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">
        kube-apiserver启动流程分析
        
    </title><meta name="Description" content="Coding, Reading and Daydreaming"><meta property="og:title" content="kube-apiserver启动流程分析" />
<meta property="og:description" content="kube-apiserver 共由 3 个组件构成（Aggregator. KubeAPIServer. APIExtensionServer），这些组件依次通过 Delegation 处理请求： Aggregator：暴露的功能类似于一个七层负载均衡，将来自用户的请求拦截转发给其他服" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qingwave.github.io/kube-apiserver-start/" /><meta property="og:image" content="https://qingwave.github.io/img/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-24T15:28:16+00:00" />
<meta property="article:modified_time" content="2021-12-12T04:54:36+00:00" /><meta property="og:site_name" content="Qingwave" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://qingwave.github.io/img/favicon.png"/>

<meta name="twitter:title" content="kube-apiserver启动流程分析"/>
<meta name="twitter:description" content="kube-apiserver 共由 3 个组件构成（Aggregator. KubeAPIServer. APIExtensionServer），这些组件依次通过 Delegation 处理请求： Aggregator：暴露的功能类似于一个七层负载均衡，将来自用户的请求拦截转发给其他服"/>
<meta name="application-name" content="Qingwave">
<meta name="apple-mobile-web-app-title" content="Qingwave">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://qingwave.github.io/kube-apiserver-start/" /><link rel="prev" href="https://qingwave.github.io/kube-apiserver-aggretation-api/" /><link rel="next" href="https://qingwave.github.io/k8s-tls/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><meta name="google-site-verification" content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" /><meta name="baidu-site-verification" content="muFp3xopwC" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "kube-apiserver启动流程分析",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qingwave.github.io\/kube-apiserver-start\/"
        },"genre": "posts","keywords": "k8s, apiserver","wordcount":  6818 ,
        "url": "https:\/\/qingwave.github.io\/kube-apiserver-start\/","datePublished": "2020-04-24T15:28:16+00:00","dateModified": "2021-12-12T04:54:36+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "qinng"
            },"description": ""
    }
    </script></head>

<body header-desktop="normal" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span><span class="header-title-post"> Time</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#kube-apiserver启动流程">kube-apiserver启动流程</a></li>
    <li><a href="#调用链分析">调用链分析</a>
      <ul>
        <li><a href="#配置初始化">配置初始化</a></li>
        <li><a href="#apiextensionsserver初始化">APIExtensionsServer初始化</a></li>
        <li><a href="#kubeapiserver初始化">KubeAPIServer初始化</a></li>
        <li><a href="#aggregatorserver初始化">AggregatorServer初始化</a></li>
      </ul>
    </li>
    <li><a href="#请求分析">请求分析</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title">kube-apiserver启动流程分析</h1><div class="post-meta">
            <div class="post-meta-line"><time datetime="Apr 24, 2020">Apr 24, 2020</time>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#kube-apiserver启动流程">kube-apiserver启动流程</a></li>
    <li><a href="#调用链分析">调用链分析</a>
      <ul>
        <li><a href="#配置初始化">配置初始化</a></li>
        <li><a href="#apiextensionsserver初始化">APIExtensionsServer初始化</a></li>
        <li><a href="#kubeapiserver初始化">KubeAPIServer初始化</a></li>
        <li><a href="#aggregatorserver初始化">AggregatorServer初始化</a></li>
      </ul>
    </li>
    <li><a href="#请求分析">请求分析</a></li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>kube-apiserver 共由 3 个组件构成（Aggregator. KubeAPIServer. APIExtensionServer），这些组件依次通过 Delegation 处理请求：</p>
<ul>
<li>Aggregator：暴露的功能类似于一个七层负载均衡，将来自用户的请求拦截转发给其他服务器，并且负责整个 APIServer 的 Discovery 功能；也负责处理ApiService，注册对应的扩展api。</li>
<li>KubeAPIServer ：负责对请求的一些通用处理，认证. 鉴权等，以及处理各个内建资源的 REST 服务；</li>
<li>APIExtensionServer：主要处理 CustomResourceDefinition（CRD）和 CustomResource（CR）的 REST 请求，也是 Delegation 的最后一环，如果对应 CR 不能被处理的话则会返回 404。</li>
</ul>
<h2 id="kube-apiserver启动流程" class="headerLink">
    <a href="#kube-apiserver%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b" class="header-mark"></a>kube-apiserver启动流程</h2><p>Apiserver通过<code>Run</code>方法启动, 主要逻辑为：</p>
<ol>
<li>调用<code>CreateServerChain</code>构建服务调用链并判断是否启动非安全的<code>httpserver</code>，<code>httpserver</code>链中包含 apiserver要启动的三个server，以及为每个server注册对应资源的路由；</li>
<li>调用<code>server.PrepareRun</code>进行服务运行前的准备，该方法主要完成了健康检查. 存活检查和OpenAPI路由的注册工作；</li>
<li>调用<code>prepared.Run</code>启动server；</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// Run runs the specified APIServer.  This should never exit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">completeOptions</span> <span class="nx">completedServerRunOptions</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// To help debugging, immediately log version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">klog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Version: %+v&#34;</span><span class="p">,</span> <span class="nx">version</span><span class="p">.</span><span class="nf">Get</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 创建调用链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateServerChain</span><span class="p">(</span><span class="nx">completeOptions</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 进行一些准备工作， 注册一些hander，执行hook等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">prepared</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">PrepareRun</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 开始执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">prepared</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>执行具体的<code>Run</code>方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// Run spawns the secure http server. It only returns if stopCh is closed
</span></span></span><span class="line"><span class="cl"><span class="c1">// or the secure port cannot be listened on initially.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">preparedGenericAPIServer</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">delayedStopCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">delayedStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// As soon as shutdown is initiated, /readyz should start returning failure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// This gives the load balancer a window defined by ShutdownDelayDuration to detect that /readyz is red
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// and stop sending traffic to this server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// 当终止时，关闭readiness
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nb">close</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">readinessStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ShutdownDelayDuration</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 执行非阻塞Run
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// close socket after delayed stopCh
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">NonBlockingRun</span><span class="p">(</span><span class="nx">delayedStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// run shutdown hooks directly. This includes deregistering from the kubernetes endpoint in case of kube-apiserver.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 关闭前执行一些hook操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">RunPreShutdownHooks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// wait for the delayed stopCh before closing the handler chain (it rejects everything after Wait has been called).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">&lt;-</span><span class="nx">delayedStopCh</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 等待所有请求执行完
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Wait for all requests to finish, which are bounded by the RequestTimeout variable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">HandlerChainWaitGroup</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>执行<code>NonBlockingRun</code>
<code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go:351</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">preparedGenericAPIServer</span><span class="p">)</span> <span class="nf">NonBlockingRun</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">auditStopCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. 判断是否要启动审计日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">AuditBackend</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">AuditBackend</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">auditStopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to run the audit backend: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. 启动 https server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">internalStopCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">stoppedCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">SecureServingInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Handler</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stoppedCh</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">SecureServingInfo</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ShutdownTimeout</span><span class="p">,</span> <span class="nx">internalStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">close</span><span class="p">(</span><span class="nx">internalStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">close</span><span class="p">(</span><span class="nx">auditStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">&lt;-</span><span class="nx">stopCh</span>
</span></span><span class="line"><span class="cl">        <span class="nb">close</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">readinessStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">close</span><span class="p">(</span><span class="nx">internalStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">stoppedCh</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">&lt;-</span><span class="nx">stoppedCh</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span><span class="p">.</span><span class="nx">HandlerChainWaitGroup</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">close</span><span class="p">(</span><span class="nx">auditStopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. 执行 postStartHooks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">.</span><span class="nf">RunPostStartHooks</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4. 向 systemd 发送 ready 信号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">systemd</span><span class="p">.</span><span class="nf">SdNotify</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="s">&#34;READY=1\n&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">klog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Unable to send systemd daemon successful start message: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="调用链分析" class="headerLink">
    <a href="#%e8%b0%83%e7%94%a8%e9%93%be%e5%88%86%e6%9e%90" class="header-mark"></a>调用链分析</h2><p>上一节简单分析了Apiserver的启动流程，通过初始化各种配置，封装调用链，启动Server。这节主要分析调用链。</p>
<p>初始化阶段, 通过<code>CreateServerChain</code>创建调用链， 代码在<a href="https://github.com/kubernetes/kubernetes/blob/1d057da2f73118893b5cc27c15d59ff03beb271e/cmd/kube-apiserver/app/server.go#L169" target="_blank" rel="noopener noreffer">server.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// CreateServerChain creates the apiservers connected via delegation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CreateServerChain</span><span class="p">(</span><span class="nx">completedOptions</span> <span class="nx">completedServerRunOptions</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">APIAggregator</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// nodetunneler与node通信，proxy实现代理功能，转发请求给其他apiservice
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// apiserver到cluster的通信可以通过三种方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// apiserver到kubelet的endpoint，用于logs功能，exec功能，port-forward功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// HTTP连接，即使可以用HTTPS也不做任何其他校验，并不安全
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ssh tunnel，不推荐使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nx">nodeTunneler</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateNodeDialer</span><span class="p">(</span><span class="nx">completedOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. 为 kubeAPIServer 创建配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kubeAPIServerConfig</span><span class="p">,</span> <span class="nx">insecureServingInfo</span><span class="p">,</span> <span class="nx">serviceResolver</span><span class="p">,</span> <span class="nx">pluginInitializer</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span>                                         <span class="nf">CreateKubeAPIServerConfig</span><span class="p">(</span><span class="nx">completedOptions</span><span class="p">,</span> <span class="nx">nodeTunneler</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2. 判断是否配置了 APIExtensionsServer，创建 apiExtensionsConfig 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apiExtensionsConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAPIExtensionsConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">VersionedInformers</span><span class="p">,</span>        <span class="nx">pluginInitializer</span><span class="p">,</span> <span class="nx">completedOptions</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span> <span class="nx">completedOptions</span><span class="p">.</span><span class="nx">MasterCount</span><span class="p">,</span><span class="nx">vc</span>
</span></span><span class="line"><span class="cl">        <span class="nx">serviceResolver</span><span class="p">,</span> <span class="nx">webhook</span><span class="p">.</span><span class="nf">NewDefaultAuthenticationInfoResolverWrapper</span><span class="p">(</span><span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3. 初始化 APIExtensionsServer, 通过一个空的delegate初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apiExtensionsServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAPIExtensionsServer</span><span class="p">(</span><span class="nx">apiExtensionsConfig</span><span class="p">,</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewEmptyDelegate</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4. 初始化 KubeAPIServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">kubeAPIServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateKubeAPIServer</span><span class="p">(</span><span class="nx">kubeAPIServerConfig</span><span class="p">,</span> <span class="nx">apiExtensionsServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 5. 创建 AggregatorConfig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aggregatorConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAggregatorConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">,</span> <span class="nx">completedOptions</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span>          <span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">VersionedInformers</span><span class="p">,</span> <span class="nx">serviceResolver</span><span class="p">,</span> <span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">pluginInitializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 6. 初始化 AggregatorServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aggregatorServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">createAggregatorServer</span><span class="p">(</span><span class="nx">aggregatorConfig</span><span class="p">,</span> <span class="nx">kubeAPIServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">,</span> <span class="nx">apiExtensionsServer</span><span class="p">.</span><span class="nx">Informers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 7. 判断是否启动非安全端口的 http server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">insecureServingInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">insecureHandlerChain</span> <span class="o">:=</span> <span class="nx">kubeserver</span><span class="p">.</span><span class="nf">BuildInsecureHandlerChain</span><span class="p">(</span><span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">UnprotectedHandler</span><span class="p">(),</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">insecureServingInfo</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">insecureHandlerChain</span><span class="p">,</span> <span class="nx">kubeAPIServerConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RequestTimeout</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">aggregatorServer</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>创建过程主要有以下步骤：</p>
<ol>
<li>根据配置构造apiserver的配置，调用方法<code>CreateKubeAPIServerConfig</code></li>
<li>根据配置构造扩展的apiserver的配置，调用方法为<code>createAPIExtensionsConfig</code></li>
<li>创建server，包括扩展的apiserver和原生的apiserver，调用方法为<code>createAPIExtensionsServer</code>和<code>CreateKubeAPIServer</code>。主要就是将各个handler的路由方法注册到Container中去，完全遵循go-restful的设计模式，即将处理方法注册到Route中去，同一个根路径下的Route注册到WebService中去，WebService注册到Container中，Container负责分发。访问的过程为<code>Container--&gt;WebService--&gt;Route</code></li>
<li>聚合server的配置和和创建。主要就是将原生的apiserver和扩展的apiserver的访问进行整合，添加后续的一些处理接口。调用方法为<code>createAggregatorConfig</code>和<code>createAggregatorServer</code></li>
<li>创建完成，返回配置的server信息</li>
</ol>
<p>以上几个步骤，最核心的就是apiserver如何创建，即如何按照go-restful的模式，添加路由和相应的处理方法。</p>
<h3 id="配置初始化" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>配置初始化</h3><p>先看apiserver配置的创建<code>CreateKubeAPIServerConfig-&gt;buildGenericConfig-&gt;genericapiserver.NewConfig</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// BuildGenericConfig takes the master server options and produces the genericapiserver.Config associated with it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">buildGenericConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">proxyTransport</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span> <span class="o">*</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">versionedInformers</span> <span class="nx">clientgoinformers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">insecureServingInfo</span> <span class="o">*</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DeprecatedInsecureServingInfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serviceResolver</span> <span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">ServiceResolver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pluginInitializers</span> <span class="p">[]</span><span class="nx">admission</span><span class="p">.</span><span class="nx">PluginInitializer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">admissionPostStartHook</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">storageFactory</span> <span class="o">*</span><span class="nx">serverstorage</span><span class="p">.</span><span class="nx">DefaultStorageFactory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lastErr</span> <span class="kt">error</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建genericConfig,其中包括DefaultBuildHandlerChain，一系列认证授权的中间件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericConfig</span> <span class="p">=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewConfig</span><span class="p">(</span><span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span> <span class="p">=</span> <span class="nx">master</span><span class="p">.</span><span class="nf">DefaultAPIResourceConfigSource</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化各种配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericServerRunOptions</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span><span class="nx">genericConfig</span><span class="p">);</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span> <span class="p">=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">DefaultOpenAPIConfig</span><span class="p">(</span><span class="nx">generatedopenapi</span><span class="p">.</span><span class="nx">GetOpenAPIDefinitions</span><span class="p">,</span> <span class="nx">openapinamer</span><span class="p">.</span><span class="nf">NewDefinitionNamer</span><span class="p">(</span><span class="nx">legacyscheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">extensionsapiserver</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">aggregatorscheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nx">Title</span> <span class="p">=</span> <span class="s">&#34;Kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 长连接请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LongRunningFunc</span> <span class="p">=</span> <span class="nx">filters</span><span class="p">.</span><span class="nf">BasicLongRunningRequestCheck</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">(</span><span class="s">&#34;watch&#34;</span><span class="p">,</span> <span class="s">&#34;proxy&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">(</span><span class="s">&#34;attach&#34;</span><span class="p">,</span> <span class="s">&#34;exec&#34;</span><span class="p">,</span> <span class="s">&#34;proxy&#34;</span><span class="p">,</span> <span class="s">&#34;log&#34;</span><span class="p">,</span> <span class="s">&#34;portforward&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">kubeVersion</span> <span class="o">:=</span> <span class="nx">version</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">kubeVersion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化storageFactory， 用来连接etcd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">storageFactoryConfig</span> <span class="o">:=</span> <span class="nx">kubeapiserver</span><span class="p">.</span><span class="nf">NewStorageFactoryConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">storageFactoryConfig</span><span class="p">.</span><span class="nx">APIResourceConfig</span> <span class="p">=</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span>
</span></span><span class="line"><span class="cl">	<span class="nx">completedStorageFactoryConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">storageFactoryConfig</span><span class="p">.</span><span class="nf">Complete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Etcd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">storageFactory</span><span class="p">,</span> <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">completedStorageFactoryConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storageFactory</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">EgressLookup</span> <span class="p">=</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span><span class="p">.</span><span class="nx">Lookup</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Etcd</span><span class="p">.</span><span class="nf">ApplyWithStorageFactoryTo</span><span class="p">(</span><span class="nx">storageFactory</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">);</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use protobufs for self-communication.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Since not every generic apiserver has to support protobufs, we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// cannot default to it in generic apiserver and need to explicitly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// set it in kube-apiserver.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 内部使用protobufs通信
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">ContentConfig</span><span class="p">.</span><span class="nx">ContentType</span> <span class="p">=</span> <span class="s">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Disable compression for self-communication, since we are going to be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// on a fast local network
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">DisableCompression</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// clientset初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kubeClientConfig</span> <span class="o">:=</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span>
</span></span><span class="line"><span class="cl">	<span class="nx">clientgoExternalClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientgoclientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">kubeClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create real external clientset: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">versionedInformers</span> <span class="p">=</span> <span class="nx">clientgoinformers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">clientgoExternalClient</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化认证实例，支持多种认证方式：requestheader,token, tls等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">Authentication</span><span class="p">.</span><span class="nx">Authenticator</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">OpenAPIConfig</span><span class="p">.</span><span class="nx">SecurityDefinitions</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">BuildAuthenticator</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span><span class="p">,</span> <span class="nx">clientgoExternalClient</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid authentication config: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化鉴权配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">RuleResolver</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">BuildAuthorizer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid authorization config: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">sets</span><span class="p">.</span><span class="nf">NewString</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Modes</span><span class="o">...</span><span class="p">).</span><span class="nf">Has</span><span class="p">(</span><span class="nx">modes</span><span class="p">.</span><span class="nx">ModeRBAC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">DisabledPostStartHooks</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="nx">rbacrest</span><span class="p">.</span><span class="nx">PostStartHookName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化admission webhook的配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">admissionConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">kubeapiserveradmission</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ExternalInformers</span><span class="p">:</span>    <span class="nx">versionedInformers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LoopbackClientConfig</span><span class="p">:</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">CloudConfigFile</span><span class="p">:</span>      <span class="nx">s</span><span class="p">.</span><span class="nx">CloudProvider</span><span class="p">.</span><span class="nx">CloudConfigFile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serviceResolver</span> <span class="p">=</span> <span class="nf">buildServiceResolver</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">EnableAggregatorRouting</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">authInfoResolverWrapper</span> <span class="o">:=</span> <span class="nx">webhook</span><span class="p">.</span><span class="nf">NewDefaultAuthenticationInfoResolverWrapper</span><span class="p">(</span><span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Audit</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">genericConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">versionedInformers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">serveroptions</span><span class="p">.</span><span class="nf">NewProcessInfo</span><span class="p">(</span><span class="s">&#34;kube-apiserver&#34;</span><span class="p">,</span> <span class="s">&#34;kube-system&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">serveroptions</span><span class="p">.</span><span class="nx">WebhookOptions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">AuthInfoResolverWrapper</span><span class="p">:</span> <span class="nx">authInfoResolverWrapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ServiceResolver</span><span class="p">:</span>         <span class="nx">serviceResolver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">lastErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化注入插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pluginInitializers</span><span class="p">,</span> <span class="nx">admissionPostStartHook</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">admissionConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">proxyTransport</span><span class="p">,</span> <span class="nx">genericConfig</span><span class="p">.</span><span class="nx">EgressSelector</span><span class="p">,</span> <span class="nx">serviceResolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create admission plugin initializer: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">genericConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">versionedInformers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kubeClientConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">feature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pluginInitializers</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">lastErr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to initialize admission: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">genericfeatures</span><span class="p">.</span><span class="nx">APIPriorityAndFairness</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericServerRunOptions</span><span class="p">.</span><span class="nx">EnablePriorityAndFairness</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">FlowControl</span> <span class="p">=</span> <span class="nf">BuildPriorityAndFairness</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">clientgoExternalClient</span><span class="p">,</span> <span class="nx">versionedInformers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="apiextensionsserver初始化" class="headerLink">
    <a href="#apiextensionsserver%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>APIExtensionsServer初始化</h3><p><code>APIExtensionsServer</code>最先初始化，在调用链的末尾, 处理CR、CRD相关资源.</p>
<p>其中包含的 controller 以及功能如下所示：</p>
<ol>
<li>openapiController：将 crd 资源的变化同步至提供的 OpenAPI 文档，可通过访问 /openapi/v2 进行查看；</li>
<li>crdController：负责将 crd 信息注册到 apiVersions 和 apiResources 中，两者的信息可通过 $ kubectl api-versions 和 $ kubectl api-resources 查看；</li>
<li>namingController：检查 crd obj 中是否有命名冲突，可在 crd .status.conditions 中查看；</li>
<li>establishingController：检查 crd 是否处于正常状态，可在 crd .status.conditions 中查看；</li>
<li>nonStructuralSchemaController：检查 crd obj 结构是否正常，可在 crd .status.conditions 中查看；</li>
<li>apiApprovalController：检查 crd 是否遵循 kubernetes API 声明策略，可在 crd .status.conditions 中查看；</li>
<li>finalizingController：类似于 finalizes 的功能，与 CRs 的删除有关；</li>
</ol>
<p><code>createAPIExtensionsServer</code>调用<code>apiextensionsConfig.Complete().New(delegateAPIServer)</code></p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go:132</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="o">/</span> <span class="nx">New</span> <span class="nx">returns</span> <span class="nx">a</span> <span class="nx">new</span> <span class="nx">instance</span> <span class="nx">of</span> <span class="nx">CustomResourceDefinitions</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">given</span> <span class="nx">config</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">New</span><span class="p">(</span><span class="nx">delegationTarget</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CustomResourceDefinitions</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化 genericServer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;apiextensions-apiserver&#34;</span><span class="p">,</span> <span class="nx">delegationTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CustomResourceDefinitions</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">GenericAPIServer</span><span class="p">:</span> <span class="nx">genericServer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化apigroup, 即需要暴露的api，这里extension apiserver只注册了cr于crd相关的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">apiResourceConfig</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span>
</span></span><span class="line"><span class="cl">	<span class="nx">apiGroupInfo</span> <span class="o">:=</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nf">NewDefaultAPIGroupInfo</span><span class="p">(</span><span class="nx">apiextensions</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">,</span> <span class="nx">Scheme</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">,</span> <span class="nx">Codecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">apiResourceConfig</span><span class="p">.</span><span class="nf">VersionEnabled</span><span class="p">(</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// customresourcedefinitions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">customResourceDefintionStorage</span> <span class="o">:=</span> <span class="nx">customresourcedefinition</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storage</span><span class="p">[</span><span class="s">&#34;customresourcedefinitions&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">customResourceDefintionStorage</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storage</span><span class="p">[</span><span class="s">&#34;customresourcedefinitions/status&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">customresourcedefinition</span><span class="p">.</span><span class="nf">NewStatusREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">customResourceDefintionStorage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">.</span><span class="nx">Version</span><span class="p">]</span> <span class="p">=</span> <span class="nx">storage</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">apiResourceConfig</span><span class="p">.</span><span class="nf">VersionEnabled</span><span class="p">(</span><span class="nx">v1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storage</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Storage</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// customresourcedefinitions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">customResourceDefintionStorage</span> <span class="o">:=</span> <span class="nx">customresourcedefinition</span><span class="p">.</span><span class="nf">NewREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storage</span><span class="p">[</span><span class="s">&#34;customresourcedefinitions&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">customResourceDefintionStorage</span>
</span></span><span class="line"><span class="cl">		<span class="nx">storage</span><span class="p">[</span><span class="s">&#34;customresourcedefinitions/status&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">customresourcedefinition</span><span class="p">.</span><span class="nf">NewStatusREST</span><span class="p">(</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">customResourceDefintionStorage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">VersionedResourcesStorageMap</span><span class="p">[</span><span class="nx">v1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">.</span><span class="nx">Version</span><span class="p">]</span> <span class="p">=</span> <span class="nx">storage</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 注册apigroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">InstallAPIGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">apiGroupInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// clientset创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">crdClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// it&#39;s really bad that this is leaking here, but until we can fix the test (which I&#39;m pretty sure isn&#39;t even testing what it wants to test),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// we need to be able to move forward
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create clientset: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span> <span class="p">=</span> <span class="nx">externalinformers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">crdClient</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建各种handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">delegateHandler</span> <span class="o">:=</span> <span class="nx">delegationTarget</span><span class="p">.</span><span class="nf">UnprotectedHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">delegateHandler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">delegateHandler</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NotFoundHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">versionDiscoveryHandler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">versionDiscoveryHandler</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">discovery</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">]</span><span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">APIVersionHandler</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">delegate</span><span class="p">:</span>  <span class="nx">delegateHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">groupDiscoveryHandler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">groupDiscoveryHandler</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">discovery</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">APIGroupHandler</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">delegate</span><span class="p">:</span>  <span class="nx">delegateHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">establishingController</span> <span class="o">:=</span> <span class="nx">establish</span><span class="p">.</span><span class="nf">NewEstablishingController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">ApiextensionsV1</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">crdHandler</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewCustomResourceDefinitionHandler</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">versionDiscoveryHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">groupDiscoveryHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">delegateHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">CRDRESTOptionsGetter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">AdmissionControl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">establishingController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">ServiceResolver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">AuthResolverWrapper</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">.</span><span class="nx">MasterCount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">RequestTimeout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">MinRequestTimeout</span><span class="p">)</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiGroupInfo</span><span class="p">.</span><span class="nx">StaticOpenAPISpec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">MaxRequestBodyBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">NonGoRestfulMux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/apis&#34;</span><span class="p">,</span> <span class="nx">crdHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">NonGoRestfulMux</span><span class="p">.</span><span class="nf">HandlePrefix</span><span class="p">(</span><span class="s">&#34;/apis/&#34;</span><span class="p">,</span> <span class="nx">crdHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">discoveryController</span> <span class="o">:=</span> <span class="nf">NewDiscoveryController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">versionDiscoveryHandler</span><span class="p">,</span> <span class="nx">groupDiscoveryHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">namingController</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">NewNamingConditionController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">ApiextensionsV1</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">nonStructuralSchemaController</span> <span class="o">:=</span> <span class="nx">nonstructuralschema</span><span class="p">.</span><span class="nf">NewConditionController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">ApiextensionsV1</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">apiApprovalController</span> <span class="o">:=</span> <span class="nx">apiapproval</span><span class="p">.</span><span class="nf">NewKubernetesAPIApprovalPolicyConformantConditionController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span> <span class="nx">crdClient</span><span class="p">.</span><span class="nf">ApiextensionsV1</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">finalizingController</span> <span class="o">:=</span> <span class="nx">finalizer</span><span class="p">.</span><span class="nf">NewCRDFinalizer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">crdClient</span><span class="p">.</span><span class="nf">ApiextensionsV1</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">crdHandler</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">openapiController</span> <span class="o">:=</span> <span class="nx">openapicontroller</span><span class="p">.</span><span class="nf">NewController</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 加入到启动hook中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-apiextensions-informers&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;start-apiextensions-controllers&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// OpenAPIVersionedService and StaticOpenAPISpec are populated in generic apiserver PrepareRun().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Together they serve the /openapi/v2 endpoint on a generic apiserver. A generic apiserver may
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// choose to not enable OpenAPI by having null openAPIConfig, and thus OpenAPIVersionedService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// and StaticOpenAPISpec are both null. In that case we don&#39;t run the CRD OpenAPI controller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">OpenAPIVersionedService</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">StaticOpenAPISpec</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">go</span> <span class="nx">openapiController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">StaticOpenAPISpec</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nx">OpenAPIVersionedService</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">namingController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">establishingController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">nonStructuralSchemaController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">apiApprovalController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">finalizingController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">discoverySyncedCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="nx">discoveryController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">,</span> <span class="nx">discoverySyncedCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">discoverySyncedCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// we don&#39;t want to report healthy until we can handle all CRDs that have already been registered.  Waiting for the informer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to sync makes sure that the lister will be valid before we begin.  There may still be races for CRDs added after startup,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// but we won&#39;t go healthy until we can handle the ones already present.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHookOrDie</span><span class="p">(</span><span class="s">&#34;crd-informer-synced&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">PollImmediateUntil</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Informers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">().</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">HasSynced</span><span class="p">(),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>c.GenericConfig.New</code>来初始化<code>genericapiserver</code>,包裹一些默认链，创建handler</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">completedConfig</span><span class="p">)</span> <span class="nf">New</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">delegationTarget</span> <span class="nx">DelegationTarget</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">GenericAPIServer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Genericapiserver.New() called with config.Serializer == nil&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Genericapiserver.New() called with config.LoopbackClientConfig == nil&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">EquivalentResourceRegistry</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Genericapiserver.New() called with config.EquivalentResourceRegistry == nil&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 包裹了DefaultBuildHandlerChain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">handlerChainBuilder</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">BuildHandlerChainFunc</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建apiserverhandler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">apiServerHandler</span> <span class="o">:=</span> <span class="nf">NewAPIServerHandler</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">,</span> <span class="nx">handlerChainBuilder</span><span class="p">,</span> <span class="nx">delegationTarget</span><span class="p">.</span><span class="nf">UnprotectedHandler</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>APIServerHandler</code>包含多种<code>http.Handler</code>类型，包括<code>go-restful</code>以及<code>non-go-restful</code>，以及在以上两者之间选择的<code>Director</code>对象，<code>go-restful</code>用于处理已经注册的handler，<code>non-go-restful用来处理不存在的handler，API URI处理的选择过程为：</code>FullHandlerChain-&gt; Director -&gt;{GoRestfulContainer， NonGoRestfulMux}<code>。 </code>NewAPIServerHandler`</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func NewAPIServerHandler(name string, s runtime.NegotiatedSerializer, handlerChainBuilder HandlerChainBuilderFn, notFoundHandler http.Handler) *APIServerHandler {
</span></span><span class="line"><span class="cl">	// non-go-restful路由
</span></span><span class="line"><span class="cl">	nonGoRestfulMux := mux.NewPathRecorderMux(name)
</span></span><span class="line"><span class="cl">	if notFoundHandler != nil {
</span></span><span class="line"><span class="cl">		nonGoRestfulMux.NotFoundHandler(notFoundHandler)
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	// go-resetful路由
</span></span><span class="line"><span class="cl">	gorestfulContainer := restful.NewContainer()
</span></span><span class="line"><span class="cl">	gorestfulContainer.ServeMux = http.NewServeMux()
</span></span><span class="line"><span class="cl">	gorestfulContainer.Router(restful.CurlyRouter{}) // e.g. for proxy/{kind}/{name}/{*}
</span></span><span class="line"><span class="cl">	gorestfulContainer.RecoverHandler(func(panicReason interface{}, httpWriter http.ResponseWriter) {
</span></span><span class="line"><span class="cl">		logStackOnRecover(s, panicReason, httpWriter)
</span></span><span class="line"><span class="cl">	})
</span></span><span class="line"><span class="cl">	gorestfulContainer.ServiceErrorHandler(func(serviceErr restful.ServiceError, request *restful.Request, response *restful.Response) {
</span></span><span class="line"><span class="cl">		serviceErrorHandler(s, serviceErr, request, response)
</span></span><span class="line"><span class="cl">	})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	// 选择器, 根据path选择是否执行go-restful，注册过的path执行go-restful
</span></span><span class="line"><span class="cl">	director := director{
</span></span><span class="line"><span class="cl">		name:               name,
</span></span><span class="line"><span class="cl">		goRestfulContainer: gorestfulContainer,
</span></span><span class="line"><span class="cl">		nonGoRestfulMux:    nonGoRestfulMux,
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	return &amp;APIServerHandler{
</span></span><span class="line"><span class="cl">		FullHandlerChain:   handlerChainBuilder(director),
</span></span><span class="line"><span class="cl">		GoRestfulContainer: gorestfulContainer,
</span></span><span class="line"><span class="cl">		NonGoRestfulMux:    nonGoRestfulMux,
</span></span><span class="line"><span class="cl">		Director:           director,
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>以上是<code>APIExtensionsServer</code>的初始化流程，初始化Server, 调用<code>s.GenericAPIServer.InstallAPIGroup</code>注册api。此方法的调用链非常深，主要是为了将需要暴露的<code>API Resource</code>注册到 server 中，以便能通过 http 接口进行 resource 的 REST 操作，其他几种 server 在初始化时也都会执行对应的 <code>InstallAPI</code>方法。</p>
<h3 id="kubeapiserver初始化" class="headerLink">
    <a href="#kubeapiserver%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>KubeAPIServer初始化</h3><p>KubeAPIServer 主要是提供对 API Resource 的操作请求，为 kubernetes 中众多 API 注册路由信息，暴露 RESTful API 并且对外提供 kubernetes service，使集群中以及集群外的服务都可以通过 RESTful API 操作 kubernetes 中的资源。</p>
<p>与<code>APIExtensionsServer</code>，<code>KubeAPIServer</code>初始化流程如下</p>
<ol>
<li><code>CreateKubeAPIServer</code>调用<code>kubeAPIServerConfig.Complete().New</code>来初始化</li>
<li><code>New</code>函数创建默认的<code>apigroup</code>(pod,deployment等内部资源), 调用<code>InstallAPIs</code>注册</li>
<li>启动相关controller, 加入到<code>poststarthook</code></li>
</ol>
<h3 id="aggregatorserver初始化" class="headerLink">
    <a href="#aggregatorserver%e5%88%9d%e5%a7%8b%e5%8c%96" class="header-mark"></a>AggregatorServer初始化</h3><p><code>Aggregator</code>通过<code>APIServices</code>对象关联到某个<code>Service</code>来进行请求的转发，其关联的<code>Service</code>类型进一步决定了请求转发形式。<code>Aggregator</code>包括一个<code>GenericAPIServer</code>和维护自身状态的<code>Controller</code>。其中 <code>GenericAPIServer</code>主要处理<code>apiregistration.k8s.io</code>组下的<code>APIService</code>资源请求。</p>
<p><code>Aggregator</code>除了处理资源请求外还包含几个controller：</p>
<ol>
<li>apiserviceRegistrationController：负责<code>APIServices</code>中资源的注册与删除；</li>
<li>availableConditionController：维护<code>APIServices</code>的可用状态，包括其引用<code>Service</code>是否可用等；</li>
<li>autoRegistrationController：用于保持API中存在的一组特定的<code>APIServices</code>；</li>
<li>crdRegistrationController：负责将<code>CRD GroupVersions</code>自动注册到<code>APIServices</code>中；</li>
<li>openAPIAggregationController：将<code>APIServices</code>资源的变化同步至提供的<code>OpenAPI</code>文档；
kubernetes中的一些附加组件，比如metrics-server就是通过Aggregator的方式进行扩展的，实际环境中可以通过使用apiserver-builder工具轻松以Aggregator的扩展方式创建自定义资源。</li>
</ol>
<p>初始化AggregatorServer的主要逻辑为：</p>
<ol>
<li>调用<code>aggregatorConfig.Complete().NewWithDelegate</code>创建<code>aggregatorServer</code></li>
<li>初始化<code>crdRegistrationController</code>和<code>autoRegistrationController</code>，<code>crdRegistrationController</code>负责注册CRD，<code>autoRegistrationController</code>负责将 CRD 对应的 APIServices自动注册到apiserver中，CRD 创建后可通过<code>$ kubectl get apiservices</code>查看是否注册到 apiservices中</li>
<li>将<code>autoRegistrationController</code>和<code>crdRegistrationController</code>加入到PostStartHook中</li>
</ol>
<p>首先，初始化配置<code>createAggregatorConfig</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createAggregatorConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kubeAPIServerConfig</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">commandOptions</span> <span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">ServerRunOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">externalInformers</span> <span class="nx">kubeexternalinformers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serviceResolver</span> <span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">ServiceResolver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">proxyTransport</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pluginInitializers</span> <span class="p">[]</span><span class="nx">admission</span><span class="p">.</span><span class="nx">PluginInitializer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// make a shallow copy to let us twiddle a few things
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// most of the config actually remains the same.  We only need to mess with a couple items related to the particulars of the aggregator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">genericConfig</span> <span class="o">:=</span> <span class="nx">kubeAPIServerConfig</span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">PostStartHooks</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookConfigEntry</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// override genericConfig.AdmissionControl with kube-aggregator&#39;s scheme,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// because aggregator apiserver should use its own scheme to convert its own resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 取消admission的配置，aggregator自行处理请求，不需要admissions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">commandOptions</span><span class="p">.</span><span class="nx">Admission</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">genericConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">externalInformers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">feature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pluginInitializers</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// copy the etcd options so we don&#39;t mutate originals.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">etcdOptions</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">commandOptions</span><span class="p">.</span><span class="nx">Etcd</span>
</span></span><span class="line"><span class="cl">	<span class="nx">etcdOptions</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">Paging</span> <span class="p">=</span> <span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">APIListChunking</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">etcdOptions</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">Codec</span> <span class="p">=</span> <span class="nx">aggregatorscheme</span><span class="p">.</span><span class="nx">Codecs</span><span class="p">.</span><span class="nf">LegacyCodec</span><span class="p">(</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">etcdOptions</span><span class="p">.</span><span class="nx">StorageConfig</span><span class="p">.</span><span class="nx">EncodeVersioner</span> <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewMultiGroupVersioner</span><span class="p">(</span><span class="nx">v1beta1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupKind</span><span class="p">{</span><span class="nx">Group</span><span class="p">:</span> <span class="nx">v1beta1</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">genericConfig</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">genericoptions</span><span class="p">.</span><span class="nx">SimpleRestOptionsFactory</span><span class="p">{</span><span class="nx">Options</span><span class="p">:</span> <span class="nx">etcdOptions</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// override MergedResourceConfig with aggregator defaults and registry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">commandOptions</span><span class="p">.</span><span class="nx">APIEnablement</span><span class="p">.</span><span class="nf">ApplyTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">genericConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nf">DefaultAPIResourceConfigSource</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">aggregatorscheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 配置proxy证书，用于apiserver与扩展服务的通信，使用requestheader证书签发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">certBytes</span><span class="p">,</span> <span class="nx">keyBytes</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">commandOptions</span><span class="p">.</span><span class="nx">ProxyClientCertFile</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">commandOptions</span><span class="p">.</span><span class="nx">ProxyClientKeyFile</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">certBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">commandOptions</span><span class="p">.</span><span class="nx">ProxyClientCertFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">keyBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">commandOptions</span><span class="p">.</span><span class="nx">ProxyClientKeyFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">aggregatorConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">GenericConfig</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">RecommendedConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Config</span><span class="p">:</span>                <span class="nx">genericConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">SharedInformerFactory</span><span class="p">:</span> <span class="nx">externalInformers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ExtraConfig</span><span class="p">:</span> <span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">ExtraConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ProxyClientCert</span><span class="p">:</span> <span class="nx">certBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ProxyClientKey</span><span class="p">:</span>  <span class="nx">keyBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ServiceResolver</span><span class="p">:</span> <span class="nx">serviceResolver</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// 代理请求的具体实现
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">ProxyTransport</span><span class="p">:</span>  <span class="nx">proxyTransport</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// we need to clear the poststarthooks so we don&#39;t add them multiple times to all the servers (that fails)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 加入PostStartHook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">aggregatorConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">PostStartHooks</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookConfigEntry</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">aggregatorConfig</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>createAggregatorServer</code>初始化<code>Aggregator</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">createAggregatorServer</span><span class="p">(</span><span class="nx">aggregatorConfig</span> <span class="o">*</span><span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">delegateAPIServer</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">DelegationTarget</span><span class="p">,</span> <span class="nx">apiExtensionInformers</span> <span class="nx">apiextensionsinformers</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">aggregatorapiserver</span><span class="p">.</span><span class="nx">APIAggregator</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 初始化配置，与前面流程相同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">aggregatorServer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">aggregatorConfig</span><span class="p">.</span><span class="nf">Complete</span><span class="p">().</span><span class="nf">NewWithDelegate</span><span class="p">(</span><span class="nx">delegateAPIServer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建auto-registration controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">apiRegistrationClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">apiregistrationclient</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">aggregatorConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">LoopbackClientConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">autoRegistrationController</span> <span class="o">:=</span> <span class="nx">autoregister</span><span class="p">.</span><span class="nf">NewAutoRegisterController</span><span class="p">(</span><span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">APIRegistrationInformers</span><span class="p">.</span><span class="nf">Apiregistration</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">APIServices</span><span class="p">(),</span> <span class="nx">apiRegistrationClient</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">apiServices</span> <span class="o">:=</span> <span class="nf">apiServicesToRegister</span><span class="p">(</span><span class="nx">delegateAPIServer</span><span class="p">,</span> <span class="nx">autoRegistrationController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">crdRegistrationController</span> <span class="o">:=</span> <span class="nx">crdregistration</span><span class="p">.</span><span class="nf">NewCRDRegistrationController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">apiExtensionInformers</span><span class="p">.</span><span class="nf">Apiextensions</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CustomResourceDefinitions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">autoRegistrationController</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddPostStartHook</span><span class="p">(</span><span class="s">&#34;kube-apiserver-autoregistration&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="nx">genericapiserver</span><span class="p">.</span><span class="nx">PostStartHookContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 启动controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">go</span> <span class="nx">crdRegistrationController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// let the CRD controller process the initial set of CRDs before starting the autoregistration controller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// this prevents the autoregistration controller&#39;s initial sync from deleting APIServices for CRDs that still exist.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// we only need to do this if CRDs are enabled on this server.  We can&#39;t use discovery because we are the source for discovery.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">aggregatorConfig</span><span class="p">.</span><span class="nx">GenericConfig</span><span class="p">.</span><span class="nx">MergedResourceConfig</span><span class="p">.</span><span class="nf">AnyVersionForGroupEnabled</span><span class="p">(</span><span class="s">&#34;apiextensions.k8s.io&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">crdRegistrationController</span><span class="p">.</span><span class="nf">WaitForInitialSync</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">autoRegistrationController</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">StopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">GenericAPIServer</span><span class="p">.</span><span class="nf">AddBootSequenceHealthChecks</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nf">makeAPIServiceAvailableHealthCheck</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;autoregister-completion&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">apiServices</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">aggregatorServer</span><span class="p">.</span><span class="nx">APIRegistrationInformers</span><span class="p">.</span><span class="nf">Apiregistration</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">APIServices</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">aggregatorServer</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>至此，启动步骤以前分析完了，三个组件的流量大体时一样的，通过<code>Complete().New()</code>初始化配置，创建所需的controller, 调用<code>InstallAPIGroup</code>注册<code>apigroup</code>。</p>
<h2 id="请求分析" class="headerLink">
    <a href="#%e8%af%b7%e6%b1%82%e5%88%86%e6%9e%90" class="header-mark"></a>请求分析</h2><p>上面我们分析了apiserver的调用链，大体如下
<code>DefaultHandlerChain-&gt;{handler/crdhandler/proxy}-&gt;admission-&gt;validation-&gt;etcd</code></p>
<ol>
<li>请求进入时，会经过<code>defaultchain</code>做一些认证鉴权工作</li>
<li>然后通过<code>route</code>执行对应的handler，如果为aggration api, 将直接转发请求到对应service</li>
<li>handler处理完，经过admission与validation，做一些修改和检查，用户在这部分可以自定义webhook</li>
<li>最后存入etcd</li>
</ol>
<h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h2><p>本文大体对apiserver的启动流程，以及初始化过程做了分析，由于apiserver实现复杂，中间一些细节没涉及到，还需要对着代码研究研究。</p>
<h2 id="参考" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>参考</h2><ul>
<li><a href="https://juejin.im/post/5c934e5a5188252d7c216981" target="_blank" rel="noopener noreffer">https://juejin.im/post/5c934e5a5188252d7c216981</a></li>
<li><a href="https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/" target="_blank" rel="noopener noreffer">https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/</a></li>
</ul>
</div>

        
        <div class="post-footer" id="post-footer">
    <div class="post-meta-line"><span class="single-tag">
                <a href='/tags/k8s/'>#k8s</a>
                    <span class="separator"> </span>
                <a href='/tags/apiserver/'>#apiserver</a></span></div>

    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-link">
                <a href='/about'>About Me</a>
            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
        </div>
    </div><div class="post-nav"><a href="/kube-apiserver-aggretation-api/" class="prev" rel="prev" title="kubernetes扩展apiserver实现分析"><i class="fas fa-angle-left fa-fw"></i>kubernetes扩展apiserver实现分析</a>
            <a href="/k8s-tls/" class="next" rel="next" title="可能是史上最全的Kubernetes证书解析">可能是史上最全的Kubernetes证书解析<i class="fas fa-angle-right fa-fw"></i></a></div></div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qingwave.github.io" target="_blank" rel="noopener noreferrer">Qingwave</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-134548083-1', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"maxShownLines":-1},"comment":{"giscus":{"customTheme":"light","darkTheme":"dark","dataCategory":"Announcements","dataCategoryId":"DIC_kwDOCg97r84CBQfL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"qingwave/qingwave.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=","lightTheme":"light"}}};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script></div>
</body>

</html>