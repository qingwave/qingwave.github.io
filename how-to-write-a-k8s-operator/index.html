<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">
        快速实现一个Kubernetes Operator
        
    </title><meta name="Description" content="Coding, Reading and Daydreaming"><meta property="og:title" content="快速实现一个Kubernetes Operator" />
<meta property="og:description" content="Kubernetes提供了众多的扩展功能，比如CRD、CRI、CSI等等，强大的扩展功能让k8s迅速占领市场。Operator模式可以实现CRD并管理自定义资源的生命周期，本文基于kubebuilder快速实现一个Operator，示例源码见mygame。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qingwave.github.io/how-to-write-a-k8s-operator/" /><meta property="og:image" content="https://qingwave.github.io/img/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-12T02:58:47+00:00" />
<meta property="article:modified_time" content="2022-10-31T10:29:13+08:00" /><meta property="og:site_name" content="Qingwave" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://qingwave.github.io/img/favicon.png"/>

<meta name="twitter:title" content="快速实现一个Kubernetes Operator"/>
<meta name="twitter:description" content="Kubernetes提供了众多的扩展功能，比如CRD、CRI、CSI等等，强大的扩展功能让k8s迅速占领市场。Operator模式可以实现CRD并管理自定义资源的生命周期，本文基于kubebuilder快速实现一个Operator，示例源码见mygame。"/>
<meta name="application-name" content="Qingwave">
<meta name="apple-mobile-web-app-title" content="Qingwave">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://qingwave.github.io/how-to-write-a-k8s-operator/" /><link rel="prev" href="https://qingwave.github.io/k8s-hpa-enchance/" /><link rel="next" href="https://qingwave.github.io/k8s-kubebuilder-deep-dive/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><meta name="google-site-verification" content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" /><meta name="baidu-site-verification" content="muFp3xopwC" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "快速实现一个Kubernetes Operator",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qingwave.github.io\/how-to-write-a-k8s-operator\/"
        },"genre": "posts","keywords": "k8s","wordcount":  3083 ,
        "url": "https:\/\/qingwave.github.io\/how-to-write-a-k8s-operator\/","datePublished": "2021-08-12T02:58:47+00:00","dateModified": "2022-10-31T10:29:13+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "qinng"
            },"description": ""
    }
    </script></head>

<body header-desktop="normal" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span><span class="header-title-post"> Time</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#kubebuilder">Kubebuilder</a></li>
    <li><a href="#示例">示例</a>
      <ul>
        <li><a href="#准备环境">准备环境</a></li>
        <li><a href="#创建项目">创建项目</a></li>
        <li><a href="#创建api">创建API</a></li>
        <li><a href="#编写api">编写API</a></li>
        <li><a href="#编写controller逻辑">编写Controller逻辑</a></li>
        <li><a href="#部署验证">部署验证</a></li>
        <li><a href="#webhook">Webhook</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title">快速实现一个Kubernetes Operator</h1><div class="post-meta">
            <div class="post-meta-line"><time datetime="Aug 12, 2021">Aug 12, 2021</time>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#kubebuilder">Kubebuilder</a></li>
    <li><a href="#示例">示例</a>
      <ul>
        <li><a href="#准备环境">准备环境</a></li>
        <li><a href="#创建项目">创建项目</a></li>
        <li><a href="#创建api">创建API</a></li>
        <li><a href="#编写api">编写API</a></li>
        <li><a href="#编写controller逻辑">编写Controller逻辑</a></li>
        <li><a href="#部署验证">部署验证</a></li>
        <li><a href="#webhook">Webhook</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Kubernetes提供了众多的扩展功能，比如CRD、CRI、CSI等等，强大的扩展功能让k8s迅速占领市场。<a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/" target="_blank" rel="noopener noreffer">Operator</a>模式可以实现CRD并管理自定义资源的生命周期，本文基于<a href="https://kubebuilder.io/" target="_blank" rel="noopener noreffer">kubebuilder</a>快速实现一个Operator，示例源码见<a href="https://github.com/qingwave/mygame" target="_blank" rel="noopener noreffer">mygame</a>。</p>
<h2 id="kubebuilder" class="headerLink">
    <a href="#kubebuilder" class="header-mark"></a>Kubebuilder</h2><p><code>kubebuilder</code>是一个官方提供快速实现Operator的工具包，可快速生成k8s的CRD、Controller、Webhook，用户只需要实现业务逻辑。</p>
<blockquote>
<p>类似工具还有<a href="https://sdk.operatorframework.io/" target="_blank" rel="noopener noreffer">operader-sdk</a>，目前正在与<code>Kubebuilder</code>融合</p>
</blockquote>
<p>kubebuilder封装了<code>controller-runtime</code>与<code>controller-tools</code>，通过<code>controller-gen</code>来生产代码，简化了用户创建Operator的步骤。</p>
<p>一般创建Operator流程如下：</p>
<ol>
<li>创建工作目录，初始化项目</li>
<li>创建API，填充字段</li>
<li>创建Controller，编写核心协调逻辑(Reconcile)</li>
<li>创建Webhook，实现接口，可选</li>
<li>验证测试</li>
<li>发布到集群中</li>
</ol>
<h2 id="示例" class="headerLink">
    <a href="#%e7%a4%ba%e4%be%8b" class="header-mark"></a>示例</h2><p>我们准备创建一个2048的游戏，对外可以提供服务，也能方便地扩缩容。</p>
<h3 id="准备环境" class="headerLink">
    <a href="#%e5%87%86%e5%a4%87%e7%8e%af%e5%a2%83" class="header-mark"></a>准备环境</h3><p>首先你需要有Kubernetes、Docker、Golang相关环境。
Linux下安装kubebuilder</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/<span class="k">$(</span>go env GOOS<span class="k">)</span>/<span class="k">$(</span>go env GOARCH<span class="k">)</span>
</span></span><span class="line"><span class="cl">chmod +x kubebuilder <span class="o">&amp;&amp;</span> mv kubebuilder /usr/local/bin/
</span></span></code></pre></div><h3 id="创建项目" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba%e9%a1%b9%e7%9b%ae" class="header-mark"></a>创建项目</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mkdir -p ~/work/mygame &amp;&amp; cd $_
</span></span><span class="line"><span class="cl">kubebuilder init --domain qingwave.github.io --repo qingwave.github.io/mygame
</span></span></code></pre></div><h3 id="创建api" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%baapi" class="header-mark"></a>创建API</h3><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubebuilder create api --group myapp --version v1 --kind Game
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Create Resource [y/n]
</span></span><span class="line"><span class="cl">y #生成CR
</span></span><span class="line"><span class="cl">Create Controller [y/n]
</span></span><span class="line"><span class="cl">y #生成Controller
</span></span></code></pre></div><p>目录结构如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">├── api
</span></span><span class="line"><span class="cl">│   └── v1 # CRD定义
</span></span><span class="line"><span class="cl">├── bin
</span></span><span class="line"><span class="cl">│   └── controller-gen
</span></span><span class="line"><span class="cl">├── config
</span></span><span class="line"><span class="cl">│   ├── crd # crd配置
</span></span><span class="line"><span class="cl">│   ├── default
</span></span><span class="line"><span class="cl">│   ├── manager # operator部署文件
</span></span><span class="line"><span class="cl">│   ├── prometheus
</span></span><span class="line"><span class="cl">│   ├── rbac
</span></span><span class="line"><span class="cl">│   └── samples # cr示例
</span></span><span class="line"><span class="cl">├── controllers
</span></span><span class="line"><span class="cl">│   ├── game_controller.go # controller逻辑
</span></span><span class="line"><span class="cl">│   └── suite_test.go
</span></span><span class="line"><span class="cl">├── Dockerfile
</span></span><span class="line"><span class="cl">├── go.mod
</span></span><span class="line"><span class="cl">├── go.sum
</span></span><span class="line"><span class="cl">├── hack
</span></span><span class="line"><span class="cl">│   └── boilerplate.go.txt # 头文件模板
</span></span><span class="line"><span class="cl">├── main.go # 项目主函数
</span></span><span class="line"><span class="cl">├── Makefile 
</span></span><span class="line"><span class="cl">└── PROJECT #项目元数据
</span></span></code></pre></div><h3 id="编写api" class="headerLink">
    <a href="#%e7%bc%96%e5%86%99api" class="header-mark"></a>编写API</h3><p>在<code>mygame/api/v1/game_types.go</code>定义我们需要的字段</p>
<p><code>Spec</code>配置如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">GameSpec</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Number of desired pods. This is a pointer to distinguish between explicit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// zero and not specified. Defaults to 1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//+kubebuilder:default:=1 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//+kubebuilder:validation:Minimum:=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Replicas</span> <span class="o">*</span><span class="kt">int32</span> <span class="s">`json:&#34;replicas,omitempty&#34; protobuf:&#34;varint,1,opt,name=replicas&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Docker image name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// +optional
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Image</span> <span class="kt">string</span> <span class="s">`json:&#34;image,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ingress Host name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Host</span> <span class="kt">string</span> <span class="s">`json:&#34;host,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p><code>kubebuilder:default</code>可以设置默认值</p>
</blockquote>
<p><code>Status</code>定义如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Running</span>  <span class="p">=</span> <span class="s">&#34;Running&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Pending</span>  <span class="p">=</span> <span class="s">&#34;Pending&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">NotReady</span> <span class="p">=</span> <span class="s">&#34;NotReady&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Failed</span>   <span class="p">=</span> <span class="s">&#34;Failed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">GameStatus</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Phase is the phase of guestbook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Phase</span> <span class="kt">string</span> <span class="s">`json:&#34;phase,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// replicas is the number of Pods created by the StatefulSet controller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Replicas</span> <span class="kt">int32</span> <span class="s">`json:&#34;replicas&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// readyReplicas is the number of Pods created by the StatefulSet controller that have a Ready Condition.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ReadyReplicas</span> <span class="kt">int32</span> <span class="s">`json:&#34;readyReplicas&#34;`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// LabelSelector is label selectors for query over pods that should match the replica count used by HPA.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">LabelSelector</span> <span class="kt">string</span> <span class="s">`json:&#34;labelSelector,omitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>另外需要添加<code>scale</code>接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//+kubebuilder:subresource:scale:specpath=.spec.replicas,statuspath=.status.replicas,selectorpath=.status.labelSelector
</span></span></code></pre></div><p>添加<code>kubectl</code>展示参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//+kubebuilder:printcolumn:name=&#34;Phase&#34;,type=&#34;string&#34;,JSONPath=&#34;.status.phase&#34;,description=&#34;The phase of game.&#34;
</span></span><span class="line"><span class="cl">//+kubebuilder:printcolumn:name=&#34;Host&#34;,type=&#34;string&#34;,JSONPath=&#34;.spec.host&#34;,description=&#34;The Host Address.&#34;
</span></span><span class="line"><span class="cl">//+kubebuilder:printcolumn:name=&#34;DESIRED&#34;,type=&#34;integer&#34;,JSONPath=&#34;.spec.replicas&#34;,description=&#34;The desired number of pods.&#34;
</span></span><span class="line"><span class="cl">//+kubebuilder:printcolumn:name=&#34;CURRENT&#34;,type=&#34;integer&#34;,JSONPath=&#34;.status.replicas&#34;,description=&#34;The number of currently all pods.&#34;
</span></span><span class="line"><span class="cl">//+kubebuilder:printcolumn:name=&#34;READY&#34;,type=&#34;integer&#34;,JSONPath=&#34;.status.readyReplicas&#34;,description=&#34;The number of pods ready.&#34;
</span></span><span class="line"><span class="cl">//+kubebuilder:printcolumn:name=&#34;AGE&#34;,type=&#34;date&#34;,JSONPath=&#34;.metadata.creationTimestamp&#34;,description=&#34;CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC.&#34;
</span></span></code></pre></div><h3 id="编写controller逻辑" class="headerLink">
    <a href="#%e7%bc%96%e5%86%99controller%e9%80%bb%e8%be%91" class="header-mark"></a>编写Controller逻辑</h3><p>Controller的核心逻辑在<code>Reconcile</code>中，我们只需要填充自己的业务逻辑</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">GameReconciler</span><span class="p">)</span> <span class="nf">Reconcile</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;revice reconcile event&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 获取game对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">game</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">myappv1</span><span class="p">.</span><span class="nx">Game</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="nx">client</span><span class="p">.</span><span class="nf">IgnoreNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果处在删除中直接跳过
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">game</span><span class="p">.</span><span class="nx">DeletionTimestamp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;game in deleting&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 同步资源，如果资源不存在创建deployment、ingress、service，并更新status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">syncGame</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">game</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to sync game&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Result</span><span class="p">{},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>添加rbac配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete
</span></span><span class="line"><span class="cl">//+kubebuilder:rbac:groups=apps,resources=deployments/status,verbs=get;update;patch
</span></span><span class="line"><span class="cl">//+kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete
</span></span><span class="line"><span class="cl">//+kubebuilder:rbac:groups=networking,resources=ingresses,verbs=get;list;watch;create;update;patch;delete
</span></span></code></pre></div><p>具体<code>syncGame</code>逻辑如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">GameReconciler</span><span class="p">)</span> <span class="nf">syncGame</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="o">*</span><span class="nx">myappv1</span><span class="p">.</span><span class="nx">Game</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">game</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.</span><span class="nf">DeepCopy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">name</span> <span class="o">:=</span> <span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Namespace</span><span class="p">:</span> <span class="nx">game</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Name</span><span class="p">:</span>      <span class="nx">game</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 构造owner
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">owner</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">OwnerReference</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">APIVersion</span><span class="p">:</span>         <span class="nx">game</span><span class="p">.</span><span class="nx">APIVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Kind</span><span class="p">:</span>               <span class="nx">game</span><span class="p">.</span><span class="nx">Kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>               <span class="nx">game</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Controller</span><span class="p">:</span>         <span class="nx">pointer</span><span class="p">.</span><span class="nf">BoolPtr</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">BlockOwnerDeletion</span><span class="p">:</span> <span class="nx">pointer</span><span class="p">.</span><span class="nf">BoolPtr</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">UID</span><span class="p">:</span>                <span class="nx">game</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">labels</span> <span class="o">:=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">Labels</span>
</span></span><span class="line"><span class="cl">	<span class="nx">labels</span><span class="p">[</span><span class="nx">gameLabelName</span><span class="p">]</span> <span class="p">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">Name</span>
</span></span><span class="line"><span class="cl">	<span class="nx">meta</span> <span class="o">:=</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Name</span><span class="p">:</span>            <span class="nx">game</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Namespace</span><span class="p">:</span>       <span class="nx">game</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Labels</span><span class="p">:</span>          <span class="nx">labels</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">OwnerReferences</span><span class="p">:</span> <span class="nx">owner</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 获取对应deployment, 如不存在则创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">deploy</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">deploy</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">deploy</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">meta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Spec</span><span class="p">:</span>       <span class="nf">getDeploymentSpec</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">labels</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">deploy</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;create deployment success&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果存在对比和game生成的deployment是否一致，不一致则更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">want</span> <span class="o">:=</span> <span class="nf">getDeploymentSpec</span><span class="p">(</span><span class="nx">game</span><span class="p">,</span> <span class="nx">labels</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">get</span> <span class="o">:=</span> <span class="nf">getSpecFromDeployment</span><span class="p">(</span><span class="nx">deploy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">DeepEqual</span><span class="p">(</span><span class="nx">want</span><span class="p">,</span> <span class="nx">get</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">deploy</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">meta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Spec</span><span class="p">:</span>       <span class="nx">want</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">deploy</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;update deployment success&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">//service创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">svc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">corev1</span><span class="p">.</span><span class="nx">Service</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">svc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// ingress创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ing</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">networkingv1</span><span class="p">.</span><span class="nx">Ingress</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">ing</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">newStatus</span> <span class="o">:=</span> <span class="nx">myappv1</span><span class="p">.</span><span class="nx">GameStatus</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Replicas</span><span class="p">:</span>      <span class="o">*</span><span class="nx">game</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Replicas</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ReadyReplicas</span><span class="p">:</span> <span class="nx">deploy</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">ReadyReplicas</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">newStatus</span><span class="p">.</span><span class="nx">Replicas</span> <span class="o">==</span> <span class="nx">newStatus</span><span class="p">.</span><span class="nx">ReadyReplicas</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">newStatus</span><span class="p">.</span><span class="nx">Phase</span> <span class="p">=</span> <span class="nx">myappv1</span><span class="p">.</span><span class="nx">Running</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">newStatus</span><span class="p">.</span><span class="nx">Phase</span> <span class="p">=</span> <span class="nx">myappv1</span><span class="p">.</span><span class="nx">NotReady</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 更新状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">DeepEqual</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span> <span class="nx">newStatus</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">game</span><span class="p">.</span><span class="nx">Status</span> <span class="p">=</span> <span class="nx">newStatus</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;update game status&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Update</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">game</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>默认情况下生成的controller只监听自定义资源，在示例中我们也需要监听<code>game</code>的子资源，如监听<code>deployment</code>是否符合预期</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// SetupWithManager sets up the controller with the Manager.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">GameReconciler</span><span class="p">)</span> <span class="nf">SetupWithManager</span><span class="p">(</span><span class="nx">mgr</span> <span class="nx">ctrl</span><span class="p">.</span><span class="nx">Manager</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 创建controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;game-controller&#34;</span><span class="p">,</span> <span class="nx">mgr</span><span class="p">,</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Reconciler</span><span class="p">:</span>              <span class="nx">r</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MaxConcurrentReconciles</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="c1">//controller运行的worker数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//监听自定义资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">myappv1</span><span class="p">.</span><span class="nx">Game</span><span class="p">{}},</span> <span class="o">&amp;</span><span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestForObject</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//监听deployment,将owner信息即game namespace/name添加到队列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">source</span><span class="p">.</span><span class="nx">Kind</span><span class="p">{</span><span class="nx">Type</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">appsv1</span><span class="p">.</span><span class="nx">Deployment</span><span class="p">{}},</span> <span class="o">&amp;</span><span class="nx">handler</span><span class="p">.</span><span class="nx">EnqueueRequestForOwner</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">OwnerType</span><span class="p">:</span>    <span class="o">&amp;</span><span class="nx">myappv1</span><span class="p">.</span><span class="nx">Game</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsController</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="部署验证" class="headerLink">
    <a href="#%e9%83%a8%e7%bd%b2%e9%aa%8c%e8%af%81" class="header-mark"></a>部署验证</h3><p>安装CRD</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">make install
</span></span></code></pre></div><p>本地运行operator</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">make run
</span></span></code></pre></div><p>修改sample文件<code>config/samples/myapp_v1_game.yaml</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">myapp.qingwave.github.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Game</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">game-sample</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">alexwhen/docker-2048</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">mygame.io</span><span class="w">
</span></span></span></code></pre></div><p>部署<code>game-sample</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl apply -f config/samples/myapp_v1_game.yaml
</span></span></code></pre></div><p>查看<code>game</code>自定义资源状态</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看game</span>
</span></span><span class="line"><span class="cl">kubectl get game
</span></span><span class="line"><span class="cl">NAME          PHASE     HOST        DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">game-sample   Running   mygame.io   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>       6m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deploy</span>
</span></span><span class="line"><span class="cl">kubectl get deploy game-sample
</span></span><span class="line"><span class="cl">NAME          READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">game-sample   1/1     <span class="m">1</span>            <span class="m">1</span>           6m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看ingress</span>
</span></span><span class="line"><span class="cl">kubectl get ing game-sample
</span></span><span class="line"><span class="cl">NAME          CLASS    HOSTS       ADDRESS        PORTS   AGE
</span></span><span class="line"><span class="cl">game-sample   &lt;none&gt;   mygame.io   192.168.49.2   <span class="m">80</span>      7m
</span></span></code></pre></div><p>验证应用，在<code>/etc/hosts</code>中添加<code>&lt;Ingress ADDRESS Ip&gt;	mygame.io</code>，访问浏览器如下图所示
<img
        class="lazyload"
        data-src="/img/blogImg/crd_mygame.png"
        data-srcset="/img/blogImg/crd_mygame.png, /img/blogImg/crd_mygame.png 1.5x, /img/blogImg/crd_mygame.png 2x"
        data-sizes="auto"
        alt="/img/blogImg/crd_mygame.png"
        title="2048">

</p>
<p>验证扩容</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl scale games.myapp.qingwave.github.io game-sample --replicas <span class="m">2</span>
</span></span><span class="line"><span class="cl">game.myapp.qingwave.github.io/game-sample scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 扩容后</span>
</span></span><span class="line"><span class="cl">kubectl get games.myapp.qingwave.github.io
</span></span><span class="line"><span class="cl">NAME          PHASE     HOST        DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">game-sample   Running   mygame.io   <span class="m">2</span>         <span class="m">2</span>         <span class="m">2</span>       7m
</span></span></code></pre></div><p>如需部署<code>Operator</code>到集群中，可参考官方文档，制作镜像并上传，运行<code>make deploy</code></p>
<h3 id="webhook" class="headerLink">
    <a href="#webhook" class="header-mark"></a>Webhook</h3><p>通常我们需要与CR自定义资源设置部分字段的默认值，或者验证字段是否合法，这就需要自己实现<code>Webhook</code>，<code>Kubebuilder</code>也提供了<code>Webhook</code>的功能。</p>
<p>通过设置<code>--defaulting</code>可创建<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook" target="_blank" rel="noopener noreffer">mutatingadmissionwebhook</a>类型准入控制器，用来修改传入资源；参数<code>--programmatic-validation</code>可创建<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook" target="_blank" rel="noopener noreffer">validatingadmissionwebhook</a>，用来验证传入资源</p>
<blockquote>
<p>在资源创建、修改时<code>apiserver</code>会通过http调用<code>webhook</code>提供的接口，所以会带来额外开销，简单的验证工作可通过<code>//+kubebuilder:validation</code>注解，直接通过<code>openapi</code>验证，性能更好</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubebuilder create webhook --group myapp --version v1 --kind Game --defaulting --programmatic-validation
</span></span></code></pre></div><p>生成文件在<code>api/v1/game_webhook.go</code></p>
<p><code>Default</code>接口可实现修改资源，根据kubebuilder注释,当<code>game</code>资源<code>create</code>与<code>update</code>时，调用这个接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//+kubebuilder:webhook:path=/mutate-myapp-qingwave-github-io-v1-game,mutating=true,failurePolicy=fail,sideEffects=None,groups=myapp.qingwave.github.io,resources=games,verbs=create;update,versions=v1,name=mgame.kb.io,admissionReviewVersions={v1,v1beta1}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">defaultImage</span> <span class="p">=</span> <span class="s">`alexwhen/docker-2048`</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Default implements webhook.Defaulter so a webhook will be registered for the type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Game</span><span class="p">)</span> <span class="nf">Default</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">gamelog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置默认镜像
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Image</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Image</span> <span class="p">=</span> <span class="nx">defaultImage</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 设置默认Host
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Host</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Host</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s.%s.mygame.io&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>同样的通过<code>ValidateCreate</code>、<code>ValidateUpdate</code>可实现<code>validating webhook</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Game</span><span class="p">)</span> <span class="nf">ValidateCreate</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">gamelog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;validate create&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Host不能包括通配符
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span> <span class="s">&#34;*&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;host should not contain *&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>本地验证webhook需要配置证书，在集群中测试更方便点，可参考官方文档。</p>
<h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h2><p>至此，我们已经实现了一个功能完全的<code>game-operator</code>，可以管理<code>game</code>资源的生命周期，创建/更新game时会自动创建<code>deployment、service、ingress</code>等资源，当<code>deployment</code>被误删或者误修改时也可以自动回复到期望状态，也实现了<code>scale</code>接口。</p>
<p>通过<code>kubebuiler</code>大大简化了开发<code>operator</code>的成本，我们只需要关心业务逻辑即可，不需要再手动去创建<code>client/controller</code>等，但同时<code>kubebuilder</code>生成的代码中屏蔽了很多细节，比如<code>controller</code>的最大worker数、同步时间、队列类型等参数设置，只有了解<code>operator</code>的原理才更好应用于生产。</p>
<h2 id="引用" class="headerLink">
    <a href="#%e5%bc%95%e7%94%a8" class="header-mark"></a>引用</h2><ul>
<li><a href="https://book.kubebuilder.io/" target="_blank" rel="noopener noreffer">https://book.kubebuilder.io/</a></li>
</ul></div>

        
        <div class="post-footer" id="post-footer">
    <div class="post-meta-line"><span class="single-tag">
                <a href='/tags/k8s/'>#k8s</a></span></div>

    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-link">
                <a href='/about'>About Me</a>
            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
        </div>
    </div><div class="post-nav"><a href="/k8s-hpa-enchance/" class="prev" rel="prev" title="优化Kubernetes横向扩缩HPA"><i class="fas fa-angle-left fa-fw"></i>优化Kubernetes横向扩缩HPA</a>
            <a href="/k8s-kubebuilder-deep-dive/" class="next" rel="next" title="深入了解kubebuilder">深入了解kubebuilder<i class="fas fa-angle-right fa-fw"></i></a></div></div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qingwave.github.io" target="_blank" rel="noopener noreferrer">Qingwave</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-134548083-1', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"maxShownLines":-1},"comment":{"giscus":{"customTheme":"light","darkTheme":"dark","dataCategory":"Announcements","dataCategoryId":"DIC_kwDOCg97r84CBQfL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"qingwave/qingwave.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=","lightTheme":"light"}}};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script></div>
</body>

</html>