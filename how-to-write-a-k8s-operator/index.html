<!DOCTYPE html><html class="2xl:text-[20px]" dir="ltr" lang="zh-cn"><head><meta charset="UTF-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>快速实现一个Kubernetes Operator</title><meta content="index,follow" name="robots"/><meta content="快速实现一个Kubernetes Operator" property="og:title"/><meta content="https://qingwave.github.io/how-to-write-a-k8s-operator" property="og:url"/><meta content="article" property="og:type"/><link href="https://qingwave.github.io/how-to-write-a-k8s-operator" rel="canonical"/><style is:global>:root{--aw-font-sans:'InterVariable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" name="google-site-verification"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" type="text/partytown"></script><script type="text/partytown">(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href="/favicon.ico" rel="shortcut icon"><link href="/favicon.svg" rel="icon" type="image/svg+xml"><link href="/favicon.svg" rel="mask-icon" color="#8D46E7"><link href="/_astro/_...page_.95a5b0bf.css" rel="stylesheet"/></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="py-8 flex-none mt-8 sticky top-0 w-full z-40" id="header"><div class="mx-auto max-w-3xl sm:px-6 px-6 md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href="/" class="items-center flex"><img src="/favicon.svg" class="h-6 w-6 dark:invert invert-0"></a><div class="items-center flex md:hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type="button" data-aw-toggle-color-scheme><svg astro-icon="ph:moon-fill" class="h-8 w-8" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill="currentColor"/></svg></button> <button aria-label="Toggle Menu" class="items-center transition dark:focus:ring-gray-700 dark:hover:bg-gray-800 dark:text-gray-400 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 inline-flex ml-1.5 p-2.5 rounded-lg text-gray-500 text-sm" type="button" data-aw-toggle-menu><svg astro-icon="tabler:menu" class="h-6 w-6" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g class="icon-tabler" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M4 8h16"/><path d="M4 16h16"/></g></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 text-xl w-full"><li class=""><a href="/blogs" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">写作</a></li><li class=""><a href="/project" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">项目</a></li><li class=""><a href="/tags" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">标签</a></li><li class=""><a href="/about" class="items-center flex dark:hover:text-white duration-150 ease-in-out hover:text-gray-900 px-4 py-3 transition visited:font-bold">关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type="button" data-aw-toggle-color-scheme><svg astro-icon="ph:moon-fill" class="h-6 w-6" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill="currentColor"/></svg></button></div></div></div></header><main><section class="mx-auto lg:py-20 py-8 sm:py-16"><article><header class=""><div class="flex px-4 flex-col justify-between max-w-3xl mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Thu Aug 12 2021 02:58:47 GMT+0000 (Coordinated Universal Time)">Aug 12, 2021</time> · <a href="/categories/cloud" class="capitalize hover:underline">cloud</a></p></div><h1 class="mx-auto max-w-3xl sm:px-6 px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">快速实现一个Kubernetes Operator</h1><p class="mx-auto max-w-3xl sm:px-6 px-4 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="mx-auto max-w-3xl sm:px-6 px-4"><div class="border-t dark:border-slate-700"></div></div></header><div class="mx-auto max-w-3xl sm:px-6 px-6 mt-8 dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert lg:prose-xl prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow-lg prose-lg prose-md"><p>Kubernetes 提供了众多的扩展功能，比如 CRD、CRI、CSI 等等，强大的扩展功能让 k8s 迅速占领市场。<a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">Operator</a>模式可以实现 CRD 并管理自定义资源的生命周期，本文基于<a href="https://kubebuilder.io/">kubebuilder</a>快速实现一个 Operator，示例源码见<a href="https://github.com/qingwave/mygame">mygame</a>。</p><h2 id="kubebuilder">Kubebuilder</h2><p><code>kubebuilder</code>是一个官方提供快速实现 Operator 的工具包，可快速生成 k8s 的 CRD、Controller、Webhook，用户只需要实现业务逻辑。</p><blockquote><p>类似工具还有<a href="https://sdk.operatorframework.io/">operader-sdk</a>，目前正在与<code>Kubebuilder</code>融合</p></blockquote><p>kubebuilder 封装了<code>controller-runtime</code>与<code>controller-tools</code>，通过<code>controller-gen</code>来生产代码，简化了用户创建 Operator 的步骤。</p><p>一般创建 Operator 流程如下：</p><ol><li>创建工作目录，初始化项目</li><li>创建 API，填充字段</li><li>创建 Controller，编写核心协调逻辑(Reconcile)</li><li>创建 Webhook，实现接口，可选</li><li>验证测试</li><li>发布到集群中</li></ol><h2 id="示例">示例</h2><p>我们准备创建一个 2048 的游戏，对外可以提供服务，也能方便地扩缩容。</p><h3 id="准备环境">准备环境</h3><p>首先你需要有 Kubernetes、Docker、Golang 相关环境。 Linux 下安装 kubebuilder</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/</span><span style="color:#e9f284">$(</span><span style="color:#f1fa8c">go env GOOS</span><span style="color:#e9f284">)</span><span style="color:#f8f8f2">/</span><span style="color:#e9f284">$(</span><span style="color:#f1fa8c">go env GOARCH</span><span style="color:#e9f284">)</span></span>
<span class="line"><span style="color:#f8f8f2">chmod +x kubebuilder </span><span style="color:#ff79c6">&#x26;&#x26;</span><span style="color:#f8f8f2"> mv kubebuilder /usr/local/bin/</span></span></code></pre><h3 id="创建项目">创建项目</h3><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">mkdir -p ~/work/mygame &#x26;&#x26; cd $_</span></span>
<span class="line"><span style="color:#f8f8f2">kubebuilder init --domain qingwave.github.io --repo qingwave.github.io/mygame</span></span></code></pre><h3 id="创建-api">创建 API</h3><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">kubebuilder create api --group myapp --version v1 --kind Game</span></span>
<span class="line"><span style="color:#f8f8f2"></span></span>
<span class="line"><span style="color:#f8f8f2">Create Resource [y/n]</span></span>
<span class="line"><span style="color:#f8f8f2">y #生成CR</span></span>
<span class="line"><span style="color:#f8f8f2">Create Controller [y/n]</span></span>
<span class="line"><span style="color:#f8f8f2">y #生成Controller</span></span></code></pre><p>目录结构如下：</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">├── api</span></span>
<span class="line"><span style="color:#f8f8f2">│   └── v1 # CRD定义</span></span>
<span class="line"><span style="color:#f8f8f2">├── bin</span></span>
<span class="line"><span style="color:#f8f8f2">│   └── controller-gen</span></span>
<span class="line"><span style="color:#f8f8f2">├── config</span></span>
<span class="line"><span style="color:#f8f8f2">│   ├── crd # crd配置</span></span>
<span class="line"><span style="color:#f8f8f2">│   ├── default</span></span>
<span class="line"><span style="color:#f8f8f2">│   ├── manager # operator部署文件</span></span>
<span class="line"><span style="color:#f8f8f2">│   ├── prometheus</span></span>
<span class="line"><span style="color:#f8f8f2">│   ├── rbac</span></span>
<span class="line"><span style="color:#f8f8f2">│   └── samples # cr示例</span></span>
<span class="line"><span style="color:#f8f8f2">├── controllers</span></span>
<span class="line"><span style="color:#f8f8f2">│   ├── game_controller.go # controller逻辑</span></span>
<span class="line"><span style="color:#f8f8f2">│   └── suite_test.go</span></span>
<span class="line"><span style="color:#f8f8f2">├── Dockerfile</span></span>
<span class="line"><span style="color:#f8f8f2">├── go.mod</span></span>
<span class="line"><span style="color:#f8f8f2">├── go.sum</span></span>
<span class="line"><span style="color:#f8f8f2">├── hack</span></span>
<span class="line"><span style="color:#f8f8f2">│   └── boilerplate.go.txt # 头文件模板</span></span>
<span class="line"><span style="color:#f8f8f2">├── main.go # 项目主函数</span></span>
<span class="line"><span style="color:#f8f8f2">├── Makefile</span></span>
<span class="line"><span style="color:#f8f8f2">└── PROJECT #项目元数据</span></span></code></pre><h3 id="编写-api">编写 API</h3><p>在<code>mygame/api/v1/game_types.go</code>定义我们需要的字段</p><p><code>Spec</code>配置如下</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#ff79c6">type</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">GameSpec</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Number of desired pods. This is a pointer to distinguish between explicit</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// zero and not specified. Defaults to 1.</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// +optional</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//+kubebuilder:default:=1</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//+kubebuilder:validation:Minimum:=1</span></span>
<span class="line"><span style="color:#f8f8f2">	Replicas </span><span style="color:#ff79c6">*</span><span style="color:#8be9fd">int32</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">json:"replicas,omitempty" protobuf:"varint,1,opt,name=replicas"</span><span style="color:#e9f284">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Docker image name</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// +optional</span></span>
<span class="line"><span style="color:#f8f8f2">	Image </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">json:"image,omitempty"</span><span style="color:#e9f284">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Ingress Host name</span></span>
<span class="line"><span style="color:#f8f8f2">	Host </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">json:"host,omitempty"</span><span style="color:#e9f284">`</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><blockquote><p><code>kubebuilder:default</code>可以设置默认值</p></blockquote><p><code>Status</code>定义如下</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#ff79c6">const</span><span style="color:#f8f8f2"> (</span></span>
<span class="line"><span style="color:#f8f8f2">	Running  </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Running</span><span style="color:#e9f284">"</span></span>
<span class="line"><span style="color:#f8f8f2">	Pending  </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Pending</span><span style="color:#e9f284">"</span></span>
<span class="line"><span style="color:#f8f8f2">	NotReady </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">NotReady</span><span style="color:#e9f284">"</span></span>
<span class="line"><span style="color:#f8f8f2">	Failed   </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">Failed</span><span style="color:#e9f284">"</span></span>
<span class="line"><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ff79c6">type</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">GameStatus</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">struct</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Phase is the phase of guestbook</span></span>
<span class="line"><span style="color:#f8f8f2">	Phase </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">json:"phase,omitempty"</span><span style="color:#e9f284">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// replicas is the number of Pods created by the StatefulSet controller.</span></span>
<span class="line"><span style="color:#f8f8f2">	Replicas </span><span style="color:#8be9fd">int32</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">json:"replicas"</span><span style="color:#e9f284">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// readyReplicas is the number of Pods created by the StatefulSet controller that have a Ready Condition.</span></span>
<span class="line"><span style="color:#f8f8f2">	ReadyReplicas </span><span style="color:#8be9fd">int32</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">json:"readyReplicas"</span><span style="color:#e9f284">`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// LabelSelector is label selectors for query over pods that should match the replica count used by HPA.</span></span>
<span class="line"><span style="color:#f8f8f2">	LabelSelector </span><span style="color:#8be9fd">string</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">json:"labelSelector,omitempty"</span><span style="color:#e9f284">`</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>另外需要添加<code>scale</code>接口</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">//+kubebuilder:subresource:scale:specpath=.spec.replicas,statuspath=.status.replicas,selectorpath=.status.labelSelector</span></span></code></pre><p>添加<code>kubectl</code>展示参数</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">//+kubebuilder:printcolumn:name="Phase",type="string",JSONPath=".status.phase",description="The phase of game."</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:printcolumn:name="Host",type="string",JSONPath=".spec.host",description="The Host Address."</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:printcolumn:name="DESIRED",type="integer",JSONPath=".spec.replicas",description="The desired number of pods."</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:printcolumn:name="CURRENT",type="integer",JSONPath=".status.replicas",description="The number of currently all pods."</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:printcolumn:name="READY",type="integer",JSONPath=".status.readyReplicas",description="The number of pods ready."</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:printcolumn:name="AGE",type="date",JSONPath=".metadata.creationTimestamp",description="CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC."</span></span></code></pre><h3 id="编写-controller-逻辑">编写 Controller 逻辑</h3><p>Controller 的核心逻辑在<code>Reconcile</code>中，我们只需要填充自己的业务逻辑</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (r </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">GameReconciler) </span><span style="color:#50fa7b">Reconcile</span><span style="color:#f8f8f2">(ctx context.Context, req ctrl.Request) (ctrl.Result, </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">	logger </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> log.</span><span style="color:#8be9fd">FromContext</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"><span style="color:#f8f8f2">	logger.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">revice reconcile event</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, req.</span><span style="color:#8be9fd">String</span><span style="color:#f8f8f2">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 获取game对象</span></span>
<span class="line"><span style="color:#f8f8f2">	game </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">myappv1.Game{}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> r.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, req.NamespacedName, game); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> ctrl.Result{}, client.</span><span style="color:#8be9fd">IgnoreNotFound</span><span style="color:#f8f8f2">(err)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// 如果处在删除中直接跳过</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> game.DeletionTimestamp </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		logger.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">game in deleting</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, req.</span><span style="color:#8be9fd">String</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> ctrl.Result{}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// 同步资源，如果资源不存在创建deployment、ingress、service，并更新status</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> r.</span><span style="color:#8be9fd">syncGame</span><span style="color:#f8f8f2">(ctx, game); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		logger.</span><span style="color:#8be9fd">Error</span><span style="color:#f8f8f2">(err, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">failed to sync game</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, req.</span><span style="color:#8be9fd">String</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> ctrl.Result{}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> ctrl.Result{}, </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>添加 rbac 配置</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:rbac:groups=apps,resources=deployments/status,verbs=get;update;patch</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete</span></span>
<span class="line"><span style="color:#f8f8f2">//+kubebuilder:rbac:groups=networking,resources=ingresses,verbs=get;list;watch;create;update;patch;delete</span></span></code></pre><p>具体<code>syncGame</code>逻辑如下</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (r </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">GameReconciler) </span><span style="color:#50fa7b">syncGame</span><span style="color:#f8f8f2">(ctx context.Context, obj </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">myappv1.Game) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	logger </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> log.</span><span style="color:#8be9fd">FromContext</span><span style="color:#f8f8f2">(ctx)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	game </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> obj.</span><span style="color:#8be9fd">DeepCopy</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">	name </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> types.NamespacedName{</span></span>
<span class="line"><span style="color:#f8f8f2">		Namespace: game.Namespace,</span></span>
<span class="line"><span style="color:#f8f8f2">		Name:      game.Name,</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// 构造owner</span></span>
<span class="line"><span style="color:#f8f8f2">	owner </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> []metav1.OwnerReference{</span></span>
<span class="line"><span style="color:#f8f8f2">		{</span></span>
<span class="line"><span style="color:#f8f8f2">			APIVersion:         game.APIVersion,</span></span>
<span class="line"><span style="color:#f8f8f2">			Kind:               game.Kind,</span></span>
<span class="line"><span style="color:#f8f8f2">			Name:               game.Name,</span></span>
<span class="line"><span style="color:#f8f8f2">			Controller:         pointer.</span><span style="color:#8be9fd">BoolPtr</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">true</span><span style="color:#f8f8f2">),</span></span>
<span class="line"><span style="color:#f8f8f2">			BlockOwnerDeletion: pointer.</span><span style="color:#8be9fd">BoolPtr</span><span style="color:#f8f8f2">(</span><span style="color:#bd93f9">true</span><span style="color:#f8f8f2">),</span></span>
<span class="line"><span style="color:#f8f8f2">			UID:                game.UID,</span></span>
<span class="line"><span style="color:#f8f8f2">		},</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	labels </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> game.Labels</span></span>
<span class="line"><span style="color:#f8f8f2">	labels[gameLabelName] </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> game.Name</span></span>
<span class="line"><span style="color:#f8f8f2">	meta </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> metav1.ObjectMeta{</span></span>
<span class="line"><span style="color:#f8f8f2">		Name:            game.Name,</span></span>
<span class="line"><span style="color:#f8f8f2">		Namespace:       game.Namespace,</span></span>
<span class="line"><span style="color:#f8f8f2">		Labels:          labels,</span></span>
<span class="line"><span style="color:#f8f8f2">		OwnerReferences: owner,</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// 获取对应deployment, 如不存在则创建</span></span>
<span class="line"><span style="color:#f8f8f2">	deploy </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">appsv1.Deployment{}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> r.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, name, deploy); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">errors.</span><span style="color:#8be9fd">IsNotFound</span><span style="color:#f8f8f2">(err) {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		deploy </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">appsv1.Deployment{</span></span>
<span class="line"><span style="color:#f8f8f2">			ObjectMeta: meta,</span></span>
<span class="line"><span style="color:#f8f8f2">			Spec:       </span><span style="color:#8be9fd">getDeploymentSpec</span><span style="color:#f8f8f2">(game, labels),</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> r.</span><span style="color:#8be9fd">Create</span><span style="color:#f8f8f2">(ctx, deploy); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">		logger.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">create deployment success</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, name.</span><span style="color:#8be9fd">String</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">	} </span><span style="color:#ff79c6">else</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">    </span><span style="color:#6272a4">// 如果存在对比和game生成的deployment是否一致，不一致则更新</span></span>
<span class="line"><span style="color:#f8f8f2">		want </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">getDeploymentSpec</span><span style="color:#f8f8f2">(game, labels)</span></span>
<span class="line"><span style="color:#f8f8f2">		get </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#8be9fd">getSpecFromDeployment</span><span style="color:#f8f8f2">(deploy)</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">reflect.</span><span style="color:#8be9fd">DeepEqual</span><span style="color:#f8f8f2">(want, get) {</span></span>
<span class="line"><span style="color:#f8f8f2">			deploy </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">appsv1.Deployment{</span></span>
<span class="line"><span style="color:#f8f8f2">				ObjectMeta: meta,</span></span>
<span class="line"><span style="color:#f8f8f2">				Spec:       want,</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">			</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> r.</span><span style="color:#8be9fd">Update</span><span style="color:#f8f8f2">(ctx, deploy); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">				</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">			}</span></span>
<span class="line"><span style="color:#f8f8f2">			logger.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">update deployment success</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, name.</span><span style="color:#8be9fd">String</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		}</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">//service创建</span></span>
<span class="line"><span style="color:#f8f8f2">	svc </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">corev1.Service{}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> r.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, name, svc); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	  </span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// ingress创建</span></span>
<span class="line"><span style="color:#f8f8f2">	ing </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">networkingv1.Ingress{}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> r.</span><span style="color:#8be9fd">Get</span><span style="color:#f8f8f2">(ctx, name, ing); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">...</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	newStatus </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> myappv1.GameStatus{</span></span>
<span class="line"><span style="color:#f8f8f2">		Replicas:      </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">game.Spec.Replicas,</span></span>
<span class="line"><span style="color:#f8f8f2">		ReadyReplicas: deploy.Status.ReadyReplicas,</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> newStatus.Replicas </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> newStatus.ReadyReplicas {</span></span>
<span class="line"><span style="color:#f8f8f2">		newStatus.Phase </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> myappv1.Running</span></span>
<span class="line"><span style="color:#f8f8f2">	} </span><span style="color:#ff79c6">else</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		newStatus.Phase </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> myappv1.NotReady</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#6272a4">// 更新状态</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> </span><span style="color:#ff79c6">!</span><span style="color:#f8f8f2">reflect.</span><span style="color:#8be9fd">DeepEqual</span><span style="color:#f8f8f2">(game.Status, newStatus) {</span></span>
<span class="line"><span style="color:#f8f8f2">		game.Status </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> newStatus</span></span>
<span class="line"><span style="color:#f8f8f2">		logger.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">update game status</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, name.</span><span style="color:#8be9fd">String</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> r.Client.</span><span style="color:#8be9fd">Status</span><span style="color:#f8f8f2">().</span><span style="color:#8be9fd">Update</span><span style="color:#f8f8f2">(ctx, game)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>默认情况下生成的 controller 只监听自定义资源，在示例中我们也需要监听<code>game</code>的子资源，如监听<code>deployment</code>是否符合预期</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#6272a4">// SetupWithManager sets up the controller with the Manager.</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (r </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">GameReconciler) </span><span style="color:#50fa7b">SetupWithManager</span><span style="color:#f8f8f2">(mgr ctrl.Manager) </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 创建controller</span></span>
<span class="line"><span style="color:#f8f8f2">	c, err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> controller.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">game-controller</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, mgr, controller.Options{</span></span>
<span class="line"><span style="color:#f8f8f2">		Reconciler:              r,</span></span>
<span class="line"><span style="color:#f8f8f2">		MaxConcurrentReconciles: </span><span style="color:#bd93f9">3</span><span style="color:#f8f8f2">, </span><span style="color:#6272a4">//controller运行的worker数</span></span>
<span class="line"><span style="color:#f8f8f2">	})</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//监听自定义资源</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">source.Kind{Type: </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">myappv1.Game{}}, </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">handler.EnqueueRequestForObject{}); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">//监听deployment,将owner信息即game namespace/name添加到队列</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> err </span><span style="color:#ff79c6">:=</span><span style="color:#f8f8f2"> c.</span><span style="color:#8be9fd">Watch</span><span style="color:#f8f8f2">(</span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">source.Kind{Type: </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">appsv1.Deployment{}}, </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">handler.EnqueueRequestForOwner{</span></span>
<span class="line"><span style="color:#f8f8f2">		OwnerType:    </span><span style="color:#ff79c6">&#x26;</span><span style="color:#f8f8f2">myappv1.Game{},</span></span>
<span class="line"><span style="color:#f8f8f2">		IsController: </span><span style="color:#bd93f9">true</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">	}); err </span><span style="color:#ff79c6">!=</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> err</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><h3 id="部署验证">部署验证</h3><p>安装 CRD</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">make install</span></span></code></pre><p>本地运行 operator</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">make run</span></span></code></pre><p>修改 sample 文件<code>config/samples/myapp_v1_game.yaml</code></p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#8be9fd">apiVersion</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#f1fa8c">myapp.qingwave.github.io/v1</span></span>
<span class="line"><span style="color:#8be9fd">kind</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#f1fa8c">Game</span></span>
<span class="line"><span style="color:#8be9fd">metadata</span><span style="color:#ff79c6">:</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#8be9fd">name</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#f1fa8c">game-sample</span></span>
<span class="line"><span style="color:#8be9fd">spec</span><span style="color:#ff79c6">:</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#8be9fd">replicas</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">1</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#8be9fd">image</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#f1fa8c">alexwhen/docker-2048</span></span>
<span class="line"><span style="color:#f8f8f2">  </span><span style="color:#8be9fd">host</span><span style="color:#ff79c6">:</span><span style="color:#f8f8f2"> </span><span style="color:#f1fa8c">mygame.io</span></span></code></pre><p>部署<code>game-sample</code></p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">kubectl apply -f config/samples/myapp_v1_game.yaml</span></span></code></pre><p>查看<code>game</code>自定义资源状态</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#6272a4"># 查看game</span></span>
<span class="line"><span style="color:#f8f8f2">kubectl get game</span></span>
<span class="line"><span style="color:#f8f8f2">NAME          PHASE     HOST        DESIRED   CURRENT   READY   AGE</span></span>
<span class="line"><span style="color:#f8f8f2">game-sample   Running   mygame.io   1         1         1       6m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># 查看deploy</span></span>
<span class="line"><span style="color:#f8f8f2">kubectl get deploy game-sample</span></span>
<span class="line"><span style="color:#f8f8f2">NAME          READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class="line"><span style="color:#f8f8f2">game-sample   1/1     1            1           6m</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># 查看ingress</span></span>
<span class="line"><span style="color:#f8f8f2">kubectl get ing game-sample</span></span>
<span class="line"><span style="color:#f8f8f2">NAME          CLASS    HOSTS       ADDRESS        PORTS   AGE</span></span>
<span class="line"><span style="color:#f8f8f2">game-sample   </span><span style="color:#ff79c6">&#x3C;</span><span style="color:#f8f8f2">none</span><span style="color:#ff79c6">></span><span style="color:#f8f8f2">   mygame.io   192.168.49.2   80      7m</span></span></code></pre><p>验证应用，在<code>/etc/hosts</code>中添加<code>&#x3C;Ingress ADDRESS Ip>	mygame.io</code>，访问浏览器如下图所示 <img src="/img/blog/crd_mygame.png" alt="2048"></p><p>验证扩容</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">kubectl scale games.myapp.qingwave.github.io game-sample --replicas 2</span></span>
<span class="line"><span style="color:#f8f8f2">game.myapp.qingwave.github.io/game-sample scaled</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4"># 扩容后</span></span>
<span class="line"><span style="color:#f8f8f2">kubectl get games.myapp.qingwave.github.io</span></span>
<span class="line"><span style="color:#f8f8f2">NAME          PHASE     HOST        DESIRED   CURRENT   READY   AGE</span></span>
<span class="line"><span style="color:#f8f8f2">game-sample   Running   mygame.io   2         2         2       7m</span></span></code></pre><p>如需部署<code>Operator</code>到集群中，可参考官方文档，制作镜像并上传，运行<code>make deploy</code></p><h3 id="webhook">Webhook</h3><p>通常我们需要与 CR 自定义资源设置部分字段的默认值，或者验证字段是否合法，这就需要自己实现<code>Webhook</code>，<code>Kubebuilder</code>也提供了<code>Webhook</code>的功能。</p><p>通过设置<code>--defaulting</code>可创建<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook">mutatingadmissionwebhook</a>类型准入控制器，用来修改传入资源；参数<code>--programmatic-validation</code>可创建<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook">validatingadmissionwebhook</a>，用来验证传入资源</p><blockquote><p>在资源创建、修改时<code>apiserver</code>会通过 http 调用<code>webhook</code>提供的接口，所以会带来额外开销，简单的验证工作可通过<code>//+kubebuilder:validation</code>注解，直接通过<code>openapi</code>验证，性能更好</p></blockquote><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">kubebuilder create webhook --group myapp --version v1 --kind Game --defaulting --programmatic-validation</span></span></code></pre><p>生成文件在<code>api/v1/game_webhook.go</code></p><p><code>Default</code>接口可实现修改资源，根据 kubebuilder 注释,当<code>game</code>资源<code>create</code>与<code>update</code>时，调用这个接口</p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#f8f8f2">//+kubebuilder:webhook:path=/mutate-myapp-qingwave-github-io-v1-game,mutating=true,failurePolicy=fail,sideEffects=None,groups=myapp.qingwave.github.io,resources=games,verbs=create;update,versions=v1,name=mgame.kb.io,admissionReviewVersions={v1,v1beta1}</span></span></code></pre><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#ff79c6">const</span><span style="color:#f8f8f2"> (</span></span>
<span class="line"><span style="color:#f8f8f2">	defaultImage </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">`</span><span style="color:#f1fa8c">alexwhen/docker-2048</span><span style="color:#e9f284">`</span></span>
<span class="line"><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272a4">// Default implements webhook.Defaulter so a webhook will be registered for the type</span></span>
<span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (r </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Game) </span><span style="color:#50fa7b">Default</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">	gamelog.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">default</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, r.Name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 设置默认镜像</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> r.Spec.Image </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">""</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		r.Spec.Image </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> defaultImage</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// 设置默认Host</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> r.Spec.Host </span><span style="color:#ff79c6">==</span><span style="color:#f8f8f2"> </span><span style="color:#e9f284">""</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">		r.Spec.Host </span><span style="color:#ff79c6">=</span><span style="color:#f8f8f2"> fmt.</span><span style="color:#8be9fd">Sprintf</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">.</span><span style="color:#bd93f9">%s</span><span style="color:#f1fa8c">.mygame.io</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, r.Name, r.Namespace)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>同样的通过<code>ValidateCreate</code>、<code>ValidateUpdate</code>可实现<code>validating webhook</code></p><pre class="astro-code" is:raw="" style="background-color:#282a36;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word"><code><span class="line"><span style="color:#ff79c6">func</span><span style="color:#f8f8f2"> (r </span><span style="color:#ff79c6">*</span><span style="color:#f8f8f2">Game) </span><span style="color:#50fa7b">ValidateCreate</span><span style="color:#f8f8f2">() </span><span style="color:#8be9fd">error</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#f8f8f2">	gamelog.</span><span style="color:#8be9fd">Info</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">validate create</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">name</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">, r.Name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#6272a4">// Host不能包括通配符</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">if</span><span style="color:#f8f8f2"> strings.</span><span style="color:#8be9fd">Contains</span><span style="color:#f8f8f2">(r.Spec.Host, </span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">*</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">) {</span></span>
<span class="line"><span style="color:#f8f8f2">		</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> errors.</span><span style="color:#8be9fd">New</span><span style="color:#f8f8f2">(</span><span style="color:#e9f284">"</span><span style="color:#f1fa8c">host should not contain *</span><span style="color:#e9f284">"</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">	}</span></span>
<span class="line"><span style="color:#f8f8f2">	</span><span style="color:#ff79c6">return</span><span style="color:#f8f8f2"> </span><span style="color:#bd93f9">nil</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>本地验证 webhook 需要配置证书，在集群中测试更方便点，可参考官方文档。</p><h2 id="总结">总结</h2><p>至此，我们已经实现了一个功能完全的<code>game-operator</code>，可以管理<code>game</code>资源的生命周期，创建/更新 game 时会自动创建<code>deployment、service、ingress</code>等资源，当<code>deployment</code>被误删或者误修改时也可以自动回复到期望状态，也实现了<code>scale</code>接口。</p><p>通过<code>kubebuiler</code>大大简化了开发<code>operator</code>的成本，我们只需要关心业务逻辑即可，不需要再手动去创建<code>client/controller</code>等，但同时<code>kubebuilder</code>生成的代码中屏蔽了很多细节，比如<code>controller</code>的最大 worker 数、同步时间、队列类型等参数设置，只有了解<code>operator</code>的原理才更好应用于生产。</p><h2 id="引用">引用</h2><ul><li><a href="https://book.kubebuilder.io/">https://book.kubebuilder.io/</a></li></ul></div><div class="flex flex-col justify-between max-w-3xl mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class="mr-5"><li class="bg-gray-100 dark:bg-slate-700 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-lg"><a href="/tags/k8s" class="dark:text-slate-300 dark:hover:text-gray-200 hover:text-primary text-muted">#k8s</a></li></ul></div></article><div class="mx-auto max-w-3xl sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script async src="https://giscus.app/client.js" crossorigin="anonymous" data-category="Announcements" data-category-id="DIC_kwDOCg97r84CBQfL" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="title" data-reactions-enabled="1" data-repo="qingwave/qingwave.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict="0" data-theme="light"></script></div></section></main><footer class="relative"><div class="mx-auto max-w-3xl sm:px-6 px-4"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden="true"></div><div class="mx-auto max-w-3xl sm:px-6 px-4 dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="flex md:mb-0 -ml-2 mb-4 md:ml-4 md:order-1"><li><a href="/rss.xml" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label="RSS"><svg astro-icon="tabler:rss" class="h-5 w-5" viewBox="0 0 24 24"><g class="icon-tabler" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href="/" class="hover:brightness-50">Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function a(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:"dark"===localStorage.theme?"dark":"light"}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),a=encodeURIComponent(t.getAttribute("data-aw-text"));let c;switch(o){case"facebook":c=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":c=`https://twitter.com/intent/tweet?url=${n}&text=${a}`;break;case"linkedin":c=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${a}`;break;case"whatsapp":c=`https://wa.me/?text=${a}%20${n}`;break;case"mail":c=`mailto:?subject=%22${a}%22&body=${a}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=c,s.click()})),a(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{a()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>