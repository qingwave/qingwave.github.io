<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=zh><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>快速实现一个Kubernetes Operator</title><meta content=借助Kubebuilder实现2048游戏的控制器 name=description><meta content=index,follow name=robots><link href=https://qingwave.github.io/how-to-write-a-k8s-operator/ rel=canonical><meta content="快速实现一个Kubernetes Operator" property=og:title><meta content=借助Kubebuilder实现2048游戏的控制器 property=og:description><meta content=https://qingwave.github.io/how-to-write-a-k8s-operator/ property=og:url><meta content=article property=og:type><meta content=https://qingwave.github.io/img/blog/crd_mygame.png property=og:image><meta content="快速实现一个Kubernetes Operator" property=og:image:alt><meta content=summary_large_image name=twitter:card><style is:global>:root{--aw-font-sans:'Inter Variable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI name=google-site-verification><script src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async type=text/partytown></script><script type=text/partytown>(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.svg rel=mask-icon color=#8D46E7><link href=/sitemap-index.xml rel=sitemap><link href=/_astro/_page_.B0sZk8pa.css rel=stylesheet><link href=/_astro/_page_.u7U6Tnvc.css rel=stylesheet><script src=/_astro/hoisted.DNuUAAyM.js type=module></script><script>!function(t,e,n,r){(window.crossOriginIsolated||navigator.serviceWorker)&&((r=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(r[n]||[]).concat(["dataLayer.push"]))}(window,"partytown","forward");const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((()=>{const t=new Set;let e=[];do{Object.getOwnPropertyNames(e).forEach((n=>{"function"==typeof e[n]&&t.add(n)}))}while((e=Object.getPrototypeOf(e))!==Object.prototype);return Array.from(t)})());!function(t,r,o,i,a,s,c,d,l,p,u=t,f){function y(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(l=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(h,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",b),a?w(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):h())))}function w(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function h(n,o){for(b(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<l.length;n++)(o=r.createElement("script")).innerHTML=l[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function b(){clearTimeout(d)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?y():(t.addEventListener("DOMContentLoaded",y),t.addEventListener("load",y))}(window,document,navigator,top,window.crossOriginIsolated),document.addEventListener("astro:before-swap",(t=>{let e=document.body.querySelector("iframe[src*='/~partytown/']");e&&t.newDocument.body.append(e)}))</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id=header><div class="px-4 mx-auto sm:px-6 max-w-3xl md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href=/ class="items-center flex"><img alt="" src=/favicon.svg class="h-6 w-6 dark:invert invert-0"></a><div class="items-center flex md:hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-7 w-7" data-icon=tabler:moon-filled height=1em width=1em><symbol id=ai:tabler:moon-filled viewBox="0 0 24 24"><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341-.82-.476-1.644-1.298-1.31a6.5 6.5 0 0 1-6.864-10.787l.077-.08c.551-.63.113-1.653-.758-1.653h-.266l-.068-.006z" fill=currentColor /></symbol><use href=#ai:tabler:moon-filled></use></svg></button> <button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:focus:ring-gray-700 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 ml-1.5 rounded-lg text-gray-500 transition" aria-label="Toggle Menu" type=button data-aw-toggle-menu><svg class="h-6 w-6" data-icon=tabler:menu height=1em width=1em><symbol id=ai:tabler:menu viewBox="0 0 24 24"><path d="M4 8h16M4 16h16" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use href=#ai:tabler:menu></use></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 w-full"><li class=""><a href=/blog/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>文章</a></li><li class=""><a href=/project/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>项目</a></li><li class=""><a href=/reading/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>阅读</a></li><li class=""><a href=/about/ class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-6 w-6" data-icon=tabler:moon-filled height=1em width=1em viewBox="0 0 24 24"><use href=#ai:tabler:moon-filled></use></svg></button></div></div></div></header><main><section class=page><article><header class=""><div class="flex px-4 flex-col justify-between mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Thu Aug 12 2021 02:58:47 GMT+0000 (Coordinated Universal Time)">Aug 12, 2021</time> · <a href=/categories/cloud/ class="capitalize hover:underline">cloud</a></p></div><h1 class="px-4 mx-auto sm:px-6 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">快速实现一个Kubernetes Operator</h1><p class="px-4 mx-auto sm:px-6 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="px-4 mx-auto sm:px-6"><div class="border-t dark:border-slate-700"></div></div></header><div class="mx-auto sm:px-6 px-6 mt-8 3xl:prose-xl break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow prose-lg"><p>Kubernetes 提供了众多的扩展功能，比如 CRD、CRI、CSI 等等，强大的扩展功能让 k8s 迅速占领市场。<a href=https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/ >Operator</a>模式可以实现 CRD 并管理自定义资源的生命周期，本文基于<a href=https://kubebuilder.io/ >kubebuilder</a>快速实现一个 Operator，示例源码见<a href=https://github.com/qingwave/mygame>mygame</a>。</p><h2 id=kubebuilder>Kubebuilder</h2><p><code>kubebuilder</code>是一个官方提供快速实现 Operator 的工具包，可快速生成 k8s 的 CRD、Controller、Webhook，用户只需要实现业务逻辑。</p><blockquote><p>类似工具还有<a href=https://sdk.operatorframework.io/ >operader-sdk</a>，目前正在与<code>Kubebuilder</code>融合</p></blockquote><p>kubebuilder 封装了<code>controller-runtime</code>与<code>controller-tools</code>，通过<code>controller-gen</code>来生产代码，简化了用户创建 Operator 的步骤。</p><p>一般创建 Operator 流程如下：</p><ol><li>创建工作目录，初始化项目</li><li>创建 API，填充字段</li><li>创建 Controller，编写核心协调逻辑(Reconcile)</li><li>创建 Webhook，实现接口，可选</li><li>验证测试</li><li>发布到集群中</li></ol><h2 id=示例>示例</h2><p>我们准备创建一个 2048 的游戏，对外可以提供服务，也能方便地扩缩容。</p><h3 id=准备环境>准备环境</h3><p>首先你需要有 Kubernetes、Docker、Golang 相关环境。 Linux 下安装 kubebuilder</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>curl</span><span style=color:#bd93f9> -L</span><span style=color:#bd93f9> -o</span><span style=color:#f1fa8c> kubebuilder</span><span style=color:#f1fa8c> https://go.kubebuilder.io/dl/latest/</span><span style=color:#f8f8f2>$(</span><span style=color:#50fa7b>go</span><span style=color:#f1fa8c> env</span><span style=color:#f1fa8c> GOOS</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>/</span><span style=color:#f8f8f2>$(</span><span style=color:#50fa7b>go</span><span style=color:#f1fa8c> env</span><span style=color:#f1fa8c> GOARCH</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>chmod</span><span style=color:#f1fa8c> +x</span><span style=color:#f1fa8c> kubebuilder</span><span style=color:#f8f8f2> &#x26;&#x26; </span><span style=color:#50fa7b>mv</span><span style=color:#f1fa8c> kubebuilder</span><span style=color:#f1fa8c> /usr/local/bin/</span></span>
<span class=line></span></code></pre><h3 id=创建项目>创建项目</h3><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>mkdir -p ~/work/mygame &#x26;&#x26; cd $_</span></span>
<span class=line><span>kubebuilder init --domain qingwave.github.io --repo qingwave.github.io/mygame</span></span>
<span class=line><span></span></span></code></pre><h3 id=创建-api>创建 API</h3><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>kubebuilder create api --group myapp --version v1 --kind Game</span></span>
<span class=line><span></span></span>
<span class=line><span>Create Resource [y/n]</span></span>
<span class=line><span>y #生成CR</span></span>
<span class=line><span>Create Controller [y/n]</span></span>
<span class=line><span>y #生成Controller</span></span>
<span class=line><span></span></span></code></pre><p>目录结构如下：</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>├── api</span></span>
<span class=line><span>│   └── v1 # CRD定义</span></span>
<span class=line><span>├── bin</span></span>
<span class=line><span>│   └── controller-gen</span></span>
<span class=line><span>├── config</span></span>
<span class=line><span>│   ├── crd # crd配置</span></span>
<span class=line><span>│   ├── default</span></span>
<span class=line><span>│   ├── manager # operator部署文件</span></span>
<span class=line><span>│   ├── prometheus</span></span>
<span class=line><span>│   ├── rbac</span></span>
<span class=line><span>│   └── samples # cr示例</span></span>
<span class=line><span>├── controllers</span></span>
<span class=line><span>│   ├── game_controller.go # controller逻辑</span></span>
<span class=line><span>│   └── suite_test.go</span></span>
<span class=line><span>├── Dockerfile</span></span>
<span class=line><span>├── go.mod</span></span>
<span class=line><span>├── go.sum</span></span>
<span class=line><span>├── hack</span></span>
<span class=line><span>│   └── boilerplate.go.txt # 头文件模板</span></span>
<span class=line><span>├── main.go # 项目主函数</span></span>
<span class=line><span>├── Makefile</span></span>
<span class=line><span>└── PROJECT #项目元数据</span></span>
<span class=line><span></span></span></code></pre><h3 id=编写-api>编写 API</h3><p>在<code>mygame/api/v1/game_types.go</code>定义我们需要的字段</p><p><code>Spec</code>配置如下</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> GameSpec</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>	// Number of desired pods. This is a pointer to distinguish between explicit</span></span>
<span class=line><span style=color:#6272a4>	// zero and not specified. Defaults to 1.</span></span>
<span class=line><span style=color:#6272a4>	// +optional</span></span>
<span class=line><span style=color:#6272a4>	//+kubebuilder:default:=1</span></span>
<span class=line><span style=color:#6272a4>	//+kubebuilder:validation:Minimum:=1</span></span>
<span class=line><span style=color:#f8f8f2>	Replicas </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>int32</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>json:"replicas,omitempty" protobuf:"varint,1,opt,name=replicas"</span><span style=color:#e9f284>`</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Docker image name</span></span>
<span class=line><span style=color:#6272a4>	// +optional</span></span>
<span class=line><span style=color:#f8f8f2>	Image </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>json:"image,omitempty"</span><span style=color:#e9f284>`</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Ingress Host name</span></span>
<span class=line><span style=color:#f8f8f2>	Host </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>json:"host,omitempty"</span><span style=color:#e9f284>`</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><blockquote><p><code>kubebuilder:default</code>可以设置默认值</p></blockquote><p><code>Status</code>定义如下</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>const</span><span style=color:#f8f8f2> (</span></span>
<span class=line><span style=color:#bd93f9>	Running</span><span style=color:#ff79c6>  =</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>Running</span><span style=color:#e9f284>"</span></span>
<span class=line><span style=color:#bd93f9>	Pending</span><span style=color:#ff79c6>  =</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>Pending</span><span style=color:#e9f284>"</span></span>
<span class=line><span style=color:#bd93f9>	NotReady</span><span style=color:#ff79c6> =</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>NotReady</span><span style=color:#e9f284>"</span></span>
<span class=line><span style=color:#bd93f9>	Failed</span><span style=color:#ff79c6>   =</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>Failed</span><span style=color:#e9f284>"</span></span>
<span class=line><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> GameStatus</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>	// Phase is the phase of guestbook</span></span>
<span class=line><span style=color:#f8f8f2>	Phase </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>json:"phase,omitempty"</span><span style=color:#e9f284>`</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// replicas is the number of Pods created by the StatefulSet controller.</span></span>
<span class=line><span style=color:#f8f8f2>	Replicas </span><span style=color:#8be9fd;font-style:italic>int32</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>json:"replicas"</span><span style=color:#e9f284>`</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// readyReplicas is the number of Pods created by the StatefulSet controller that have a Ready Condition.</span></span>
<span class=line><span style=color:#f8f8f2>	ReadyReplicas </span><span style=color:#8be9fd;font-style:italic>int32</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>json:"readyReplicas"</span><span style=color:#e9f284>`</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// LabelSelector is label selectors for query over pods that should match the replica count used by HPA.</span></span>
<span class=line><span style=color:#f8f8f2>	LabelSelector </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>json:"labelSelector,omitempty"</span><span style=color:#e9f284>`</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>另外需要添加<code>scale</code>接口</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>//+kubebuilder:subresource:scale:specpath=.spec.replicas,statuspath=.status.replicas,selectorpath=.status.labelSelector</span></span>
<span class=line><span></span></span></code></pre><p>添加<code>kubectl</code>展示参数</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>//+kubebuilder:printcolumn:name="Phase",type="string",JSONPath=".status.phase",description="The phase of game."</span></span>
<span class=line><span>//+kubebuilder:printcolumn:name="Host",type="string",JSONPath=".spec.host",description="The Host Address."</span></span>
<span class=line><span>//+kubebuilder:printcolumn:name="DESIRED",type="integer",JSONPath=".spec.replicas",description="The desired number of pods."</span></span>
<span class=line><span>//+kubebuilder:printcolumn:name="CURRENT",type="integer",JSONPath=".status.replicas",description="The number of currently all pods."</span></span>
<span class=line><span>//+kubebuilder:printcolumn:name="READY",type="integer",JSONPath=".status.readyReplicas",description="The number of pods ready."</span></span>
<span class=line><span>//+kubebuilder:printcolumn:name="AGE",type="date",JSONPath=".metadata.creationTimestamp",description="CreationTimestamp is a timestamp representing the server time when this object was created. It is not guaranteed to be set in happens-before order across separate operations. Clients may not set this value. It is represented in RFC3339 form and is in UTC."</span></span>
<span class=line><span></span></span></code></pre><h3 id=编写-controller-逻辑>编写 Controller 逻辑</h3><p>Controller 的核心逻辑在<code>Reconcile</code>中，我们只需要填充自己的业务逻辑</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>r </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>GameReconciler</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Reconcile</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>ctx</span><span style=color:#8be9fd;font-style:italic> context</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Context</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>req</span><span style=color:#8be9fd;font-style:italic> ctrl</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Request</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>ctrl</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Result</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	logger </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> log.</span><span style=color:#50fa7b>FromContext</span><span style=color:#f8f8f2>(ctx)</span></span>
<span class=line><span style=color:#f8f8f2>	logger.</span><span style=color:#50fa7b>Info</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>revice reconcile event</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, req.</span><span style=color:#50fa7b>String</span><span style=color:#f8f8f2>())</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 获取game对象</span></span>
<span class=line><span style=color:#f8f8f2>	game </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>myappv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Game</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>Get</span><span style=color:#f8f8f2>(ctx, req.NamespacedName, game); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#8be9fd;font-style:italic> ctrl</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Result</span><span style=color:#f8f8f2>{}, client.</span><span style=color:#50fa7b>IgnoreNotFound</span><span style=color:#f8f8f2>(err)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 如果处在删除中直接跳过</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> game.DeletionTimestamp </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		logger.</span><span style=color:#50fa7b>Info</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>game in deleting</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, req.</span><span style=color:#50fa7b>String</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#8be9fd;font-style:italic> ctrl</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Result</span><span style=color:#f8f8f2>{}, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 同步资源，如果资源不存在创建deployment、ingress、service，并更新status</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>syncGame</span><span style=color:#f8f8f2>(ctx, game); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		logger.</span><span style=color:#50fa7b>Error</span><span style=color:#f8f8f2>(err, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>failed to sync game</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, req.</span><span style=color:#50fa7b>String</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#8be9fd;font-style:italic> ctrl</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Result</span><span style=color:#f8f8f2>{}, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#8be9fd;font-style:italic> ctrl</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Result</span><span style=color:#f8f8f2>{}, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>添加 rbac 配置</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>//+kubebuilder:rbac:groups=apps,resources=deployments,verbs=get;list;watch;create;update;patch;delete</span></span>
<span class=line><span>//+kubebuilder:rbac:groups=apps,resources=deployments/status,verbs=get;update;patch</span></span>
<span class=line><span>//+kubebuilder:rbac:groups=core,resources=services,verbs=get;list;watch;create;update;patch;delete</span></span>
<span class=line><span>//+kubebuilder:rbac:groups=networking,resources=ingresses,verbs=get;list;watch;create;update;patch;delete</span></span>
<span class=line><span></span></span></code></pre><p>具体<code>syncGame</code>逻辑如下</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>r </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>GameReconciler</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>syncGame</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>ctx</span><span style=color:#8be9fd;font-style:italic> context</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Context</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>myappv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Game</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	logger </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> log.</span><span style=color:#50fa7b>FromContext</span><span style=color:#f8f8f2>(ctx)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	game </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> obj.</span><span style=color:#50fa7b>DeepCopy</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	name </span><span style=color:#ff79c6>:=</span><span style=color:#8be9fd;font-style:italic> types</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>NamespacedName</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		Namespace: game.Namespace,</span></span>
<span class=line><span style=color:#f8f8f2>		Name:      game.Name,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 构造owner</span></span>
<span class=line><span style=color:#f8f8f2>	owner </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> []</span><span style=color:#8be9fd;font-style:italic>metav1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>OwnerReference</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		{</span></span>
<span class=line><span style=color:#f8f8f2>			APIVersion:         game.APIVersion,</span></span>
<span class=line><span style=color:#f8f8f2>			Kind:               game.Kind,</span></span>
<span class=line><span style=color:#f8f8f2>			Name:               game.Name,</span></span>
<span class=line><span style=color:#f8f8f2>			Controller:         pointer.</span><span style=color:#50fa7b>BoolPtr</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>true</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>			BlockOwnerDeletion: pointer.</span><span style=color:#50fa7b>BoolPtr</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>true</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>			UID:                game.UID,</span></span>
<span class=line><span style=color:#f8f8f2>		},</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	labels </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> game.Labels</span></span>
<span class=line><span style=color:#f8f8f2>	labels[gameLabelName] </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> game.Name</span></span>
<span class=line><span style=color:#f8f8f2>	meta </span><span style=color:#ff79c6>:=</span><span style=color:#8be9fd;font-style:italic> metav1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ObjectMeta</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		Name:            game.Name,</span></span>
<span class=line><span style=color:#f8f8f2>		Namespace:       game.Namespace,</span></span>
<span class=line><span style=color:#f8f8f2>		Labels:          labels,</span></span>
<span class=line><span style=color:#f8f8f2>		OwnerReferences: owner,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 获取对应deployment, 如不存在则创建</span></span>
<span class=line><span style=color:#f8f8f2>	deploy </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>appsv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Deployment</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>Get</span><span style=color:#f8f8f2>(ctx, name, deploy); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#ff79c6> !</span><span style=color:#f8f8f2>errors.</span><span style=color:#50fa7b>IsNotFound</span><span style=color:#f8f8f2>(err) {</span></span>
<span class=line><span style=color:#ff79c6>			return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>		deploy </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>appsv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Deployment</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>			ObjectMeta: meta,</span></span>
<span class=line><span style=color:#f8f8f2>			Spec:       </span><span style=color:#50fa7b>getDeploymentSpec</span><span style=color:#f8f8f2>(game, labels),</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>Create</span><span style=color:#f8f8f2>(ctx, deploy); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>			return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>		logger.</span><span style=color:#50fa7b>Info</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>create deployment success</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, name.</span><span style=color:#50fa7b>String</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>	} </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>    // 如果存在对比和game生成的deployment是否一致，不一致则更新</span></span>
<span class=line><span style=color:#f8f8f2>		want </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> getDeploymentSpec</span><span style=color:#f8f8f2>(game, labels)</span></span>
<span class=line><span style=color:#f8f8f2>		get </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> getSpecFromDeployment</span><span style=color:#f8f8f2>(deploy)</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#ff79c6> !</span><span style=color:#f8f8f2>reflect.</span><span style=color:#50fa7b>DeepEqual</span><span style=color:#f8f8f2>(want, get) {</span></span>
<span class=line><span style=color:#f8f8f2>			deploy </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>appsv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Deployment</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>				ObjectMeta: meta,</span></span>
<span class=line><span style=color:#f8f8f2>				Spec:       want,</span></span>
<span class=line><span style=color:#f8f8f2>			}</span></span>
<span class=line><span style=color:#ff79c6>			if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>Update</span><span style=color:#f8f8f2>(ctx, deploy); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>				return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>			}</span></span>
<span class=line><span style=color:#f8f8f2>			logger.</span><span style=color:#50fa7b>Info</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>update deployment success</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, name.</span><span style=color:#50fa7b>String</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  //service创建</span></span>
<span class=line><span style=color:#f8f8f2>	svc </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>corev1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Service</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>Get</span><span style=color:#f8f8f2>(ctx, name, svc); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	  ...</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // ingress创建</span></span>
<span class=line><span style=color:#f8f8f2>	ing </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>networkingv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Ingress</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>Get</span><span style=color:#f8f8f2>(ctx, name, ing); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		...</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	newStatus </span><span style=color:#ff79c6>:=</span><span style=color:#8be9fd;font-style:italic> myappv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>GameStatus</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		Replicas:      </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>game.Spec.Replicas,</span></span>
<span class=line><span style=color:#f8f8f2>		ReadyReplicas: deploy.Status.ReadyReplicas,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> newStatus.Replicas </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> newStatus.ReadyReplicas {</span></span>
<span class=line><span style=color:#f8f8f2>		newStatus.Phase </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> myappv1.Running</span></span>
<span class=line><span style=color:#f8f8f2>	} </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		newStatus.Phase </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> myappv1.NotReady</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>  // 更新状态</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#ff79c6> !</span><span style=color:#f8f8f2>reflect.</span><span style=color:#50fa7b>DeepEqual</span><span style=color:#f8f8f2>(game.Status, newStatus) {</span></span>
<span class=line><span style=color:#f8f8f2>		game.Status </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> newStatus</span></span>
<span class=line><span style=color:#f8f8f2>		logger.</span><span style=color:#50fa7b>Info</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>update game status</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, name.</span><span style=color:#50fa7b>String</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> r.Client.</span><span style=color:#50fa7b>Status</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>Update</span><span style=color:#f8f8f2>(ctx, game)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>默认情况下生成的 controller 只监听自定义资源，在示例中我们也需要监听<code>game</code>的子资源，如监听<code>deployment</code>是否符合预期</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// SetupWithManager sets up the controller with the Manager.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>r </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>GameReconciler</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>SetupWithManager</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>mgr</span><span style=color:#8be9fd;font-style:italic> ctrl</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Manager</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>	// 创建controller</span></span>
<span class=line><span style=color:#f8f8f2>	c, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> controller.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>game-controller</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, mgr, </span><span style=color:#8be9fd;font-style:italic>controller</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Options</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		Reconciler:              r,</span></span>
<span class=line><span style=color:#f8f8f2>		MaxConcurrentReconciles: </span><span style=color:#bd93f9>3</span><span style=color:#f8f8f2>, </span><span style=color:#6272a4>//controller运行的worker数</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	//监听自定义资源</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> c.</span><span style=color:#50fa7b>Watch</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>source</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Kind</span><span style=color:#f8f8f2>{Type: </span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>myappv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Game</span><span style=color:#f8f8f2>{}}, </span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>handler</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>EnqueueRequestForObject</span><span style=color:#f8f8f2>{}); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	//监听deployment,将owner信息即game namespace/name添加到队列</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> c.</span><span style=color:#50fa7b>Watch</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>source</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Kind</span><span style=color:#f8f8f2>{Type: </span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>appsv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Deployment</span><span style=color:#f8f8f2>{}}, </span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>handler</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>EnqueueRequestForOwner</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		OwnerType:    </span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>myappv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Game</span><span style=color:#f8f8f2>{},</span></span>
<span class=line><span style=color:#f8f8f2>		IsController: </span><span style=color:#bd93f9>true</span><span style=color:#f8f8f2>,</span></span>
<span class=line><span style=color:#f8f8f2>	}); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=部署验证>部署验证</h3><p>安装 CRD</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>make install</span></span>
<span class=line><span></span></span></code></pre><p>本地运行 operator</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>make run</span></span>
<span class=line><span></span></span></code></pre><p>修改 sample 文件<code>config/samples/myapp_v1_game.yaml</code></p><pre class="astro-code dracula" data-language=yaml style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#8be9fd>apiVersion</span><span style=color:#ff79c6>:</span><span style=color:#f1fa8c> myapp.qingwave.github.io/v1</span></span>
<span class=line><span style=color:#8be9fd>kind</span><span style=color:#ff79c6>:</span><span style=color:#f1fa8c> Game</span></span>
<span class=line><span style=color:#8be9fd>metadata</span><span style=color:#ff79c6>:</span></span>
<span class=line><span style=color:#8be9fd>  name</span><span style=color:#ff79c6>:</span><span style=color:#f1fa8c> game-sample</span></span>
<span class=line><span style=color:#8be9fd>spec</span><span style=color:#ff79c6>:</span></span>
<span class=line><span style=color:#8be9fd>  replicas</span><span style=color:#ff79c6>:</span><span style=color:#bd93f9> 1</span></span>
<span class=line><span style=color:#8be9fd>  image</span><span style=color:#ff79c6>:</span><span style=color:#f1fa8c> alexwhen/docker-2048</span></span>
<span class=line><span style=color:#8be9fd>  host</span><span style=color:#ff79c6>:</span><span style=color:#f1fa8c> mygame.io</span></span>
<span class=line></span></code></pre><p>部署<code>game-sample</code></p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>kubectl apply -f config/samples/myapp_v1_game.yaml</span></span>
<span class=line><span></span></span></code></pre><p>查看<code>game</code>自定义资源状态</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4># 查看game</span></span>
<span class=line><span style=color:#50fa7b>kubectl</span><span style=color:#f1fa8c> get</span><span style=color:#f1fa8c> game</span></span>
<span class=line><span style=color:#50fa7b>NAME</span><span style=color:#f1fa8c>          PHASE</span><span style=color:#f1fa8c>     HOST</span><span style=color:#f1fa8c>        DESIRED</span><span style=color:#f1fa8c>   CURRENT</span><span style=color:#f1fa8c>   READY</span><span style=color:#f1fa8c>   AGE</span></span>
<span class=line><span style=color:#50fa7b>game-sample</span><span style=color:#f1fa8c>   Running</span><span style=color:#f1fa8c>   mygame.io</span><span style=color:#bd93f9>   1</span><span style=color:#bd93f9>         1</span><span style=color:#bd93f9>         1</span><span style=color:#f1fa8c>       6m</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4># 查看deploy</span></span>
<span class=line><span style=color:#50fa7b>kubectl</span><span style=color:#f1fa8c> get</span><span style=color:#f1fa8c> deploy</span><span style=color:#f1fa8c> game-sample</span></span>
<span class=line><span style=color:#50fa7b>NAME</span><span style=color:#f1fa8c>          READY</span><span style=color:#f1fa8c>   UP-TO-DATE</span><span style=color:#f1fa8c>   AVAILABLE</span><span style=color:#f1fa8c>   AGE</span></span>
<span class=line><span style=color:#50fa7b>game-sample</span><span style=color:#f1fa8c>   1/1</span><span style=color:#bd93f9>     1</span><span style=color:#bd93f9>            1</span><span style=color:#f1fa8c>           6m</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4># 查看ingress</span></span>
<span class=line><span style=color:#50fa7b>kubectl</span><span style=color:#f1fa8c> get</span><span style=color:#f1fa8c> ing</span><span style=color:#f1fa8c> game-sample</span></span>
<span class=line><span style=color:#50fa7b>NAME</span><span style=color:#f1fa8c>          CLASS</span><span style=color:#f1fa8c>    HOSTS</span><span style=color:#f1fa8c>       ADDRESS</span><span style=color:#f1fa8c>        PORTS</span><span style=color:#f1fa8c>   AGE</span></span>
<span class=line><span style=color:#50fa7b>game-sample</span><span style=color:#ff79c6>   &#x3C;</span><span style=color:#f1fa8c>non</span><span style=color:#f8f8f2>e</span><span style=color:#ff79c6>></span><span style=color:#f1fa8c>   mygame.io</span><span style=color:#bd93f9>   192.168.49.2</span><span style=color:#bd93f9>   80</span><span style=color:#f1fa8c>      7m</span></span>
<span class=line></span></code></pre><p>验证应用，在<code>/etc/hosts</code>中添加<code>&#x3C;Ingress ADDRESS Ip>	mygame.io</code>，访问浏览器如下图所示 <img alt=2048 src=/img/blog/crd_mygame.png loading=lazy></p><p>验证扩容</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>kubectl</span><span style=color:#f1fa8c> scale</span><span style=color:#f1fa8c> games.myapp.qingwave.github.io</span><span style=color:#f1fa8c> game-sample</span><span style=color:#bd93f9> --replicas</span><span style=color:#bd93f9> 2</span></span>
<span class=line><span style=color:#50fa7b>game.myapp.qingwave.github.io/game-sample</span><span style=color:#f1fa8c> scaled</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4># 扩容后</span></span>
<span class=line><span style=color:#50fa7b>kubectl</span><span style=color:#f1fa8c> get</span><span style=color:#f1fa8c> games.myapp.qingwave.github.io</span></span>
<span class=line><span style=color:#50fa7b>NAME</span><span style=color:#f1fa8c>          PHASE</span><span style=color:#f1fa8c>     HOST</span><span style=color:#f1fa8c>        DESIRED</span><span style=color:#f1fa8c>   CURRENT</span><span style=color:#f1fa8c>   READY</span><span style=color:#f1fa8c>   AGE</span></span>
<span class=line><span style=color:#50fa7b>game-sample</span><span style=color:#f1fa8c>   Running</span><span style=color:#f1fa8c>   mygame.io</span><span style=color:#bd93f9>   2</span><span style=color:#bd93f9>         2</span><span style=color:#bd93f9>         2</span><span style=color:#f1fa8c>       7m</span></span>
<span class=line></span></code></pre><p>如需部署<code>Operator</code>到集群中，可参考官方文档，制作镜像并上传，运行<code>make deploy</code></p><h3 id=webhook>Webhook</h3><p>通常我们需要与 CR 自定义资源设置部分字段的默认值，或者验证字段是否合法，这就需要自己实现<code>Webhook</code>，<code>Kubebuilder</code>也提供了<code>Webhook</code>的功能。</p><p>通过设置<code>--defaulting</code>可创建<a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook>mutatingadmissionwebhook</a>类型准入控制器，用来修改传入资源；参数<code>--programmatic-validation</code>可创建<a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook>validatingadmissionwebhook</a>，用来验证传入资源</p><blockquote><p>在资源创建、修改时<code>apiserver</code>会通过 http 调用<code>webhook</code>提供的接口，所以会带来额外开销，简单的验证工作可通过<code>//+kubebuilder:validation</code>注解，直接通过<code>openapi</code>验证，性能更好</p></blockquote><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>kubebuilder</span><span style=color:#f1fa8c> create</span><span style=color:#f1fa8c> webhook</span><span style=color:#bd93f9> --group</span><span style=color:#f1fa8c> myapp</span><span style=color:#bd93f9> --version</span><span style=color:#f1fa8c> v1</span><span style=color:#bd93f9> --kind</span><span style=color:#f1fa8c> Game</span><span style=color:#bd93f9> --defaulting</span><span style=color:#bd93f9> --programmatic-validation</span></span>
<span class=line></span></code></pre><p>生成文件在<code>api/v1/game_webhook.go</code></p><p><code>Default</code>接口可实现修改资源，根据 kubebuilder 注释,当<code>game</code>资源<code>create</code>与<code>update</code>时，调用这个接口</p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>//+kubebuilder:webhook:path=/mutate-myapp-qingwave-github-io-v1-game,mutating=true,failurePolicy=fail,sideEffects=None,groups=myapp.qingwave.github.io,resources=games,verbs=create;update,versions=v1,name=mgame.kb.io,admissionReviewVersions={v1,v1beta1}</span></span>
<span class=line><span></span></span></code></pre><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>const</span><span style=color:#f8f8f2> (</span></span>
<span class=line><span style=color:#bd93f9>	defaultImage</span><span style=color:#ff79c6> =</span><span style=color:#e9f284> `</span><span style=color:#f1fa8c>alexwhen/docker-2048</span><span style=color:#e9f284>`</span></span>
<span class=line><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Default implements webhook.Defaulter so a webhook will be registered for the type</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>r </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Game</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Default</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>	gamelog.</span><span style=color:#50fa7b>Info</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>default</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, r.Name)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 设置默认镜像</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> r.Spec.Image </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> ""</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		r.Spec.Image </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> defaultImage</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// 设置默认Host</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> r.Spec.Host </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> ""</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		r.Spec.Host </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Sprintf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#bd93f9>%s</span><span style=color:#f1fa8c>.</span><span style=color:#bd93f9>%s</span><span style=color:#f1fa8c>.mygame.io</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, r.Name, r.Namespace)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>同样的通过<code>ValidateCreate</code>、<code>ValidateUpdate</code>可实现<code>validating webhook</code></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>r </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Game</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>ValidateCreate</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	gamelog.</span><span style=color:#50fa7b>Info</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>validate create</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>name</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, r.Name)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Host不能包括通配符</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> strings.</span><span style=color:#50fa7b>Contains</span><span style=color:#f8f8f2>(r.Spec.Host, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>*</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> errors.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>host should not contain *</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>本地验证 webhook 需要配置证书，在集群中测试更方便点，可参考官方文档。</p><h2 id=总结>总结</h2><p>至此，我们已经实现了一个功能完全的<code>game-operator</code>，可以管理<code>game</code>资源的生命周期，创建/更新 game 时会自动创建<code>deployment、service、ingress</code>等资源，当<code>deployment</code>被误删或者误修改时也可以自动回复到期望状态，也实现了<code>scale</code>接口。</p><p>通过<code>kubebuiler</code>大大简化了开发<code>operator</code>的成本，我们只需要关心业务逻辑即可，不需要再手动去创建<code>client/controller</code>等，但同时<code>kubebuilder</code>生成的代码中屏蔽了很多细节，比如<code>controller</code>的最大 worker 数、同步时间、队列类型等参数设置，只有了解<code>operator</code>的原理才更好应用于生产。</p><h2 id=引用>引用</h2><ul><li><a href=https://book.kubebuilder.io/ >https://book.kubebuilder.io/</a></li></ul></div><div class="flex flex-col justify-between mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class=mr-5><li class="rounded-full border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1"><a href=/tags/k8s/ class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#k8s</a></li></ul></div></article><div class="mx-auto sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script src=https://giscus.app/client.js async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOCg97r84CBQfL data-emit-metadata=0 data-input-position=top data-lang=en data-loading=lazy data-mapping=title data-reactions-enabled=1 data-repo=qingwave/qingwave.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict=0 data-theme=light></script></div></section><div class="bottom-8 fixed hidden right-6 z-50" id=back-to-top><button class="rounded-full dark:hover:bg-slate-800 dark:hover:text-gray-100 dark:text-gray-300 hover:bg-neutral-100 hover:text-neutral-500 p-3 text-neutral-300"><svg class="h-6 w-6" data-icon=ph:rocket-fill height=1em width=1em><symbol id=ai:ph:rocket-fill viewBox="0 0 256 256"><path d="M152 224a8 8 0 0 1-8 8h-32a8 8 0 0 1 0-16h32a8 8 0 0 1 8 8m71.62-68.17l-12.36 55.63a16 16 0 0 1-25.51 9.11L158.51 200h-61l-27.26 20.57a16 16 0 0 1-25.51-9.11l-12.36-55.63a16.09 16.09 0 0 1 3.32-13.71l28.56-34.26a123 123 0 0 1 8.57-36.67c12.9-32.34 36-52.63 45.37-59.85a16 16 0 0 1 19.6 0c9.34 7.22 32.47 27.51 45.37 59.85a123 123 0 0 1 8.57 36.67l28.56 34.26a16.09 16.09 0 0 1 3.32 13.71m-139.23 34q-16.11-29.33-19.56-57.67L48 152.36L60.36 208l.18-.13ZM140 100a12 12 0 1 0-12 12a12 12 0 0 0 12-12m68 52.36l-16.83-20.2q-3.42 28.28-19.56 57.69l23.85 18l.18.13Z" fill=currentColor /></symbol><use href=#ai:ph:rocket-fill></use></svg></button></div></main><footer class=relative><div class="px-4 mx-auto sm:px-6 max-w-3xl"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="px-4 mx-auto sm:px-6 max-w-3xl dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href=/rss.xml class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label=RSS><svg class="h-5 w-5" data-icon=tabler:rss height=1em width=1em><symbol id=ai:tabler:rss viewBox="0 0 24 24"><path d="M4 19a1 1 0 1 0 2 0a1 1 0 1 0-2 0M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use href=#ai:tabler:rss></use></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href=https://qingwave.github.io class=hover:brightness-50>Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function c(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:localStorage.theme}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),c=encodeURIComponent(t.getAttribute("data-aw-text"));let a;switch(o){case"facebook":a=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":a=`https://twitter.com/intent/tweet?url=${n}&text=${c}`;break;case"linkedin":a=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${c}`;break;case"whatsapp":a=`https://wa.me/?text=${c}%20${n}`;break;case"mail":a=`mailto:?subject=%22${c}%22&body=${c}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=a,s.click()})),c(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{c()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>