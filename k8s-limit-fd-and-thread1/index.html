<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=zh><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>k8s中fd与thread限制(一)</title><meta content=index,follow name=robots /><link href=https://qingwave.github.io/k8s-limit-fd-and-thread1 rel=canonical /><meta content=k8s中fd与thread限制(一) property=og:title /><meta content=https://qingwave.github.io/k8s-limit-fd-and-thread1 property=og:url /><meta content=article property=og:type /><meta content=https://qingwave.github.io/ property=og:image /><meta content=k8s中fd与thread限制(一) property=og:image:alt /><meta content=summary_large_image name=twitter:card /><style is:global>:root{--aw-font-sans:'Inter Variable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI name=google-site-verification><script src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async type=text/partytown></script><script type=text/partytown>(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.svg rel=mask-icon color=#8D46E7><link href=/sitemap-index.xml rel=sitemap><link href=/_astro/_page_.r6ftNKhy.css rel=stylesheet><link href=/_astro/_page_.DhGzlvej.css rel=stylesheet><script src=/_astro/hoisted.DNuUAAyM.js type=module></script><script>!function(t,e,n,r){(window.crossOriginIsolated||navigator.serviceWorker)&&((r=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(r[n]||[]).concat(["dataLayer.push"]))}(window,"partytown","forward");const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((()=>{const t=new Set;let e=[];do{Object.getOwnPropertyNames(e).forEach((n=>{"function"==typeof e[n]&&t.add(n)}))}while((e=Object.getPrototypeOf(e))!==Object.prototype);return Array.from(t)})());!function(t,r,o,i,a,s,c,d,l,p,u=t,y){function f(){y||(y=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(l=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(h,1e4),r.addEventListener("pt0",b),a?w(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):h())))}function w(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.10.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function h(n,o){for(b(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<l.length;n++)(o=r.createElement("script")).innerHTML=l[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function b(){clearTimeout(d)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?f():(t.addEventListener("DOMContentLoaded",f),t.addEventListener("load",f))}(window,document,navigator,top,window.crossOriginIsolated),document.addEventListener("astro:before-swap",(t=>{let e=document.body.querySelector("iframe[src*='/~partytown/']");t.newDocument.body.append(e)}))</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id=header><div class="px-4 mx-auto sm:px-6 max-w-3xl md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href=/ class="items-center flex"><img alt="" src=/favicon.svg class="h-6 w-6 dark:invert invert-0"></a><div class="items-center flex md:hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-7 w-7" data-icon=tabler:moon-filled height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:moon-filled><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341-.82-.476-1.644-1.298-1.31a6.5 6.5 0 0 1-6.864-10.787l.077-.08c.551-.63.113-1.653-.758-1.653h-.266l-.068-.006z" fill=currentColor /></symbol><use xlink:href=#ai:tabler:moon-filled></use></svg></button> <button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:focus:ring-gray-700 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 ml-1.5 rounded-lg text-gray-500 transition" aria-label="Toggle Menu" type=button data-aw-toggle-menu><svg class="h-6 w-6" data-icon=tabler:menu height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:menu><path d="M4 8h16M4 16h16" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use xlink:href=#ai:tabler:menu></use></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 w-full"><li class=""><a href=/blog class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>文章</a></li><li class=""><a href=/project class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>项目</a></li><li class=""><a href=/reading class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>阅读</a></li><li class=""><a href=/about class="items-center flex dark:text-neutral-300 font-medium px-4 py-3 text-neutral-500" memu-item>关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" aria-label="Toggle between Dark and Light mode" type=button data-aw-toggle-color-scheme><svg class="h-6 w-6" data-icon=tabler:moon-filled height=1em viewBox="0 0 24 24" width=1em><use xlink:href=#ai:tabler:moon-filled></use></svg></button></div></div></div></header><main><section class=page><article><header class=""><div class="flex px-4 flex-col justify-between mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Tue Jul 16 2019 18:44:47 GMT+0000 (Coordinated Universal Time)">Jul 16, 2019</time> · <a href=/categories/cloud class="capitalize hover:underline">cloud</a></p></div><h1 class="px-4 mx-auto sm:px-6 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">k8s中fd与thread限制(一)</h1><p class="px-4 mx-auto sm:px-6 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="px-4 mx-auto sm:px-6"><div class="border-t dark:border-slate-700"></div></div></header><div class="mx-auto sm:px-6 px-6 mt-8 3xl:prose-xl break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow prose-lg"><h2 id=背景>背景</h2><p>linux 中为了防止进程恶意使用资源，系统使用 ulimit 来限制进程的资源使用情况（包括文件描述符，线程数，内存大小等）。同样地在容器化场景中，需要限制其系统资源的使用量。</p><h2 id=限制方法>限制方法</h2><ul><li><strong>ulimit</strong>: docker 默认支持 ulimit 设置，可以在 dockerd 中配置 default-ulimits 可为宿主机所有容器配置默认的 ulimit，docker 启动时可添加 —ulimit 为每个容器配置 ulimit 会覆盖默认的设置；目前 k8s 暂不支持 ulimit</li><li><strong>cgroup</strong>: docker 默认支持 cgroup 中内存、cpu、pid 等的限制，对于线程限制可通过 —pids-limit 可限制每个容器的 pid 总数，dockerd 暂无默认的 pid limit 设置；k8s 限制线程数，可通过在 kubelet 中开启 SupportPodPidsLimit 特性，设置 pod 级别 pid limit</li><li><strong>/etc/securiy/limits.conf,systcl.confg</strong>: 通过 ulimit 命令设置只对当前登录用户有效，永久设置可通过 limits.conf 配置文件实现，以及系统级别限制可通过 systcl.confg 配置文件</li></ul><h2 id=实验对比>实验对比</h2><h3 id=环境>环境</h3><p><strong>本地环境</strong>： os: Ubuntu 16.04.6 LTS 4.4.0-154-generic docker: 18.09.7 base-image: alpine:v3.9</p><p><strong>k8s 环境</strong>： kubelet: v1.10.11.1 docker: 18.09.6</p><h3 id=ulimit>ulimit</h3><p>用户级别资源限制，分为 soft 限制与 hard 限制</p><ul><li>soft ： 用户可修改，但不能超过硬限制</li><li>hard：只有 root 用户可修改</li></ul><p><strong>修改方式</strong>： ulimit 命令，临时修改；/etc/security/limits.conf，永久修改</p><p><strong>工作原理</strong>： 根据 PAM （ Pluggable Authentication Modules 简称 PAM）机制，应用程序启动时，按 /etc/pam.d 配置加载 pam_xxxx.so 模块。 /etc/pam.d 下包含了 login 、sshd 、su 、sudo 等程序的 PAM 配置文件， 因此用户重新登录时，将调用 pam_limits.so 加载 limits.conf 配置文件</p><h4 id=文件描述符限制>文件描述符限制</h4><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>RLIMIT_NOFILE</span></span>
<span class=line><span>              This specifies a value one greater than the maximum file</span></span>
<span class=line><span>              descriptor number that can be opened by this process.</span></span>
<span class=line><span>              Attempts (open(2), pipe(2), dup(2), etc.)  to exceed this</span></span>
<span class=line><span>              limit yield the error EMFILE.  (Historically, this limit was</span></span>
<span class=line><span>              named RLIMIT_OFILE on BSD.)</span></span>
<span class=line><span></span></span>
<span class=line><span>              Since Linux 4.5, this limit also defines the maximum number of</span></span>
<span class=line><span>              file descriptors that an unprivileged process (one without the</span></span>
<span class=line><span>              CAP_SYS_RESOURCE capability) may have "in flight" to other</span></span>
<span class=line><span>              processes, by being passed across UNIX domain sockets.  This</span></span>
<span class=line><span>              limit applies to the sendmsg(2) system call.  For further</span></span>
<span class=line><span>              details, see unix(7).</span></span>
<span class=line><span></span></span></code></pre><p>根据定义，nofile 限制进程所能最多打开的文件数量，作用范围进程。</p><ol><li>设置 ulimit nofile 限制 soft 100/hard 200，默认启动为 root 用户</li></ol><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>$ docker run -d --ulimit nofile=100:200  cr.d.xiaomi.net/containercloud/alpine:webtool top</span></span>
<span class=line><span></span></span></code></pre><ol start=2><li>进入容器查看， fd soft 限制为 100 个</li></ol><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>/ # ulimit -a</span></span>
<span class=line><span>-f: file size (blocks)             unlimited</span></span>
<span class=line><span>-t: cpu time (seconds)             unlimited</span></span>
<span class=line><span>-d: data seg size (kb)             unlimited</span></span>
<span class=line><span>-s: stack size (kb)                8192</span></span>
<span class=line><span>-c: core file size (blocks)        unlimited</span></span>
<span class=line><span>-m: resident set size (kb)         unlimited</span></span>
<span class=line><span>-l: locked memory (kb)             64</span></span>
<span class=line><span>-p: processes                      unlimited</span></span>
<span class=line><span>-n: file descriptors               100</span></span>
<span class=line><span>-v: address space (kb)             unlimited</span></span>
<span class=line><span>-w: locks                          unlimited</span></span>
<span class=line><span>-e: scheduling priority            0</span></span>
<span class=line><span>-r: real-time priority             0</span></span>
<span class=line><span></span></span></code></pre><ol start=3><li>使用 ab 测试，并发 90 个 http 请求，创建 90 个 socket，正常运行</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # ab -n 1000000 -c 90 http://61.135.169.125:80/ &#x26;</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # lsof | wc -l</span></span>
<span class=line><span style=color:#50fa7b>108</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # lsof | grep -c ab</span></span>
<span class=line><span style=color:#50fa7b>94</span></span>
<span class=line></span></code></pre><ol start=4><li>并发 100 个 http 请求，受到 ulimit 限制</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> #  ab -n 1000000 -c 100 http://61.135.169.125:80/</span></span>
<span class=line><span style=color:#50fa7b>This</span><span style=color:#f1fa8c> is</span><span style=color:#f1fa8c> ApacheBench,</span><span style=color:#f1fa8c> Version</span><span style=color:#bd93f9> 2.3</span><span style=color:#ff79c6> &#x3C;</span><span style=color:#bd93f9>$Revision</span><span style=color:#f1fa8c>:</span><span style=color:#bd93f9> 1843412</span><span style=color:#f8f8f2> $</span><span style=color:#ff79c6>></span></span>
<span class=line><span style=color:#50fa7b>Copyright</span><span style=color:#bd93f9> 1996</span><span style=color:#f1fa8c> Adam</span><span style=color:#f1fa8c> Twiss,</span><span style=color:#f1fa8c> Zeus</span><span style=color:#f1fa8c> Technology</span><span style=color:#f1fa8c> Ltd,</span><span style=color:#f1fa8c> http://www.zeustech.net/</span></span>
<span class=line><span style=color:#50fa7b>Licensed</span><span style=color:#f1fa8c> to</span><span style=color:#f1fa8c> The</span><span style=color:#f1fa8c> Apache</span><span style=color:#f1fa8c> Software</span><span style=color:#f1fa8c> Foundation,</span><span style=color:#f1fa8c> http://www.apache.org/</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>Benchmarking</span><span style=color:#bd93f9> 61.135.169.125</span><span style=color:#f8f8f2> (be </span><span style=color:#f1fa8c>patient</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>socket:</span><span style=color:#f1fa8c> No</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> descriptors</span><span style=color:#f1fa8c> available</span><span style=color:#f8f8f2> (24)</span></span>
<span class=line></span></code></pre><h4 id=线程限制>线程限制</h4><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>RLIMIT_NPROC</span></span>
<span class=line><span>              This is a limit on the number of extant process (or, more pre‐</span></span>
<span class=line><span>              cisely on Linux, threads) for the real user ID of the calling</span></span>
<span class=line><span>              process.  So long as the current number of processes belonging</span></span>
<span class=line><span>              to this process's real user ID is greater than or equal to</span></span>
<span class=line><span>              this limit, fork(2) fails with the error EAGAIN.</span></span>
<span class=line><span></span></span>
<span class=line><span>              The RLIMIT_NPROC limit is not enforced for processes that have</span></span>
<span class=line><span>              either the CAP_SYS_ADMIN or the CAP_SYS_RESOURCE capability.</span></span>
<span class=line><span></span></span></code></pre><p>由定义可知，nproc 进程限制的范围是对于每个 uid，并且对于 root 用户无效。</p><h5 id=容器-uid>容器 uid</h5><p>同一主机上运行的所有容器共享同一个内核(主机的内核)，docker 通过 namspace 对 pid/utc/network 等进行了隔离，虽然 docker 中已经实现了 user namespace，但由于各种原因，默认没有开启，见<a href=https://docs.docker.com/engine/security/userns-remap/ >docker user namespace</a></p><pre class="astro-code dracula" data-language=plaintext style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span>$ docker run -d  cr.d.xiaomi.net/containercloud/alpine:webtool top</span></span>
<span class=line><span></span></span></code></pre><p>宿主机中查看 top 进程，显示 root 用户</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> ps</span><span style=color:#bd93f9> -ef</span><span style=color:#ff79c6> |</span><span style=color:#50fa7b>grep</span><span style=color:#f1fa8c> top</span></span>
<span class=line><span style=color:#50fa7b>root</span><span style=color:#bd93f9>      4096</span><span style=color:#bd93f9>  4080</span><span style=color:#bd93f9>  0</span><span style=color:#f1fa8c> 15:01</span><span style=color:#f1fa8c> ?</span><span style=color:#f1fa8c>        00:00:01</span><span style=color:#f1fa8c> top</span></span>
<span class=line></span></code></pre><p>容器中查看 id，uid 为 0 对应宿主机的 root 用户,虽然同为 root 用户，但 Linux Capabilities 不同，实际权限与宿主机 root 要少很多</p><p>在容器中切换用户到 operator(uid 为 11)，执行 sleep 命令，主机中查看对应进程用户为 app，对应 uid 同样为 11</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # id</span></span>
<span class=line><span style=color:#bd93f9>uid</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>0</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>root</span><span style=color:#f8f8f2>) </span><span style=color:#bd93f9>gid</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>0</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>root</span><span style=color:#f8f8f2>) </span><span style=color:#bd93f9>groups</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>0</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>root</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,1</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>bin</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,2</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>daemon</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,3</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>sys</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,4</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>adm</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,6</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>disk</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,10</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>wheel</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,11</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>floppy</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,20</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>dialout</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,26</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>tape</span><span style=color:#f8f8f2>)</span><span style=color:#f1fa8c>,27</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>video</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # su operator</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#f8f8f2> $ </span><span style=color:#f1fa8c>id</span></span>
<span class=line><span style=color:#bd93f9>uid</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>11</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>operator</span><span style=color:#f8f8f2>) </span><span style=color:#bd93f9>gid</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>0</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>root</span><span style=color:#f8f8f2>) </span><span style=color:#bd93f9>groups</span><span style=color:#ff79c6>=</span><span style=color:#f1fa8c>0</span><span style=color:#f8f8f2>(</span><span style=color:#50fa7b>root</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#f8f8f2> $ </span><span style=color:#f1fa8c>sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> ps</span><span style=color:#bd93f9> -ef</span><span style=color:#ff79c6> |</span><span style=color:#50fa7b>grep</span><span style=color:#e9f284> '</span><span style=color:#f1fa8c>sleep 100</span><span style=color:#e9f284>'</span></span>
<span class=line><span style=color:#50fa7b>app</span><span style=color:#bd93f9>      19302</span><span style=color:#bd93f9> 19297</span><span style=color:#bd93f9>  0</span><span style=color:#f1fa8c> 16:39</span><span style=color:#f1fa8c> pts/0</span><span style=color:#f1fa8c>    00:00:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> cat</span><span style=color:#f1fa8c> /etc/passwd</span><span style=color:#ff79c6> |</span><span style=color:#50fa7b> grep</span><span style=color:#f1fa8c> app</span></span>
<span class=line><span style=color:#50fa7b>app:x:11:0::/home/app:</span></span>
<span class=line></span></code></pre><h5 id=验证不同用户下-ulimit-的限制>验证不同用户下 ulimit 的限制</h5><p>设置 ulimit nproc 限制 soft 10/hard 20，默认启动为 root 用户</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> run</span><span style=color:#bd93f9> -d</span><span style=color:#bd93f9> --ulimit</span><span style=color:#f1fa8c> nproc=10:20</span><span style=color:#f1fa8c>  cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#f1fa8c> top</span></span>
<span class=line></span></code></pre><p>进入容器查看， fd soft 限制为 100 个</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # ulimit -a</span></span>
<span class=line><span style=color:#50fa7b>-f:</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (blocks)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-t:</span><span style=color:#f1fa8c> cpu</span><span style=color:#f1fa8c> time</span><span style=color:#f8f8f2> (seconds)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-d:</span><span style=color:#f1fa8c> data</span><span style=color:#f1fa8c> seg</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (kb)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-s:</span><span style=color:#f1fa8c> stack</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (kb)                8192</span></span>
<span class=line><span style=color:#50fa7b>-c:</span><span style=color:#f1fa8c> core</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (blocks)        unlimited</span></span>
<span class=line><span style=color:#50fa7b>-m:</span><span style=color:#f1fa8c> resident</span><span style=color:#f1fa8c> set</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (kb)         unlimited</span></span>
<span class=line><span style=color:#50fa7b>-l:</span><span style=color:#f1fa8c> locked</span><span style=color:#f1fa8c> memory</span><span style=color:#f8f8f2> (kb)             64</span></span>
<span class=line><span style=color:#50fa7b>-p:</span><span style=color:#f1fa8c> processes</span><span style=color:#bd93f9>                      10</span></span>
<span class=line><span style=color:#50fa7b>-n:</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> descriptors</span><span style=color:#bd93f9>               1048576</span></span>
<span class=line><span style=color:#50fa7b>-v:</span><span style=color:#f1fa8c> address</span><span style=color:#f1fa8c> space</span><span style=color:#f8f8f2> (kb)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-w:</span><span style=color:#f1fa8c> locks</span><span style=color:#f1fa8c>                          unlimited</span></span>
<span class=line><span style=color:#50fa7b>-e:</span><span style=color:#f1fa8c> scheduling</span><span style=color:#f1fa8c> priority</span><span style=color:#bd93f9>            0</span></span>
<span class=line><span style=color:#50fa7b>-r:</span><span style=color:#f1fa8c> real-time</span><span style=color:#f1fa8c> priority</span><span style=color:#bd93f9>             0</span></span>
<span class=line></span></code></pre><p>启动 30 个进程</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # for i in `seq 30`;do sleep 100 &#x26;; done</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # ps | wc -l</span></span>
<span class=line><span style=color:#50fa7b>36</span></span>
<span class=line></span></code></pre><p>切换到 operator 用户</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # su operator</span></span>
<span class=line><span style=color:#6272a4># 启动多个进程，到第11个进程无法进行fork</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#f8f8f2> $ </span><span style=color:#f1fa8c>for</span><span style=color:#f1fa8c> i</span><span style=color:#f1fa8c> in</span><span style=color:#f1fa8c> `</span><span style=color:#50fa7b>seq</span><span style=color:#bd93f9> 8</span><span style=color:#f1fa8c>`</span><span style=color:#f8f8f2>; </span><span style=color:#ff79c6>do</span></span>
<span class=line><span style=color:#ff79c6>></span><span style=color:#f8f8f2> sleep 100 &#x26;</span></span>
<span class=line><span style=color:#ff79c6>></span><span style=color:#ff79c6> done</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#f8f8f2> $ </span><span style=color:#f1fa8c>sleep</span><span style=color:#bd93f9> 100</span><span style=color:#f8f8f2> &#x26;</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#f8f8f2> $ </span><span style=color:#f1fa8c>sleep</span><span style=color:#bd93f9> 100</span><span style=color:#f8f8f2> &#x26;</span></span>
<span class=line><span style=color:#50fa7b>sh:</span><span style=color:#f1fa8c> can</span><span style=color:#e9f284>'</span><span style=color:#f1fa8c>t fork: Resource temporarily unavailable</span></span>
<span class=line></span></code></pre><p>root 下查看</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # ps -ef | grep operator</span></span>
<span class=line><span style=color:#50fa7b>   79</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sh</span></span>
<span class=line><span style=color:#50fa7b>   99</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  100</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  101</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  102</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  103</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  104</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  105</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  106</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  107</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  0:00</span><span style=color:#f1fa8c> sleep</span><span style=color:#bd93f9> 100</span></span>
<span class=line><span style=color:#50fa7b>  109</span><span style=color:#f1fa8c> root</span><span style=color:#f1fa8c>      0:00</span><span style=color:#f1fa8c> grep</span><span style=color:#f1fa8c> operator</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # ps -ef | grep operator| wc -l</span></span>
<span class=line><span style=color:#50fa7b>10</span></span>
<span class=line></span></code></pre><h5 id=验证-ulimit-在不同容器相同-uid-下的限制>验证 ulimit 在不同容器相同 uid 下的限制</h5><p>设置 ulimit nproc 限制 soft 3/hard 3，默认启动为 operator 用户,起 4 个容器，第四个启动失败</p><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> run</span><span style=color:#bd93f9> -d</span><span style=color:#bd93f9> --ulimit</span><span style=color:#f1fa8c> nproc=3:3</span><span style=color:#bd93f9> --name</span><span style=color:#f1fa8c> nproc1</span><span style=color:#bd93f9> -u</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#f1fa8c> top</span></span>
<span class=line><span style=color:#50fa7b>eeb1551bf757ad4f112c61cc48d7cbe959185f65109e4b44f28085f246043e65</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> run</span><span style=color:#bd93f9> -d</span><span style=color:#bd93f9> --ulimit</span><span style=color:#f1fa8c> nproc=3:3</span><span style=color:#bd93f9> --name</span><span style=color:#f1fa8c> nproc2</span><span style=color:#bd93f9> -u</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#f1fa8c> top</span></span>
<span class=line><span style=color:#50fa7b>42ff29844565a9cb3af2c8dd560308b1f31306041d3dbd929011d65f1848a262</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> run</span><span style=color:#bd93f9> -d</span><span style=color:#bd93f9> --ulimit</span><span style=color:#f1fa8c> nproc=3:3</span><span style=color:#bd93f9> --name</span><span style=color:#f1fa8c> nproc3</span><span style=color:#bd93f9> -u</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#f1fa8c> top</span></span>
<span class=line><span style=color:#50fa7b>b7c9b469e73f969d922841dd77265467959eda28ed06301af8bf83bcf18e8c23</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> run</span><span style=color:#bd93f9> -d</span><span style=color:#bd93f9> --ulimit</span><span style=color:#f1fa8c> nproc=3:3</span><span style=color:#bd93f9> --name</span><span style=color:#f1fa8c> nproc4</span><span style=color:#bd93f9> -u</span><span style=color:#f1fa8c> operator</span><span style=color:#f1fa8c>  cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#f1fa8c> top</span></span>
<span class=line><span style=color:#50fa7b>b49d8bb58757c88f69903059af2ee7e2a6cc2fa5774bc531941194c52edfd763</span></span>
<span class=line><span style=color:#50fa7b>$</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> ps</span><span style=color:#bd93f9> -a</span><span style=color:#ff79c6> |</span><span style=color:#50fa7b>grep</span><span style=color:#f1fa8c> nproc</span></span>
<span class=line><span style=color:#50fa7b>b49d8bb58757</span><span style=color:#f1fa8c>        cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#e9f284>      "</span><span style=color:#f1fa8c>top</span><span style=color:#e9f284>"</span><span style=color:#bd93f9>                    16</span><span style=color:#f1fa8c> seconds</span><span style=color:#f1fa8c> ago</span><span style=color:#f1fa8c>      Exited</span><span style=color:#f8f8f2> (1) 15 seconds ago                               nproc4</span></span>
<span class=line><span style=color:#50fa7b>b7c9b469e73f</span><span style=color:#f1fa8c>        cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#e9f284>      "</span><span style=color:#f1fa8c>top</span><span style=color:#e9f284>"</span><span style=color:#bd93f9>                    23</span><span style=color:#f1fa8c> seconds</span><span style=color:#f1fa8c> ago</span><span style=color:#f1fa8c>      Up</span><span style=color:#bd93f9> 22</span><span style=color:#f1fa8c> seconds</span><span style=color:#f1fa8c>                                           nproc3</span></span>
<span class=line><span style=color:#50fa7b>42ff29844565</span><span style=color:#f1fa8c>        cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#e9f284>      "</span><span style=color:#f1fa8c>top</span><span style=color:#e9f284>"</span><span style=color:#bd93f9>                    31</span><span style=color:#f1fa8c> seconds</span><span style=color:#f1fa8c> ago</span><span style=color:#f1fa8c>      Up</span><span style=color:#bd93f9> 29</span><span style=color:#f1fa8c> seconds</span><span style=color:#f1fa8c>                                           nproc2</span></span>
<span class=line><span style=color:#50fa7b>eeb1551bf757</span><span style=color:#f1fa8c>        cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#e9f284>      "</span><span style=color:#f1fa8c>top</span><span style=color:#e9f284>"</span><span style=color:#bd93f9>                    38</span><span style=color:#f1fa8c> seconds</span><span style=color:#f1fa8c> ago</span><span style=color:#f1fa8c>      Up</span><span style=color:#bd93f9> 36</span><span style=color:#f1fa8c> seconds</span><span style=color:#f1fa8c>                                           nproc1</span></span>
<span class=line></span></code></pre><h5 id=总结>总结</h5><ul><li>ulimit 限制 fd 总数，限制级别进程，可对所有用户生效</li><li>ulimit 限制线程总数，限制级别用户（uid)，限制同一个 uid 下所有线程/进程数，对于 root 账号无效</li><li>对于目前线上情况，有较小的概率因 ulimit 限制导致 fork 失败，如同一个宿主机中有多个 work 容器且基础镜像相同（即 uid 相同），若一个容器线程泄露，由于 ulimit 限制会影响其他容器正常运行</li></ul><h3 id=cgroup>cgroup</h3><p>cgroup 中对 pid 进行了隔离，通过更改 docker/kubelet 配置，可以限制 pid 总数，从而达到限制线程总数的目的。线程数限制与系统中多处配置有关，取最小值，参考<a href=https://stackoverflow.com/questions/34452302/how-to-increase-maximum-number-of-jvm-threads-linux-64bit>stackoverflow 上线程数的设置</a></p><ul><li>docker，容器启动时设置 —pids-limit 参数，限制容器级别 pid 总数</li><li>kubelet，开启 SupportPodPidsLimit 特性，设置—pod-max-pids 参数，限制 node 每个 pod 的 pid 总数</li></ul><p>以 kubelet 为例，开启 SupportPodPidsLimit，<code>--feature-gates=SupportPodPidsLimit=true</code></p><ol><li>配置 kubelet，每个 pod 允许最大 pid 数目为 150</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f8f8f2>[root@node01 </span><span style=color:#ff79c6>~</span><span style=color:#f8f8f2>]# ps -ef </span><span style=color:#ff79c6>|</span><span style=color:#50fa7b>grep</span><span style=color:#f1fa8c> kubelet</span></span>
<span class=line><span style=color:#50fa7b>root</span><span style=color:#bd93f9>     18735</span><span style=color:#bd93f9>     1</span><span style=color:#bd93f9> 14</span><span style=color:#f1fa8c> 11:19</span><span style=color:#f1fa8c> ?</span><span style=color:#f1fa8c>        00:53:28</span><span style=color:#f1fa8c> ./kubelet</span><span style=color:#bd93f9> --v=1</span><span style=color:#bd93f9> --address=0.0.0.0</span><span style=color:#bd93f9> --feature-gates=SupportPodPidsLimit=true</span><span style=color:#bd93f9> --pod-max-pids=150</span><span style=color:#bd93f9> --allow-privileged=true</span><span style=color:#bd93f9> --pod-infra-container-image=cr.d.xiaomi.net/kubernetes/pause-amd64:3.1</span><span style=color:#bd93f9> --root-dir=/home/kubelet</span><span style=color:#bd93f9> --node-status-update-frequency=5s</span><span style=color:#bd93f9> --kubeconfig=/home/xbox/kubelet/conf/kubelet-kubeconfig</span><span style=color:#bd93f9> --fail-swap-on=false</span><span style=color:#bd93f9> --max-pods=254</span><span style=color:#bd93f9> --runtime-cgroups=/systemd/system.slice/frigga.service</span><span style=color:#bd93f9> --kubelet-cgroups=/systemd/system.slice/frigga.service</span><span style=color:#bd93f9> --make-iptables-util-chains=false</span></span>
<span class=line></span></code></pre><ol start=2><li>在 pod 中起测试线程，root 下起 100 个线程</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # for i in `seq 100`; do</span></span>
<span class=line><span style=color:#ff79c6>></span><span style=color:#f8f8f2> sleep 1000 &#x26;</span></span>
<span class=line><span style=color:#ff79c6>></span><span style=color:#ff79c6> done</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # ps | wc -l</span></span>
<span class=line><span style=color:#50fa7b>106</span></span>
<span class=line></span></code></pre><ol start=3><li>operator 下，创建线程受到限制，系统最多只能创建 150 个</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # su operator</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#f8f8f2> $</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#f8f8f2> $ </span><span style=color:#f1fa8c>for</span><span style=color:#f1fa8c> i</span><span style=color:#f1fa8c> in</span><span style=color:#f1fa8c> `</span><span style=color:#50fa7b>seq</span><span style=color:#bd93f9> 100</span><span style=color:#f1fa8c>`</span><span style=color:#f8f8f2>; </span><span style=color:#ff79c6>do</span></span>
<span class=line><span style=color:#ff79c6>></span><span style=color:#f8f8f2> sleep 1000 &#x26;</span></span>
<span class=line><span style=color:#ff79c6>></span><span style=color:#ff79c6> done</span></span>
<span class=line><span style=color:#50fa7b>sh:</span><span style=color:#f1fa8c> can</span><span style=color:#e9f284>'</span><span style=color:#f1fa8c>t fork: Resource temporarily unavailable</span></span>
<span class=line><span style=color:#f1fa8c>/ $ ps | wc -l</span></span>
<span class=line><span style=color:#f1fa8c>150</span></span>
<span class=line></span></code></pre><ol start=4><li>在 cgroup 中查看，pids 达到最大限制</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f8f8f2>[root@node01 </span><span style=color:#ff79c6>~</span><span style=color:#f8f8f2>]# cat /sys/fs/cgroup/pids/kubepods/besteffort/pod8b61d4de-a7ad-11e9-b5b9-246e96ad0900/pids.current</span></span>
<span class=line><span style=color:#50fa7b>150</span></span>
<span class=line><span style=color:#f8f8f2>[root@node01 </span><span style=color:#ff79c6>~</span><span style=color:#f8f8f2>]# cat /sys/fs/cgroup/pids/kubepods/besteffort/pod8b61d4de-a7ad-11e9-b5b9-246e96ad0900/pids.max</span></span>
<span class=line><span style=color:#50fa7b>150</span></span>
<span class=line></span></code></pre><ol start=5><li>总结 cgroup 对于 pid 的限制能够达到限制线程数目的，目前 docker 只支持对每个容器的限制，不支持全局配置；kubelet 只支持对于 node 所有 pod 的全局配置，不支持具体每个 pod 的配置</li></ol><h3 id=limitsconfsysctlconf>limits.conf/sysctl.conf</h3><p>limits.conf 是 ulimit 的具体配置，目录项/etc/security/limit.d/中的配置会覆盖 limits.conf。</p><p>sysctl.conf 为机器级别的资源限制，root 用户可修改，目录项/etc/security/sysctl.d/中的配置会覆盖 sysctl.conf，在/etc/sysctl.conf 中添加对应配置（fd: fs.file-max = {}; pid: kernel.pid_max = {}）</p><ol><li>测试容器中修改 sysctl.conf 文件</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> run</span><span style=color:#bd93f9> -d</span><span style=color:#bd93f9> --ulimit</span><span style=color:#f1fa8c> nofile=100:200</span><span style=color:#f1fa8c> cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#f1fa8c> top</span></span>
<span class=line><span style=color:#50fa7b>cb1250c8fd217258da51c6818fa2ce2e2f6e35bf1d52648f1f432e6ce579cf0d</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> exec</span><span style=color:#bd93f9> -it</span><span style=color:#f1fa8c> cb1250c</span><span style=color:#f1fa8c> sh</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # ulimit -a</span></span>
<span class=line><span style=color:#50fa7b>-f:</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (blocks)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-t:</span><span style=color:#f1fa8c> cpu</span><span style=color:#f1fa8c> time</span><span style=color:#f8f8f2> (seconds)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-d:</span><span style=color:#f1fa8c> data</span><span style=color:#f1fa8c> seg</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (kb)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-s:</span><span style=color:#f1fa8c> stack</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (kb)                8192</span></span>
<span class=line><span style=color:#50fa7b>-c:</span><span style=color:#f1fa8c> core</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (blocks)        unlimited</span></span>
<span class=line><span style=color:#50fa7b>-m:</span><span style=color:#f1fa8c> resident</span><span style=color:#f1fa8c> set</span><span style=color:#f1fa8c> size</span><span style=color:#f8f8f2> (kb)         unlimited</span></span>
<span class=line><span style=color:#50fa7b>-l:</span><span style=color:#f1fa8c> locked</span><span style=color:#f1fa8c> memory</span><span style=color:#f8f8f2> (kb)             64</span></span>
<span class=line><span style=color:#50fa7b>-p:</span><span style=color:#f1fa8c> processes</span><span style=color:#f1fa8c>                      unlimited</span></span>
<span class=line><span style=color:#50fa7b>-n:</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> descriptors</span><span style=color:#bd93f9>               100</span></span>
<span class=line><span style=color:#50fa7b>-v:</span><span style=color:#f1fa8c> address</span><span style=color:#f1fa8c> space</span><span style=color:#f8f8f2> (kb)             unlimited</span></span>
<span class=line><span style=color:#50fa7b>-w:</span><span style=color:#f1fa8c> locks</span><span style=color:#f1fa8c>                          unlimited</span></span>
<span class=line><span style=color:#50fa7b>-e:</span><span style=color:#f1fa8c> scheduling</span><span style=color:#f1fa8c> priority</span><span style=color:#bd93f9>            0</span></span>
<span class=line><span style=color:#50fa7b>-r:</span><span style=color:#f1fa8c> real-time</span><span style=color:#f1fa8c> priority</span><span style=color:#bd93f9>             0</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> #</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # echo 10 > /proc/sys/kernel/pid_max</span></span>
<span class=line><span style=color:#50fa7b>sh:</span><span style=color:#f1fa8c> can</span><span style=color:#e9f284>'</span><span style=color:#f1fa8c>t create /proc/sys/kernel/pid_max: Read-only file system</span></span>
<span class=line><span style=color:#f1fa8c>/ # echo 10 > /proc/sys/kernel/pid_max</span></span>
<span class=line><span style=color:#f1fa8c>sh: can</span><span style=color:#e9f284>'</span><span style=color:#f1fa8c>t</span><span style=color:#f1fa8c> create</span><span style=color:#f1fa8c> /proc/sys/kernel/pid_max:</span><span style=color:#f1fa8c> Read-only</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> system</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # echo "fs.file-max=5" >> /etc/sysctl.conf</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # sysctl -p</span></span>
<span class=line><span style=color:#50fa7b>sysctl:</span><span style=color:#f1fa8c> error</span><span style=color:#f1fa8c> setting</span><span style=color:#f1fa8c> key</span><span style=color:#e9f284> '</span><span style=color:#f1fa8c>fs.file-max</span><span style=color:#e9f284>'</span><span style=color:#f1fa8c>:</span><span style=color:#f1fa8c> Read-only</span><span style=color:#f1fa8c> file</span><span style=color:#f1fa8c> system</span></span>
<span class=line></span></code></pre><ol start=2><li>以 priviledged 模式测试，谨慎测试</li></ol><pre class="astro-code dracula" data-language=bash style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> cat</span><span style=color:#f1fa8c> /proc/sys/kernel/pid_max</span></span>
<span class=line><span style=color:#50fa7b>32768</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> run</span><span style=color:#bd93f9> -d</span><span style=color:#bd93f9> --</span><span style=color:#bd93f9> --ulimit</span><span style=color:#f1fa8c> nofile=100:200</span><span style=color:#f1fa8c> cr.d.xiaomi.net/containercloud/alpine:webtool</span><span style=color:#f1fa8c> top</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> docker</span><span style=color:#f1fa8c> exec</span><span style=color:#bd93f9> -it</span><span style=color:#f1fa8c> pedantic_vaughan</span><span style=color:#f1fa8c> sh</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # cat /proc/sys/kernel/pid_max</span></span>
<span class=line><span style=color:#50fa7b>32768</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # echo 50000 > /proc/sys/kernel/pid_max</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # cat /proc/sys/kernel/pid_max</span></span>
<span class=line><span style=color:#50fa7b>50000</span></span>
<span class=line><span style=color:#50fa7b>/</span><span style=color:#6272a4> # exit</span></span>
<span class=line><span style=color:#50fa7b>$</span><span style=color:#f1fa8c> cat</span><span style=color:#f1fa8c> /proc/sys/kernel/pid_max</span></span>
<span class=line><span style=color:#50fa7b>50000</span><span style=color:#6272a4> # 宿主机的文件也变成50000</span></span>
<span class=line></span></code></pre><ol start=3><li>总结 由于 docker 隔离的不彻底，在 docker 中修改 sysctl 会覆盖主机中的配置，不能用来实现容器级别资源限制 limits.conf 可以在容器中设置，效果同 ulimit。</li></ol><h2 id=结论>结论</h2><p><img alt=pod-fd-limit src=/img/blog/pod-fd-limit.png loading=lazy></p><p>推荐方案如下：</p><ul><li>fd 限制： 修改 dockerd 配置<code>default-ulimits</code>，限制进程级别 fd</li><li>thread 限制：修改 kubelet 配置<code>--feature-gates=SupportPodPidsLimit=true --pod-max-pids={}</code>，cgroup 级别限制 pid，从而限制线程数</li><li>其他注意事项，调整节点 pid.max 参数；放开或者调大镜像中 ulimit 对非 root 账户 nproc 限制</li></ul><h2 id=引用>引用</h2><ul><li><a href=https://docs.docker.com/engine/reference/commandline/run/#set-ulimits-in-container---ulimit>https://docs.docker.com/engine/reference/commandline/run/#set-ulimits-in-container---ulimit</a></li><li><a href=http://man7.org/linux/man-pages/man2/getrlimit.2.html>http://man7.org/linux/man-pages/man2/getrlimit.2.html</a></li><li><a href=https://feichashao.com/ulimit_demo/ >https://feichashao.com/ulimit_demo/</a></li><li><a href=https://medium.com/@mccode/understanding-how-uid-and-gid-work-in-docker-containers-c37a01d01cf>https://medium.com/@mccode/understanding-how-uid-and-gid-work-in-docker-containers-c37a01d01cf</a></li><li><a href=https://docs.docker.com/engine/security/userns-remap/ >https://docs.docker.com/engine/security/userns-remap/</a></li></ul></div><div class="flex flex-col justify-between mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class=mr-5><li class="rounded-full border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1"><a href=/tags/k8s class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#k8s</a></li><li class="rounded-full border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1"><a href=/tags/docker class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#docker</a></li></ul></div></article><div class="mx-auto sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script src=https://giscus.app/client.js async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOCg97r84CBQfL data-emit-metadata=0 data-input-position=top data-lang=en data-loading=lazy data-mapping=title data-reactions-enabled=1 data-repo=qingwave/qingwave.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict=0 data-theme=light></script></div></section><div class="bottom-8 fixed hidden right-6 z-50" id=back-to-top><button class="rounded-full dark:hover:bg-slate-800 dark:hover:text-gray-100 dark:text-gray-300 hover:bg-neutral-100 hover:text-neutral-500 p-3 text-neutral-300"><svg class="h-6 w-6" data-icon=ph:rocket-fill height=1em viewBox="0 0 256 256" width=1em><symbol id=ai:ph:rocket-fill><path d="M152 224a8 8 0 0 1-8 8h-32a8 8 0 0 1 0-16h32a8 8 0 0 1 8 8m71.62-68.17l-12.36 55.63a16 16 0 0 1-25.51 9.11L158.51 200h-61l-27.26 20.57a16 16 0 0 1-25.51-9.11l-12.36-55.63a16.09 16.09 0 0 1 3.32-13.71l28.56-34.26a123 123 0 0 1 8.57-36.67c12.9-32.34 36-52.63 45.37-59.85a16 16 0 0 1 19.6 0c9.34 7.22 32.47 27.51 45.37 59.85a123 123 0 0 1 8.57 36.67l28.56 34.26a16.09 16.09 0 0 1 3.32 13.71m-139.23 34q-16.11-29.33-19.56-57.67L48 152.36L60.36 208l.18-.13ZM140 100a12 12 0 1 0-12 12a12 12 0 0 0 12-12m68 52.36l-16.83-20.2q-3.42 28.28-19.56 57.69l23.85 18l.18.13Z" fill=currentColor /></symbol><use xlink:href=#ai:ph:rocket-fill></use></svg></button></div></main><footer class=relative><div class="px-4 mx-auto sm:px-6 max-w-3xl"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="px-4 mx-auto sm:px-6 max-w-3xl dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href=/rss.xml class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label=RSS><svg class="h-5 w-5" data-icon=tabler:rss height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:rss><path d="M4 19a1 1 0 1 0 2 0a1 1 0 1 0-2 0M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use xlink:href=#ai:tabler:rss></use></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href=https://qingwave.github.io class=hover:brightness-50>Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function c(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:localStorage.theme}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),c=encodeURIComponent(t.getAttribute("data-aw-text"));let a;switch(o){case"facebook":a=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":a=`https://twitter.com/intent/tweet?url=${n}&text=${c}`;break;case"linkedin":a=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${c}`;break;case"whatsapp":a=`https://wa.me/?text=${c}%20${n}`;break;case"mail":a=`mailto:?subject=%22${c}%22&body=${c}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=a,s.click()})),c(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{c()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>