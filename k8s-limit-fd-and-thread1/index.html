<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">
        k8s中fd与thread限制(一)
        
    </title><meta name="Description" content="Coding, Reading and Daydreaming"><meta property="og:title" content="k8s中fd与thread限制(一)" />
<meta property="og:description" content="
    背景linux中为了防止进程恶意使用资源，系统使用ulimit来限制进程的资源使用情况（包括文件描述符，线程数，内存大小等）。同样地在容器化场景中，需要限制其系统资源的使用量。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qingwave.github.io/k8s-limit-fd-and-thread1/" /><meta property="og:image" content="https://qingwave.github.io/img/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-07-16T18:44:47+00:00" />
<meta property="article:modified_time" content="2021-11-20T10:59:07+00:00" /><meta property="og:site_name" content="Qingwave" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://qingwave.github.io/img/favicon.png"/>

<meta name="twitter:title" content="k8s中fd与thread限制(一)"/>
<meta name="twitter:description" content="
    背景linux中为了防止进程恶意使用资源，系统使用ulimit来限制进程的资源使用情况（包括文件描述符，线程数，内存大小等）。同样地在容器化场景中，需要限制其系统资源的使用量。"/>
<meta name="application-name" content="Qingwave">
<meta name="apple-mobile-web-app-title" content="Qingwave">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://qingwave.github.io/k8s-limit-fd-and-thread1/" /><link rel="prev" href="https://qingwave.github.io/container-memory/" /><link rel="next" href="https://qingwave.github.io/k8s-limit-fd-and-thread2/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><meta name="google-site-verification" content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" /><meta name="baidu-site-verification" content="muFp3xopwC" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "k8s中fd与thread限制(一)",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qingwave.github.io\/k8s-limit-fd-and-thread1\/"
        },"genre": "posts","keywords": "k8s, docker","wordcount":  3458 ,
        "url": "https:\/\/qingwave.github.io\/k8s-limit-fd-and-thread1\/","datePublished": "2019-07-16T18:44:47+00:00","dateModified": "2021-11-20T10:59:07+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Qingwave"
            },"description": ""
    }
    </script></head>

<body header-desktop="normal" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span><span class="header-title-post"> Time</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#限制方法">限制方法</a></li>
    <li><a href="#实验对比">实验对比</a>
      <ul>
        <li><a href="#环境">环境</a></li>
        <li><a href="#ulimit">ulimit</a>
          <ul>
            <li><a href="#文件描述符限制">文件描述符限制</a></li>
            <li><a href="#线程限制">线程限制</a>
              <ul>
                <li><a href="#容器uid">容器uid</a></li>
                <li><a href="#验证不同用户下ulimit的限制">验证不同用户下ulimit的限制</a></li>
                <li><a href="#验证ulimit在不同容器相同uid下的限制">验证ulimit在不同容器相同uid下的限制</a></li>
                <li><a href="#总结">总结</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#cgroup">cgroup</a></li>
        <li><a href="#limitsconfsysctlconf">limits.conf/sysctl.conf</a></li>
      </ul>
    </li>
    <li><a href="#结论">结论</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title">k8s中fd与thread限制(一)</h1><div class="post-meta">
            <div class="post-meta-line"><time datetime="Jul 16, 2019">Jul 16, 2019</time>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#限制方法">限制方法</a></li>
    <li><a href="#实验对比">实验对比</a>
      <ul>
        <li><a href="#环境">环境</a></li>
        <li><a href="#ulimit">ulimit</a>
          <ul>
            <li><a href="#文件描述符限制">文件描述符限制</a></li>
            <li><a href="#线程限制">线程限制</a>
              <ul>
                <li><a href="#容器uid">容器uid</a></li>
                <li><a href="#验证不同用户下ulimit的限制">验证不同用户下ulimit的限制</a></li>
                <li><a href="#验证ulimit在不同容器相同uid下的限制">验证ulimit在不同容器相同uid下的限制</a></li>
                <li><a href="#总结">总结</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#cgroup">cgroup</a></li>
        <li><a href="#limitsconfsysctlconf">limits.conf/sysctl.conf</a></li>
      </ul>
    </li>
    <li><a href="#结论">结论</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="背景" class="headerLink">
    <a href="#%e8%83%8c%e6%99%af" class="header-mark"></a>背景</h2><p>linux中为了防止进程恶意使用资源，系统使用ulimit来限制进程的资源使用情况（包括文件描述符，线程数，内存大小等）。同样地在容器化场景中，需要限制其系统资源的使用量。</p>
<h2 id="限制方法" class="headerLink">
    <a href="#%e9%99%90%e5%88%b6%e6%96%b9%e6%b3%95" class="header-mark"></a>限制方法</h2><ul>
<li><strong>ulimit</strong>: docker 默认支持ulimit设置，可以在dockerd中配置 default-ulimits 可为宿主机所有容器配置默认的ulimit，docker启动时可添加 &ndash;ulimit 为每个容器配置ulimit会覆盖默认的设置；目前k8s暂不支持ulimit</li>
<li><strong>cgroup</strong>: docker 默认支持cgroup中内存、cpu、pid等的限制，对于线程限制可通过 &ndash;pids-limit 可限制每个容器的pid总数，dockerd暂无默认的pid limit设置；k8s 限制线程数，可通过在kubelet中开启SupportPodPidsLimit特性，设置pod级别pid limit</li>
<li><strong>/etc/securiy/limits.conf,systcl.confg</strong>: 通过ulimit命令设置只对当前登录用户有效，永久设置可通过limits.conf配置文件实现，以及系统级别限制可通过systcl.confg配置文件</li>
</ul>
<h2 id="实验对比" class="headerLink">
    <a href="#%e5%ae%9e%e9%aa%8c%e5%af%b9%e6%af%94" class="header-mark"></a>实验对比</h2><h3 id="环境" class="headerLink">
    <a href="#%e7%8e%af%e5%a2%83" class="header-mark"></a>环境</h3><p><strong>本地环境</strong>：
os: Ubuntu 16.04.6 LTS 4.4.0-154-generic
docker: 18.09.7
base-image: alpine:v3.9</p>
<p><strong>k8s环境</strong>：
kubelet: v1.10.11.1
docker: 18.09.6</p>
<h3 id="ulimit" class="headerLink">
    <a href="#ulimit" class="header-mark"></a>ulimit</h3><p>用户级别资源限制，分为soft限制与hard限制</p>
<ul>
<li>soft ： 用户可修改，但不能超过硬限制</li>
<li>hard：只有root用户可修改</li>
</ul>
<p><strong>修改方式</strong>： ulimit命令，临时修改；/etc/security/limits.conf，永久修改</p>
<p><strong>工作原理</strong>： 根据 PAM （ Pluggable Authentication Modules 简称 PAM）机制，应用程序启动时，按 /etc/pam.d 配置加载 pam_xxxx.so 模块。 /etc/pam.d 下包含了 login 、sshd 、su 、sudo 等程序的 PAM 配置文件， 因此用户重新登录时，将调用 pam_limits.so 加载 limits.conf 配置文件</p>
<h4 id="文件描述符限制" class="headerLink">
    <a href="#%e6%96%87%e4%bb%b6%e6%8f%8f%e8%bf%b0%e7%ac%a6%e9%99%90%e5%88%b6" class="header-mark"></a>文件描述符限制</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">RLIMIT_NOFILE
</span></span><span class="line"><span class="cl">              This specifies a value one greater than the maximum file
</span></span><span class="line"><span class="cl">              descriptor number that can be opened by this process.
</span></span><span class="line"><span class="cl">              Attempts (open(2), pipe(2), dup(2), etc.)  to exceed this
</span></span><span class="line"><span class="cl">              limit yield the error EMFILE.  (Historically, this limit was
</span></span><span class="line"><span class="cl">              named RLIMIT_OFILE on BSD.)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              Since Linux 4.5, this limit also defines the maximum number of
</span></span><span class="line"><span class="cl">              file descriptors that an unprivileged process (one without the
</span></span><span class="line"><span class="cl">              CAP_SYS_RESOURCE capability) may have &#34;in flight&#34; to other
</span></span><span class="line"><span class="cl">              processes, by being passed across UNIX domain sockets.  This
</span></span><span class="line"><span class="cl">              limit applies to the sendmsg(2) system call.  For further
</span></span><span class="line"><span class="cl">              details, see unix(7).
</span></span></code></pre></div><p>根据定义，nofile 限制进程所能最多打开的文件数量，作用范围进程。</p>
<ol>
<li>设置 ulimit nofile限制soft 100/hard 200，默认启动为root用户</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ docker run -d --ulimit nofile=100:200  cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span></code></pre></div><ol start="2">
<li>进入容器查看， fd soft限制为100个</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # ulimit -a
</span></span><span class="line"><span class="cl">-f: file size (blocks)             unlimited
</span></span><span class="line"><span class="cl">-t: cpu time (seconds)             unlimited
</span></span><span class="line"><span class="cl">-d: data seg size (kb)             unlimited
</span></span><span class="line"><span class="cl">-s: stack size (kb)                8192
</span></span><span class="line"><span class="cl">-c: core file size (blocks)        unlimited
</span></span><span class="line"><span class="cl">-m: resident set size (kb)         unlimited
</span></span><span class="line"><span class="cl">-l: locked memory (kb)             64
</span></span><span class="line"><span class="cl">-p: processes                      unlimited
</span></span><span class="line"><span class="cl">-n: file descriptors               100
</span></span><span class="line"><span class="cl">-v: address space (kb)             unlimited
</span></span><span class="line"><span class="cl">-w: locks                          unlimited
</span></span><span class="line"><span class="cl">-e: scheduling priority            0
</span></span><span class="line"><span class="cl">-r: real-time priority             0
</span></span></code></pre></div><ol start="3">
<li>使用ab测试，并发90个http请求，创建90个socket，正常运行</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/ <span class="c1"># ab -n 1000000 -c 90 http://61.135.169.125:80/ &amp;</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># lsof | wc -l </span>
</span></span><span class="line"><span class="cl"><span class="m">108</span>
</span></span><span class="line"><span class="cl">/ <span class="c1"># lsof | grep -c ab</span>
</span></span><span class="line"><span class="cl"><span class="m">94</span>
</span></span></code></pre></div><ol start="4">
<li>并发100个http请求，受到ulimit限制
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/ <span class="c1">#  ab -n 1000000 -c 100 http://61.135.169.125:80/</span>
</span></span><span class="line"><span class="cl">This is ApacheBench, Version 2.3 &lt;<span class="nv">$Revision</span>: <span class="m">1843412</span> $&gt;
</span></span><span class="line"><span class="cl">Copyright <span class="m">1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span></span><span class="line"><span class="cl">Licensed to The Apache Software Foundation, http://www.apache.org/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Benchmarking 61.135.169.125 <span class="o">(</span>be patient<span class="o">)</span>
</span></span><span class="line"><span class="cl">socket: No file descriptors available <span class="o">(</span>24<span class="o">)</span>
</span></span></code></pre></div></li>
</ol>
<h4 id="线程限制" class="headerLink">
    <a href="#%e7%ba%bf%e7%a8%8b%e9%99%90%e5%88%b6" class="header-mark"></a>线程限制</h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">RLIMIT_NPROC
</span></span><span class="line"><span class="cl">              This is a limit on the number of extant process (or, more pre‐
</span></span><span class="line"><span class="cl">              cisely on Linux, threads) for the real user ID of the calling
</span></span><span class="line"><span class="cl">              process.  So long as the current number of processes belonging
</span></span><span class="line"><span class="cl">              to this process&#39;s real user ID is greater than or equal to
</span></span><span class="line"><span class="cl">              this limit, fork(2) fails with the error EAGAIN.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              The RLIMIT_NPROC limit is not enforced for processes that have
</span></span><span class="line"><span class="cl">              either the CAP_SYS_ADMIN or the CAP_SYS_RESOURCE capability.
</span></span></code></pre></div><p>由定义可知，nproc进程限制的范围是对于每个uid，并且对于root用户无效。</p>
<h5 id="容器uid" class="headerLink">
    <a href="#%e5%ae%b9%e5%99%a8uid" class="header-mark"></a>容器uid</h5><p>同一主机上运行的所有容器共享同一个内核(主机的内核)，docker通过namspace对pid/utc/network等进行了隔离，虽然docker中已经实现了user namespace，但由于各种原因，默认没有开启，见<a href="https://docs.docker.com/engine/security/userns-remap/" target="_blank" rel="noopener noreffer">docker user namespace</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ docker run -d  cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span></code></pre></div><p>宿主机中查看top进程，显示root用户</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ ps -ef |grep top
</span></span><span class="line"><span class="cl">root      4096  4080  0 15:01 ?        00:00:01 top
</span></span></code></pre></div><p>容器中查看id，uid为0对应宿主机的root用户,虽然同为root用户，但Linux Capabilities不同，实际权限与宿主机root要少很多</p>
<p>在容器中切换用户到operator(uid为11)，执行sleep命令，主机中查看对应进程用户为app，对应uid同样为11</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # id
</span></span><span class="line"><span class="cl">uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)
</span></span><span class="line"><span class="cl">/ # su operator
</span></span><span class="line"><span class="cl">/ $ id
</span></span><span class="line"><span class="cl">uid=11(operator) gid=0(root) groups=0(root)
</span></span><span class="line"><span class="cl">/ $ sleep 100
</span></span><span class="line"><span class="cl">$ ps -ef |grep &#39;sleep 100&#39;
</span></span><span class="line"><span class="cl">app      19302 19297  0 16:39 pts/0    00:00:00 sleep 100
</span></span><span class="line"><span class="cl">$ cat /etc/passwd | grep app
</span></span><span class="line"><span class="cl">app❌11:0::/home/app:
</span></span></code></pre></div><h5 id="验证不同用户下ulimit的限制" class="headerLink">
    <a href="#%e9%aa%8c%e8%af%81%e4%b8%8d%e5%90%8c%e7%94%a8%e6%88%b7%e4%b8%8bulimit%e7%9a%84%e9%99%90%e5%88%b6" class="header-mark"></a>验证不同用户下ulimit的限制</h5><p>设置 ulimit nproc限制soft 10/hard 20，默认启动为root用户</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ docker run -d --ulimit nproc=10:20  cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span></code></pre></div><p>进入容器查看， fd soft限制为100个</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # ulimit -a
</span></span><span class="line"><span class="cl">-f: file size (blocks)             unlimited
</span></span><span class="line"><span class="cl">-t: cpu time (seconds)             unlimited
</span></span><span class="line"><span class="cl">-d: data seg size (kb)             unlimited
</span></span><span class="line"><span class="cl">-s: stack size (kb)                8192
</span></span><span class="line"><span class="cl">-c: core file size (blocks)        unlimited
</span></span><span class="line"><span class="cl">-m: resident set size (kb)         unlimited
</span></span><span class="line"><span class="cl">-l: locked memory (kb)             64
</span></span><span class="line"><span class="cl">-p: processes                      10
</span></span><span class="line"><span class="cl">-n: file descriptors               1048576
</span></span><span class="line"><span class="cl">-v: address space (kb)             unlimited
</span></span><span class="line"><span class="cl">-w: locks                          unlimited
</span></span><span class="line"><span class="cl">-e: scheduling priority            0
</span></span><span class="line"><span class="cl">-r: real-time priority             0
</span></span></code></pre></div><p>启动30个进程</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # for i in `seq 30`;do sleep 100 &amp;; done
</span></span><span class="line"><span class="cl">/ # ps | wc -l 
</span></span><span class="line"><span class="cl">36
</span></span></code></pre></div><p>切换到operator用户</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # su operator
</span></span><span class="line"><span class="cl"># 启动多个进程，到第11个进程无法进行fork
</span></span><span class="line"><span class="cl">/ $ for i in `seq 8`; do
</span></span><span class="line"><span class="cl">&gt; sleep 100 &amp;
</span></span><span class="line"><span class="cl">&gt; done
</span></span><span class="line"><span class="cl">/ $ sleep 100 &amp;
</span></span><span class="line"><span class="cl">/ $ sleep 100 &amp;
</span></span><span class="line"><span class="cl">sh: can&#39;t fork: Resource temporarily unavailable
</span></span></code></pre></div><p>root下查看</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # ps -ef | grep operator
</span></span><span class="line"><span class="cl">   79 operator  0:00 sh
</span></span><span class="line"><span class="cl">   99 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  100 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  101 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  102 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  103 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  104 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  105 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  106 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  107 operator  0:00 sleep 100
</span></span><span class="line"><span class="cl">  109 root      0:00 grep operator
</span></span><span class="line"><span class="cl">/ # ps -ef | grep operator| wc -l
</span></span><span class="line"><span class="cl">10
</span></span></code></pre></div><h5 id="验证ulimit在不同容器相同uid下的限制" class="headerLink">
    <a href="#%e9%aa%8c%e8%af%81ulimit%e5%9c%a8%e4%b8%8d%e5%90%8c%e5%ae%b9%e5%99%a8%e7%9b%b8%e5%90%8cuid%e4%b8%8b%e7%9a%84%e9%99%90%e5%88%b6" class="header-mark"></a>验证ulimit在不同容器相同uid下的限制</h5><p>设置 ulimit nproc限制soft 3/hard 3，默认启动为operator用户,起4个容器，第四个启动失败</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ docker run -d --ulimit nproc=3:3 --name nproc1 -u operator  cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span><span class="line"><span class="cl">eeb1551bf757ad4f112c61cc48d7cbe959185f65109e4b44f28085f246043e65
</span></span><span class="line"><span class="cl">$ docker run -d --ulimit nproc=3:3 --name nproc2 -u operator  cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span><span class="line"><span class="cl">42ff29844565a9cb3af2c8dd560308b1f31306041d3dbd929011d65f1848a262
</span></span><span class="line"><span class="cl">$ docker run -d --ulimit nproc=3:3 --name nproc3 -u operator  cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span><span class="line"><span class="cl">b7c9b469e73f969d922841dd77265467959eda28ed06301af8bf83bcf18e8c23
</span></span><span class="line"><span class="cl">$ docker run -d --ulimit nproc=3:3 --name nproc4 -u operator  cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span><span class="line"><span class="cl">b49d8bb58757c88f69903059af2ee7e2a6cc2fa5774bc531941194c52edfd763
</span></span><span class="line"><span class="cl">$
</span></span><span class="line"><span class="cl">$ docker ps -a |grep nproc
</span></span><span class="line"><span class="cl">b49d8bb58757        cr.d.xiaomi.net/containercloud/alpine:webtool      &#34;top&#34;                    16 seconds ago      Exited (1) 15 seconds ago                               nproc4
</span></span><span class="line"><span class="cl">b7c9b469e73f        cr.d.xiaomi.net/containercloud/alpine:webtool      &#34;top&#34;                    23 seconds ago      Up 22 seconds                                           nproc3
</span></span><span class="line"><span class="cl">42ff29844565        cr.d.xiaomi.net/containercloud/alpine:webtool      &#34;top&#34;                    31 seconds ago      Up 29 seconds                                           nproc2
</span></span><span class="line"><span class="cl">eeb1551bf757        cr.d.xiaomi.net/containercloud/alpine:webtool      &#34;top&#34;                    38 seconds ago      Up 36 seconds                                           nproc1
</span></span></code></pre></div><h5 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h5><ul>
<li>ulimit限制fd总数，限制级别进程，可对所有用户生效</li>
<li>ulimit限制线程总数，限制级别用户（uid)，限制同一个uid下所有线程/进程数，对于root账号无效</li>
<li>对于目前线上情况，有较小的概率因ulimit限制导致fork失败，如同一个宿主机中有多个work容器且基础镜像相同（即uid相同），若一个容器线程泄露，由于ulimit限制会影响其他容器正常运行</li>
</ul>
<h3 id="cgroup" class="headerLink">
    <a href="#cgroup" class="header-mark"></a>cgroup</h3><p>cgroup中对pid进行了隔离，通过更改docker/kubelet配置，可以限制pid总数，从而达到限制线程总数的目的。线程数限制与系统中多处配置有关，取最小值，参考<a href="https://stackoverflow.com/questions/34452302/how-to-increase-maximum-number-of-jvm-threads-linux-64bit" target="_blank" rel="noopener noreffer">stackoverflow上线程数的设置</a></p>
<ul>
<li>docker，容器启动时设置 &ndash;pids-limit 参数，限制容器级别pid总数</li>
<li>kubelet，开启SupportPodPidsLimit特性，设置&ndash;pod-max-pids参数，限制node每个pod的pid总数</li>
</ul>
<p>以kubelet为例，开启SupportPodPidsLimit，<code>--feature-gates=SupportPodPidsLimit=true</code></p>
<ol>
<li>配置kubelet，每个pod允许最大pid数目为150</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@node01 ~<span class="o">]</span><span class="c1"># ps -ef |grep kubelet</span>
</span></span><span class="line"><span class="cl">root     <span class="m">18735</span>     <span class="m">1</span> <span class="m">14</span> 11:19 ?        00:53:28 ./kubelet --v<span class="o">=</span><span class="m">1</span> --address<span class="o">=</span>0.0.0.0 --feature-gates<span class="o">=</span><span class="nv">SupportPodPidsLimit</span><span class="o">=</span><span class="nb">true</span> --pod-max-pids<span class="o">=</span><span class="m">150</span> --allow-privileged<span class="o">=</span><span class="nb">true</span> --pod-infra-container-image<span class="o">=</span>cr.d.xiaomi.net/kubernetes/pause-amd64:3.1 --root-dir<span class="o">=</span>/home/kubelet --node-status-update-frequency<span class="o">=</span>5s --kubeconfig<span class="o">=</span>/home/xbox/kubelet/conf/kubelet-kubeconfig --fail-swap-on<span class="o">=</span><span class="nb">false</span> --max-pods<span class="o">=</span><span class="m">254</span> --runtime-cgroups<span class="o">=</span>/systemd/system.slice/frigga.service --kubelet-cgroups<span class="o">=</span>/systemd/system.slice/frigga.service --make-iptables-util-chains<span class="o">=</span><span class="nb">false</span>
</span></span></code></pre></div><ol start="2">
<li>在pod中起测试线程，root下起100个线程</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # for i in `seq 100`; do
</span></span><span class="line"><span class="cl">&gt; sleep 1000 &amp;
</span></span><span class="line"><span class="cl">&gt; done
</span></span><span class="line"><span class="cl">/ # ps | wc -l
</span></span><span class="line"><span class="cl">106
</span></span></code></pre></div><ol start="3">
<li>operator 下，创建线程受到限制，系统最多只能创建150个</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/ # su operator
</span></span><span class="line"><span class="cl">/ $ 
</span></span><span class="line"><span class="cl">/ $ for i in `seq 100`; do
</span></span><span class="line"><span class="cl">&gt; sleep 1000 &amp;
</span></span><span class="line"><span class="cl">&gt; done
</span></span><span class="line"><span class="cl">sh: can&#39;t fork: Resource temporarily unavailable
</span></span><span class="line"><span class="cl">/ $ ps | wc -l
</span></span><span class="line"><span class="cl">150
</span></span></code></pre></div><ol start="4">
<li>在cgroup中查看，pids达到最大限制</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@node01 ~]# cat /sys/fs/cgroup/pids/kubepods/besteffort/pod8b61d4de-a7ad-11e9-b5b9-246e96ad0900/pids.current 
</span></span><span class="line"><span class="cl">150
</span></span><span class="line"><span class="cl">[root@node01 ~]# cat /sys/fs/cgroup/pids/kubepods/besteffort/pod8b61d4de-a7ad-11e9-b5b9-246e96ad0900/pids.max 
</span></span><span class="line"><span class="cl">150
</span></span></code></pre></div><ol start="5">
<li>总结
cgroup对于pid的限制能够达到限制线程数目的，目前docker只支持对每个容器的限制，不支持全局配置；kubelet只支持对于node所有pod的全局配置，不支持具体每个pod的配置</li>
</ol>
<h3 id="limitsconfsysctlconf" class="headerLink">
    <a href="#limitsconfsysctlconf" class="header-mark"></a>limits.conf/sysctl.conf</h3><p>limits.conf是ulimit的具体配置，目录项/etc/security/limit.d/中的配置会覆盖limits.conf。</p>
<p>sysctl.conf为机器级别的资源限制，root用户可修改，目录项/etc/security/sysctl.d/中的配置会覆盖sysctl.conf，在/etc/sysctl.conf中添加对应配置（fd: fs.file-max = {}; pid: kernel.pid_max = {}）</p>
<ol>
<li>
<p>测试容器中修改sysctl.conf文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ docker run -d --ulimit nofile=100:200 cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span><span class="line"><span class="cl">cb1250c8fd217258da51c6818fa2ce2e2f6e35bf1d52648f1f432e6ce579cf0d
</span></span><span class="line"><span class="cl">$ docker exec -it cb1250c sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/ # ulimit -a
</span></span><span class="line"><span class="cl">-f: file size (blocks)             unlimited
</span></span><span class="line"><span class="cl">-t: cpu time (seconds)             unlimited
</span></span><span class="line"><span class="cl">-d: data seg size (kb)             unlimited
</span></span><span class="line"><span class="cl">-s: stack size (kb)                8192
</span></span><span class="line"><span class="cl">-c: core file size (blocks)        unlimited
</span></span><span class="line"><span class="cl">-m: resident set size (kb)         unlimited
</span></span><span class="line"><span class="cl">-l: locked memory (kb)             64
</span></span><span class="line"><span class="cl">-p: processes                      unlimited
</span></span><span class="line"><span class="cl">-n: file descriptors               100
</span></span><span class="line"><span class="cl">-v: address space (kb)             unlimited
</span></span><span class="line"><span class="cl">-w: locks                          unlimited
</span></span><span class="line"><span class="cl">-e: scheduling priority            0
</span></span><span class="line"><span class="cl">-r: real-time priority             0
</span></span><span class="line"><span class="cl">/ # 
</span></span><span class="line"><span class="cl">/ # echo 10 &gt; /proc/sys/kernel/pid_max
</span></span><span class="line"><span class="cl">sh: can&#39;t create /proc/sys/kernel/pid_max: Read-only file system
</span></span><span class="line"><span class="cl">/ # echo 10 &gt; /proc/sys/kernel/pid_max
</span></span><span class="line"><span class="cl">sh: can&#39;t create /proc/sys/kernel/pid_max: Read-only file system
</span></span><span class="line"><span class="cl">/ # echo &#34;fs.file-max=5&#34; &gt;&gt; /etc/sysctl.conf
</span></span><span class="line"><span class="cl">/ # sysctl -p
</span></span><span class="line"><span class="cl">sysctl: error setting key &#39;fs.file-max&#39;: Read-only file system
</span></span></code></pre></div></li>
<li>
<p>以priviledged模式测试，谨慎测试</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ cat /proc/sys/kernel/pid_max
</span></span><span class="line"><span class="cl">32768
</span></span><span class="line"><span class="cl">$ docker run -d -- --ulimit nofile=100:200 cr.d.xiaomi.net/containercloud/alpine:webtool top
</span></span><span class="line"><span class="cl">$ docker exec -it pedantic_vaughan sh
</span></span><span class="line"><span class="cl">/ # cat /proc/sys/kernel/pid_max
</span></span><span class="line"><span class="cl">32768
</span></span><span class="line"><span class="cl">/ # echo 50000 &gt; /proc/sys/kernel/pid_max
</span></span><span class="line"><span class="cl">/ # cat /proc/sys/kernel/pid_max
</span></span><span class="line"><span class="cl">50000
</span></span><span class="line"><span class="cl">/ # exit
</span></span><span class="line"><span class="cl">$ cat /proc/sys/kernel/pid_max
</span></span><span class="line"><span class="cl">50000 # 宿主机的文件也变成50000
</span></span></code></pre></div></li>
<li>
<p>总结
由于docker隔离的不彻底，在docker中修改sysctl会覆盖主机中的配置，不能用来实现容器级别资源限制
limits.conf可以在容器中设置，效果同ulimit</p>
</li>
</ol>
<h2 id="结论" class="headerLink">
    <a href="#%e7%bb%93%e8%ae%ba" class="header-mark"></a>结论</h2><p><img
        class="lazyload"
        data-src="/img/blogImg/pod-fd-limit.png"
        data-srcset="/img/blogImg/pod-fd-limit.png, /img/blogImg/pod-fd-limit.png 1.5x, /img/blogImg/pod-fd-limit.png 2x"
        data-sizes="auto"
        alt="/img/blogImg/pod-fd-limit.png"
        title="pod-fd-limit">

</p>
<p>推荐方案如下：</p>
<ul>
<li>fd限制： 修改dockerd配置<code>default-ulimits</code>，限制进程级别fd</li>
<li>thread限制：修改kubelet配置<code>--feature-gates=SupportPodPidsLimit=true --pod-max-pids={}</code>，cgroup级别限制pid，从而限制线程数</li>
<li>其他注意事项，调整节点pid.max参数；放开或者调大镜像中ulimit对非root账户nproc限制</li>
</ul>
<h2 id="引用" class="headerLink">
    <a href="#%e5%bc%95%e7%94%a8" class="header-mark"></a>引用</h2><ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/run/#set-ulimits-in-container---ulimit" target="_blank" rel="noopener noreffer">https://docs.docker.com/engine/reference/commandline/run/#set-ulimits-in-container---ulimit</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/getrlimit.2.html" target="_blank" rel="noopener noreffer">http://man7.org/linux/man-pages/man2/getrlimit.2.html</a></li>
<li><a href="https://feichashao.com/ulimit_demo/" target="_blank" rel="noopener noreffer">https://feichashao.com/ulimit_demo/</a></li>
<li><a href="https://medium.com/@mccode/understanding-how-uid-and-gid-work-in-docker-containers-c37a01d01cf" target="_blank" rel="noopener noreffer">https://medium.com/@mccode/understanding-how-uid-and-gid-work-in-docker-containers-c37a01d01cf</a></li>
<li><a href="https://docs.docker.com/engine/security/userns-remap/" target="_blank" rel="noopener noreffer">https://docs.docker.com/engine/security/userns-remap/</a></li>
</ul></div>

        
        <div class="post-footer" id="post-footer">
    <div class="post-meta-line"><span class="single-tag">
                <a href='/tags/k8s/'>#k8s</a>
                    <span class="separator"> </span>
                <a href='/tags/docker/'>#docker</a></span></div>

    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-link">
                <a href='/about'>About Me</a>
            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
        </div>
    </div><div class="post-nav"><a href="/container-memory/" class="prev" rel="prev" title="容器内存分析"><i class="fas fa-angle-left fa-fw"></i>容器内存分析</a>
            <a href="/k8s-limit-fd-and-thread2/" class="next" rel="next" title="k8s中fd与thread限制(二)">k8s中fd与thread限制(二)<i class="fas fa-angle-right fa-fw"></i></a></div></div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qingwave.github.io" target="_blank" rel="noopener noreferrer">Qingwave</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-134548083-1', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"maxShownLines":-1},"comment":{"giscus":{"customTheme":"light","darkTheme":"dark","dataCategory":"Announcements","dataCategoryId":"DIC_kwDOCg97r84CBQfL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"qingwave/qingwave.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=","lightTheme":"light"}}};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script></div>
</body>

</html>