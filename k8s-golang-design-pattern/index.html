<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">
        Kubernetes中的Golang设计模式
        
    </title><meta name="Description" content="Coding, Reading and Daydreaming"><meta property="og:title" content="Kubernetes中的Golang设计模式" />
<meta property="og:description" content="随着Kubernetes成为容器编排领域的事实标准，Golang在云原生方面应用的也越来越多。今天我们跟随K8s的脚步，学习下在K8s中使用哪些经典的设计模式。 创建型模式创建型模式顾名思义提供了对象的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://qingwave.github.io/k8s-golang-design-pattern/" /><meta property="og:image" content="https://qingwave.github.io/img/favicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-14T07:18:45+00:00" />
<meta property="article:modified_time" content="2022-04-18T03:22:42+00:00" /><meta property="og:site_name" content="Qingwave" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://qingwave.github.io/img/favicon.png"/>

<meta name="twitter:title" content="Kubernetes中的Golang设计模式"/>
<meta name="twitter:description" content="随着Kubernetes成为容器编排领域的事实标准，Golang在云原生方面应用的也越来越多。今天我们跟随K8s的脚步，学习下在K8s中使用哪些经典的设计模式。 创建型模式创建型模式顾名思义提供了对象的"/>
<meta name="application-name" content="Qingwave">
<meta name="apple-mobile-web-app-title" content="Qingwave">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://qingwave.github.io/k8s-golang-design-pattern/" /><link rel="prev" href="https://qingwave.github.io/how-to-write-k8s-cni/" /><link rel="next" href="https://qingwave.github.io/openpolicyagent-vs-casbin/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><meta name="google-site-verification" content="-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI" /><meta name="baidu-site-verification" content="muFp3xopwC" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kubernetes中的Golang设计模式",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qingwave.github.io\/k8s-golang-design-pattern\/"
        },"genre": "posts","keywords": "golang, k8s","wordcount":  4114 ,
        "url": "https:\/\/qingwave.github.io\/k8s-golang-design-pattern\/","datePublished": "2022-04-14T07:18:45+00:00","dateModified": "2022-04-18T03:22:42+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Qingwave"
            },"description": ""
    }
    </script></head>

<body header-desktop="normal" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('light' === 'light' || 'light' === 'dark') setTheme('light'), saveTheme('light'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span><span class="header-title-post"> Time</span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Qingwave">Qingwave<span class="header-title-inner">'</span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/about/" title="About">About</a><a class="menu-item" href="/tags/" title="Tags">Tags</a><a class="menu-item" href="/categories/" title="Categories">Categories</a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#创建型模式">创建型模式</a>
      <ul>
        <li><a href="#单例模式">单例模式</a></li>
        <li><a href="#工厂模式">工厂模式</a></li>
        <li><a href="#建造者模式">建造者模式</a></li>
        <li><a href="#原型模式">原型模式</a></li>
      </ul>
    </li>
    <li><a href="#结构型模式">结构型模式</a>
      <ul>
        <li><a href="#适配器模式">适配器模式</a></li>
        <li><a href="#桥接模式">桥接模式</a></li>
        <li><a href="#组合模式">组合模式</a></li>
        <li><a href="#代理模式">代理模式</a></li>
        <li><a href="#外观模式">外观模式</a></li>
        <li><a href="#装饰模式">装饰模式</a></li>
        <li><a href="#享元模式">享元模式</a></li>
      </ul>
    </li>
    <li><a href="#行为型模式">行为型模式</a>
      <ul>
        <li><a href="#观察者模式">观察者模式</a></li>
        <li><a href="#命令模式">命令模式</a></li>
        <li><a href="#迭代器模式">迭代器模式</a></li>
        <li><a href="#策略模式">策略模式</a></li>
        <li><a href="#状态模式">状态模式</a></li>
        <li><a href="#备忘录模式">备忘录模式</a></li>
        <li><a href="#职责链模式">职责链模式</a></li>
        <li><a href="#访问者模式">访问者模式</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title">Kubernetes中的Golang设计模式</h1><div class="post-meta">
            <div class="post-meta-line"><time datetime="Apr 14, 2022">Apr 14, 2022</time>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#创建型模式">创建型模式</a>
      <ul>
        <li><a href="#单例模式">单例模式</a></li>
        <li><a href="#工厂模式">工厂模式</a></li>
        <li><a href="#建造者模式">建造者模式</a></li>
        <li><a href="#原型模式">原型模式</a></li>
      </ul>
    </li>
    <li><a href="#结构型模式">结构型模式</a>
      <ul>
        <li><a href="#适配器模式">适配器模式</a></li>
        <li><a href="#桥接模式">桥接模式</a></li>
        <li><a href="#组合模式">组合模式</a></li>
        <li><a href="#代理模式">代理模式</a></li>
        <li><a href="#外观模式">外观模式</a></li>
        <li><a href="#装饰模式">装饰模式</a></li>
        <li><a href="#享元模式">享元模式</a></li>
      </ul>
    </li>
    <li><a href="#行为型模式">行为型模式</a>
      <ul>
        <li><a href="#观察者模式">观察者模式</a></li>
        <li><a href="#命令模式">命令模式</a></li>
        <li><a href="#迭代器模式">迭代器模式</a></li>
        <li><a href="#策略模式">策略模式</a></li>
        <li><a href="#状态模式">状态模式</a></li>
        <li><a href="#备忘录模式">备忘录模式</a></li>
        <li><a href="#职责链模式">职责链模式</a></li>
        <li><a href="#访问者模式">访问者模式</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#引用">引用</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>随着Kubernetes成为容器编排领域的事实标准，Golang在云原生方面应用的也越来越多。今天我们跟随K8s的脚步，学习下在K8s中使用哪些经典的设计模式。</p>
<h2 id="创建型模式" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba%e5%9e%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>创建型模式</h2><p>创建型模式顾名思义提供了对象的创建机制，封装了内部的复杂性，提高代码复用和灵活性。包括：</p>
<ul>
<li>单例模式</li>
<li>工厂模式</li>
<li>建造者模式</li>
<li>原型模式</li>
</ul>
<h3 id="单例模式" class="headerLink">
    <a href="#%e5%8d%95%e4%be%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>单例模式</h3><p>单例模式用来保证一个类只有一个实例，并提供调用它的一个全局访问点。单例模式是设计模式中最简单，使用最广的一个，通常用来创建一个共享的实例，比如数据库连接池、线程池等。</p>
<p>单例模式分为懒汉式（使用时创建，延迟调用）与饿汉式（初始化时创建），通常我们使用<code>once.Do</code>来实现懒汉式，保证其线程安全。</p>
<p>在<code>kubeadm</code>中使用了单例模式来创建用户与用户组
<a href="https://github.com/kubernetes/kubernetes/tree/master/cmd/kubeadm/app/util/staticpod/utils.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/tree/master/cmd/kubeadm/app/util/staticpod/utils.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">usersAndGroups</span>     <span class="o">*</span><span class="nx">users</span><span class="p">.</span><span class="nx">UsersAndGroups</span>
</span></span><span class="line"><span class="cl">	<span class="nx">usersAndGroupsOnce</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetUsersAndGroups</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">users</span><span class="p">.</span><span class="nx">UsersAndGroups</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nx">usersAndGroupsOnce</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">usersAndGroups</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">users</span><span class="p">.</span><span class="nf">AddUsersAndGroups</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">usersAndGroups</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="工厂模式" class="headerLink">
    <a href="#%e5%b7%a5%e5%8e%82%e6%a8%a1%e5%bc%8f" class="header-mark"></a>工厂模式</h3><p>工厂模式通过一个工厂方法来创建不同的产品，又分为简单工厂、工厂方法、抽象工厂，一般用来创建一类相似的产品，方便扩展。</p>
<p>简单工厂根据不同的输入创建不同的产品，在Golang中采用<code>Newxxx</code>的方式实现。</p>
<p>在<code>kubelet</code>中通过输入同创建不同的认证类型
<a href="https://github.com/kubernetes/kubernetes/tree/master/cmd/kubelet/app/auth.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/tree/master/cmd/kubelet/app/auth.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">BuildAuthz</span><span class="p">(</span><span class="nx">client</span> <span class="nx">authorizationclient</span><span class="p">.</span><span class="nx">AuthorizationV1Interface</span><span class="p">,</span> <span class="nx">authz</span> <span class="nx">kubeletconfig</span><span class="p">.</span><span class="nx">KubeletAuthorization</span><span class="p">)</span> <span class="p">(</span><span class="nx">authorizer</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">authz</span><span class="p">.</span><span class="nx">Mode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">kubeletconfig</span><span class="p">.</span><span class="nx">KubeletAuthorizationModeAlwaysAllow</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">authorizerfactory</span><span class="p">.</span><span class="nf">NewAlwaysAllowAuthorizer</span><span class="p">(),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">kubeletconfig</span><span class="p">.</span><span class="nx">KubeletAuthorizationModeWebhook</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">client</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;no client provided, cannot use webhook authorization&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">authorizerConfig</span> <span class="o">:=</span> <span class="nx">authorizerfactory</span><span class="p">.</span><span class="nx">DelegatingAuthorizerConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">SubjectAccessReviewClient</span><span class="p">:</span> <span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">AllowCacheTTL</span><span class="p">:</span>             <span class="nx">authz</span><span class="p">.</span><span class="nx">Webhook</span><span class="p">.</span><span class="nx">CacheAuthorizedTTL</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">DenyCacheTTL</span><span class="p">:</span>              <span class="nx">authz</span><span class="p">.</span><span class="nx">Webhook</span><span class="p">.</span><span class="nx">CacheUnauthorizedTTL</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">WebhookRetryBackoff</span><span class="p">:</span>       <span class="nx">genericoptions</span><span class="p">.</span><span class="nf">DefaultAuthWebhookRetryBackoff</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">authorizerConfig</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="s">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no authorization mode specified&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unknown authorization mode %s&#34;</span><span class="p">,</span> <span class="nx">authz</span><span class="p">.</span><span class="nx">Mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>以及https://github.com/kubernetes/client-go/blob/master/tools/cache/store.go</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewStore</span><span class="p">(</span><span class="nx">keyFunc</span> <span class="nx">KeyFunc</span><span class="p">)</span> <span class="nx">Store</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">cache</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cacheStorage</span><span class="p">:</span> <span class="nf">NewThreadSafeStore</span><span class="p">(</span><span class="nx">Indexers</span><span class="p">{},</span> <span class="nx">Indices</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">keyFunc</span><span class="p">:</span>      <span class="nx">keyFunc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">cache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// cacheStorage bears the burden of thread safety for the cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cacheStorage</span> <span class="nx">ThreadSafeStore</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// keyFunc is used to make the key for objects stored in and retrieved from items, and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// should be deterministic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">keyFunc</span> <span class="nx">KeyFunc</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Store</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Add</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Update</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Delete</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">List</span><span class="p">()</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ListKeys</span><span class="p">()</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Get</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// GetByKey returns the accumulator associated with the given key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetByKey</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Replace</span><span class="p">([]</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Resync</span><span class="p">()</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>抽象工厂用来构建复杂的一组产品，在informer的实现中使用了抽象工厂
<a href="https://github.com/kubernetes/client-go/blob/master/informers/factory.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/client-go/blob/master/informers/factory.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// NewSharedInformerFactoryWithOptions constructs a new instance of a SharedInformerFactory with additional options.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSharedInformerFactoryWithOptions</span><span class="p">(</span><span class="nx">client</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">defaultResync</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="nx">SharedInformerOption</span><span class="p">)</span> <span class="nx">SharedInformerFactory</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">factory</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sharedInformerFactory</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">:</span>           <span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">namespace</span><span class="p">:</span>        <span class="nx">v1</span><span class="p">.</span><span class="nx">NamespaceAll</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">defaultResync</span><span class="p">:</span>    <span class="nx">defaultResync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">informers</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span><span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">startedInformers</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span><span class="kt">bool</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">customResync</span><span class="p">:</span>     <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Apply all options
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">factory</span> <span class="p">=</span> <span class="nf">opt</span><span class="p">(</span><span class="nx">factory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">factory</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SharedInformerFactory provides shared informers for resources in all known
</span></span></span><span class="line"><span class="cl"><span class="c1">// API group versions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">SharedInformerFactory</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">internalinterfaces</span><span class="p">.</span><span class="nx">SharedInformerFactory</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ForResource</span><span class="p">(</span><span class="nx">resource</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionResource</span><span class="p">)</span> <span class="p">(</span><span class="nx">GenericInformer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">WaitForCacheSync</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kd">map</span><span class="p">[</span><span class="nx">reflect</span><span class="p">.</span><span class="nx">Type</span><span class="p">]</span><span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Admissionregistration</span><span class="p">()</span> <span class="nx">admissionregistration</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Internal</span><span class="p">()</span> <span class="nx">apiserverinternal</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Apps</span><span class="p">()</span> <span class="nx">apps</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Autoscaling</span><span class="p">()</span> <span class="nx">autoscaling</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Batch</span><span class="p">()</span> <span class="nx">batch</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Certificates</span><span class="p">()</span> <span class="nx">certificates</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Coordination</span><span class="p">()</span> <span class="nx">coordination</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Core</span><span class="p">()</span> <span class="nx">core</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Discovery</span><span class="p">()</span> <span class="nx">discovery</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Events</span><span class="p">()</span> <span class="nx">events</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Extensions</span><span class="p">()</span> <span class="nx">extensions</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Flowcontrol</span><span class="p">()</span> <span class="nx">flowcontrol</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Networking</span><span class="p">()</span> <span class="nx">networking</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Node</span><span class="p">()</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Policy</span><span class="p">()</span> <span class="nx">policy</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Rbac</span><span class="p">()</span> <span class="nx">rbac</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Scheduling</span><span class="p">()</span> <span class="nx">scheduling</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Storage</span><span class="p">()</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">sharedInformerFactory</span><span class="p">)</span> <span class="nf">Apps</span><span class="p">()</span> <span class="nx">apps</span><span class="p">.</span><span class="nx">Interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">apps</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">tweakListOptions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="建造者模式" class="headerLink">
    <a href="#%e5%bb%ba%e9%80%a0%e8%80%85%e6%a8%a1%e5%bc%8f" class="header-mark"></a>建造者模式</h3><p>建造者模式通过逐步构建复杂的对象，降低创建对象的复杂度。通常多个步骤返回中间对象，最后通过<code>Build</code>完成检验与构建工作。</p>
<p>在<code>controller-runtime</code>中使用了建造者模式来创建controller
<a href="https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/builder" target="_blank" rel="noopener noreffer">https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/builder</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// Builder builds a Controller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Builder</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">forInput</span>         <span class="nx">ForInput</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ownsInput</span>        <span class="p">[]</span><span class="nx">OwnsInput</span>
</span></span><span class="line"><span class="cl">	<span class="nx">watchesInput</span>     <span class="p">[]</span><span class="nx">WatchesInput</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mgr</span>              <span class="nx">manager</span><span class="p">.</span><span class="nx">Manager</span>
</span></span><span class="line"><span class="cl">	<span class="nx">globalPredicates</span> <span class="p">[]</span><span class="nx">predicate</span><span class="p">.</span><span class="nx">Predicate</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctrl</span>             <span class="nx">controller</span><span class="p">.</span><span class="nx">Controller</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctrlOptions</span>      <span class="nx">controller</span><span class="p">.</span><span class="nx">Options</span>
</span></span><span class="line"><span class="cl">	<span class="nx">name</span>             <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">For</span><span class="p">(</span><span class="nx">object</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Object</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">ForOption</span><span class="p">)</span> <span class="o">*</span><span class="nx">Builder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">object</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;For(...) should only be called once, could not assign multiple objects for reconciliation&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">blder</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">ForInput</span><span class="p">{</span><span class="nx">object</span><span class="p">:</span> <span class="nx">object</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opt</span><span class="p">.</span><span class="nf">ApplyToFor</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span> <span class="p">=</span> <span class="nx">input</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">blder</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Watches exposes the lower-level ControllerManagedBy Watches functions through the builder.  Consider using
</span></span></span><span class="line"><span class="cl"><span class="c1">// Owns or For instead of Watches directly.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Specified predicates are registered only for given source.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">Watches</span><span class="p">(</span><span class="nx">src</span> <span class="nx">source</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span> <span class="nx">eventhandler</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">EventHandler</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">WatchesOption</span><span class="p">)</span> <span class="o">*</span><span class="nx">Builder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">WatchesInput</span><span class="p">{</span><span class="nx">src</span><span class="p">:</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">eventhandler</span><span class="p">:</span> <span class="nx">eventhandler</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opt</span><span class="p">.</span><span class="nf">ApplyToWatches</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">blder</span><span class="p">.</span><span class="nx">watchesInput</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">blder</span><span class="p">.</span><span class="nx">watchesInput</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">blder</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// WithOptions overrides the controller options use in doController. Defaults to empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">WithOptions</span><span class="p">(</span><span class="nx">options</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span> <span class="o">*</span><span class="nx">Builder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">blder</span><span class="p">.</span><span class="nx">ctrlOptions</span> <span class="p">=</span> <span class="nx">options</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">blder</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// WithLogger overrides the controller options&#39;s logger used.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">WithLogger</span><span class="p">(</span><span class="nx">log</span> <span class="nx">logr</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="o">*</span><span class="nx">Builder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">blder</span><span class="p">.</span><span class="nx">ctrlOptions</span><span class="p">.</span><span class="nx">Log</span> <span class="p">=</span> <span class="nx">log</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">blder</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Build builds the Application Controller and returns the Controller it created.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">blder</span> <span class="o">*</span><span class="nx">Builder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">r</span> <span class="nx">reconcile</span><span class="p">.</span><span class="nx">Reconciler</span><span class="p">)</span> <span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">Controller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must provide a non-nil Reconciler&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">mgr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must provide a non-nil Manager&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Checking the reconcile type exist or not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">forInput</span><span class="p">.</span><span class="nx">object</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;must provide an object for reconciliation&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Set the ControllerManagedBy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">doController</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Set the Watch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">blder</span><span class="p">.</span><span class="nf">doWatch</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">blder</span><span class="p">.</span><span class="nx">ctrl</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="原型模式" class="headerLink">
    <a href="#%e5%8e%9f%e5%9e%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>原型模式</h3><p>原型模式用来解决对象复制问题，通过<code>Clone</code>方法，返回对象的复制品。将实现细节与使用解耦。</p>
<p>在k8s中所有资源都需要使用<code>DeepCopy</code>接口即原型模式
<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/zz_generated.deepcopy.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/zz_generated.deepcopy.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">Pod</span><span class="p">)</span> <span class="nf">DeepCopyInto</span><span class="p">(</span><span class="nx">out</span> <span class="o">*</span><span class="nx">Pod</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="nx">out</span> <span class="p">=</span> <span class="o">*</span><span class="nx">in</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="p">=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">TypeMeta</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nf">DeepCopyInto</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">out</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nf">DeepCopyInto</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">out</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nf">DeepCopyInto</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">out</span><span class="p">.</span><span class="nx">Status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new Pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">in</span> <span class="o">*</span><span class="nx">Pod</span><span class="p">)</span> <span class="nf">DeepCopy</span><span class="p">()</span> <span class="o">*</span><span class="nx">Pod</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">in</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Pod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span><span class="p">.</span><span class="nf">DeepCopyInto</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="结构型模式" class="headerLink">
    <a href="#%e7%bb%93%e6%9e%84%e5%9e%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>结构型模式</h2><p>结构型模式通过将对象组合成更大的结构，从而提供系统的灵活性。包括：</p>
<ul>
<li>适配器模式</li>
<li>桥接模式</li>
<li>组合模式</li>
<li>代理模式</li>
<li>外观模式</li>
<li>装饰模式</li>
<li>享元模式</li>
</ul>
<h3 id="适配器模式" class="headerLink">
    <a href="#%e9%80%82%e9%85%8d%e5%99%a8%e6%a8%a1%e5%bc%8f" class="header-mark"></a>适配器模式</h3><p>通过适配器模式能使不兼容的对象相互协作，通常做一些兼容性工作（老版本、外部服务）时会使用到。</p>
<p>k8s中有很多适配器的例子, 通过<code>Adapter</code>去包裹其他对象转换成统一的接口
<a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replication/conversion.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replication/conversion.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// informerAdapter implements ReplicaSetInformer by wrapping ReplicationControllerInformer
</span></span></span><span class="line"><span class="cl"><span class="c1">// and converting objects.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">informerAdapter</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rcInformer</span> <span class="nx">coreinformers</span><span class="p">.</span><span class="nx">ReplicationControllerInformer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">i</span> <span class="nx">informerAdapter</span><span class="p">)</span> <span class="nf">Informer</span><span class="p">()</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">conversionInformer</span><span class="p">{</span><span class="nx">i</span><span class="p">.</span><span class="nx">rcInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">i</span> <span class="nx">informerAdapter</span><span class="p">)</span> <span class="nf">Lister</span><span class="p">()</span> <span class="nx">appslisters</span><span class="p">.</span><span class="nx">ReplicaSetLister</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">conversionLister</span><span class="p">{</span><span class="nx">i</span><span class="p">.</span><span class="nx">rcInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/kubernetes/client-go/blob/master/tools/events/event_broadcaster.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/client-go/blob/master/tools/events/event_broadcaster.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">eventBroadcasterAdapterImpl</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">coreClient</span>          <span class="nx">typedv1core</span><span class="p">.</span><span class="nx">EventsGetter</span>
</span></span><span class="line"><span class="cl">	<span class="nx">coreBroadcaster</span>     <span class="nx">record</span><span class="p">.</span><span class="nx">EventBroadcaster</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eventsv1Client</span>      <span class="nx">typedeventsv1</span><span class="p">.</span><span class="nx">EventsV1Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eventsv1Broadcaster</span> <span class="nx">EventBroadcaster</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NewEventBroadcasterAdapter creates a wrapper around new and legacy broadcasters to simplify
</span></span></span><span class="line"><span class="cl"><span class="c1">// migration of individual components to the new Event API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewEventBroadcasterAdapter</span><span class="p">(</span><span class="nx">client</span> <span class="nx">clientset</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="nx">EventBroadcasterAdapter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eventClient</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">eventBroadcasterAdapterImpl</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Discovery</span><span class="p">().</span><span class="nf">ServerResourcesForGroupVersion</span><span class="p">(</span><span class="nx">eventsv1</span><span class="p">.</span><span class="nx">SchemeGroupVersion</span><span class="p">.</span><span class="nf">String</span><span class="p">());</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">eventClient</span><span class="p">.</span><span class="nx">eventsv1Client</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">EventsV1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">eventClient</span><span class="p">.</span><span class="nx">eventsv1Broadcaster</span> <span class="p">=</span> <span class="nf">NewBroadcaster</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">EventSinkImpl</span><span class="p">{</span><span class="nx">Interface</span><span class="p">:</span> <span class="nx">eventClient</span><span class="p">.</span><span class="nx">eventsv1Client</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Even though there can soon exist cases when coreBroadcaster won&#39;t really be needed,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// we create it unconditionally because its overhead is minor and will simplify using usage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// patterns of this library in all components.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">eventClient</span><span class="p">.</span><span class="nx">coreClient</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">eventClient</span><span class="p">.</span><span class="nx">coreBroadcaster</span> <span class="p">=</span> <span class="nx">record</span><span class="p">.</span><span class="nf">NewBroadcaster</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">eventClient</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// StartRecordingToSink starts sending events received from the specified eventBroadcaster to the given sink.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">eventBroadcasterAdapterImpl</span><span class="p">)</span> <span class="nf">StartRecordingToSink</span><span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">eventsv1Broadcaster</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">eventsv1Client</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">e</span><span class="p">.</span><span class="nx">eventsv1Broadcaster</span><span class="p">.</span><span class="nf">StartRecordingToSink</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">coreBroadcaster</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">coreClient</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">e</span><span class="p">.</span><span class="nx">coreBroadcaster</span><span class="p">.</span><span class="nf">StartRecordingToSink</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">typedv1core</span><span class="p">.</span><span class="nx">EventSinkImpl</span><span class="p">{</span><span class="nx">Interface</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">coreClient</span><span class="p">.</span><span class="nf">Events</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">eventBroadcasterAdapterImpl</span><span class="p">)</span> <span class="nf">NewRecorder</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">EventRecorder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">eventsv1Broadcaster</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">eventsv1Client</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">eventsv1Broadcaster</span><span class="p">.</span><span class="nf">NewRecorder</span><span class="p">(</span><span class="nx">scheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">record</span><span class="p">.</span><span class="nf">NewEventRecorderAdapter</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nf">DeprecatedNewLegacyRecorder</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="桥接模式" class="headerLink">
    <a href="#%e6%a1%a5%e6%8e%a5%e6%a8%a1%e5%bc%8f" class="header-mark"></a>桥接模式</h3><p>桥接模式将实现与抽象解耦，可提供系统的系统的灵活性与可扩展性。</p>
<p>在k8s中大量使用，如<code>DiscoveryClient</code>的实现
<a href="https://github.com/kubernetes/client-go/blob/master/discovery/discovery_client.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/client-go/blob/master/discovery/discovery_client.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">DiscoveryClient</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">restClient</span> <span class="nx">restclient</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">LegacyPrefix</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">DiscoveryInterface</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">RESTClient</span><span class="p">()</span> <span class="nx">restclient</span><span class="p">.</span><span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ServerGroupsInterface</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ServerResourcesInterface</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ServerVersionInterface</span>
</span></span><span class="line"><span class="cl">	<span class="nx">OpenAPISchemaInterface</span>
</span></span><span class="line"><span class="cl">	<span class="nx">OpenAPIV3SchemaInterface</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NewDiscoveryClient returns a new DiscoveryClient for the given RESTClient.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewDiscoveryClient</span><span class="p">(</span><span class="nx">c</span> <span class="nx">restclient</span><span class="p">.</span><span class="nx">Interface</span><span class="p">)</span> <span class="o">*</span><span class="nx">DiscoveryClient</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">DiscoveryClient</span><span class="p">{</span><span class="nx">restClient</span><span class="p">:</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">LegacyPrefix</span><span class="p">:</span> <span class="s">&#34;/api&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// RESTClient returns a RESTClient that is used to communicate
</span></span></span><span class="line"><span class="cl"><span class="c1">// with API server by this client implementation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">DiscoveryClient</span><span class="p">)</span> <span class="nf">RESTClient</span><span class="p">()</span> <span class="nx">restclient</span><span class="p">.</span><span class="nx">Interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">d</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">restClient</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="组合模式" class="headerLink">
    <a href="#%e7%bb%84%e5%90%88%e6%a8%a1%e5%bc%8f" class="header-mark"></a>组合模式</h3><p>组合模式通过组合小对象形成更大的结构，并且具有相同的接口。和Golang中的组合非常相似，使用也非常广泛。</p>
<p><a href="https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/cache/cache.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/cache/cache.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// Cache knows how to load Kubernetes objects, fetch informers to request
</span></span></span><span class="line"><span class="cl"><span class="c1">// to receive events for Kubernetes objects (at a low-level),
</span></span></span><span class="line"><span class="cl"><span class="c1">// and add indices to fields on the objects stored in the cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Cache</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Cache acts as a client to objects stored in the cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">client</span><span class="p">.</span><span class="nx">Reader</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Cache loads informers and adds field indices.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Informers</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Informers</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetInformer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">obj</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">(</span><span class="nx">Informer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">GetInformerForKind</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">gvk</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersionKind</span><span class="p">)</span> <span class="p">(</span><span class="nx">Informer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">WaitForCacheSync</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">.</span><span class="nx">FieldIndexer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="代理模式" class="headerLink">
    <a href="#%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" class="header-mark"></a>代理模式</h3><p>代理模式通过代理来替代真实服务，通常代理类与真实类具有相同的接口，在代理类中可以做一些额外操作（访问控制、缓存等）</p>
<p>在k8s中通过代理来实现访问Node、Pod、Service。</p>
<h3 id="外观模式" class="headerLink">
    <a href="#%e5%a4%96%e8%a7%82%e6%a8%a1%e5%bc%8f" class="header-mark"></a>外观模式</h3><p>外观模式通过一个高度抽象的接口，使子系统更加容器使用，使用也很广泛</p>
<p>比如<code>controller-runtime</code>中创建时<code>controllerManager</code>时调用了很多子系统，使用时只需通过<code>GetClient()</code>便可得到<code>Client</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// New returns a new Manager for creating Controllers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">config</span> <span class="o">*</span><span class="nx">rest</span><span class="p">.</span><span class="nx">Config</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="nx">Manager</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Set default values for options fields
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">options</span> <span class="p">=</span> <span class="nf">setOptionsDefaults</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cluster</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cluster</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">clusterOptions</span> <span class="o">*</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">Scheme</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Scheme</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">MapperProvider</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">MapperProvider</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">Logger</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">SyncPeriod</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">SyncPeriod</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">Namespace</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Namespace</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">NewCache</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">NewCache</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">NewClient</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">NewClient</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">ClientDisableCacheFor</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ClientDisableCacheFor</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">DryRunClient</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">DryRunClient</span>
</span></span><span class="line"><span class="cl">		<span class="nx">clusterOptions</span><span class="p">.</span><span class="nx">EventBroadcaster</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">EventBroadcaster</span> <span class="c1">//nolint:staticcheck
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">controllerManager</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cluster</span><span class="p">:</span>                       <span class="nx">cluster</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">cluster</span><span class="p">)</span> <span class="nf">GetClient</span><span class="p">()</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Client</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="装饰模式" class="headerLink">
    <a href="#%e8%a3%85%e9%a5%b0%e6%a8%a1%e5%bc%8f" class="header-mark"></a>装饰模式</h3><p>装饰模式通过原有对象多次包装从而添加新功能，典型的一些Http中间件实现（日志、认证）</p>
<p><code>admission</code>中装饰器的使用
<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/decorator.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/decorator.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Decorator</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">Decorate</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">Interface</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Interface</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">DecoratorFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">Interface</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Interface</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="nx">DecoratorFunc</span><span class="p">)</span> <span class="nf">Decorate</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">Interface</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">d</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Decorators</span> <span class="p">[]</span><span class="nx">Decorator</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Decorate applies the decorator in inside-out order, i.e. the first decorator in the slice is first applied to the given handler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="nx">Decorators</span><span class="p">)</span> <span class="nf">Decorate</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">Interface</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">Interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="nx">handler</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">d</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">result</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Decorate</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="享元模式" class="headerLink">
    <a href="#%e4%ba%ab%e5%85%83%e6%a8%a1%e5%bc%8f" class="header-mark"></a>享元模式</h3><p>享元模式通过共享多个对象共有的子对象，从而节省内存。如连接池、对象池的实现等，在Golang中通过<code>sync.Pool</code>可实现对象复用即享元模式。</p>
<p>在<code>apiserver/endpoints</code>中通过共享gzip对象，减少内存分配以及gc时间</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">gzipPool</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">New</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gw</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewWriterLevel</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">defaultGzipContentEncodingLevel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">gw</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">deferredResponseWriter</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">hw</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">hw</span>
</span></span><span class="line"><span class="cl">	<span class="nx">header</span> <span class="o">:=</span> <span class="nx">hw</span><span class="p">.</span><span class="nf">Header</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">w</span><span class="p">.</span><span class="nx">contentEncoding</span> <span class="o">==</span> <span class="s">&#34;gzip&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">defaultGzipThresholdBytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">header</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Vary&#34;</span><span class="p">,</span> <span class="s">&#34;Accept-Encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">gw</span> <span class="o">:=</span> <span class="nx">gzipPool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gw</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">hw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nx">w</span> <span class="p">=</span> <span class="nx">gw</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nx">w</span> <span class="p">=</span> <span class="nx">hw</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hw</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">deferredResponseWriter</span><span class="p">)</span> <span class="nf">Close</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nx">hasWritten</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">t</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">w</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gzipPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="行为型模式" class="headerLink">
    <a href="#%e8%a1%8c%e4%b8%ba%e5%9e%8b%e6%a8%a1%e5%bc%8f" class="header-mark"></a>行为型模式</h2><p>行为型模式负责对象间的通信和职责委派，常用的包括：</p>
<ul>
<li>观察者模式</li>
<li>中介者模式</li>
<li>命令模式</li>
<li>迭代器模式</li>
<li>策略模式</li>
<li>状态模式</li>
<li>备忘录模式</li>
<li>职责链模式</li>
<li>访问者模式</li>
<li>解释器模式</li>
</ul>
<h3 id="观察者模式" class="headerLink">
    <a href="#%e8%a7%82%e5%af%9f%e8%80%85%e6%a8%a1%e5%bc%8f" class="header-mark"></a>观察者模式</h3><p>观察者模式允许观察者订阅事件，当事件触发时会通知观察对象。</p>
<p>在<code>shardInformer</code>订阅事件时使用了观察者模式
<a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/shared_informer.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/client-go/blob/master/tools/cache/shared_informer.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span> <span class="nf">AddEventHandlerWithResyncPeriod</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">ResourceEventHandler</span><span class="p">,</span> <span class="nx">resyncPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">addListener</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">indexer</span><span class="p">.</span><span class="nf">List</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">listener</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">addNotification</span><span class="p">{</span><span class="nx">newObj</span><span class="p">:</span> <span class="nx">item</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 事件触发时通知所有对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sharedIndexInformer</span><span class="p">)</span> <span class="nf">OnAdd</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Invocation of this function is locked under s.blockDeltas, so it is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// save to distribute the notification
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">cacheMutationDetector</span><span class="p">.</span><span class="nf">AddObject</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">processor</span><span class="p">.</span><span class="nf">distribute</span><span class="p">(</span><span class="nx">addNotification</span><span class="p">{</span><span class="nx">newObj</span><span class="p">:</span> <span class="nx">obj</span><span class="p">},</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">sharedProcessor</span><span class="p">)</span> <span class="nf">distribute</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">sync</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listenersLock</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">sync</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">listener</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">syncingListeners</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">listener</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">listener</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">listeners</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">listener</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="命令模式" class="headerLink">
    <a href="#%e5%91%bd%e4%bb%a4%e6%a8%a1%e5%bc%8f" class="header-mark"></a>命令模式</h3><p>命令模式通过将请求封装为对象，方便存储调用。</p>
<p>在k8s中所有组件启动都是通过<code>github.com/spf13/cobra</code>工具包
<a href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/apiserver.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/apiserver.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">command</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">NewAPIServerCommand</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">code</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="迭代器模式" class="headerLink">
    <a href="#%e8%bf%ad%e4%bb%a3%e5%99%a8%e6%a8%a1%e5%bc%8f" class="header-mark"></a>迭代器模式</h3><p>迭代器允许顺序遍历复杂的数据结构而不暴露其内部细节。通常通过<code>Next</code>方法来迭代下一个对象。</p>
<p>k8s在对象序列化时使用了迭代器。</p>
<h3 id="策略模式" class="headerLink">
    <a href="#%e7%ad%96%e7%95%a5%e6%a8%a1%e5%bc%8f" class="header-mark"></a>策略模式</h3><p>策略模式通过定义一系列算法，允许运行时可替换算法，从而实现算法分离。</p>
<p>策略模式与桥接模式非常像，只是桥接模式的抽象程度更高一点。
<a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/admissionregistration/mutatingwebhookconfiguration/storage/storage.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/admissionregistration/mutatingwebhookconfiguration/storage/storage.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// NewREST returns a RESTStorage object that will work against mutatingWebhookConfiguration.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewREST</span><span class="p">(</span><span class="nx">optsGetter</span> <span class="nx">generic</span><span class="p">.</span><span class="nx">RESTOptionsGetter</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">REST</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">store</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">genericregistry</span><span class="p">.</span><span class="nx">Store</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">NewFunc</span><span class="p">:</span>     <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">admissionregistration</span><span class="p">.</span><span class="nx">MutatingWebhookConfiguration</span><span class="p">{}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">NewListFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="nx">admissionregistration</span><span class="p">.</span><span class="nx">MutatingWebhookConfigurationList</span><span class="p">{}</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ObjectNameFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Object</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">admissionregistration</span><span class="p">.</span><span class="nx">MutatingWebhookConfiguration</span><span class="p">).</span><span class="nx">Name</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DefaultQualifiedResource</span><span class="p">:</span> <span class="nx">admissionregistration</span><span class="p">.</span><span class="nf">Resource</span><span class="p">(</span><span class="s">&#34;mutatingwebhookconfigurations&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">CreateStrategy</span><span class="p">:</span> <span class="nx">mutatingwebhookconfiguration</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">UpdateStrategy</span><span class="p">:</span> <span class="nx">mutatingwebhookconfiguration</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">DeleteStrategy</span><span class="p">:</span> <span class="nx">mutatingwebhookconfiguration</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">TableConvertor</span><span class="p">:</span> <span class="nx">printerstorage</span><span class="p">.</span><span class="nx">TableConvertor</span><span class="p">{</span><span class="nx">TableGenerator</span><span class="p">:</span> <span class="nx">printers</span><span class="p">.</span><span class="nf">NewTableGenerator</span><span class="p">().</span><span class="nf">With</span><span class="p">(</span><span class="nx">printersinternal</span><span class="p">.</span><span class="nx">AddHandlers</span><span class="p">)},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">options</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">generic</span><span class="p">.</span><span class="nx">StoreOptions</span><span class="p">{</span><span class="nx">RESTOptions</span><span class="p">:</span> <span class="nx">optsGetter</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">store</span><span class="p">.</span><span class="nf">CompleteWithOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">REST</span><span class="p">{</span><span class="nx">store</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="状态模式" class="headerLink">
    <a href="#%e7%8a%b6%e6%80%81%e6%a8%a1%e5%bc%8f" class="header-mark"></a>状态模式</h3><p>状态模式将状态与行为分离，例如状态机的实现</p>
<p>如在容器运行时的接口中，可以获取容器状态</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Runtime</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">Status</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">RuntimeStatus</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// SyncPod syncs the running pod into the desired pod.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SyncPod</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">podStatus</span> <span class="o">*</span><span class="nx">PodStatus</span><span class="p">,</span> <span class="nx">pullSecrets</span> <span class="p">[]</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="nx">backOff</span> <span class="o">*</span><span class="nx">flowcontrol</span><span class="p">.</span><span class="nx">Backoff</span><span class="p">)</span> <span class="nx">PodSyncResult</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nf">KillPod</span><span class="p">(</span><span class="nx">pod</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">,</span> <span class="nx">runningPod</span> <span class="nx">Pod</span><span class="p">,</span> <span class="nx">gracePeriodOverride</span> <span class="o">*</span><span class="kt">int64</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteContainer</span><span class="p">(</span><span class="nx">containerID</span> <span class="nx">ContainerID</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h3 id="备忘录模式" class="headerLink">
    <a href="#%e5%a4%87%e5%bf%98%e5%bd%95%e6%a8%a1%e5%bc%8f" class="header-mark"></a>备忘录模式</h3><p>备忘录模式可以保存程序内部状态到外部，又不希望暴露内部状态的情形。例如快照可保存对象状态，用于恢复。</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/core/service/ipallocator/allocator.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/core/service/ipallocator/allocator.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="c1">// NewFromSnapshot allocates a Range and initializes it from a snapshot.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewFromSnapshot</span><span class="p">(</span><span class="nx">snap</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">RangeAllocation</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Range</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">ipnet</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">netutils</span><span class="p">.</span><span class="nf">ParseCIDRSloppy</span><span class="p">(</span><span class="nx">snap</span><span class="p">.</span><span class="nx">Range</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewInMemory</span><span class="p">(</span><span class="nx">ipnet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Restore</span><span class="p">(</span><span class="nx">ipnet</span><span class="p">,</span> <span class="nx">snap</span><span class="p">.</span><span class="nx">Data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">r</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="职责链模式" class="headerLink">
    <a href="#%e8%81%8c%e8%b4%a3%e9%93%be%e6%a8%a1%e5%bc%8f" class="header-mark"></a>职责链模式</h3><p>通过职责链分离不同的功能，可以动态组合。与装饰模式很相似，实际使用中也不需要区分其差异。</p>
<p>在<code>apiserver</code>的<code>handler</code>实现中，通过职责链来增加认证、授权、限流等操作
<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/config.go" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/config.go</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">DefaultBuildHandlerChain</span><span class="p">(</span><span class="nx">apiHandler</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="nx">filterlatency</span><span class="p">.</span><span class="nf">TrackCompleted</span><span class="p">(</span><span class="nx">apiHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithAuthorization</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Authorization</span><span class="p">.</span><span class="nx">Authorizer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Serializer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">filterlatency</span><span class="p">.</span><span class="nf">TrackStarted</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s">&#34;authorization&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">FlowControl</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">requestWorkEstimator</span> <span class="o">:=</span> <span class="nx">flowcontrolrequest</span><span class="p">.</span><span class="nf">NewWorkEstimator</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">StorageObjectCountTracker</span><span class="p">.</span><span class="nx">Get</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">FlowControl</span><span class="p">.</span><span class="nx">GetInterestedWatchCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">handler</span> <span class="p">=</span> <span class="nx">filterlatency</span><span class="p">.</span><span class="nf">TrackCompleted</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithPriorityAndFairness</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">FlowControl</span><span class="p">,</span> <span class="nx">requestWorkEstimator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">handler</span> <span class="p">=</span> <span class="nx">filterlatency</span><span class="p">.</span><span class="nf">TrackStarted</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="s">&#34;priorityandfairness&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithMaxInFlightLimit</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">MaxRequestsInFlight</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">MaxMutatingRequestsInFlight</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">LongRunningFunc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithLatencyTrackers</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithRequestInfo</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">RequestInfoResolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithRequestReceivedTimestamp</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithMuxAndDiscoveryComplete</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lifecycleSignals</span><span class="p">.</span><span class="nx">MuxAndDiscoveryComplete</span><span class="p">.</span><span class="nf">Signaled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericfilters</span><span class="p">.</span><span class="nf">WithPanicRecovery</span><span class="p">(</span><span class="nx">handler</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">RequestInfoResolver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="p">=</span> <span class="nx">genericapifilters</span><span class="p">.</span><span class="nf">WithAuditID</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">handler</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="访问者模式" class="headerLink">
    <a href="#%e8%ae%bf%e9%97%ae%e8%80%85%e6%a8%a1%e5%bc%8f" class="header-mark"></a>访问者模式</h3><p>访问者模式可以给一系列对象透明的添加功能，并且把相关代码封装到一个类中, 对象只要预留访问者接口Accept则后期为对象添加功能的时就不需要改动对象。</p>
<p>例如动物园内有多个场馆，有些场馆（熊猫馆、海洋馆）需要单独收费，那么每个场馆（对象）可以通过Accept接待游客（Vistor）。访问者模式的关键是将对象的操作分离出来形成单独的类，对象可以选择对应的操作。</p>
<p>在<code>kubectl</code>中使用访问者模式，通过不同的访问者实现不同的参数，从而拼接成Rest请求。
<a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubectl/pkg/apps/kind_visitor.go#L39" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubectl/pkg/apps/kind_visitor.go#L39</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">KindVisitor</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitDaemonSet</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitDeployment</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitJob</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitPod</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitReplicaSet</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitReplicationController</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitStatefulSet</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VisitCronJob</span><span class="p">(</span><span class="nx">kind</span> <span class="nx">GroupKindElement</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// GroupKindElement defines a Kubernetes API group elem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">GroupKindElement</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupKind</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Accept calls the Visit method on visitor that corresponds to elem&#39;s Kind
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">elem</span> <span class="nx">GroupKindElement</span><span class="p">)</span> <span class="nf">Accept</span><span class="p">(</span><span class="nx">visitor</span> <span class="nx">KindVisitor</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;apps&#34;</span><span class="p">,</span> <span class="s">&#34;extensions&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;DaemonSet&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitDaemonSet</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;apps&#34;</span><span class="p">,</span> <span class="s">&#34;extensions&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;Deployment&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitDeployment</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;batch&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;Job&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitJob</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;core&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;Pod&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitPod</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;apps&#34;</span><span class="p">,</span> <span class="s">&#34;extensions&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;ReplicaSet&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitReplicaSet</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;core&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;ReplicationController&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitReplicationController</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;apps&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;StatefulSet&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitStatefulSet</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">GroupMatch</span><span class="p">(</span><span class="s">&#34;batch&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">Kind</span> <span class="o">==</span> <span class="s">&#34;CronJob&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">visitor</span><span class="p">.</span><span class="nf">VisitCronJob</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no visitor method exists for %v&#34;</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h2><p>K8s中包含了不少经典设计模式的例子，部分没找到合适的例子便没有提及。实际使用过程中可能多种模式都有涉及，或者是一些变种，不简单的是严格的标准定义，学会灵活应用才能提高的代码质量。</p>
<h2 id="引用" class="headerLink">
    <a href="#%e5%bc%95%e7%94%a8" class="header-mark"></a>引用</h2><ul>
<li><a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener noreffer">https://github.com/kubernetes/kubernetes</a></li>
<li><a href="https://aly.arriqaaq.com/golang-design-patterns/" target="_blank" rel="noopener noreffer">https://aly.arriqaaq.com/golang-design-patterns/</a></li>
</ul>
<blockquote>
<p>Explore more in <a href="https://qingwave.github.io" target="_blank" rel="noopener noreffer">https://qingwave.github.io</a></p>
</blockquote>
</div>

        
        <div class="post-footer" id="post-footer">
    <div class="post-meta-line"><span class="single-tag">
                <a href='/tags/golang/'>#golang</a>
                    <span class="separator"> </span>
                <a href='/tags/k8s/'>#k8s</a></span></div>

    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-link">
                <a href='/about'>About Me</a>
            </div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
        </div>
    </div><div class="post-nav"><a href="/how-to-write-k8s-cni/" class="prev" rel="prev" title="手写一个Kubernetes CNI网络插件"><i class="fas fa-angle-left fa-fw"></i>手写一个Kubernetes CNI网络插件</a>
            <a href="/openpolicyagent-vs-casbin/" class="next" rel="next" title="Open Policy Agent vs Casbin">Open Policy Agent vs Casbin<i class="fas fa-angle-right fa-fw"></i></a></div></div>
<div id="comments"><div id="giscus"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://giscus.app/">giscus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qingwave.github.io" target="_blank" rel="noopener noreferrer">Qingwave</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-134548083-1', { 'anonymize_ip': true });
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"maxShownLines":-1},"comment":{"giscus":{"customTheme":"light","darkTheme":"dark","dataCategory":"Announcements","dataCategoryId":"DIC_kwDOCg97r84CBQfL","dataEmitMetadata":"0","dataInputPosition":"top","dataLang":"en","dataMapping":"title","dataReactionsEnabled":"1","dataRepo":"qingwave/qingwave.github.io","dataRepoId":"MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=","lightTheme":"light"}}};</script><script type="text/javascript" src="/js/giscus.min.js" defer></script></div>
</body>

</html>