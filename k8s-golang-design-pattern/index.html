<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=zh><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Kubernetes中的Golang设计模式</title><meta content=index,follow name=robots /><meta content=跟着K8s学编程 name=description /><meta content=summary_large_image name=twitter:card /><meta content=Kubernetes中的Golang设计模式 property=og:title /><meta content=跟着K8s学编程 property=og:description /><meta content=https://qingwave.github.io/k8s-golang-design-pattern property=og:url /><meta content=article property=og:type /><meta content=https://qingwave.github.io/ property=og:image /><meta content=Kubernetes中的Golang设计模式 property=og:image:alt /><link href=https://qingwave.github.io/k8s-golang-design-pattern rel=canonical /><style is:global>:root{--aw-font-sans:'Inter Variable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI name=google-site-verification><script src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async type=text/partytown></script><script type=text/partytown>(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.svg rel=mask-icon color=#8D46E7><link href=/sitemap-index.xml rel=sitemap><link href=/_astro/_page_.3c247233.css rel=stylesheet /><link href=/_astro/_page_.32d83315.css rel=stylesheet /><script src=/_astro/hoisted.69f8e884.js type=module></script><script>!function(t,e,n,i){(window.crossOriginIsolated||navigator.serviceWorker)&&((i=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(i[n]||[]).concat(["dataLayer.push"]))}(window,"partytown","forward"),function(t,e,n,i,o,r,a,s,d,c,l,p){function u(){p||(p=1,"/"==(a=(r.lib||"/~partytown/")+(r.debug?"debug/":""))[0]&&(d=e.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(s=setTimeout(y,1e4),e.addEventListener("pt0",f),o?w(1):n.serviceWorker?n.serviceWorker.register(a+(r.swPath||"partytown-sw.js"),{scope:a}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):y())))}function w(t){c=e.createElement(t?"script":"iframe"),t||(c.style.display="block",c.style.width="0",c.style.height="0",c.style.border="0",c.style.visibility="hidden",c.setAttribute("aria-hidden",!0)),c.src=a+"partytown-"+(t?"atomics.js?v=0.8.1":"sandbox-sw.html?"+Date.now()),e.querySelector(r.sandboxParent||"body").appendChild(c)}function y(n,o){for(f(),i==t&&(r.forward||[]).map((function(e){delete t[e.split(".")[0]]})),n=0;n<d.length;n++)(o=e.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=r.nonce,e.head.appendChild(o);c&&c.parentNode.removeChild(c)}function f(){clearTimeout(s)}r=t.partytown||{},i==t&&(r.forward||[]).map((function(e){l=t,e.split(".").map((function(e,n,i){l=l[i[n]]=n+1<i.length?"push"==i[n+1]?[]:l[i[n]]||{}:function(){(t._ptf=t._ptf||[]).push(i,arguments)}}))})),"complete"==e.readyState?u():(t.addEventListener("DOMContentLoaded",u),t.addEventListener("load",u))}(window,document,navigator,top,window.crossOriginIsolated)</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id=header><div class="max-w-3xl mx-auto sm:px-6 px-6 md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href=/ class="items-center flex"><img class="h-6 w-6 dark:invert invert-0" src=/favicon.svg></a><div class="items-center flex md:hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type=button data-aw-toggle-color-scheme><svg astro-icon=ph:moon-fill class="h-7 w-7" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill=currentColor /></svg></button><button aria-label="Toggle Menu" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:focus:ring-gray-700 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 ml-1.5 rounded-lg text-gray-500 transition" type=button data-aw-toggle-menu><svg astro-icon=tabler:menu class="h-6 w-6" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><g class=icon-tabler fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M4 8h16"/><path d="M4 16h16"/></g></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 text-xl w-full"><li class=""><a href=/blog class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>写作</a></li><li class=""><a href=/project class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>项目</a></li><li class=""><a href=/tags class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>标签</a></li><li class=""><a href=/about class="items-center flex dark:hover:text-white hover:text-gray-900 px-4 py-3" memu-item>关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type=button data-aw-toggle-color-scheme><svg astro-icon=ph:moon-fill class="h-6 w-6" viewBox="0 0 256 256"><path d="M224.3 154.9A100 100 0 1 1 101 31.7a7.9 7.9 0 0 1 10.3 8.1 5.7 5.7 0 0 1-.3 1.8A84 84 0 0 0 214.3 145l2.2-.4a8.1 8.1 0 0 1 7.8 5.7 7.2 7.2 0 0 1 0 4.6z" fill=currentColor /></svg></button></div></div></div></header><main><section class="max-w-3xl mx-auto lg:py-20 py-8 sm:py-16"><article><header class=""><div class="flex px-4 flex-col justify-between max-w-3xl mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Thu Apr 14 2022 07:18:45 GMT+0000 (Coordinated Universal Time)">Apr 14, 2022</time> · <a href=/categories/code class="capitalize hover:underline">code</a></p></div><h1 class="max-w-3xl mx-auto sm:px-6 px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">Kubernetes中的Golang设计模式</h1><p class="max-w-3xl mx-auto sm:px-6 px-4 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="max-w-3xl mx-auto sm:px-6 px-4"><div class="border-t dark:border-slate-700"></div></div></header><div class="max-w-3xl mx-auto sm:px-6 px-6 mt-8 break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert lg:prose-xl overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow prose-lg prose-md"><div class=table-wrap><p>随着 Kubernetes 成为容器编排领域的事实标准，Golang 在云原生方面应用的也越来越多。今天我们跟随 K8s 的脚步，学习下在 K8s 中使用哪些经典的设计模式。</p><h2 id=创建型模式>创建型模式</h2><p>创建型模式顾名思义提供了对象的创建机制，封装了内部的复杂性，提高代码复用和灵活性。包括：</p><ul><li>单例模式</li><li>工厂模式</li><li>建造者模式</li><li>原型模式</li></ul><h3 id=单例模式>单例模式</h3><p>单例模式用来保证一个类只有一个实例，并提供调用它的一个全局访问点。单例模式是设计模式中最简单，使用最广的一个，通常用来创建一个共享的实例，比如数据库连接池、线程池等。</p><p>单例模式分为懒汉式（使用时创建，延迟调用）与饿汉式（初始化时创建），通常我们使用<code>once.Do</code>来实现懒汉式，保证其线程安全。</p><p>在<code>kubeadm</code>中使用了单例模式来创建用户与用户组 <a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/kubeadm/app/util/staticpod/utils.go>https://github.com/kubernetes/kubernetes/tree/master/cmd/kubeadm/app/util/staticpod/utils.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>var</span><span style=color:#f8f8f2> (</span></span>
<span class=line><span style=color:#f8f8f2>	usersAndGroups     </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>users.UsersAndGroups</span></span>
<span class=line><span style=color:#f8f8f2>	usersAndGroupsOnce sync.Once</span></span>
<span class=line><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>GetUsersAndGroups</span><span style=color:#f8f8f2>() (</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>users.UsersAndGroups, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>var</span><span style=color:#f8f8f2> err </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#f8f8f2>	usersAndGroupsOnce.</span><span style=color:#8be9fd>Do</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>		usersAndGroups, err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> users.</span><span style=color:#8be9fd>AddUsersAndGroups</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> usersAndGroups, err</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=工厂模式>工厂模式</h3><p>工厂模式通过一个工厂方法来创建不同的产品，又分为简单工厂、工厂方法、抽象工厂，一般用来创建一类相似的产品，方便扩展。</p><p>简单工厂根据不同的输入创建不同的产品，在 Golang 中采用<code>Newxxx</code>的方式实现。</p><p>在<code>kubelet</code>中通过输入同创建不同的认证类型 <a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/kubelet/app/auth.go>https://github.com/kubernetes/kubernetes/tree/master/cmd/kubelet/app/auth.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>BuildAuthz</span><span style=color:#f8f8f2>(client authorizationclient.AuthorizationV1Interface, authz kubeletconfig.KubeletAuthorization) (authorizer.Authorizer, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>switch</span><span style=color:#f8f8f2> authz.Mode {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> kubeletconfig.KubeletAuthorizationModeAlwaysAllow:</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> authorizerfactory.</span><span style=color:#8be9fd>NewAlwaysAllowAuthorizer</span><span style=color:#f8f8f2>(), </span><span style=color:#bd93f9>nil</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> kubeletconfig.KubeletAuthorizationModeWebhook:</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> client </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>			</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, errors.</span><span style=color:#8be9fd>New</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>no client provided, cannot use webhook authorization</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>		authorizerConfig </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> authorizerfactory.DelegatingAuthorizerConfig{</span></span>
<span class=line><span style=color:#f8f8f2>			SubjectAccessReviewClient: client,</span></span>
<span class=line><span style=color:#f8f8f2>			AllowCacheTTL:             authz.Webhook.CacheAuthorizedTTL.Duration,</span></span>
<span class=line><span style=color:#f8f8f2>			DenyCacheTTL:              authz.Webhook.CacheUnauthorizedTTL.Duration,</span></span>
<span class=line><span style=color:#f8f8f2>			WebhookRetryBackoff:       genericoptions.</span><span style=color:#8be9fd>DefaultAuthWebhookRetryBackoff</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> authorizerConfig.</span><span style=color:#8be9fd>New</span><span style=color:#f8f8f2>()</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>""</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#8be9fd>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>no authorization mode specified</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>default</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#8be9fd>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>unknown authorization mode </span><span style=color:#bd93f9>%s</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, authz.Mode)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>以及<a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/store.go>https://github.com/kubernetes/client-go/blob/master/tools/cache/store.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>NewStore</span><span style=color:#f8f8f2>(keyFunc KeyFunc) Store {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>cache{</span></span>
<span class=line><span style=color:#f8f8f2>		cacheStorage: </span><span style=color:#8be9fd>NewThreadSafeStore</span><span style=color:#f8f8f2>(Indexers{}, Indices{}),</span></span>
<span class=line><span style=color:#f8f8f2>		keyFunc:      keyFunc,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// cacheStorage bears the burden of thread safety for the cache</span></span>
<span class=line><span style=color:#f8f8f2>	cacheStorage ThreadSafeStore</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// keyFunc is used to make the key for objects stored in and retrieved from items, and</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// should be deterministic.</span></span>
<span class=line><span style=color:#f8f8f2>	keyFunc KeyFunc</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>Store</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Add</span><span style=color:#f8f8f2>(obj </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Update</span><span style=color:#f8f8f2>(obj </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Delete</span><span style=color:#f8f8f2>(obj </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>List</span><span style=color:#f8f8f2>() []</span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>ListKeys</span><span style=color:#f8f8f2>() []</span><span style=color:#8be9fd;font-style:italic>string</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Get</span><span style=color:#f8f8f2>(obj </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}) (item </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}, exists </span><span style=color:#8be9fd;font-style:italic>bool</span><span style=color:#f8f8f2>, err </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// GetByKey returns the accumulator associated with the given key</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>GetByKey</span><span style=color:#f8f8f2>(key </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) (item </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}, exists </span><span style=color:#8be9fd;font-style:italic>bool</span><span style=color:#f8f8f2>, err </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Replace</span><span style=color:#f8f8f2>([]</span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}, </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Resync</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p>抽象工厂用来构建复杂的一组产品，在 informer 的实现中使用了抽象工厂 <a href=https://github.com/kubernetes/client-go/blob/master/informers/factory.go>https://github.com/kubernetes/client-go/blob/master/informers/factory.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// NewSharedInformerFactoryWithOptions constructs a new instance of a SharedInformerFactory with additional options.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>NewSharedInformerFactoryWithOptions</span><span style=color:#f8f8f2>(client kubernetes.Interface, defaultResync time.Duration, options </span><span style=color:#ff79c6>...</span><span style=color:#f8f8f2>SharedInformerOption) SharedInformerFactory {</span></span>
<span class=line><span style=color:#f8f8f2>	factory </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>sharedInformerFactory{</span></span>
<span class=line><span style=color:#f8f8f2>		client:           client,</span></span>
<span class=line><span style=color:#f8f8f2>		namespace:        v1.NamespaceAll,</span></span>
<span class=line><span style=color:#f8f8f2>		defaultResync:    defaultResync,</span></span>
<span class=line><span style=color:#f8f8f2>		informers:        </span><span style=color:#8be9fd>make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[reflect.Type]cache.SharedIndexInformer),</span></span>
<span class=line><span style=color:#f8f8f2>		startedInformers: </span><span style=color:#8be9fd>make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[reflect.Type]</span><span style=color:#8be9fd;font-style:italic>bool</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>		customResync:     </span><span style=color:#8be9fd>make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[reflect.Type]time.Duration),</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Apply all options</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>for</span><span style=color:#f8f8f2> _, opt </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>range</span><span style=color:#f8f8f2> options {</span></span>
<span class=line><span style=color:#f8f8f2>		factory </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>opt</span><span style=color:#f8f8f2>(factory)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> factory</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// SharedInformerFactory provides shared informers for resources in all known</span></span>
<span class=line><span style=color:#6272a4>// API group versions.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>SharedInformerFactory</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	internalinterfaces.SharedInformerFactory</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>ForResource</span><span style=color:#f8f8f2>(resource schema.GroupVersionResource) (GenericInformer, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>WaitForCacheSync</span><span style=color:#f8f8f2>(stopCh </span><span style=color:#ff79c6>&#x3C;-chan</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>struct</span><span style=color:#f8f8f2>{}) </span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[reflect.Type]</span><span style=color:#8be9fd;font-style:italic>bool</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Admissionregistration</span><span style=color:#f8f8f2>() admissionregistration.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Internal</span><span style=color:#f8f8f2>() apiserverinternal.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Apps</span><span style=color:#f8f8f2>() apps.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Autoscaling</span><span style=color:#f8f8f2>() autoscaling.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Batch</span><span style=color:#f8f8f2>() batch.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Certificates</span><span style=color:#f8f8f2>() certificates.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Coordination</span><span style=color:#f8f8f2>() coordination.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Core</span><span style=color:#f8f8f2>() core.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Discovery</span><span style=color:#f8f8f2>() discovery.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Events</span><span style=color:#f8f8f2>() events.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Extensions</span><span style=color:#f8f8f2>() extensions.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Flowcontrol</span><span style=color:#f8f8f2>() flowcontrol.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Networking</span><span style=color:#f8f8f2>() networking.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Node</span><span style=color:#f8f8f2>() node.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Policy</span><span style=color:#f8f8f2>() policy.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Rbac</span><span style=color:#f8f8f2>() rbac.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Scheduling</span><span style=color:#f8f8f2>() scheduling.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Storage</span><span style=color:#f8f8f2>() storage.Interface</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (f </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>sharedInformerFactory) </span><span style=color:#50fa7b>Apps</span><span style=color:#f8f8f2>() apps.Interface {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> apps.</span><span style=color:#8be9fd>New</span><span style=color:#f8f8f2>(f, f.namespace, f.tweakListOptions)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=建造者模式>建造者模式</h3><p>建造者模式通过逐步构建复杂的对象，降低创建对象的复杂度。通常多个步骤返回中间对象，最后通过<code>Build</code>完成检验与构建工作。</p><p>在<code>controller-runtime</code>中使用了建造者模式来创建 controller <a href=https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/builder>https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/builder</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// Builder builds a Controller.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	forInput         ForInput</span></span>
<span class=line><span style=color:#f8f8f2>	ownsInput        []OwnsInput</span></span>
<span class=line><span style=color:#f8f8f2>	watchesInput     []WatchesInput</span></span>
<span class=line><span style=color:#f8f8f2>	mgr              manager.Manager</span></span>
<span class=line><span style=color:#f8f8f2>	globalPredicates []predicate.Predicate</span></span>
<span class=line><span style=color:#f8f8f2>	ctrl             controller.Controller</span></span>
<span class=line><span style=color:#f8f8f2>	ctrlOptions      controller.Options</span></span>
<span class=line><span style=color:#f8f8f2>	name             </span><span style=color:#8be9fd;font-style:italic>string</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (blder </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder) </span><span style=color:#50fa7b>For</span><span style=color:#f8f8f2>(object client.Object, opts </span><span style=color:#ff79c6>...</span><span style=color:#f8f8f2>ForOption) </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> blder.forInput.object </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		blder.forInput.err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#8be9fd>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>For(...) should only be called once, could not assign multiple objects for reconciliation</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	input </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> ForInput{object: object}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>for</span><span style=color:#f8f8f2> _, opt </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>range</span><span style=color:#f8f8f2> opts {</span></span>
<span class=line><span style=color:#f8f8f2>		opt.</span><span style=color:#8be9fd>ApplyToFor</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>input)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	blder.forInput </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> input</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Watches exposes the lower-level ControllerManagedBy Watches functions through the builder.  Consider using</span></span>
<span class=line><span style=color:#6272a4>// Owns or For instead of Watches directly.</span></span>
<span class=line><span style=color:#6272a4>// Specified predicates are registered only for given source.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (blder </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder) </span><span style=color:#50fa7b>Watches</span><span style=color:#f8f8f2>(src source.Source, eventhandler handler.EventHandler, opts </span><span style=color:#ff79c6>...</span><span style=color:#f8f8f2>WatchesOption) </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder {</span></span>
<span class=line><span style=color:#f8f8f2>	input </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> WatchesInput{src: src, eventhandler: eventhandler}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>for</span><span style=color:#f8f8f2> _, opt </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>range</span><span style=color:#f8f8f2> opts {</span></span>
<span class=line><span style=color:#f8f8f2>		opt.</span><span style=color:#8be9fd>ApplyToWatches</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>input)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	blder.watchesInput </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>append</span><span style=color:#f8f8f2>(blder.watchesInput, input)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// WithOptions overrides the controller options use in doController. Defaults to empty.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (blder </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder) </span><span style=color:#50fa7b>WithOptions</span><span style=color:#f8f8f2>(options controller.Options) </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder {</span></span>
<span class=line><span style=color:#f8f8f2>	blder.ctrlOptions </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// WithLogger overrides the controller options's logger used.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (blder </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder) </span><span style=color:#50fa7b>WithLogger</span><span style=color:#f8f8f2>(log logr.Logger) </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder {</span></span>
<span class=line><span style=color:#f8f8f2>	blder.ctrlOptions.Log </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> log</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Build builds the Application Controller and returns the Controller it created.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (blder </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Builder) </span><span style=color:#50fa7b>Build</span><span style=color:#f8f8f2>(r reconcile.Reconciler) (controller.Controller, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> r </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#8be9fd>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>must provide a non-nil Reconciler</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> blder.mgr </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#8be9fd>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>must provide a non-nil Manager</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> blder.forInput.err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, blder.forInput.err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Checking the reconcile type exist or not</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> blder.forInput.object </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#8be9fd>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>must provide an object for reconciliation</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Set the ControllerManagedBy</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> blder.</span><span style=color:#8be9fd>doController</span><span style=color:#f8f8f2>(r); err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Set the Watch</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> blder.</span><span style=color:#8be9fd>doWatch</span><span style=color:#f8f8f2>(); err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> blder.ctrl, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=原型模式>原型模式</h3><p>原型模式用来解决对象复制问题，通过<code>Clone</code>方法，返回对象的复制品。将实现细节与使用解耦。</p><p>在 k8s 中所有资源都需要使用<code>DeepCopy</code>接口即原型模式 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/zz_generated.deepcopy.go>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/zz_generated.deepcopy.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (in </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Pod) </span><span style=color:#50fa7b>DeepCopyInto</span><span style=color:#f8f8f2>(out </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Pod) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>out </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>in</span></span>
<span class=line><span style=color:#f8f8f2>	out.TypeMeta </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> in.TypeMeta</span></span>
<span class=line><span style=color:#f8f8f2>	in.ObjectMeta.</span><span style=color:#8be9fd>DeepCopyInto</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>out.ObjectMeta)</span></span>
<span class=line><span style=color:#f8f8f2>	in.Spec.</span><span style=color:#8be9fd>DeepCopyInto</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>out.Spec)</span></span>
<span class=line><span style=color:#f8f8f2>	in.Status.</span><span style=color:#8be9fd>DeepCopyInto</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>out.Status)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new Pod.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (in </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Pod) </span><span style=color:#50fa7b>DeepCopy</span><span style=color:#f8f8f2>() </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Pod {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> in </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	out </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>new</span><span style=color:#f8f8f2>(Pod)</span></span>
<span class=line><span style=color:#f8f8f2>	in.</span><span style=color:#8be9fd>DeepCopyInto</span><span style=color:#f8f8f2>(out)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> out</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h2 id=结构型模式>结构型模式</h2><p>结构型模式通过将对象组合成更大的结构，从而提供系统的灵活性。包括：</p><ul><li>适配器模式</li><li>桥接模式</li><li>组合模式</li><li>代理模式</li><li>外观模式</li><li>装饰模式</li><li>享元模式</li></ul><h3 id=适配器模式>适配器模式</h3><p>通过适配器模式能使不兼容的对象相互协作，通常做一些兼容性工作（老版本、外部服务）时会使用到。</p><p>k8s 中有很多适配器的例子, 通过<code>Adapter</code>去包裹其他对象转换成统一的接口 <a href=https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replication/conversion.go>https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replication/conversion.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// informerAdapter implements ReplicaSetInformer by wrapping ReplicationControllerInformer</span></span>
<span class=line><span style=color:#6272a4>// and converting objects.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>informerAdapter</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	rcInformer coreinformers.ReplicationControllerInformer</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (i informerAdapter) </span><span style=color:#50fa7b>Informer</span><span style=color:#f8f8f2>() cache.SharedIndexInformer {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> conversionInformer{i.rcInformer.</span><span style=color:#8be9fd>Informer</span><span style=color:#f8f8f2>()}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (i informerAdapter) </span><span style=color:#50fa7b>Lister</span><span style=color:#f8f8f2>() appslisters.ReplicaSetLister {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> conversionLister{i.rcInformer.</span><span style=color:#8be9fd>Lister</span><span style=color:#f8f8f2>()}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><p><a href=https://github.com/kubernetes/client-go/blob/master/tools/events/event_broadcaster.go>https://github.com/kubernetes/client-go/blob/master/tools/events/event_broadcaster.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>eventBroadcasterAdapterImpl</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	coreClient          typedv1core.EventsGetter</span></span>
<span class=line><span style=color:#f8f8f2>	coreBroadcaster     record.EventBroadcaster</span></span>
<span class=line><span style=color:#f8f8f2>	eventsv1Client      typedeventsv1.EventsV1Interface</span></span>
<span class=line><span style=color:#f8f8f2>	eventsv1Broadcaster EventBroadcaster</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// NewEventBroadcasterAdapter creates a wrapper around new and legacy broadcasters to simplify</span></span>
<span class=line><span style=color:#6272a4>// migration of individual components to the new Event API.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>NewEventBroadcasterAdapter</span><span style=color:#f8f8f2>(client clientset.Interface) EventBroadcasterAdapter {</span></span>
<span class=line><span style=color:#f8f8f2>	eventClient </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>eventBroadcasterAdapterImpl{}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> _, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> client.</span><span style=color:#8be9fd>Discovery</span><span style=color:#f8f8f2>().</span><span style=color:#8be9fd>ServerResourcesForGroupVersion</span><span style=color:#f8f8f2>(eventsv1.SchemeGroupVersion.</span><span style=color:#8be9fd>String</span><span style=color:#f8f8f2>()); err </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		eventClient.eventsv1Client </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> client.</span><span style=color:#8be9fd>EventsV1</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>		eventClient.eventsv1Broadcaster </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>NewBroadcaster</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>EventSinkImpl{Interface: eventClient.eventsv1Client})</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Even though there can soon exist cases when coreBroadcaster won't really be needed,</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// we create it unconditionally because its overhead is minor and will simplify using usage</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// patterns of this library in all components.</span></span>
<span class=line><span style=color:#f8f8f2>	eventClient.coreClient </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> client.</span><span style=color:#8be9fd>CoreV1</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	eventClient.coreBroadcaster </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> record.</span><span style=color:#8be9fd>NewBroadcaster</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> eventClient</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// StartRecordingToSink starts sending events received from the specified eventBroadcaster to the given sink.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (e </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>eventBroadcasterAdapterImpl) </span><span style=color:#50fa7b>StartRecordingToSink</span><span style=color:#f8f8f2>(stopCh </span><span style=color:#ff79c6>&#x3C;-chan</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>struct</span><span style=color:#f8f8f2>{}) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> e.eventsv1Broadcaster </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> e.eventsv1Client </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		e.eventsv1Broadcaster.</span><span style=color:#8be9fd>StartRecordingToSink</span><span style=color:#f8f8f2>(stopCh)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> e.coreBroadcaster </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> e.coreClient </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		e.coreBroadcaster.</span><span style=color:#8be9fd>StartRecordingToSink</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>typedv1core.EventSinkImpl{Interface: e.coreClient.</span><span style=color:#8be9fd>Events</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>""</span><span style=color:#f8f8f2>)})</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (e </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>eventBroadcasterAdapterImpl) </span><span style=color:#50fa7b>NewRecorder</span><span style=color:#f8f8f2>(name </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) EventRecorder {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> e.eventsv1Broadcaster </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> e.eventsv1Client </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> e.eventsv1Broadcaster.</span><span style=color:#8be9fd>NewRecorder</span><span style=color:#f8f8f2>(scheme.Scheme, name)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> record.</span><span style=color:#8be9fd>NewEventRecorderAdapter</span><span style=color:#f8f8f2>(e.</span><span style=color:#8be9fd>DeprecatedNewLegacyRecorder</span><span style=color:#f8f8f2>(name))</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=桥接模式>桥接模式</h3><p>桥接模式将实现与抽象解耦，可提供系统的系统的灵活性与可扩展性。</p><p>在 k8s 中大量使用，如<code>DiscoveryClient</code>的实现 <a href=https://github.com/kubernetes/client-go/blob/master/discovery/discovery_client.go>https://github.com/kubernetes/client-go/blob/master/discovery/discovery_client.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>DiscoveryClient</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	restClient restclient.Interface</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	LegacyPrefix </span><span style=color:#8be9fd;font-style:italic>string</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>DiscoveryInterface</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>RESTClient</span><span style=color:#f8f8f2>() restclient.Interface</span></span>
<span class=line><span style=color:#f8f8f2>	ServerGroupsInterface</span></span>
<span class=line><span style=color:#f8f8f2>	ServerResourcesInterface</span></span>
<span class=line><span style=color:#f8f8f2>	ServerVersionInterface</span></span>
<span class=line><span style=color:#f8f8f2>	OpenAPISchemaInterface</span></span>
<span class=line><span style=color:#f8f8f2>	OpenAPIV3SchemaInterface</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// NewDiscoveryClient returns a new DiscoveryClient for the given RESTClient.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>NewDiscoveryClient</span><span style=color:#f8f8f2>(c restclient.Interface) </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>DiscoveryClient {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>DiscoveryClient{restClient: c, LegacyPrefix: </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>/api</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// RESTClient returns a RESTClient that is used to communicate</span></span>
<span class=line><span style=color:#6272a4>// with API server by this client implementation.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (d </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>DiscoveryClient) </span><span style=color:#50fa7b>RESTClient</span><span style=color:#f8f8f2>() restclient.Interface {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> d </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> d.restClient</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=组合模式>组合模式</h3><p>组合模式通过组合小对象形成更大的结构，并且具有相同的接口。和 Golang 中的组合非常相似，使用也非常广泛。</p><p><a href=https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/cache/cache.go>https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/cache/cache.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// Cache knows how to load Kubernetes objects, fetch informers to request</span></span>
<span class=line><span style=color:#6272a4>// to receive events for Kubernetes objects (at a low-level),</span></span>
<span class=line><span style=color:#6272a4>// and add indices to fields on the objects stored in the cache.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>Cache</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Cache acts as a client to objects stored in the cache.</span></span>
<span class=line><span style=color:#f8f8f2>	client.Reader</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Cache loads informers and adds field indices.</span></span>
<span class=line><span style=color:#f8f8f2>	Informers</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>Informers</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>GetInformer</span><span style=color:#f8f8f2>(ctx context.Context, obj client.Object) (Informer, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>GetInformerForKind</span><span style=color:#f8f8f2>(ctx context.Context, gvk schema.GroupVersionKind) (Informer, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Start</span><span style=color:#f8f8f2>(ctx context.Context) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>WaitForCacheSync</span><span style=color:#f8f8f2>(ctx context.Context) </span><span style=color:#8be9fd;font-style:italic>bool</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	client.FieldIndexer</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=代理模式>代理模式</h3><p>代理模式通过代理来替代真实服务，通常代理类与真实类具有相同的接口，在代理类中可以做一些额外操作（访问控制、缓存等）</p><p>在 k8s 中通过代理来实现访问 Node、Pod、Service。</p><h3 id=外观模式>外观模式</h3><p>外观模式通过一个高度抽象的接口，使子系统更加容器使用，使用也很广泛</p><p>比如<code>controller-runtime</code>中创建时<code>controllerManager</code>时调用了很多子系统，使用时只需通过<code>GetClient()</code>便可得到<code>Client</code></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// New returns a new Manager for creating Controllers.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(config </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>rest.Config, options Options) (Manager, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Set default values for options fields</span></span>
<span class=line><span style=color:#f8f8f2>	options </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>setOptionsDefaults</span><span style=color:#f8f8f2>(options)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	cluster, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> cluster.</span><span style=color:#8be9fd>New</span><span style=color:#f8f8f2>(config, </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(clusterOptions </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>cluster.Options) {</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.Scheme </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.Scheme</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.MapperProvider </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.MapperProvider</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.Logger </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.Logger</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.SyncPeriod </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.SyncPeriod</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.Namespace </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.Namespace</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.NewCache </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.NewCache</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.NewClient </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.NewClient</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.ClientDisableCacheFor </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.ClientDisableCacheFor</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.DryRunClient </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.DryRunClient</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.EventBroadcaster </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.EventBroadcaster </span><span style=color:#6272a4>//nolint:staticcheck</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>//...</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>controllerManager{</span></span>
<span class=line><span style=color:#f8f8f2>		cluster:                       cluster,</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#6272a4>//...</span></span>
<span class=line><span style=color:#f8f8f2>	}, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (c </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>cluster) </span><span style=color:#50fa7b>GetClient</span><span style=color:#f8f8f2>() client.Client {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> c.client</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=装饰模式>装饰模式</h3><p>装饰模式通过原有对象多次包装从而添加新功能，典型的一些 Http 中间件实现（日志、认证）</p><p><code>admission</code>中装饰器的使用 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/decorator.go>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/decorator.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>Decorator</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Decorate</span><span style=color:#f8f8f2>(handler Interface, name </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) Interface</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>DecoratorFunc</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(handler Interface, name </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) Interface</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (d DecoratorFunc) </span><span style=color:#50fa7b>Decorate</span><span style=color:#f8f8f2>(handler Interface, name </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) Interface {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>d</span><span style=color:#f8f8f2>(handler, name)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>Decorators</span><span style=color:#f8f8f2> []Decorator</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Decorate applies the decorator in inside-out order, i.e. the first decorator in the slice is first applied to the given handler.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (d Decorators) </span><span style=color:#50fa7b>Decorate</span><span style=color:#f8f8f2>(handler Interface, name </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) Interface {</span></span>
<span class=line><span style=color:#f8f8f2>	result </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> handler</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>for</span><span style=color:#f8f8f2> _, d </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>range</span><span style=color:#f8f8f2> d {</span></span>
<span class=line><span style=color:#f8f8f2>		result </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> d.</span><span style=color:#8be9fd>Decorate</span><span style=color:#f8f8f2>(result, name)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> result</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=享元模式>享元模式</h3><p>享元模式通过共享多个对象共有的子对象，从而节省内存。如连接池、对象池的实现等，在 Golang 中通过<code>sync.Pool</code>可实现对象复用即享元模式。</p><p>在<code>apiserver/endpoints</code>中通过共享 gzip 对象，减少内存分配以及 gc 时间</p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>var</span><span style=color:#f8f8f2> gzipPool </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>sync.Pool{</span></span>
<span class=line><span style=color:#f8f8f2>	New: </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{} {</span></span>
<span class=line><span style=color:#f8f8f2>		gw, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> gzip.</span><span style=color:#8be9fd>NewWriterLevel</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, defaultGzipContentEncodingLevel)</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>			</span><span style=color:#8be9fd>panic</span><span style=color:#f8f8f2>(err)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> gw</span></span>
<span class=line><span style=color:#f8f8f2>	},</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (w </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>deferredResponseWriter) </span><span style=color:#50fa7b>Write</span><span style=color:#f8f8f2>(p []</span><span style=color:#8be9fd;font-style:italic>byte</span><span style=color:#f8f8f2>) (n </span><span style=color:#8be9fd;font-style:italic>int</span><span style=color:#f8f8f2>, err </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// ...</span></span>
<span class=line><span style=color:#f8f8f2>	hw </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> w.hw</span></span>
<span class=line><span style=color:#f8f8f2>	header </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> hw.</span><span style=color:#8be9fd>Header</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>switch</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> w.contentEncoding </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>gzip</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>len</span><span style=color:#f8f8f2>(p) </span><span style=color:#ff79c6>></span><span style=color:#f8f8f2> defaultGzipThresholdBytes:</span></span>
<span class=line><span style=color:#f8f8f2>		header.</span><span style=color:#8be9fd>Set</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Content-Encoding</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>gzip</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		header.</span><span style=color:#8be9fd>Add</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Vary</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Accept-Encoding</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		gw </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> gzipPool.</span><span style=color:#8be9fd>Get</span><span style=color:#f8f8f2>().(</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>gzip.Writer)</span></span>
<span class=line><span style=color:#f8f8f2>		gw.</span><span style=color:#8be9fd>Reset</span><span style=color:#f8f8f2>(hw)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		w.w </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> gw</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>default</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		w.w </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> hw</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	header.</span><span style=color:#8be9fd>Set</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Content-Type</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, w.mediaType)</span></span>
<span class=line><span style=color:#f8f8f2>	hw.</span><span style=color:#8be9fd>WriteHeader</span><span style=color:#f8f8f2>(w.statusCode)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> w.w.</span><span style=color:#8be9fd>Write</span><span style=color:#f8f8f2>(p)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (w </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>deferredResponseWriter) </span><span style=color:#50fa7b>Close</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>!</span><span style=color:#f8f8f2>w.hasWritten {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>var</span><span style=color:#f8f8f2> err </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>switch</span><span style=color:#f8f8f2> t </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> w.w.(type) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>gzip.Writer:</span></span>
<span class=line><span style=color:#f8f8f2>		err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> t.</span><span style=color:#8be9fd>Close</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>		t.</span><span style=color:#8be9fd>Reset</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		gzipPool.</span><span style=color:#8be9fd>Put</span><span style=color:#f8f8f2>(t)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h2 id=行为型模式>行为型模式</h2><p>行为型模式负责对象间的通信和职责委派，常用的包括：</p><ul><li>观察者模式</li><li>中介者模式</li><li>命令模式</li><li>迭代器模式</li><li>策略模式</li><li>状态模式</li><li>备忘录模式</li><li>职责链模式</li><li>访问者模式</li><li>解释器模式</li></ul><h3 id=观察者模式>观察者模式</h3><p>观察者模式允许观察者订阅事件，当事件触发时会通知观察对象。</p><p>在<code>shardInformer</code>订阅事件时使用了观察者模式 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/shared_informer.go>https://github.com/kubernetes/client-go/blob/master/tools/cache/shared_informer.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (s </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>sharedIndexInformer) </span><span style=color:#50fa7b>AddEventHandlerWithResyncPeriod</span><span style=color:#f8f8f2>(handler ResourceEventHandler, resyncPeriod time.Duration) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>//...</span></span>
<span class=line><span style=color:#f8f8f2>	s.processor.</span><span style=color:#8be9fd>addListener</span><span style=color:#f8f8f2>(listener)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>for</span><span style=color:#f8f8f2> _, item </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>range</span><span style=color:#f8f8f2> s.indexer.</span><span style=color:#8be9fd>List</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>		listener.</span><span style=color:#8be9fd>add</span><span style=color:#f8f8f2>(addNotification{newObj: item})</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// 事件触发时通知所有对象</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (s </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>sharedIndexInformer) </span><span style=color:#50fa7b>OnAdd</span><span style=color:#f8f8f2>(obj </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}) {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// Invocation of this function is locked under s.blockDeltas, so it is</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// save to distribute the notification</span></span>
<span class=line><span style=color:#f8f8f2>	s.cacheMutationDetector.</span><span style=color:#8be9fd>AddObject</span><span style=color:#f8f8f2>(obj)</span></span>
<span class=line><span style=color:#f8f8f2>	s.processor.</span><span style=color:#8be9fd>distribute</span><span style=color:#f8f8f2>(addNotification{newObj: obj}, </span><span style=color:#bd93f9>false</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (p </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>sharedProcessor) </span><span style=color:#50fa7b>distribute</span><span style=color:#f8f8f2>(obj </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}, sync </span><span style=color:#8be9fd;font-style:italic>bool</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	p.listenersLock.</span><span style=color:#8be9fd>RLock</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>defer</span><span style=color:#f8f8f2> p.listenersLock.</span><span style=color:#8be9fd>RUnlock</span><span style=color:#f8f8f2>()</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> sync {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>for</span><span style=color:#f8f8f2> _, listener </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>range</span><span style=color:#f8f8f2> p.syncingListeners {</span></span>
<span class=line><span style=color:#f8f8f2>			listener.</span><span style=color:#8be9fd>add</span><span style=color:#f8f8f2>(obj)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>	} </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>for</span><span style=color:#f8f8f2> _, listener </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>range</span><span style=color:#f8f8f2> p.listeners {</span></span>
<span class=line><span style=color:#f8f8f2>			listener.</span><span style=color:#8be9fd>add</span><span style=color:#f8f8f2>(obj)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=命令模式>命令模式</h3><p>命令模式通过将请求封装为对象，方便存储调用。</p><p>在 k8s 中所有组件启动都是通过<code>github.com/spf13/cobra</code>工具包 <a href=https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/apiserver.go>https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/apiserver.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>main</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>	command </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> app.</span><span style=color:#8be9fd>NewAPIServerCommand</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	code </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> cli.</span><span style=color:#8be9fd>Run</span><span style=color:#f8f8f2>(command)</span></span>
<span class=line><span style=color:#f8f8f2>	os.</span><span style=color:#8be9fd>Exit</span><span style=color:#f8f8f2>(code)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=迭代器模式>迭代器模式</h3><p>迭代器允许顺序遍历复杂的数据结构而不暴露其内部细节。通常通过<code>Next</code>方法来迭代下一个对象。</p><p>k8s 在对象序列化时使用了迭代器。</p><h3 id=策略模式>策略模式</h3><p>策略模式通过定义一系列算法，允许运行时可替换算法，从而实现算法分离。</p><p>策略模式与桥接模式非常像，只是桥接模式的抽象程度更高一点。 <a href=https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/admissionregistration/mutatingwebhookconfiguration/storage/storage.go>https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/admissionregistration/mutatingwebhookconfiguration/storage/storage.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// NewREST returns a RESTStorage object that will work against mutatingWebhookConfiguration.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>NewREST</span><span style=color:#f8f8f2>(optsGetter generic.RESTOptionsGetter) (</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>REST, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	store </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>genericregistry.Store{</span></span>
<span class=line><span style=color:#f8f8f2>		NewFunc:     </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() runtime.Object { </span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>admissionregistration.MutatingWebhookConfiguration{} },</span></span>
<span class=line><span style=color:#f8f8f2>		NewListFunc: </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() runtime.Object { </span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>admissionregistration.MutatingWebhookConfigurationList{} },</span></span>
<span class=line><span style=color:#f8f8f2>		ObjectNameFunc: </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(obj runtime.Object) (</span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>			</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> obj.(</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>admissionregistration.MutatingWebhookConfiguration).Name, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>		},</span></span>
<span class=line><span style=color:#f8f8f2>		DefaultQualifiedResource: admissionregistration.</span><span style=color:#8be9fd>Resource</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>mutatingwebhookconfigurations</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>),</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		CreateStrategy: mutatingwebhookconfiguration.Strategy,</span></span>
<span class=line><span style=color:#f8f8f2>		UpdateStrategy: mutatingwebhookconfiguration.Strategy,</span></span>
<span class=line><span style=color:#f8f8f2>		DeleteStrategy: mutatingwebhookconfiguration.Strategy,</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		TableConvertor: printerstorage.TableConvertor{TableGenerator: printers.</span><span style=color:#8be9fd>NewTableGenerator</span><span style=color:#f8f8f2>().</span><span style=color:#8be9fd>With</span><span style=color:#f8f8f2>(printersinternal.AddHandlers)},</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	options </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>generic.StoreOptions{RESTOptions: optsGetter}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> store.</span><span style=color:#8be9fd>CompleteWithOptions</span><span style=color:#f8f8f2>(options); err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>REST{store}, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=状态模式>状态模式</h3><p>状态模式将状态与行为分离，例如状态机的实现</p><p>如在容器运行时的接口中，可以获取容器状态</p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>Runtime</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>//...</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>Status</span><span style=color:#f8f8f2>() (</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>RuntimeStatus, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>// SyncPod syncs the running pod into the desired pod.</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>SyncPod</span><span style=color:#f8f8f2>(pod </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>v1.Pod, podStatus </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>PodStatus, pullSecrets []v1.Secret, backOff </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>flowcontrol.Backoff) PodSyncResult</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>KillPod</span><span style=color:#f8f8f2>(pod </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>v1.Pod, runningPod Pod, gracePeriodOverride </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>int64</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>DeleteContainer</span><span style=color:#f8f8f2>(containerID ContainerID) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>//...</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=备忘录模式>备忘录模式</h3><p>备忘录模式可以保存程序内部状态到外部，又不希望暴露内部状态的情形。例如快照可保存对象状态，用于恢复。</p><p><a href=https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/core/service/ipallocator/allocator.go>https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/core/service/ipallocator/allocator.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// NewFromSnapshot allocates a Range and initializes it from a snapshot.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>NewFromSnapshot</span><span style=color:#f8f8f2>(snap </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>api.RangeAllocation) (</span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Range, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	_, ipnet, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> netutils.</span><span style=color:#8be9fd>ParseCIDRSloppy</span><span style=color:#f8f8f2>(snap.Range)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	r, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd>NewInMemory</span><span style=color:#f8f8f2>(ipnet)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#8be9fd>Restore</span><span style=color:#f8f8f2>(ipnet, snap.Data); err </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> r, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=职责链模式>职责链模式</h3><p>通过职责链分离不同的功能，可以动态组合。与装饰模式很相似，实际使用中也不需要区分其差异。</p><p>在<code>apiserver</code>的<code>handler</code>实现中，通过职责链来增加认证、授权、限流等操作 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/config.go>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/config.go</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> </span><span style=color:#50fa7b>DefaultBuildHandlerChain</span><span style=color:#f8f8f2>(apiHandler http.Handler, c </span><span style=color:#ff79c6>*</span><span style=color:#f8f8f2>Config) http.Handler {</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#8be9fd>TrackCompleted</span><span style=color:#f8f8f2>(apiHandler)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#8be9fd>WithAuthorization</span><span style=color:#f8f8f2>(handler, c.Authorization.Authorizer, c.Serializer)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#8be9fd>TrackStarted</span><span style=color:#f8f8f2>(handler, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>authorization</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>if</span><span style=color:#f8f8f2> c.FlowControl </span><span style=color:#ff79c6>!=</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		requestWorkEstimator </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> flowcontrolrequest.</span><span style=color:#8be9fd>NewWorkEstimator</span><span style=color:#f8f8f2>(c.StorageObjectCountTracker.Get, c.FlowControl.GetInterestedWatchCount)</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#8be9fd>TrackCompleted</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericfilters.</span><span style=color:#8be9fd>WithPriorityAndFairness</span><span style=color:#f8f8f2>(handler, c.LongRunningFunc, c.FlowControl, requestWorkEstimator)</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#8be9fd>TrackStarted</span><span style=color:#f8f8f2>(handler, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>priorityandfairness</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	} </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericfilters.</span><span style=color:#8be9fd>WithMaxInFlightLimit</span><span style=color:#f8f8f2>(handler, c.MaxRequestsInFlight, c.MaxMutatingRequestsInFlight, c.LongRunningFunc)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#6272a4>//...</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#8be9fd>WithLatencyTrackers</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#8be9fd>WithRequestInfo</span><span style=color:#f8f8f2>(handler, c.RequestInfoResolver)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#8be9fd>WithRequestReceivedTimestamp</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#8be9fd>WithMuxAndDiscoveryComplete</span><span style=color:#f8f8f2>(handler, c.lifecycleSignals.MuxAndDiscoveryComplete.</span><span style=color:#8be9fd>Signaled</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericfilters.</span><span style=color:#8be9fd>WithPanicRecovery</span><span style=color:#f8f8f2>(handler, c.RequestInfoResolver)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#8be9fd>WithAuditID</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> handler</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h3 id=访问者模式>访问者模式</h3><p>访问者模式可以给一系列对象透明的添加功能，并且把相关代码封装到一个类中, 对象只要预留访问者接口 Accept 则后期为对象添加功能的时就不需要改动对象。</p><p>例如动物园内有多个场馆，有些场馆（熊猫馆、海洋馆）需要单独收费，那么每个场馆（对象）可以通过 Accept 接待游客（Vistor）。访问者模式的关键是将对象的操作分离出来形成单独的类，对象可以选择对应的操作。</p><p>在<code>kubectl</code>中使用访问者模式，通过不同的访问者实现不同的参数，从而拼接成 Rest 请求。 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubectl/pkg/apps/kind_visitor.go#L39>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubectl/pkg/apps/kind_visitor.go#L39</a></p><pre class="astro-code dracula" style=background-color:#282a36;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>KindVisitor</span><span style=color:#f8f8f2> </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitDaemonSet</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitDeployment</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitJob</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitPod</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitReplicaSet</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitReplicationController</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitStatefulSet</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#8be9fd>VisitCronJob</span><span style=color:#f8f8f2>(kind GroupKindElement)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// GroupKindElement defines a Kubernetes API group elem</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#f8f8f2> </span><span style=color:#8be9fd;font-style:italic>GroupKindElement</span><span style=color:#f8f8f2> schema.GroupKind</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Accept calls the Visit method on visitor that corresponds to elem's Kind</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (elem GroupKindElement) </span><span style=color:#50fa7b>Accept</span><span style=color:#f8f8f2>(visitor KindVisitor) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>switch</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>extensions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>DaemonSet</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitDaemonSet</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>extensions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Deployment</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitDeployment</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>batch</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Job</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitJob</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>""</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>core</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Pod</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitPod</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>extensions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>ReplicaSet</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitReplicaSet</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>""</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>core</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>ReplicationController</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitReplicationController</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>StatefulSet</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitStatefulSet</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>case</span><span style=color:#f8f8f2> elem.</span><span style=color:#8be9fd>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>batch</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#f8f8f2> </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>CronJob</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#8be9fd>VisitCronJob</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>default</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> fmt.</span><span style=color:#8be9fd>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>no visitor method exists for </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, elem)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	</span><span style=color:#ff79c6>return</span><span style=color:#f8f8f2> </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span></code></pre><h2 id=总结>总结</h2><p>K8s 中包含了不少经典设计模式的例子，部分没找到合适的例子便没有提及。实际使用过程中可能多种模式都有涉及，或者是一些变种，不简单的是严格的标准定义，学会灵活应用才能提高的代码质量。</p><h2 id=引用>引用</h2><ul><li><a href=https://github.com/kubernetes/kubernetes>https://github.com/kubernetes/kubernetes</a></li><li><a href=https://aly.arriqaaq.com/golang-design-patterns/ >https://aly.arriqaaq.com/golang-design-patterns/</a></li></ul><blockquote><p>Explore more in <a href=https://qingwave.github.io>https://qingwave.github.io</a></p></blockquote></div></div><div class="flex flex-col justify-between max-w-3xl mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class=mr-5><li class="border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-full"><a href=/tags/golang class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#golang</a></li><li class="border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-full"><a href=/tags/k8s class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#k8s</a></li><li class="border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-full"><a href=/tags/程序设计 class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#程序设计</a></li></ul></div></article><div class="max-w-3xl mx-auto sm:px-6 px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script src=https://giscus.app/client.js async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOCg97r84CBQfL data-emit-metadata=0 data-input-position=top data-lang=en data-mapping=title data-reactions-enabled=1 data-repo=qingwave/qingwave.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict=0 data-theme=light></script></div></section></main><footer class=relative><div class="max-w-3xl mx-auto sm:px-6 px-4"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="max-w-3xl mx-auto sm:px-6 px-4 dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href=/rss.xml class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label=RSS><svg astro-icon=tabler:rss class="h-5 w-5" viewBox="0 0 24 24"><g class=icon-tabler fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><circle cx=5 cy=19 r=1 /><path d="M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9"/></g></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href=https://qingwave.github.io class=hover:brightness-50>Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function c(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:localStorage.theme}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),c=encodeURIComponent(t.getAttribute("data-aw-text"));let a;switch(o){case"facebook":a=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":a=`https://twitter.com/intent/tweet?url=${n}&text=${c}`;break;case"linkedin":a=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${c}`;break;case"whatsapp":a=`https://wa.me/?text=${c}%20${n}`;break;case"mail":a=`mailto:?subject=%22${c}%22&body=${c}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=a,s.click()})),c(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{c()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>