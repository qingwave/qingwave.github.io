<!DOCTYPE html><html class=2xl:text-[20px] dir=ltr lang=zh><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><title>Kubernetes中的Golang设计模式</title><meta content=跟着K8s学编程 name=description /><meta content=index,follow name=robots /><link href=https://qingwave.github.io/k8s-golang-design-pattern rel=canonical /><meta content=Kubernetes中的Golang设计模式 property=og:title /><meta content=跟着K8s学编程 property=og:description /><meta content=https://qingwave.github.io/k8s-golang-design-pattern property=og:url /><meta content=article property=og:type /><meta content=https://qingwave.github.io/ property=og:image /><meta content=Kubernetes中的Golang设计模式 property=og:image:alt /><meta content=summary_large_image name=twitter:card /><style is:global>:root{--aw-font-sans:'Inter Variable';--aw-font-serif:var(--aw-font-sans);--aw-font-heading:var(--aw-font-sans);--aw-color-primary:#10b981;--aw-color-secondary:rgb(30 58 138);--aw-color-accent:rgb(109 40 217);--aw-color-text-page:rgb(17 24 39);--aw-color-text-muted:rgb(75 85 99);--aw-color-bg-page:rgb(255 255 255)}</style><meta content=-8bOgP-V4XsxXZtXVx9DIXkdIuruvAYiY37vBg26acI name=google-site-verification><script src="https://www.googletagmanager.com/gtag/js?id=UA-134548083-1" async type=text/partytown></script><script type=text/partytown>(function(){const id = "UA-134548083-1";

  window.dataLayer = window.dataLayer || [];
  function gtag() {
    window.dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", id);
})();</script><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon type=image/svg+xml><link href=/favicon.svg rel=mask-icon color=#8D46E7><link href=/sitemap-index.xml rel=sitemap><link href=/_astro/_page_.CNGmXAo5.css rel=stylesheet><link href=/_astro/_page_.D-Hgf0td.css rel=stylesheet><script src=/_astro/hoisted.BtBHHDce.js type=module></script><script>!function(t,e,n,r){(window.crossOriginIsolated||navigator.serviceWorker)&&((r=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(r[n]||[]).concat(["dataLayer.push"]))}(window,"partytown","forward");const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,d,l,p,u=t,y){function f(){y||(y=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(l=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(d=setTimeout(h,1e4),r.addEventListener("pt0",b),a?w(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?w():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&w()}))}),console.error):h())))}function w(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.10.2":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function h(n,o){for(b(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<l.length;n++)(o=r.createElement("script")).innerHTML=l[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function b(){clearTimeout(d)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?f():(t.addEventListener("DOMContentLoaded",f),t.addEventListener("load",f))}(window,document,navigator,top,window.crossOriginIsolated),document.addEventListener("astro:before-swap",(t=>{let e=document.body.querySelector("iframe[src*='/~partytown/']");t.newDocument.body.append(e)}))</script></head><body class="dark:text-slate-300 antialiased bg-light dark:bg-dark text-page tracking-tight"><header class="md:py-8 flex-none mt-8 py-4 sticky top-0 w-full z-40" id=header><div class="mx-auto sm:px-6 max-w-3xl px-6 md:flex md:justify-between"><div class="items-center md:flex"><div class="flex justify-between"><a href=/ class="items-center flex"><img alt="" class="h-6 w-6 dark:invert invert-0" src=/favicon.svg></a><div class="items-center flex md:hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type=button data-aw-toggle-color-scheme><svg class="h-7 w-7" data-icon=tabler:moon-filled height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:moon-filled><path d="M12 1.992a10 10 0 1 0 9.236 13.838c.341-.82-.476-1.644-1.298-1.31a6.5 6.5 0 0 1-6.864-10.787l.077-.08c.551-.63.113-1.653-.758-1.653h-.266l-.068-.006z" fill=currentColor /></symbol><use xlink:href=#ai:tabler:moon-filled></use></svg></button> <button aria-label="Toggle Menu" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:focus:ring-gray-700 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 hover:bg-gray-100 ml-1.5 rounded-lg text-gray-500 transition" type=button data-aw-toggle-menu><svg class="h-6 w-6" data-icon=tabler:menu height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:menu><path d="M4 8h16M4 16h16" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use xlink:href=#ai:tabler:menu></use></svg></button></div></div><nav aria-label="Main navigation" class="items-center md:flex hidden dark:text-slate-200 h-[calc(100vh-72px)] md:h-auto md:mx-5 md:overflow-visible md:w-auto overflow-y-auto pr-4 w-full"><ul class="flex flex-col md:flex-row md:pt-0 md:self-center md:text-base md:w-auto pt-8 w-full"><li class=""><a href=/blog class="items-center flex font-medium px-4 py-3" memu-item>文章</a></li><li class=""><a href=/project class="items-center flex font-medium px-4 py-3" memu-item>项目</a></li><li class=""><a href=/reading class="items-center flex font-medium px-4 py-3" memu-item>阅读</a></li><li class=""><a href=/about class="items-center flex font-medium px-4 py-3" memu-item>关于我</a></li></ul></nav></div><div class="items-center flex md:mb-0 md:self-center"><div class="items-center md:flex hidden"><button aria-label="Toggle between Dark and Light mode" class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm dark:hover:text-slate-300 hover:text-slate-950 text-slate-800" type=button data-aw-toggle-color-scheme><svg class="h-6 w-6" data-icon=tabler:moon-filled height=1em viewBox="0 0 24 24" width=1em><use xlink:href=#ai:tabler:moon-filled></use></svg></button></div></div></div></header><main><section class=page><article><header class=""><div class="flex px-4 flex-col justify-between mb-2 mt-0 mx-auto sm:flex-row sm:items-center sm:px-6"><p class="text-sm dark:text-slate-400 leading-6 text-slatey-700"><time datetime="Thu Apr 14 2022 07:18:45 GMT+0000 (Coordinated Universal Time)">Apr 14, 2022</time> · <a href=/categories/code class="capitalize hover:underline">code</a></p></div><h1 class="mx-auto sm:px-6 px-4 font-bold font-heading leading-tighter md:text-5xl text-4xl tracking-tighter">Kubernetes中的Golang设计模式</h1><p class="mx-auto sm:px-6 px-4 dark:text-slate-400 mb-8 md:text-2xl mt-4 text-justify text-muted text-xl"></p><div class="mx-auto sm:px-6 px-4"><div class="border-t dark:border-slate-700"></div></div></header><div class="mx-auto sm:px-6 px-6 mt-8 3xl:prose-xl break-words dark:prose-a:text-blue-400 dark:prose-headings:text-slate-300 dark:prose-invert overflow-x-hidden prose prose-a:text-primary prose-headings:font-bold prose-headings:font-heading prose-headings:leading-tighter prose-headings:tracking-tighter prose-img:rounded-md prose-img:shadow prose-lg"><p>随着 Kubernetes 成为容器编排领域的事实标准，Golang 在云原生方面应用的也越来越多。今天我们跟随 K8s 的脚步，学习下在 K8s 中使用哪些经典的设计模式。</p><h2 id=创建型模式>创建型模式</h2><p>创建型模式顾名思义提供了对象的创建机制，封装了内部的复杂性，提高代码复用和灵活性。包括：</p><ul><li>单例模式</li><li>工厂模式</li><li>建造者模式</li><li>原型模式</li></ul><h3 id=单例模式>单例模式</h3><p>单例模式用来保证一个类只有一个实例，并提供调用它的一个全局访问点。单例模式是设计模式中最简单，使用最广的一个，通常用来创建一个共享的实例，比如数据库连接池、线程池等。</p><p>单例模式分为懒汉式（使用时创建，延迟调用）与饿汉式（初始化时创建），通常我们使用<code>once.Do</code>来实现懒汉式，保证其线程安全。</p><p>在<code>kubeadm</code>中使用了单例模式来创建用户与用户组 <a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/kubeadm/app/util/staticpod/utils.go>https://github.com/kubernetes/kubernetes/tree/master/cmd/kubeadm/app/util/staticpod/utils.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>var</span><span style=color:#f8f8f2> (</span></span>
<span class=line><span style=color:#f8f8f2>	usersAndGroups     </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>users</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>UsersAndGroups</span></span>
<span class=line><span style=color:#f8f8f2>	usersAndGroupsOnce </span><span style=color:#8be9fd;font-style:italic>sync</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Once</span></span>
<span class=line><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> GetUsersAndGroups</span><span style=color:#f8f8f2>() (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>users</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>UsersAndGroups</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>	var</span><span style=color:#f8f8f2> err </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#f8f8f2>	usersAndGroupsOnce.</span><span style=color:#50fa7b>Do</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>		usersAndGroups, err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> users.</span><span style=color:#50fa7b>AddUsersAndGroups</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> usersAndGroups, err</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=工厂模式>工厂模式</h3><p>工厂模式通过一个工厂方法来创建不同的产品，又分为简单工厂、工厂方法、抽象工厂，一般用来创建一类相似的产品，方便扩展。</p><p>简单工厂根据不同的输入创建不同的产品，在 Golang 中采用<code>Newxxx</code>的方式实现。</p><p>在<code>kubelet</code>中通过输入同创建不同的认证类型 <a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/kubelet/app/auth.go>https://github.com/kubernetes/kubernetes/tree/master/cmd/kubelet/app/auth.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> BuildAuthz</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>client</span><span style=color:#8be9fd;font-style:italic> authorizationclient</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>AuthorizationV1Interface</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>authz</span><span style=color:#8be9fd;font-style:italic> kubeletconfig</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>KubeletAuthorization</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>authorizer</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Authorizer</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>	switch</span><span style=color:#f8f8f2> authz.Mode {</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> kubeletconfig.KubeletAuthorizationModeAlwaysAllow:</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> authorizerfactory.</span><span style=color:#50fa7b>NewAlwaysAllowAuthorizer</span><span style=color:#f8f8f2>(), </span><span style=color:#bd93f9>nil</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> kubeletconfig.KubeletAuthorizationModeWebhook:</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#f8f8f2> client </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>			return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, errors.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>no client provided, cannot use webhook authorization</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>		authorizerConfig </span><span style=color:#ff79c6>:=</span><span style=color:#8be9fd;font-style:italic> authorizerfactory</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>DelegatingAuthorizerConfig</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>			SubjectAccessReviewClient: client,</span></span>
<span class=line><span style=color:#f8f8f2>			AllowCacheTTL:             authz.Webhook.CacheAuthorizedTTL.Duration,</span></span>
<span class=line><span style=color:#f8f8f2>			DenyCacheTTL:              authz.Webhook.CacheUnauthorizedTTL.Duration,</span></span>
<span class=line><span style=color:#f8f8f2>			WebhookRetryBackoff:       genericoptions.</span><span style=color:#50fa7b>DefaultAuthWebhookRetryBackoff</span><span style=color:#f8f8f2>(),</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> authorizerConfig.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>()</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#e9f284> ""</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>no authorization mode specified</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	default</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>unknown authorization mode </span><span style=color:#bd93f9>%s</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, authz.Mode)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>以及<a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/store.go>https://github.com/kubernetes/client-go/blob/master/tools/cache/store.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> NewStore</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>keyFunc</span><span style=color:#8be9fd;font-style:italic> KeyFunc</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>Store</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		cacheStorage: </span><span style=color:#50fa7b>NewThreadSafeStore</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd;font-style:italic>Indexers</span><span style=color:#f8f8f2>{}, </span><span style=color:#8be9fd;font-style:italic>Indices</span><span style=color:#f8f8f2>{}),</span></span>
<span class=line><span style=color:#f8f8f2>		keyFunc:      keyFunc,</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> cache</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>	// cacheStorage bears the burden of thread safety for the cache</span></span>
<span class=line><span style=color:#f8f8f2>	cacheStorage </span><span style=color:#8be9fd;font-style:italic>ThreadSafeStore</span></span>
<span class=line><span style=color:#6272a4>	// keyFunc is used to make the key for objects stored in and retrieved from items, and</span></span>
<span class=line><span style=color:#6272a4>	// should be deterministic.</span></span>
<span class=line><span style=color:#f8f8f2>	keyFunc </span><span style=color:#8be9fd;font-style:italic>KeyFunc</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> Store</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#50fa7b>	Add</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	Update</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	Delete</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	List</span><span style=color:#f8f8f2>() []</span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	ListKeys</span><span style=color:#f8f8f2>() []</span><span style=color:#8be9fd;font-style:italic>string</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	Get</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}) (</span><span style=color:#ffb86c;font-style:italic>item</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}, </span><span style=color:#ffb86c;font-style:italic>exists</span><span style=color:#8be9fd;font-style:italic> bool</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>err</span><span style=color:#8be9fd;font-style:italic> error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// GetByKey returns the accumulator associated with the given key</span></span>
<span class=line><span style=color:#50fa7b>	GetByKey</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>key</span><span style=color:#8be9fd;font-style:italic> string</span><span style=color:#f8f8f2>) (</span><span style=color:#ffb86c;font-style:italic>item</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}, </span><span style=color:#ffb86c;font-style:italic>exists</span><span style=color:#8be9fd;font-style:italic> bool</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>err</span><span style=color:#8be9fd;font-style:italic> error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	Replace</span><span style=color:#f8f8f2>([]</span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{}, </span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	Resync</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p>抽象工厂用来构建复杂的一组产品，在 informer 的实现中使用了抽象工厂 <a href=https://github.com/kubernetes/client-go/blob/master/informers/factory.go>https://github.com/kubernetes/client-go/blob/master/informers/factory.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// NewSharedInformerFactoryWithOptions constructs a new instance of a SharedInformerFactory with additional options.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> NewSharedInformerFactoryWithOptions</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>client</span><span style=color:#8be9fd;font-style:italic> kubernetes</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>defaultResync</span><span style=color:#8be9fd;font-style:italic> time</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Duration</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>options</span><span style=color:#ff79c6> ...</span><span style=color:#8be9fd;font-style:italic>SharedInformerOption</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>SharedInformerFactory</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	factory </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>sharedInformerFactory</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		client:           client,</span></span>
<span class=line><span style=color:#f8f8f2>		namespace:        v1.NamespaceAll,</span></span>
<span class=line><span style=color:#f8f8f2>		defaultResync:    defaultResync,</span></span>
<span class=line><span style=color:#f8f8f2>		informers:        </span><span style=color:#50fa7b>make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>reflect</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Type</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>SharedIndexInformer</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>		startedInformers: </span><span style=color:#50fa7b>make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>reflect</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Type</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>bool</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>		customResync:     </span><span style=color:#50fa7b>make</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>reflect</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Type</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>time</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Duration</span><span style=color:#f8f8f2>),</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Apply all options</span></span>
<span class=line><span style=color:#ff79c6>	for</span><span style=color:#f8f8f2> _, opt </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> range</span><span style=color:#f8f8f2> options {</span></span>
<span class=line><span style=color:#f8f8f2>		factory </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> opt</span><span style=color:#f8f8f2>(factory)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> factory</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// SharedInformerFactory provides shared informers for resources in all known</span></span>
<span class=line><span style=color:#6272a4>// API group versions.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> SharedInformerFactory</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	internalinterfaces</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>SharedInformerFactory</span></span>
<span class=line><span style=color:#50fa7b>	ForResource</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>resource</span><span style=color:#8be9fd;font-style:italic> schema</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>GroupVersionResource</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>GenericInformer</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	WaitForCacheSync</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>stopCh</span><span style=color:#ff79c6> &#x3C;-chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{}) </span><span style=color:#ff79c6>map</span><span style=color:#f8f8f2>[</span><span style=color:#8be9fd;font-style:italic>reflect</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Type</span><span style=color:#f8f8f2>]</span><span style=color:#8be9fd;font-style:italic>bool</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	Admissionregistration</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>admissionregistration</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Internal</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>apiserverinternal</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Apps</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>apps</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Autoscaling</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>autoscaling</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Batch</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>batch</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Certificates</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>certificates</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Coordination</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>coordination</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Core</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>core</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Discovery</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>discovery</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Events</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>events</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Extensions</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>extensions</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Flowcontrol</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>flowcontrol</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Networking</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>networking</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Node</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>node</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Policy</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>policy</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Rbac</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>rbac</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Scheduling</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>scheduling</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#50fa7b>	Storage</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>storage</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>f </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>sharedInformerFactory</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Apps</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>apps</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> apps.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(f, f.namespace, f.tweakListOptions)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=建造者模式>建造者模式</h3><p>建造者模式通过逐步构建复杂的对象，降低创建对象的复杂度。通常多个步骤返回中间对象，最后通过<code>Build</code>完成检验与构建工作。</p><p>在<code>controller-runtime</code>中使用了建造者模式来创建 controller <a href=https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/builder>https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/builder</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// Builder builds a Controller.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> Builder</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	forInput         </span><span style=color:#8be9fd;font-style:italic>ForInput</span></span>
<span class=line><span style=color:#f8f8f2>	ownsInput        []</span><span style=color:#8be9fd;font-style:italic>OwnsInput</span></span>
<span class=line><span style=color:#f8f8f2>	watchesInput     []</span><span style=color:#8be9fd;font-style:italic>WatchesInput</span></span>
<span class=line><span style=color:#f8f8f2>	mgr              </span><span style=color:#8be9fd;font-style:italic>manager</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Manager</span></span>
<span class=line><span style=color:#f8f8f2>	globalPredicates []</span><span style=color:#8be9fd;font-style:italic>predicate</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Predicate</span></span>
<span class=line><span style=color:#f8f8f2>	ctrl             </span><span style=color:#8be9fd;font-style:italic>controller</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Controller</span></span>
<span class=line><span style=color:#f8f8f2>	ctrlOptions      </span><span style=color:#8be9fd;font-style:italic>controller</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Options</span></span>
<span class=line><span style=color:#f8f8f2>	name             </span><span style=color:#8be9fd;font-style:italic>string</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>blder </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>For</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>object</span><span style=color:#8be9fd;font-style:italic> client</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Object</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>opts</span><span style=color:#ff79c6> ...</span><span style=color:#8be9fd;font-style:italic>ForOption</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> blder.forInput.object </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		blder.forInput.err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>For(...) should only be called once, could not assign multiple objects for reconciliation</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	input </span><span style=color:#ff79c6>:=</span><span style=color:#8be9fd;font-style:italic> ForInput</span><span style=color:#f8f8f2>{object: object}</span></span>
<span class=line><span style=color:#ff79c6>	for</span><span style=color:#f8f8f2> _, opt </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> range</span><span style=color:#f8f8f2> opts {</span></span>
<span class=line><span style=color:#f8f8f2>		opt.</span><span style=color:#50fa7b>ApplyToFor</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>input)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	blder.forInput </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> input</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Watches exposes the lower-level ControllerManagedBy Watches functions through the builder.  Consider using</span></span>
<span class=line><span style=color:#6272a4>// Owns or For instead of Watches directly.</span></span>
<span class=line><span style=color:#6272a4>// Specified predicates are registered only for given source.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>blder </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Watches</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>src</span><span style=color:#8be9fd;font-style:italic> source</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Source</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>eventhandler</span><span style=color:#8be9fd;font-style:italic> handler</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>EventHandler</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>opts</span><span style=color:#ff79c6> ...</span><span style=color:#8be9fd;font-style:italic>WatchesOption</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	input </span><span style=color:#ff79c6>:=</span><span style=color:#8be9fd;font-style:italic> WatchesInput</span><span style=color:#f8f8f2>{src: src, eventhandler: eventhandler}</span></span>
<span class=line><span style=color:#ff79c6>	for</span><span style=color:#f8f8f2> _, opt </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> range</span><span style=color:#f8f8f2> opts {</span></span>
<span class=line><span style=color:#f8f8f2>		opt.</span><span style=color:#50fa7b>ApplyToWatches</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>input)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	blder.watchesInput </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> append</span><span style=color:#f8f8f2>(blder.watchesInput, input)</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// WithOptions overrides the controller options use in doController. Defaults to empty.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>blder </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>WithOptions</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>options</span><span style=color:#8be9fd;font-style:italic> controller</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Options</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	blder.ctrlOptions </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// WithLogger overrides the controller options's logger used.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>blder </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>WithLogger</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>log</span><span style=color:#8be9fd;font-style:italic> logr</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Logger</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	blder.ctrlOptions.Log </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> log</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> blder</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Build builds the Application Controller and returns the Controller it created.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>blder </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Builder</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Build</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>r</span><span style=color:#8be9fd;font-style:italic> reconcile</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Reconciler</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>controller</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Controller</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> r </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>must provide a non-nil Reconciler</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> blder.mgr </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>must provide a non-nil Manager</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> blder.forInput.err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, blder.forInput.err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#6272a4>	// Checking the reconcile type exist or not</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> blder.forInput.object </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>must provide an object for reconciliation</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Set the ControllerManagedBy</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> blder.</span><span style=color:#50fa7b>doController</span><span style=color:#f8f8f2>(r); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Set the Watch</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> blder.</span><span style=color:#50fa7b>doWatch</span><span style=color:#f8f8f2>(); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> blder.ctrl, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=原型模式>原型模式</h3><p>原型模式用来解决对象复制问题，通过<code>Clone</code>方法，返回对象的复制品。将实现细节与使用解耦。</p><p>在 k8s 中所有资源都需要使用<code>DeepCopy</code>接口即原型模式 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/zz_generated.deepcopy.go>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/core/v1/zz_generated.deepcopy.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// DeepCopyInto is an autogenerated deepcopy function, copying the receiver, writing into out. in must be non-nil.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>in </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Pod</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>DeepCopyInto</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>out</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>Pod</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>	*</span><span style=color:#f8f8f2>out </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> *</span><span style=color:#f8f8f2>in</span></span>
<span class=line><span style=color:#f8f8f2>	out.TypeMeta </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> in.TypeMeta</span></span>
<span class=line><span style=color:#f8f8f2>	in.ObjectMeta.</span><span style=color:#50fa7b>DeepCopyInto</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>out.ObjectMeta)</span></span>
<span class=line><span style=color:#f8f8f2>	in.Spec.</span><span style=color:#50fa7b>DeepCopyInto</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>out.Spec)</span></span>
<span class=line><span style=color:#f8f8f2>	in.Status.</span><span style=color:#50fa7b>DeepCopyInto</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#f8f8f2>out.Status)</span></span>
<span class=line><span style=color:#ff79c6>	return</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// DeepCopy is an autogenerated deepcopy function, copying the receiver, creating a new Pod.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>in </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Pod</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>DeepCopy</span><span style=color:#f8f8f2>() </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Pod</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> in </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	out </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> new</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd;font-style:italic>Pod</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	in.</span><span style=color:#50fa7b>DeepCopyInto</span><span style=color:#f8f8f2>(out)</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> out</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h2 id=结构型模式>结构型模式</h2><p>结构型模式通过将对象组合成更大的结构，从而提供系统的灵活性。包括：</p><ul><li>适配器模式</li><li>桥接模式</li><li>组合模式</li><li>代理模式</li><li>外观模式</li><li>装饰模式</li><li>享元模式</li></ul><h3 id=适配器模式>适配器模式</h3><p>通过适配器模式能使不兼容的对象相互协作，通常做一些兼容性工作（老版本、外部服务）时会使用到。</p><p>k8s 中有很多适配器的例子, 通过<code>Adapter</code>去包裹其他对象转换成统一的接口 <a href=https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replication/conversion.go>https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replication/conversion.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// informerAdapter implements ReplicaSetInformer by wrapping ReplicationControllerInformer</span></span>
<span class=line><span style=color:#6272a4>// and converting objects.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> informerAdapter</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	rcInformer </span><span style=color:#8be9fd;font-style:italic>coreinformers</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ReplicationControllerInformer</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>i </span><span style=color:#8be9fd;font-style:italic>informerAdapter</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Informer</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>cache</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>SharedIndexInformer</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#8be9fd;font-style:italic> conversionInformer</span><span style=color:#f8f8f2>{i.rcInformer.</span><span style=color:#50fa7b>Informer</span><span style=color:#f8f8f2>()}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>i </span><span style=color:#8be9fd;font-style:italic>informerAdapter</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Lister</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>appslisters</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>ReplicaSetLister</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#8be9fd;font-style:italic> conversionLister</span><span style=color:#f8f8f2>{i.rcInformer.</span><span style=color:#50fa7b>Lister</span><span style=color:#f8f8f2>()}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><p><a href=https://github.com/kubernetes/client-go/blob/master/tools/events/event_broadcaster.go>https://github.com/kubernetes/client-go/blob/master/tools/events/event_broadcaster.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> eventBroadcasterAdapterImpl</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	coreClient          </span><span style=color:#8be9fd;font-style:italic>typedv1core</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>EventsGetter</span></span>
<span class=line><span style=color:#f8f8f2>	coreBroadcaster     </span><span style=color:#8be9fd;font-style:italic>record</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>EventBroadcaster</span></span>
<span class=line><span style=color:#f8f8f2>	eventsv1Client      </span><span style=color:#8be9fd;font-style:italic>typedeventsv1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>EventsV1Interface</span></span>
<span class=line><span style=color:#f8f8f2>	eventsv1Broadcaster </span><span style=color:#8be9fd;font-style:italic>EventBroadcaster</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// NewEventBroadcasterAdapter creates a wrapper around new and legacy broadcasters to simplify</span></span>
<span class=line><span style=color:#6272a4>// migration of individual components to the new Event API.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> NewEventBroadcasterAdapter</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>client</span><span style=color:#8be9fd;font-style:italic> clientset</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>EventBroadcasterAdapter</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	eventClient </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>eventBroadcasterAdapterImpl</span><span style=color:#f8f8f2>{}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> _, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> client.</span><span style=color:#50fa7b>Discovery</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>ServerResourcesForGroupVersion</span><span style=color:#f8f8f2>(eventsv1.SchemeGroupVersion.</span><span style=color:#50fa7b>String</span><span style=color:#f8f8f2>()); err </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		eventClient.eventsv1Client </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> client.</span><span style=color:#50fa7b>EventsV1</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>		eventClient.eventsv1Broadcaster </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> NewBroadcaster</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>EventSinkImpl</span><span style=color:#f8f8f2>{Interface: eventClient.eventsv1Client})</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#6272a4>	// Even though there can soon exist cases when coreBroadcaster won't really be needed,</span></span>
<span class=line><span style=color:#6272a4>	// we create it unconditionally because its overhead is minor and will simplify using usage</span></span>
<span class=line><span style=color:#6272a4>	// patterns of this library in all components.</span></span>
<span class=line><span style=color:#f8f8f2>	eventClient.coreClient </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> client.</span><span style=color:#50fa7b>CoreV1</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	eventClient.coreBroadcaster </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> record.</span><span style=color:#50fa7b>NewBroadcaster</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> eventClient</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// StartRecordingToSink starts sending events received from the specified eventBroadcaster to the given sink.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>e </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>eventBroadcasterAdapterImpl</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>StartRecordingToSink</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>stopCh</span><span style=color:#ff79c6> &#x3C;-chan</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2>{}) {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> e.eventsv1Broadcaster </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#ff79c6> &#x26;&#x26;</span><span style=color:#f8f8f2> e.eventsv1Client </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		e.eventsv1Broadcaster.</span><span style=color:#50fa7b>StartRecordingToSink</span><span style=color:#f8f8f2>(stopCh)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> e.coreBroadcaster </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#ff79c6> &#x26;&#x26;</span><span style=color:#f8f8f2> e.coreClient </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		e.coreBroadcaster.</span><span style=color:#50fa7b>StartRecordingToSink</span><span style=color:#f8f8f2>(</span><span style=color:#ff79c6>&#x26;</span><span style=color:#8be9fd;font-style:italic>typedv1core</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>EventSinkImpl</span><span style=color:#f8f8f2>{Interface: e.coreClient.</span><span style=color:#50fa7b>Events</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>""</span><span style=color:#f8f8f2>)})</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>e </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>eventBroadcasterAdapterImpl</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>NewRecorder</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>name</span><span style=color:#8be9fd;font-style:italic> string</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>EventRecorder</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> e.eventsv1Broadcaster </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#ff79c6> &#x26;&#x26;</span><span style=color:#f8f8f2> e.eventsv1Client </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> e.eventsv1Broadcaster.</span><span style=color:#50fa7b>NewRecorder</span><span style=color:#f8f8f2>(scheme.Scheme, name)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> record.</span><span style=color:#50fa7b>NewEventRecorderAdapter</span><span style=color:#f8f8f2>(e.</span><span style=color:#50fa7b>DeprecatedNewLegacyRecorder</span><span style=color:#f8f8f2>(name))</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=桥接模式>桥接模式</h3><p>桥接模式将实现与抽象解耦，可提供系统的系统的灵活性与可扩展性。</p><p>在 k8s 中大量使用，如<code>DiscoveryClient</code>的实现 <a href=https://github.com/kubernetes/client-go/blob/master/discovery/discovery_client.go>https://github.com/kubernetes/client-go/blob/master/discovery/discovery_client.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> DiscoveryClient</span><span style=color:#ff79c6> struct</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	restClient </span><span style=color:#8be9fd;font-style:italic>restclient</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	LegacyPrefix </span><span style=color:#8be9fd;font-style:italic>string</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> DiscoveryInterface</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#50fa7b>	RESTClient</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>restclient</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	ServerGroupsInterface</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	ServerResourcesInterface</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	ServerVersionInterface</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	OpenAPISchemaInterface</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	OpenAPIV3SchemaInterface</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// NewDiscoveryClient returns a new DiscoveryClient for the given RESTClient.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> NewDiscoveryClient</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>c</span><span style=color:#8be9fd;font-style:italic> restclient</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>DiscoveryClient</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>DiscoveryClient</span><span style=color:#f8f8f2>{restClient: c, LegacyPrefix: </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>/api</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// RESTClient returns a RESTClient that is used to communicate</span></span>
<span class=line><span style=color:#6272a4>// with API server by this client implementation.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>d </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>DiscoveryClient</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>RESTClient</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>restclient</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> d </span><span style=color:#ff79c6>==</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> d.restClient</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=组合模式>组合模式</h3><p>组合模式通过组合小对象形成更大的结构，并且具有相同的接口。和 Golang 中的组合非常相似，使用也非常广泛。</p><p><a href=https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/cache/cache.go>https://github.com/kubernetes-sigs/controller-runtime/tree/master/pkg/cache/cache.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// Cache knows how to load Kubernetes objects, fetch informers to request</span></span>
<span class=line><span style=color:#6272a4>// to receive events for Kubernetes objects (at a low-level),</span></span>
<span class=line><span style=color:#6272a4>// and add indices to fields on the objects stored in the cache.</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> Cache</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>	// Cache acts as a client to objects stored in the cache.</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	client</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Reader</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// Cache loads informers and adds field indices.</span></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	Informers</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> Informers</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#50fa7b>	GetInformer</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>ctx</span><span style=color:#8be9fd;font-style:italic> context</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Context</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#8be9fd;font-style:italic> client</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Object</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>Informer</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	GetInformerForKind</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>ctx</span><span style=color:#8be9fd;font-style:italic> context</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Context</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>gvk</span><span style=color:#8be9fd;font-style:italic> schema</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>GroupVersionKind</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>Informer</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	Start</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>ctx</span><span style=color:#8be9fd;font-style:italic> context</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Context</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	WaitForCacheSync</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>ctx</span><span style=color:#8be9fd;font-style:italic> context</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Context</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>bool</span></span>
<span class=line></span>
<span class=line><span style=color:#8be9fd;font-style:italic>	client</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>FieldIndexer</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=代理模式>代理模式</h3><p>代理模式通过代理来替代真实服务，通常代理类与真实类具有相同的接口，在代理类中可以做一些额外操作（访问控制、缓存等）</p><p>在 k8s 中通过代理来实现访问 Node、Pod、Service。</p><h3 id=外观模式>外观模式</h3><p>外观模式通过一个高度抽象的接口，使子系统更加容器使用，使用也很广泛</p><p>比如<code>controller-runtime</code>中创建时<code>controllerManager</code>时调用了很多子系统，使用时只需通过<code>GetClient()</code>便可得到<code>Client</code></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// New returns a new Manager for creating Controllers.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> New</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>config</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>rest</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>options</span><span style=color:#8be9fd;font-style:italic> Options</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>Manager</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>	// Set default values for options fields</span></span>
<span class=line><span style=color:#f8f8f2>	options </span><span style=color:#ff79c6>=</span><span style=color:#50fa7b> setOptionsDefaults</span><span style=color:#f8f8f2>(options)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	cluster, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> cluster.</span><span style=color:#50fa7b>New</span><span style=color:#f8f8f2>(config, </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>clusterOptions</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>cluster</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Options</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.Scheme </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.Scheme</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.MapperProvider </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.MapperProvider</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.Logger </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.Logger</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.SyncPeriod </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.SyncPeriod</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.Namespace </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.Namespace</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.NewCache </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.NewCache</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.NewClient </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.NewClient</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.ClientDisableCacheFor </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.ClientDisableCacheFor</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.DryRunClient </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.DryRunClient</span></span>
<span class=line><span style=color:#f8f8f2>		clusterOptions.EventBroadcaster </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> options.EventBroadcaster </span><span style=color:#6272a4>//nolint:staticcheck</span></span>
<span class=line><span style=color:#f8f8f2>	})</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	//...</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>controllerManager</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		cluster:                       cluster,</span></span>
<span class=line><span style=color:#6272a4>		//...</span></span>
<span class=line><span style=color:#f8f8f2>	}, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>c </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>cluster</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>GetClient</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>client</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Client</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> c.client</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=装饰模式>装饰模式</h3><p>装饰模式通过原有对象多次包装从而添加新功能，典型的一些 Http 中间件实现（日志、认证）</p><p><code>admission</code>中装饰器的使用 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/decorator.go>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/decorator.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> Decorator</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#50fa7b>	Decorate</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>handler</span><span style=color:#8be9fd;font-style:italic> Interface</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>name</span><span style=color:#8be9fd;font-style:italic> string</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> DecoratorFunc</span><span style=color:#ff79c6> func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>handler</span><span style=color:#8be9fd;font-style:italic> Interface</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>name</span><span style=color:#8be9fd;font-style:italic> string</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>Interface</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>d </span><span style=color:#8be9fd;font-style:italic>DecoratorFunc</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Decorate</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>handler</span><span style=color:#8be9fd;font-style:italic> Interface</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>name</span><span style=color:#8be9fd;font-style:italic> string</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>Interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#50fa7b> d</span><span style=color:#f8f8f2>(handler, name)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> Decorators</span><span style=color:#f8f8f2> []</span><span style=color:#8be9fd;font-style:italic>Decorator</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Decorate applies the decorator in inside-out order, i.e. the first decorator in the slice is first applied to the given handler.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>d </span><span style=color:#8be9fd;font-style:italic>Decorators</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Decorate</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>handler</span><span style=color:#8be9fd;font-style:italic> Interface</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>name</span><span style=color:#8be9fd;font-style:italic> string</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>Interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	result </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> handler</span></span>
<span class=line><span style=color:#ff79c6>	for</span><span style=color:#f8f8f2> _, d </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> range</span><span style=color:#f8f8f2> d {</span></span>
<span class=line><span style=color:#f8f8f2>		result </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> d.</span><span style=color:#50fa7b>Decorate</span><span style=color:#f8f8f2>(result, name)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> result</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=享元模式>享元模式</h3><p>享元模式通过共享多个对象共有的子对象，从而节省内存。如连接池、对象池的实现等，在 Golang 中通过<code>sync.Pool</code>可实现对象复用即享元模式。</p><p>在<code>apiserver/endpoints</code>中通过共享 gzip 对象，减少内存分配以及 gc 时间</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>var</span><span style=color:#f8f8f2> gzipPool </span><span style=color:#ff79c6>=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>sync</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Pool</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>	New: </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() </span><span style=color:#ff79c6>interface</span><span style=color:#f8f8f2>{} {</span></span>
<span class=line><span style=color:#f8f8f2>		gw, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> gzip.</span><span style=color:#50fa7b>NewWriterLevel</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>, defaultGzipContentEncodingLevel)</span></span>
<span class=line><span style=color:#ff79c6>		if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#50fa7b>			panic</span><span style=color:#f8f8f2>(err)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> gw</span></span>
<span class=line><span style=color:#f8f8f2>	},</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>w </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>deferredResponseWriter</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Write</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>p</span><span style=color:#f8f8f2> []</span><span style=color:#8be9fd;font-style:italic>byte</span><span style=color:#f8f8f2>) (</span><span style=color:#ffb86c;font-style:italic>n</span><span style=color:#8be9fd;font-style:italic> int</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>err</span><span style=color:#8be9fd;font-style:italic> error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>	// ...</span></span>
<span class=line><span style=color:#f8f8f2>	hw </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> w.hw</span></span>
<span class=line><span style=color:#f8f8f2>	header </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> hw.</span><span style=color:#50fa7b>Header</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#ff79c6>	switch</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> w.contentEncoding </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>gzip</span><span style=color:#e9f284>"</span><span style=color:#ff79c6> &#x26;&#x26;</span><span style=color:#50fa7b> len</span><span style=color:#f8f8f2>(p) </span><span style=color:#ff79c6>></span><span style=color:#f8f8f2> defaultGzipThresholdBytes:</span></span>
<span class=line><span style=color:#f8f8f2>		header.</span><span style=color:#50fa7b>Set</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Content-Encoding</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>gzip</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		header.</span><span style=color:#50fa7b>Add</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Vary</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Accept-Encoding</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		gw </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> gzipPool.</span><span style=color:#50fa7b>Get</span><span style=color:#f8f8f2>().(</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>gzip</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Writer</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		gw.</span><span style=color:#50fa7b>Reset</span><span style=color:#f8f8f2>(hw)</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		w.w </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> gw</span></span>
<span class=line><span style=color:#ff79c6>	default</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		w.w </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> hw</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>	header.</span><span style=color:#50fa7b>Set</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>Content-Type</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, w.mediaType)</span></span>
<span class=line><span style=color:#f8f8f2>	hw.</span><span style=color:#50fa7b>WriteHeader</span><span style=color:#f8f8f2>(w.statusCode)</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> w.w.</span><span style=color:#50fa7b>Write</span><span style=color:#f8f8f2>(p)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>w </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>deferredResponseWriter</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Close</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#ff79c6> !</span><span style=color:#f8f8f2>w.hasWritten {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	var</span><span style=color:#f8f8f2> err </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#ff79c6>	switch</span><span style=color:#f8f8f2> t </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> w.w.(</span><span style=color:#ff79c6>type</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>gzip</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Writer</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		err </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> t.</span><span style=color:#50fa7b>Close</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>		t.</span><span style=color:#50fa7b>Reset</span><span style=color:#f8f8f2>(</span><span style=color:#bd93f9>nil</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>		gzipPool.</span><span style=color:#50fa7b>Put</span><span style=color:#f8f8f2>(t)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> err</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h2 id=行为型模式>行为型模式</h2><p>行为型模式负责对象间的通信和职责委派，常用的包括：</p><ul><li>观察者模式</li><li>中介者模式</li><li>命令模式</li><li>迭代器模式</li><li>策略模式</li><li>状态模式</li><li>备忘录模式</li><li>职责链模式</li><li>访问者模式</li><li>解释器模式</li></ul><h3 id=观察者模式>观察者模式</h3><p>观察者模式允许观察者订阅事件，当事件触发时会通知观察对象。</p><p>在<code>shardInformer</code>订阅事件时使用了观察者模式 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/shared_informer.go>https://github.com/kubernetes/client-go/blob/master/tools/cache/shared_informer.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>s </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>sharedIndexInformer</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>AddEventHandlerWithResyncPeriod</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>handler</span><span style=color:#8be9fd;font-style:italic> ResourceEventHandler</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>resyncPeriod</span><span style=color:#8be9fd;font-style:italic> time</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Duration</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#6272a4>	//...</span></span>
<span class=line><span style=color:#f8f8f2>	s.processor.</span><span style=color:#50fa7b>addListener</span><span style=color:#f8f8f2>(listener)</span></span>
<span class=line><span style=color:#ff79c6>	for</span><span style=color:#f8f8f2> _, item </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> range</span><span style=color:#f8f8f2> s.indexer.</span><span style=color:#50fa7b>List</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>		listener.</span><span style=color:#50fa7b>add</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd;font-style:italic>addNotification</span><span style=color:#f8f8f2>{newObj: item})</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// 事件触发时通知所有对象</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>s </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>sharedIndexInformer</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>OnAdd</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}) {</span></span>
<span class=line><span style=color:#6272a4>	// Invocation of this function is locked under s.blockDeltas, so it is</span></span>
<span class=line><span style=color:#6272a4>	// save to distribute the notification</span></span>
<span class=line><span style=color:#f8f8f2>	s.cacheMutationDetector.</span><span style=color:#50fa7b>AddObject</span><span style=color:#f8f8f2>(obj)</span></span>
<span class=line><span style=color:#f8f8f2>	s.processor.</span><span style=color:#50fa7b>distribute</span><span style=color:#f8f8f2>(</span><span style=color:#8be9fd;font-style:italic>addNotification</span><span style=color:#f8f8f2>{newObj: obj}, </span><span style=color:#bd93f9>false</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>p </span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>sharedProcessor</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>distribute</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2>{}, </span><span style=color:#ffb86c;font-style:italic>sync</span><span style=color:#8be9fd;font-style:italic> bool</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	p.listenersLock.</span><span style=color:#50fa7b>RLock</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#ff79c6>	defer</span><span style=color:#f8f8f2> p.listenersLock.</span><span style=color:#50fa7b>RUnlock</span><span style=color:#f8f8f2>()</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> sync {</span></span>
<span class=line><span style=color:#ff79c6>		for</span><span style=color:#f8f8f2> _, listener </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> range</span><span style=color:#f8f8f2> p.syncingListeners {</span></span>
<span class=line><span style=color:#f8f8f2>			listener.</span><span style=color:#50fa7b>add</span><span style=color:#f8f8f2>(obj)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>	} </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		for</span><span style=color:#f8f8f2> _, listener </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> range</span><span style=color:#f8f8f2> p.listeners {</span></span>
<span class=line><span style=color:#f8f8f2>			listener.</span><span style=color:#50fa7b>add</span><span style=color:#f8f8f2>(obj)</span></span>
<span class=line><span style=color:#f8f8f2>		}</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=命令模式>命令模式</h3><p>命令模式通过将请求封装为对象，方便存储调用。</p><p>在 k8s 中所有组件启动都是通过<code>github.com/spf13/cobra</code>工具包 <a href=https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/apiserver.go>https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-apiserver/apiserver.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> main</span><span style=color:#f8f8f2>() {</span></span>
<span class=line><span style=color:#f8f8f2>	command </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> app.</span><span style=color:#50fa7b>NewAPIServerCommand</span><span style=color:#f8f8f2>()</span></span>
<span class=line><span style=color:#f8f8f2>	code </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> cli.</span><span style=color:#50fa7b>Run</span><span style=color:#f8f8f2>(command)</span></span>
<span class=line><span style=color:#f8f8f2>	os.</span><span style=color:#50fa7b>Exit</span><span style=color:#f8f8f2>(code)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=迭代器模式>迭代器模式</h3><p>迭代器允许顺序遍历复杂的数据结构而不暴露其内部细节。通常通过<code>Next</code>方法来迭代下一个对象。</p><p>k8s 在对象序列化时使用了迭代器。</p><h3 id=策略模式>策略模式</h3><p>策略模式通过定义一系列算法，允许运行时可替换算法，从而实现算法分离。</p><p>策略模式与桥接模式非常像，只是桥接模式的抽象程度更高一点。 <a href=https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/admissionregistration/mutatingwebhookconfiguration/storage/storage.go>https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/admissionregistration/mutatingwebhookconfiguration/storage/storage.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// NewREST returns a RESTStorage object that will work against mutatingWebhookConfiguration.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> NewREST</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>optsGetter</span><span style=color:#8be9fd;font-style:italic> generic</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>RESTOptionsGetter</span><span style=color:#f8f8f2>) (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>REST</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	store </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>genericregistry</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Store</span><span style=color:#f8f8f2>{</span></span>
<span class=line><span style=color:#f8f8f2>		NewFunc:     </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>runtime</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Object</span><span style=color:#f8f8f2> { </span><span style=color:#ff79c6>return</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>admissionregistration</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>MutatingWebhookConfiguration</span><span style=color:#f8f8f2>{} },</span></span>
<span class=line><span style=color:#f8f8f2>		NewListFunc: </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>() </span><span style=color:#8be9fd;font-style:italic>runtime</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Object</span><span style=color:#f8f8f2> { </span><span style=color:#ff79c6>return</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>admissionregistration</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>MutatingWebhookConfigurationList</span><span style=color:#f8f8f2>{} },</span></span>
<span class=line><span style=color:#f8f8f2>		ObjectNameFunc: </span><span style=color:#ff79c6>func</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>obj</span><span style=color:#8be9fd;font-style:italic> runtime</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Object</span><span style=color:#f8f8f2>) (</span><span style=color:#8be9fd;font-style:italic>string</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#ff79c6>			return</span><span style=color:#f8f8f2> obj.(</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>admissionregistration</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>MutatingWebhookConfiguration</span><span style=color:#f8f8f2>).Name, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>		},</span></span>
<span class=line><span style=color:#f8f8f2>		DefaultQualifiedResource: admissionregistration.</span><span style=color:#50fa7b>Resource</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>mutatingwebhookconfigurations</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>),</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		CreateStrategy: mutatingwebhookconfiguration.Strategy,</span></span>
<span class=line><span style=color:#f8f8f2>		UpdateStrategy: mutatingwebhookconfiguration.Strategy,</span></span>
<span class=line><span style=color:#f8f8f2>		DeleteStrategy: mutatingwebhookconfiguration.Strategy,</span></span>
<span class=line></span>
<span class=line><span style=color:#f8f8f2>		TableConvertor: </span><span style=color:#8be9fd;font-style:italic>printerstorage</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>TableConvertor</span><span style=color:#f8f8f2>{TableGenerator: printers.</span><span style=color:#50fa7b>NewTableGenerator</span><span style=color:#f8f8f2>().</span><span style=color:#50fa7b>With</span><span style=color:#f8f8f2>(printersinternal.AddHandlers)},</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	options </span><span style=color:#ff79c6>:=</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>generic</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>StoreOptions</span><span style=color:#f8f8f2>{RESTOptions: optsGetter}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> store.</span><span style=color:#50fa7b>CompleteWithOptions</span><span style=color:#f8f8f2>(options); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#ff79c6> &#x26;</span><span style=color:#8be9fd;font-style:italic>REST</span><span style=color:#f8f8f2>{store}, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=状态模式>状态模式</h3><p>状态模式将状态与行为分离，例如状态机的实现</p><p>如在容器运行时的接口中，可以获取容器状态</p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> Runtime</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#6272a4>	//...</span></span>
<span class=line><span style=color:#50fa7b>	Status</span><span style=color:#f8f8f2>() (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>RuntimeStatus</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	// SyncPod syncs the running pod into the desired pod.</span></span>
<span class=line><span style=color:#50fa7b>	SyncPod</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>pod</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>v1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Pod</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>podStatus</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>PodStatus</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>pullSecrets</span><span style=color:#f8f8f2> []</span><span style=color:#8be9fd;font-style:italic>v1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Secret</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>backOff</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>flowcontrol</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Backoff</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>PodSyncResult</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	KillPod</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>pod</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>v1</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Pod</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>runningPod</span><span style=color:#8be9fd;font-style:italic> Pod</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>gracePeriodOverride</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>int64</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line></span>
<span class=line><span style=color:#50fa7b>	DeleteContainer</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>containerID</span><span style=color:#8be9fd;font-style:italic> ContainerID</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span></span>
<span class=line><span style=color:#6272a4>	//...</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=备忘录模式>备忘录模式</h3><p>备忘录模式可以保存程序内部状态到外部，又不希望暴露内部状态的情形。例如快照可保存对象状态，用于恢复。</p><p><a href=https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/core/service/ipallocator/allocator.go>https://github.com/kubernetes/kubernetes/blob/master/pkg/registry/core/service/ipallocator/allocator.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6272a4>// NewFromSnapshot allocates a Range and initializes it from a snapshot.</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> NewFromSnapshot</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>snap</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>api</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>RangeAllocation</span><span style=color:#f8f8f2>) (</span><span style=color:#ff79c6>*</span><span style=color:#8be9fd;font-style:italic>Range</span><span style=color:#f8f8f2>, </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2>) {</span></span>
<span class=line><span style=color:#f8f8f2>	_, ipnet, err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> netutils.</span><span style=color:#50fa7b>ParseCIDRSloppy</span><span style=color:#f8f8f2>(snap.Range)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#f8f8f2>	r, err </span><span style=color:#ff79c6>:=</span><span style=color:#50fa7b> NewInMemory</span><span style=color:#f8f8f2>(ipnet)</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> err </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> r.</span><span style=color:#50fa7b>Restore</span><span style=color:#f8f8f2>(ipnet, snap.Data); err </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2>, err</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> r, </span><span style=color:#bd93f9>nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=职责链模式>职责链模式</h3><p>通过职责链分离不同的功能，可以动态组合。与装饰模式很相似，实际使用中也不需要区分其差异。</p><p>在<code>apiserver</code>的<code>handler</code>实现中，通过职责链来增加认证、授权、限流等操作 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/config.go>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/server/config.go</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>func</span><span style=color:#50fa7b> DefaultBuildHandlerChain</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>apiHandler</span><span style=color:#8be9fd;font-style:italic> http</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Handler</span><span style=color:#f8f8f2>, </span><span style=color:#ffb86c;font-style:italic>c</span><span style=color:#ff79c6> *</span><span style=color:#8be9fd;font-style:italic>Config</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>http</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>Handler</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#50fa7b>TrackCompleted</span><span style=color:#f8f8f2>(apiHandler)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#50fa7b>WithAuthorization</span><span style=color:#f8f8f2>(handler, c.Authorization.Authorizer, c.Serializer)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#50fa7b>TrackStarted</span><span style=color:#f8f8f2>(handler, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>authorization</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line></span>
<span class=line><span style=color:#ff79c6>	if</span><span style=color:#f8f8f2> c.FlowControl </span><span style=color:#ff79c6>!=</span><span style=color:#bd93f9> nil</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		requestWorkEstimator </span><span style=color:#ff79c6>:=</span><span style=color:#f8f8f2> flowcontrolrequest.</span><span style=color:#50fa7b>NewWorkEstimator</span><span style=color:#f8f8f2>(c.StorageObjectCountTracker.Get, c.FlowControl.GetInterestedWatchCount)</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#50fa7b>TrackCompleted</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericfilters.</span><span style=color:#50fa7b>WithPriorityAndFairness</span><span style=color:#f8f8f2>(handler, c.LongRunningFunc, c.FlowControl, requestWorkEstimator)</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> filterlatency.</span><span style=color:#50fa7b>TrackStarted</span><span style=color:#f8f8f2>(handler, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>priorityandfairness</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>	} </span><span style=color:#ff79c6>else</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#f8f8f2>		handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericfilters.</span><span style=color:#50fa7b>WithMaxInFlightLimit</span><span style=color:#f8f8f2>(handler, c.MaxRequestsInFlight, c.MaxMutatingRequestsInFlight, c.LongRunningFunc)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>	//...</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#50fa7b>WithLatencyTrackers</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#50fa7b>WithRequestInfo</span><span style=color:#f8f8f2>(handler, c.RequestInfoResolver)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#50fa7b>WithRequestReceivedTimestamp</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#50fa7b>WithMuxAndDiscoveryComplete</span><span style=color:#f8f8f2>(handler, c.lifecycleSignals.MuxAndDiscoveryComplete.</span><span style=color:#50fa7b>Signaled</span><span style=color:#f8f8f2>())</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericfilters.</span><span style=color:#50fa7b>WithPanicRecovery</span><span style=color:#f8f8f2>(handler, c.RequestInfoResolver)</span></span>
<span class=line><span style=color:#f8f8f2>	handler </span><span style=color:#ff79c6>=</span><span style=color:#f8f8f2> genericapifilters.</span><span style=color:#50fa7b>WithAuditID</span><span style=color:#f8f8f2>(handler)</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#f8f8f2> handler</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h3 id=访问者模式>访问者模式</h3><p>访问者模式可以给一系列对象透明的添加功能，并且把相关代码封装到一个类中, 对象只要预留访问者接口 Accept 则后期为对象添加功能的时就不需要改动对象。</p><p>例如动物园内有多个场馆，有些场馆（熊猫馆、海洋馆）需要单独收费，那么每个场馆（对象）可以通过 Accept 接待游客（Vistor）。访问者模式的关键是将对象的操作分离出来形成单独的类，对象可以选择对应的操作。</p><p>在<code>kubectl</code>中使用访问者模式，通过不同的访问者实现不同的参数，从而拼接成 Rest 请求。 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubectl/pkg/apps/kind_visitor.go#L39>https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/kubectl/pkg/apps/kind_visitor.go#L39</a></p><pre class="astro-code dracula" data-language=go style=background-color:#282a36;color:#f8f8f2;overflow-x:auto tabindex=0><code><span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> KindVisitor</span><span style=color:#ff79c6> interface</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#50fa7b>	VisitDaemonSet</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	VisitDeployment</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	VisitJob</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	VisitPod</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	VisitReplicaSet</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	VisitReplicationController</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	VisitStatefulSet</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#50fa7b>	VisitCronJob</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>kind</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#f8f8f2>)</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// GroupKindElement defines a Kubernetes API group elem</span></span>
<span class=line><span style=color:#ff79c6>type</span><span style=color:#8be9fd;font-style:italic> GroupKindElement</span><span style=color:#8be9fd;font-style:italic> schema</span><span style=color:#f8f8f2>.</span><span style=color:#8be9fd;font-style:italic>GroupKind</span></span>
<span class=line></span>
<span class=line><span style=color:#6272a4>// Accept calls the Visit method on visitor that corresponds to elem's Kind</span></span>
<span class=line><span style=color:#ff79c6>func</span><span style=color:#f8f8f2> (</span><span style=color:#ffb86c;font-style:italic>elem </span><span style=color:#8be9fd;font-style:italic>GroupKindElement</span><span style=color:#f8f8f2>) </span><span style=color:#50fa7b>Accept</span><span style=color:#f8f8f2>(</span><span style=color:#ffb86c;font-style:italic>visitor</span><span style=color:#8be9fd;font-style:italic> KindVisitor</span><span style=color:#f8f8f2>) </span><span style=color:#8be9fd;font-style:italic>error</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	switch</span><span style=color:#f8f8f2> {</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>extensions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>DaemonSet</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitDaemonSet</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>extensions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>Deployment</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitDeployment</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>batch</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>Job</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitJob</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>""</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>core</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>Pod</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitPod</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>extensions</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>ReplicaSet</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitReplicaSet</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>""</span><span style=color:#f8f8f2>, </span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>core</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>ReplicationController</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitReplicationController</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>apps</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>StatefulSet</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitStatefulSet</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	case</span><span style=color:#f8f8f2> elem.</span><span style=color:#50fa7b>GroupMatch</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>batch</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>) </span><span style=color:#ff79c6>&#x26;&#x26;</span><span style=color:#f8f8f2> elem.Kind </span><span style=color:#ff79c6>==</span><span style=color:#e9f284> "</span><span style=color:#f1fa8c>CronJob</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#f8f8f2>		visitor.</span><span style=color:#50fa7b>VisitCronJob</span><span style=color:#f8f8f2>(elem)</span></span>
<span class=line><span style=color:#ff79c6>	default</span><span style=color:#f8f8f2>:</span></span>
<span class=line><span style=color:#ff79c6>		return</span><span style=color:#f8f8f2> fmt.</span><span style=color:#50fa7b>Errorf</span><span style=color:#f8f8f2>(</span><span style=color:#e9f284>"</span><span style=color:#f1fa8c>no visitor method exists for </span><span style=color:#bd93f9>%v</span><span style=color:#e9f284>"</span><span style=color:#f8f8f2>, elem)</span></span>
<span class=line><span style=color:#f8f8f2>	}</span></span>
<span class=line><span style=color:#ff79c6>	return</span><span style=color:#bd93f9> nil</span></span>
<span class=line><span style=color:#f8f8f2>}</span></span>
<span class=line></span></code></pre><h2 id=总结>总结</h2><p>K8s 中包含了不少经典设计模式的例子，部分没找到合适的例子便没有提及。实际使用过程中可能多种模式都有涉及，或者是一些变种，不简单的是严格的标准定义，学会灵活应用才能提高的代码质量。</p><h2 id=引用>引用</h2><ul><li><a href=https://github.com/kubernetes/kubernetes>https://github.com/kubernetes/kubernetes</a></li><li><a href=https://aly.arriqaaq.com/golang-design-patterns/ >https://aly.arriqaaq.com/golang-design-patterns/</a></li></ul><blockquote><p>Explore more in <a href=https://qingwave.github.io>https://qingwave.github.io</a></p></blockquote></div><div class="flex flex-col justify-between mx-auto sm:flex-row sm:px-6 mt-8 px-6"><ul class=mr-5><li class="border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-full"><a href=/tags/golang class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#golang</a></li><li class="border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-full"><a href=/tags/k8s class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#k8s</a></li><li class="border border-slate-500 dark:border-slate-100 font-medium inline-block mx-1 my-1 px-2 py-1 rounded-full"><a href=/tags/程序设计 class="dark:text-slate-300 dark:hover:text-blue-400 hover:text-primary text-muted">#程序设计</a></li></ul></div></article><div class="mx-auto sm:px-6 max-w-3xl px-6 dark:text-slate-400 giscus-container py-16 text-muted"><script src=https://giscus.app/client.js async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOCg97r84CBQfL data-emit-metadata=0 data-input-position=top data-lang=en data-loading=lazy data-mapping=title data-reactions-enabled=1 data-repo=qingwave/qingwave.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNjg3ODY4NjM=" data-strict=0 data-theme=light></script></div></section></main><footer class=relative><div class="mx-auto sm:px-6 px-4 max-w-3xl"><div class="border-t border-gray-200 dark:border-slate-800"></div></div><div class="dark:bg-dark absolute inset-0 pointer-events-none" aria-hidden=true></div><div class="mx-auto sm:px-6 px-4 max-w-3xl dark:text-slate-300 relative"><div class="md:flex md:justify-between md:items-center md:py-8 py-6"><ul class="md:flex hidden -ml-2 mb-4 md:mb-0 md:ml-4 md:order-1"><li><a href=/rss.xml class="items-center dark:text-gray-400 inline-flex p-2.5 text-sm text-muted" aria-label=RSS><svg class="h-5 w-5" data-icon=tabler:rss height=1em viewBox="0 0 24 24" width=1em><symbol id=ai:tabler:rss><path d="M4 19a1 1 0 1 0 2 0a1 1 0 1 0-2 0M4 4a16 16 0 0 1 16 16M4 11a9 9 0 0 1 9 9" fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 /></symbol><use xlink:href=#ai:tabler:rss></use></svg></a></li></ul><div class="text-sm dark:text-slate-400 mr-4"><span class="h-5 w-5 bg-[url(/favicon.ico)] bg-cover float-left md:-mt-0.5 mr-1.5 rounded-sm"></span> <span class="dark:text-slate-300 text-slate-700"><a href=https://qingwave.github.io class=hover:brightness-50>Qingwave</a> · All rights reserved.</span></div></div></div></footer><script>!function(){const e="light";function t(e){"dark"===e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}function o(e,t,o){const n="string"==typeof e?document.querySelectorAll(e):e;n&&n.length&&n.forEach((e=>{e.addEventListener(t,(t=>o(t,e)),!1)}))}e&&e.endsWith(":only")||!localStorage.theme?t(e.replace(":only","")):"dark"===localStorage.theme||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):t("light"),window.onload=function(){let t=window.scrollY,n=!0;function c(){const e=document.getElementById("header");t>60&&!e.classList.contains("scroll")?document.getElementById("header").classList.add("scroll"):t<=60&&e.classList.contains("scroll")&&document.getElementById("header").classList.remove("scroll"),n=!1}o("[data-aw-toggle-menu]","click",(function(e,t){t.classList.toggle("expanded"),document.body.classList.toggle("overflow-hidden"),document.getElementById("header")?.classList.toggle("h-screen"),document.querySelector("#header nav")?.classList.toggle("hidden")})),o("[data-aw-toggle-color-scheme]","click",(function(){e.endsWith(":only")||(document.documentElement.classList.toggle("dark"),localStorage.theme=document.documentElement.classList.contains("dark")?"dark":"light",function(e){const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")}({setConfig:{theme:localStorage.theme}}))})),o("[data-aw-social-share]","click",(function(e,t){const o=t.getAttribute("data-aw-social-share"),n=encodeURIComponent(t.getAttribute("data-aw-url")),c=encodeURIComponent(t.getAttribute("data-aw-text"));let a;switch(o){case"facebook":a=`https://www.facebook.com/sharer.php?u=${n}`;break;case"twitter":a=`https://twitter.com/intent/tweet?url=${n}&text=${c}`;break;case"linkedin":a=`https://www.linkedin.com/shareArticle?mini=true&url=${n}&title=${c}`;break;case"whatsapp":a=`https://wa.me/?text=${c}%20${n}`;break;case"mail":a=`mailto:?subject=%22${c}%22&body=${c}%20${n}`;break;default:return}const s=document.createElement("a");s.target="_blank",s.href=a,s.click()})),c(),o([document],"scroll",(function(){t=window.scrollY,n||(window.requestAnimationFrame((()=>{c()})),n=!0)}))},window.onpageshow=function(){document.documentElement.classList.add("motion-safe:scroll-smooth");const e=document.querySelector("[data-aw-toggle-menu]");e&&e.classList.remove("expanded"),document.body.classList.remove("overflow-hidden"),document.getElementById("header")?.classList.remove("h-screen"),document.querySelector("#header nav")?.classList.add("hidden")}}()</script></body></html>